<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AI Product Catalog Manager</title>
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script src="https://unpkg.com/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    .dark { background-color: #1a1a2e; color: #eaeaea; }
    .dark .bg-white { background-color: #16213e !important; }
    .dark .bg-gray-50 { background-color: #1a1a2e !important; }
    .dark .bg-gray-100 { background-color: #1f2937 !important; }
    .dark .text-gray-800 { color: #eaeaea !important; }
    .dark .text-gray-700 { color: #d1d5db !important; }
    .dark .text-gray-600 { color: #9ca3af !important; }
    .dark .text-gray-500 { color: #9ca3af !important; }
    .dark .border-gray-200 { border-color: #374151 !important; }
    .dark .border-gray-300 { border-color: #4b5563 !important; }
    .dark input, .dark select { background-color: #1f2937 !important; color: #eaeaea !important; border-color: #4b5563 !important; }
    .dark .hover\:bg-gray-50:hover { background-color: #1f2937 !important; }
    .dark .bg-purple-50, .dark .bg-blue-50, .dark .bg-green-50, .dark .bg-yellow-50, .dark .bg-orange-50 { background-color: rgba(139, 92, 246, 0.1) !important; }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useRef, useEffect } = React;

    const API_URL = 'https://product-catalog-ai-production.up.railway.app';

    function App() {
      // Auth state
      const [isAuthenticated, setIsAuthenticated] = useState(false);
      const [authToken, setAuthToken] = useState(null);
      const [user, setUser] = useState(null);
      const [loginError, setLoginError] = useState('');
      const [isLoggingIn, setIsLoggingIn] = useState(false);
      const [loginForm, setLoginForm] = useState({ username: '', password: '', rememberMe: false });

      // Data state
      const [products, setProducts] = useState([]);
      const [bundles, setBundles] = useState([]);
      const [messages, setMessages] = useState([]);
      const [input, setInput] = useState("");
      const [isLoading, setIsLoading] = useState(false);
      const [activeTab, setActiveTab] = useState('chat');
      const [editingItem, setEditingItem] = useState(null);
      const [editingType, setEditingType] = useState(null);
      const [createType, setCreateType] = useState('product');
      const [newItem, setNewItem] = useState({});
      const [showCreateForm, setShowCreateForm] = useState(false);
      const [searchQuery, setSearchQuery] = useState('');
      const [searchResults, setSearchResults] = useState({ products: [], bundles: [] });
      const [showSearchResults, setShowSearchResults] = useState(false);
      const [showSanityReport, setShowSanityReport] = useState(false);
      const [sanityReport, setSanityReport] = useState(null);
      const [isCheckingSanity, setIsCheckingSanity] = useState(false);
      
      // Dynamic prompt suggestions based on context
      const [lastQueryType, setLastQueryType] = useState(null);
      
      const getSmartPrompts = () => {
        const prompts = {
          gettingStarted: [
            "What file formats can I upload?",
            "Show me an example structure",
            "What can you help me with?",
            "How do I get started?"
          ],
          
          // ROLE-SPECIFIC PROMPTS
          productOwner: [
            "What bundles are launching this quarter?",
            "Which bundles need renewal decisions?",
            "Show bundles expiring in next 30 days",
            "What's our most expensive bundle?",
            "What's our cheapest bundle?",
            "Compare our Fibre offerings",
            "Which bundles have the best value?",
            "Show bundle pricing tier breakdown",
            "What bundles compete with each other?",
            "Which products are in most bundles?",
            "Suggest bundle improvements",
            "What gaps exist in our bundle lineup?"
          ],
          
          businessAnalyst: [
            "Give me a full data summary",
            "Show all bundle configurations",
            "Compare all network types (DOCSIS vs FTTP)",
            "Break down bundles by category",
            "What's the price distribution?",
            "Find any data inconsistencies",
            "Which bundles have incomplete data?",
            "Show bundle to product mapping",
            "List all unique product combinations",
            "What patterns exist in pricing?",
            "Identify duplicate or similar bundles",
            "Create a bundle comparison matrix",
            "Show pricing anomalies",
            "What's the average price per category?"
          ],
          
          developer: [
            "Show me the data structure",
            "What fields are available?",
            "List all unique values for each column",
            "Find bundles with missing IDs",
            "Check for data type issues",
            "Show bundles with special characters",
            "Find formatting inconsistencies",
            "What's the schema of this data?",
            "Show sample bundle configuration",
            "List all bundle IDs",
            "Show all product SKUs",
            "Find null or empty values",
            "Check date format consistency",
            "Validate ID patterns"
          ],
          
          dailyStandUp: [
            "What's changed recently?",
            "Show bundles added this week",
            "What bundles expire today?",
            "What expires this week?",
            "Quick summary of all active bundles",
            "Any pricing changes needed?",
            "What needs immediate attention?",
            "Show bundles by end date (soonest first)",
            "Any data quality issues to fix?",
            "What's our current bundle count?",
            "Show today's bundle status"
          ],
          
          // SPECIFIC LOOKUP QUERIES
          bundleLookup: [
            "Find bundle by ID...",
            "Show me bundle [ID] details",
            "What products are in bundle [ID]?",
            "When does bundle [ID] expire?",
            "What's the price of bundle [ID]?",
            "Compare bundle [ID] with similar bundles",
            "Show all M50 bundles",
            "Show all M125 bundles",
            "Show all M250 bundles",
            "Show all M350 bundles",
            "Show all M500 bundles",
            "Show all Gig1 bundles",
            "Find all Flex bundles",
            "Find all Solus bundles"
          ],
          
          productLookup: [
            "Which bundles contain Netflix?",
            "Which bundles contain Disney+?",
            "Which bundles contain Sky Sports?",
            "Which bundles contain BT Sport?",
            "Which bundles have streaming included?",
            "Find bundles with broadband only",
            "Find bundles with TV included",
            "Find bundles with phone included",
            "What add-ons are available?"
          ],
          
          configurationQueries: [
            "How is bundle [ID] configured?",
            "What's included in the Family pack?",
            "Show all BB + Stream configurations",
            "Show all BB Solus configurations",
            "What's the difference between Flex and non-Flex?",
            "Compare Standard vs Premium tiers",
            "Show network configuration for bundle [ID]",
            "What speed tiers do we offer?",
            "Show all DOCSIS bundles",
            "Show all FTTP bundles",
            "Compare DOCSIS vs FTTP offerings"
          ],
          
          pricingQueries: [
            "Show pricing for all M500 bundles",
            "Compare intro vs standard pricing",
            "Which bundles have promotional pricing?",
            "Show Â£0 intro price bundles",
            "Which bundles are under Â£50?",
            "Which bundles are over Â£70?",
            "Price breakdown by speed tier",
            "Show bundles with best intro deals",
            "Compare pricing across categories"
          ],

          bundleAnalysis: [
            "Which bundles end this year?",
            "Which bundles expire in the next 30 days?",
            "Which bundles expire in the next 3 months?",
            "Show all bundles with Netflix",
            "Show all bundles with Disney+",
            "Which bundles have the most products?",
            "List bundles by price (high to low)",
            "List bundles by price (low to high)",
            "Show bundles cheaper than Â£50",
            "Show bundles more expensive than Â£100",
            "Which bundles are DOCSIS?",
            "Which bundles are FTTP?",
            "Show all BB Solus bundles",
            "Show all BB + Stream bundles",
            "Compare Flex vs non-Flex bundles",
            "Which bundles were added this month?",
            "Show bundles by category",
            "Find duplicate bundles"
          ],
          productAnalysis: [
            "Show all products by category",
            "Which products aren't in any bundle?",
            "List products with missing data",
            "What's the average product price?",
            "Show duplicate products",
            "Which products are most expensive?",
            "Which products are cheapest?",
            "Show products added this month",
            "Find products with no price",
            "List all product categories"
          ],
          crossAnalysis: [
            "Which products appear in the most bundles?",
            "Suggest new bundle combinations",
            "Find pricing inconsistencies",
            "Compare bundle vs individual pricing",
            "Which products should I add to bundles?",
            "Find bundles with similar products",
            "Show product overlap between bundles",
            "Which bundles offer best value?"
          ],
          dataQuality: [
            "Check my data for errors",
            "Find rows with missing fields",
            "Show me any duplicates",
            "Validate all dates are correct",
            "Find inconsistent pricing",
            "Check for empty cells",
            "Validate bundle IDs",
            "Find formatting issues"
          ],
          reporting: [
            "Give me a summary of all bundles",
            "Give me a summary of all products",
            "Create a pricing report",
            "Show me bundles expiring each month",
            "Break down bundles by network type",
            "Break down bundles by category",
            "Show monthly bundle count",
            "Revenue analysis by bundle type"
          ]
        };
        return prompts;
      };

      // Get dynamic follow-up prompts based on last query
      const getFollowUpPrompts = () => {
        if (!lastQueryType) return [];
        
        const followUps = {
          'bundles_ending': [
            "Export these to Excel",
            "Which of these have Netflix?",
            "Sort by price",
            "Show full details for each",
            "Which have the best value?",
            "Compare pricing across these",
            "Who owns these bundles?",
            "What's the renewal plan?"
          ],
          'bundles_netflix': [
            "Which also have Disney+?",
            "Sort by price",
            "Which end this year?",
            "Compare Netflix tiers",
            "Which is cheapest with Netflix?",
            "Show all streaming bundles",
            "What other content is included?"
          ],
          'bundles_price': [
            "Filter by network type",
            "Show only BB + Stream",
            "Which include streaming?",
            "Compare top 5",
            "Show intro vs standard pricing",
            "Find promotional offers",
            "Price per speed tier"
          ],
          'products_category': [
            "Which category has most?",
            "Show products not in bundles",
            "Average price by category",
            "Find gaps in categories",
            "List all categories",
            "Category breakdown chart"
          ],
          'data_quality': [
            "Show the specific errors",
            "How do I fix these?",
            "Export issues list",
            "Which are critical?",
            "Re-validate after fixes",
            "Check IDs specifically",
            "Validate dates only"
          ],
          'bundle_lookup': [
            "Show all products in this bundle",
            "When does this expire?",
            "What's the pricing?",
            "Compare with similar bundles",
            "Show configuration details",
            "What network type is this?",
            "Is there a Flex version?"
          ],
          'configuration': [
            "Compare with other configs",
            "What's the network type?",
            "Show all similar bundles",
            "What products are included?",
            "DOCSIS or FTTP?",
            "Show speed options",
            "List all variants"
          ],
          'pricing': [
            "Show intro vs standard",
            "Which has best value?",
            "Compare across speeds",
            "Show promotional pricing",
            "Price per product included",
            "Export pricing table"
          ],
          'daily': [
            "What needs action today?",
            "Show expiring bundles",
            "Any data issues?",
            "Quick summary",
            "What changed this week?",
            "Upcoming renewals"
          ],
          'general': [
            "Tell me more",
            "Export this table",
            "Show in different format",
            "Compare with others",
            "Summarize findings",
            "What else should I know?"
          ]
        };
        
        return followUps[lastQueryType] || followUps['general'];
      };

      // Detect query type for follow-up suggestions
      const detectQueryType = (query) => {
        const q = query.toLowerCase();
        if (q.includes('end') && (q.includes('year') || q.includes('month') || q.includes('expire'))) return 'bundles_ending';
        if (q.includes('netflix') || q.includes('disney') || q.includes('streaming')) return 'bundles_netflix';
        if (q.includes('price') || q.includes('cheap') || q.includes('expensive') || q.includes('cost')) return 'pricing';
        if (q.includes('category') || q.includes('categories')) return 'products_category';
        if (q.includes('error') || q.includes('quality') || q.includes('missing') || q.includes('duplicate') || q.includes('validate')) return 'data_quality';
        if (q.includes('config') || q.includes('docsis') || q.includes('fttp') || q.includes('network')) return 'configuration';
        if (q.includes('show me bundle') || q.includes('find bundle') || q.includes('bundle id') || q.match(/\b(m50|m125|m250|m350|m500|gig)/)) return 'bundle_lookup';
        if (q.includes('today') || q.includes('this week') || q.includes('stand') || q.includes('quick') || q.includes('summary')) return 'daily';
        return 'general';
      };

      // Get column-specific prompts based on actual data
      const getColumnSpecificPrompts = () => {
        const prompts = [];
        
        if (bundles.length > 0) {
          const cols = Object.keys(bundles[0]);
          
          // Date columns
          cols.forEach(col => {
            if (col.toLowerCase().includes('date') || col.toLowerCase().includes('end') || col.toLowerCase().includes('expir')) {
              prompts.push(`Show bundles by ${col}`);
              prompts.push(`Which bundles have ${col} this year?`);
              prompts.push(`Sort bundles by ${col}`);
            }
          });
          
          // Price columns
          cols.forEach(col => {
            if (col.toLowerCase().includes('price') || col.toLowerCase().includes('cost')) {
              prompts.push(`Show bundles sorted by ${col}`);
              prompts.push(`Average ${col} across all bundles`);
              prompts.push(`Find bundles with ${col} under Â£50`);
            }
          });
          
          // Category/Type columns
          cols.forEach(col => {
            if (col.toLowerCase().includes('type') || col.toLowerCase().includes('category') || col.toLowerCase().includes('network')) {
              prompts.push(`Break down bundles by ${col}`);
              prompts.push(`Show unique values in ${col}`);
              prompts.push(`Count bundles per ${col}`);
            }
          });
          
          // Name columns - look for specific products
          const sampleValues = bundles.slice(0, 20).map(b => Object.values(b).join(' ')).join(' ').toLowerCase();
          if (sampleValues.includes('netflix')) prompts.push('Show all bundles with Netflix');
          if (sampleValues.includes('disney')) prompts.push('Show all bundles with Disney+');
          if (sampleValues.includes('spotify')) prompts.push('Show all bundles with Spotify');
          if (sampleValues.includes('flex')) prompts.push('Compare Flex vs non-Flex bundles');
          if (sampleValues.includes('fibre')) prompts.push('Show all Fibre bundles');
          if (sampleValues.includes('gig')) prompts.push('Show all Gig speed bundles');
        }
        
        return [...new Set(prompts)].slice(0, 10); // Unique prompts, max 10
      };

      // NEW FEATURES
      const [darkMode, setDarkMode] = useState(false);
      const [favoritePrompts, setFavoritePrompts] = useState([]);
      const [showCompare, setShowCompare] = useState(false);
      const [compareItems, setCompareItems] = useState([]);
      const [selectedItems, setSelectedItems] = useState({ products: [], bundles: [] });
      const [showCharts, setShowCharts] = useState(false);
      const [showOnboarding, setShowOnboarding] = useState(true);
      const [onboardingStep, setOnboardingStep] = useState(1);
      const [showPromptLibrary, setShowPromptLibrary] = useState(false);
      
      const messagesEndRef = useRef(null);
      const searchInputRef = useRef(null);
      const chartRef = useRef(null);
      const priceChartRef = useRef(null);

      // Parse and render markdown tables
      const parseMarkdownTable = (tableText) => {
        const lines = tableText.trim().split('\n').filter(line => line.trim());
        if (lines.length < 2) return null;
        
        const parseRow = (row) => {
          return row.split('|').map(cell => cell.trim()).filter(cell => cell && !cell.match(/^[-:]+$/));
        };
        
        const headers = parseRow(lines[0]);
        if (headers.length === 0) return null;
        
        // Skip separator line
        const dataStartIndex = lines[1].includes('---') ? 2 : 1;
        const rows = lines.slice(dataStartIndex).map(parseRow).filter(row => row.length > 0);
        
        return { headers, rows };
      };

      const exportTableToCSV = (tableData, filename = 'table-export.csv') => {
        if (!tableData) return;
        const csvContent = [
          tableData.headers.join(','),
          ...tableData.rows.map(row => row.map(cell => `"${cell}"`).join(','))
        ].join('\n');
        
        const blob = new Blob([csvContent], { type: 'text/csv' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        a.click();
        addMessage('system', `âœ… Table exported to ${filename}`);
      };

      const exportTableToExcel = (tableData, filename = 'table-export.xlsx') => {
        if (!tableData) return;
        const wsData = [tableData.headers, ...tableData.rows];
        const ws = XLSX.utils.aoa_to_sheet(wsData);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, 'Data');
        XLSX.writeFile(wb, filename);
        addMessage('system', `âœ… Table exported to ${filename}`);
      };

      const renderFormattedMessage = (content) => {
        // Split content into parts (tables and text)
        const parts = [];
        let currentText = '';
        const lines = content.split('\n');
        let tableLines = [];
        let inTable = false;

        lines.forEach((line, idx) => {
          const isTableLine = line.trim().startsWith('|') && line.trim().endsWith('|');
          
          if (isTableLine) {
            if (!inTable && currentText.trim()) {
              parts.push({ type: 'text', content: currentText });
              currentText = '';
            }
            inTable = true;
            tableLines.push(line);
          } else {
            if (inTable && tableLines.length > 0) {
              parts.push({ type: 'table', content: tableLines.join('\n') });
              tableLines = [];
              inTable = false;
            }
            currentText += line + '\n';
          }
        });

        // Handle remaining content
        if (tableLines.length > 0) {
          parts.push({ type: 'table', content: tableLines.join('\n') });
        }
        if (currentText.trim()) {
          parts.push({ type: 'text', content: currentText });
        }

        return (
          <div className="space-y-4">
            {parts.map((part, idx) => {
              if (part.type === 'table') {
                const tableData = parseMarkdownTable(part.content);
                if (!tableData) return <pre key={idx} className="whitespace-pre-wrap font-sans text-sm">{part.content}</pre>;
                
                return (
                  <div key={idx} className="border border-gray-200 rounded-lg overflow-hidden">
                    <div className="bg-gray-50 px-3 py-2 flex justify-between items-center border-b border-gray-200">
                      <span className="text-xs font-semibold text-gray-500">{tableData.rows.length} rows</span>
                      <div className="flex gap-2">
                        <button 
                          onClick={() => exportTableToCSV(tableData)} 
                          className="text-xs px-2 py-1 bg-blue-100 text-blue-700 rounded hover:bg-blue-200 font-medium"
                        >
                          ğŸ“¥ CSV
                        </button>
                        <button 
                          onClick={() => exportTableToExcel(tableData)} 
                          className="text-xs px-2 py-1 bg-green-100 text-green-700 rounded hover:bg-green-200 font-medium"
                        >
                          ğŸ“Š Excel
                        </button>
                      </div>
                    </div>
                    <div className="overflow-x-auto">
                      <table className="w-full text-sm">
                        <thead className="bg-purple-50">
                          <tr>
                            {tableData.headers.map((header, hIdx) => (
                              <th key={hIdx} className="px-3 py-2 text-left font-semibold text-purple-900 border-b border-purple-200 whitespace-nowrap">
                                {header}
                              </th>
                            ))}
                          </tr>
                        </thead>
                        <tbody>
                          {tableData.rows.map((row, rIdx) => (
                            <tr key={rIdx} className={`${rIdx % 2 === 0 ? 'bg-white' : 'bg-gray-50'} hover:bg-purple-50`}>
                              {row.map((cell, cIdx) => (
                                <td key={cIdx} className="px-3 py-2 border-b border-gray-100 whitespace-nowrap">
                                  {cell}
                                </td>
                              ))}
                            </tr>
                          ))}
                        </tbody>
                      </table>
                    </div>
                  </div>
                );
              } else {
                // Render text with basic markdown formatting
                const formattedText = part.content
                  .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
                  .replace(/\*(.+?)\*/g, '<em>$1</em>')
                  .replace(/`(.+?)`/g, '<code class="bg-gray-100 px-1 rounded text-purple-700">$1</code>');
                
                return (
                  <div 
                    key={idx} 
                    className="text-sm whitespace-pre-wrap" 
                    dangerouslySetInnerHTML={{ __html: formattedText }}
                  />
                );
              }
            })}
          </div>
        );
      };

      const scrollToBottom = () => {
        messagesEndRef.current?.scrollIntoView({ behavior: "smooth" });
      };

      useEffect(() => {
        scrollToBottom();
      }, [messages]);

      // Load saved preferences
      useEffect(() => {
        const storedToken = localStorage.getItem('auth_token');
        const storedUser = localStorage.getItem('auth_user');
        const storedDarkMode = localStorage.getItem('dark_mode');
        const storedFavorites = localStorage.getItem('favorite_prompts');
        
        if (storedToken && storedUser) {
          setAuthToken(storedToken);
          setUser(JSON.parse(storedUser));
          setIsAuthenticated(true);
          verifyToken(storedToken);
        }
        
        if (storedDarkMode === 'true') setDarkMode(true);
        if (storedFavorites) setFavoritePrompts(JSON.parse(storedFavorites));
        
        // Check if onboarding completed
        const onboardingComplete = localStorage.getItem('onboarding_complete');
        if (onboardingComplete === 'true') setShowOnboarding(false);
      }, []);

      // Toggle dark mode
      const toggleDarkMode = () => {
        const newMode = !darkMode;
        setDarkMode(newMode);
        localStorage.setItem('dark_mode', newMode.toString());
      };

      // Complete onboarding
      const completeOnboarding = () => {
        setShowOnboarding(false);
        localStorage.setItem('onboarding_complete', 'true');
      };

      const resetOnboarding = () => {
        setShowOnboarding(true);
        setOnboardingStep(1);
        localStorage.removeItem('onboarding_complete');
      };

      // Onboarding Wizard Component
      const OnboardingWizard = () => {
        const steps = [
          {
            title: "Welcome to AI Product Catalog Manager! ğŸ‘‹",
            description: "This tool helps you manage, analyze, and get insights from your product and bundle data using AI.",
            icon: "ğŸš€",
            features: [
              "ğŸ“Š Upload and analyze your product/bundle spreadsheets",
              "ğŸ¤– Ask AI questions about your data in plain English",
              "ğŸ“ˆ Visualize data with charts and comparisons",
              "âœ… Check data quality and find errors automatically"
            ]
          },
          {
            title: "Step 1: Upload Your Data ğŸ“",
            description: "Start by uploading your Products and/or Bundles files. We support Excel (.xlsx) and CSV files.",
            icon: "ğŸ“",
            tips: [
              "ğŸ’¡ Products = Individual items (e.g., Netflix, Broadband, TV packages)",
              "ğŸ’¡ Bundles = Combinations of products sold together",
              "ğŸ’¡ Your file should have headers in the first row",
              "ğŸ’¡ Common columns: ID, Name, Price, Category, End Date"
            ],
            action: "upload"
          },
          {
            title: "Step 2: Ask the AI Anything ğŸ’¬",
            description: "Once your data is loaded, you can ask questions in plain English. The AI understands your data!",
            icon: "ğŸ¤–",
            examples: [
              "\"Which bundles expire this year?\"",
              "\"Show all bundles with Netflix\"",
              "\"Find pricing errors in my data\"",
              "\"Compare M500 vs Gig1 bundles\"",
              "\"What products aren't in any bundle?\""
            ]
          },
          {
            title: "Step 3: Explore Features ğŸ¯",
            description: "Use the tabs and tools to manage your catalog effectively.",
            icon: "âœ¨",
            features: [
              "ğŸ“Š Charts - Visualize pricing and categories",
              "âš–ï¸ Compare - Side-by-side bundle comparison",
              "ğŸ” Search - Find anything instantly (Cmd+K)",
              "ğŸ§  AI Sanity Check - Automatic data validation",
              "ğŸ“¥ Export - Download tables to Excel/CSV"
            ]
          },
          {
            title: "You're Ready! ğŸ‰",
            description: "Start by uploading a file, or try asking the AI a question. Need help? Click any suggested prompt!",
            icon: "ğŸ‰",
            quickStart: true
          }
        ];

        const currentStep = steps[onboardingStep - 1];

        return (
          <div className="bg-white rounded-xl shadow-2xl border-2 border-purple-200 overflow-hidden mb-6">
            {/* Progress bar */}
            <div className="bg-gradient-to-r from-purple-500 to-blue-500 p-1">
              <div className="flex justify-between px-4">
                {steps.map((_, idx) => (
                  <div key={idx} className={`w-8 h-8 rounded-full flex items-center justify-center text-sm font-bold transition-all ${idx + 1 <= onboardingStep ? 'bg-white text-purple-600' : 'bg-purple-400 text-white'}`}>
                    {idx + 1 <= onboardingStep ? 'âœ“' : idx + 1}
                  </div>
                ))}
              </div>
            </div>
            
            <div className="p-8">
              {/* Header */}
              <div className="text-center mb-6">
                <div className="text-6xl mb-4">{currentStep.icon}</div>
                <h2 className="text-2xl font-bold text-gray-800 mb-2">{currentStep.title}</h2>
                <p className="text-gray-600">{currentStep.description}</p>
              </div>

              {/* Content based on step */}
              {currentStep.features && (
                <div className="bg-purple-50 rounded-lg p-4 mb-6">
                  <div className="grid md:grid-cols-2 gap-3">
                    {currentStep.features.map((feature, idx) => (
                      <div key={idx} className="flex items-center gap-2 text-gray-700">
                        <span>{feature}</span>
                      </div>
                    ))}
                  </div>
                </div>
              )}

              {currentStep.tips && (
                <div className="bg-blue-50 rounded-lg p-4 mb-6">
                  <p className="font-semibold text-blue-800 mb-2">ğŸ’¡ Tips:</p>
                  <ul className="space-y-2">
                    {currentStep.tips.map((tip, idx) => (
                      <li key={idx} className="text-blue-700 text-sm">{tip}</li>
                    ))}
                  </ul>
                </div>
              )}

              {currentStep.examples && (
                <div className="bg-green-50 rounded-lg p-4 mb-6">
                  <p className="font-semibold text-green-800 mb-2">ğŸ’¬ Try asking:</p>
                  <div className="flex flex-wrap gap-2">
                    {currentStep.examples.map((example, idx) => (
                      <span key={idx} className="px-3 py-1 bg-white text-green-700 rounded-full text-sm border border-green-200">{example}</span>
                    ))}
                  </div>
                </div>
              )}

              {currentStep.action === 'upload' && (
                <div className="bg-amber-50 rounded-lg p-4 mb-6 border-2 border-dashed border-amber-300">
                  <p className="text-center text-amber-800 font-medium">
                    ğŸ‘† Use the "Upload Your Data" section above to add your files
                  </p>
                </div>
              )}

              {currentStep.quickStart && (
                <div className="grid md:grid-cols-3 gap-4 mb-6">
                  <button onClick={() => { completeOnboarding(); document.querySelector('input[type="file"]')?.click(); }} className="p-4 bg-purple-100 rounded-lg hover:bg-purple-200 transition text-center">
                    <div className="text-3xl mb-2">ğŸ“</div>
                    <div className="font-semibold text-purple-800">Upload Data</div>
                    <div className="text-xs text-purple-600">Start with your files</div>
                  </button>
                  <button onClick={() => { completeOnboarding(); setInput("What can you help me with?"); }} className="p-4 bg-blue-100 rounded-lg hover:bg-blue-200 transition text-center">
                    <div className="text-3xl mb-2">ğŸ¤–</div>
                    <div className="font-semibold text-blue-800">Ask AI</div>
                    <div className="text-xs text-blue-600">Get help from AI</div>
                  </button>
                  <button onClick={completeOnboarding} className="p-4 bg-green-100 rounded-lg hover:bg-green-200 transition text-center">
                    <div className="text-3xl mb-2">ğŸ¯</div>
                    <div className="font-semibold text-green-800">Explore</div>
                    <div className="text-xs text-green-600">Look around first</div>
                  </button>
                </div>
              )}

              {/* Navigation */}
              <div className="flex justify-between items-center pt-4 border-t border-gray-200">
                <button 
                  onClick={() => setOnboardingStep(Math.max(1, onboardingStep - 1))}
                  className={`px-4 py-2 rounded-lg font-medium ${onboardingStep === 1 ? 'text-gray-400 cursor-not-allowed' : 'text-purple-600 hover:bg-purple-50'}`}
                  disabled={onboardingStep === 1}
                >
                  â† Back
                </button>
                
                <div className="flex gap-2">
                  <button onClick={completeOnboarding} className="px-4 py-2 text-gray-500 hover:text-gray-700 text-sm">
                    Skip tutorial
                  </button>
                  
                  {onboardingStep < steps.length ? (
                    <button 
                      onClick={() => setOnboardingStep(onboardingStep + 1)}
                      className="px-6 py-2 bg-gradient-to-r from-purple-600 to-blue-600 text-white rounded-lg font-semibold hover:from-purple-700 hover:to-blue-700"
                    >
                      Next â†’
                    </button>
                  ) : (
                    <button 
                      onClick={completeOnboarding}
                      className="px-6 py-2 bg-gradient-to-r from-green-600 to-emerald-600 text-white rounded-lg font-semibold hover:from-green-700 hover:to-emerald-700"
                    >
                      Get Started! ğŸš€
                    </button>
                  )}
                </div>
              </div>
            </div>
          </div>
        );
      };

      // Favorite prompts
      const toggleFavoritePrompt = (prompt) => {
        let updated;
        if (favoritePrompts.includes(prompt)) {
          updated = favoritePrompts.filter(p => p !== prompt);
        } else {
          updated = [...favoritePrompts, prompt];
        }
        setFavoritePrompts(updated);
        localStorage.setItem('favorite_prompts', JSON.stringify(updated));
      };

      // Export chat
      const exportChat = () => {
        const chatText = messages.map(m => {
          const role = m.role === 'user' ? 'You' : m.role === 'assistant' ? 'AI' : 'System';
          return `[${role}]\n${m.content}\n`;
        }).join('\n---\n\n');
        
        const blob = new Blob([`AI Product Catalog - Chat Export\nExported: ${new Date().toLocaleString()}\n\n${'='.repeat(50)}\n\n${chatText}`], { type: 'text/plain' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `chat-export-${Date.now()}.txt`;
        a.click();
        addMessage('system', 'âœ… Chat exported successfully!');
      };

      // Compare bundles
      const addToCompare = (item, type) => {
        if (compareItems.length >= 4) {
          alert('Maximum 4 items to compare');
          return;
        }
        if (compareItems.find(i => i.id === item.id || JSON.stringify(i) === JSON.stringify(item))) {
          return;
        }
        setCompareItems([...compareItems, { ...item, _type: type }]);
      };

      const removeFromCompare = (index) => {
        setCompareItems(compareItems.filter((_, i) => i !== index));
      };

      // Bulk selection
      const toggleSelectItem = (type, index) => {
        const current = selectedItems[type];
        if (current.includes(index)) {
          setSelectedItems({ ...selectedItems, [type]: current.filter(i => i !== index) });
        } else {
          setSelectedItems({ ...selectedItems, [type]: [...current, index] });
        }
      };

      const selectAllItems = (type) => {
        const items = type === 'products' ? products : bundles;
        setSelectedItems({ ...selectedItems, [type]: items.map((_, i) => i) });
      };

      const deselectAllItems = (type) => {
        setSelectedItems({ ...selectedItems, [type]: [] });
      };

      const deleteSelectedItems = (type) => {
        if (!confirm(`Delete ${selectedItems[type].length} selected ${type}?`)) return;
        
        if (type === 'products') {
          setProducts(products.filter((_, i) => !selectedItems.products.includes(i)));
        } else {
          setBundles(bundles.filter((_, i) => !selectedItems.bundles.includes(i)));
        }
        setSelectedItems({ ...selectedItems, [type]: [] });
        addMessage('system', `âœ… Deleted ${selectedItems[type].length} ${type}`);
      };

      // Charts
      const renderCharts = () => {
        if (!showCharts) return;
        
        setTimeout(() => {
          // Category distribution chart
          if (chartRef.current && products.length > 0) {
            const ctx = chartRef.current.getContext('2d');
            const categoryField = Object.keys(products[0]).find(k => k.toLowerCase().includes('category')) || Object.keys(products[0])[1];
            const categories = {};
            products.forEach(p => {
              const cat = p[categoryField] || 'Unknown';
              categories[cat] = (categories[cat] || 0) + 1;
            });
            
            if (window.categoryChart) window.categoryChart.destroy();
            window.categoryChart = new Chart(ctx, {
              type: 'doughnut',
              data: {
                labels: Object.keys(categories),
                datasets: [{
                  data: Object.values(categories),
                  backgroundColor: ['#8b5cf6', '#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#ec4899', '#6366f1', '#14b8a6']
                }]
              },
              options: {
                responsive: true,
                plugins: { legend: { position: 'bottom' }, title: { display: true, text: 'Products by Category' } }
              }
            });
          }
          
          // Price distribution chart
          if (priceChartRef.current && bundles.length > 0) {
            const ctx = priceChartRef.current.getContext('2d');
            const priceField = Object.keys(bundles[0]).find(k => k.toLowerCase().includes('price')) || Object.keys(bundles[0])[2];
            const bundleNames = bundles.slice(0, 10).map(b => b[Object.keys(b)[0]] || 'Bundle');
            const prices = bundles.slice(0, 10).map(b => parseFloat(String(b[priceField]).replace(/[^0-9.-]/g, '')) || 0);
            
            if (window.priceChart) window.priceChart.destroy();
            window.priceChart = new Chart(ctx, {
              type: 'bar',
              data: {
                labels: bundleNames.map(n => String(n).substring(0, 15)),
                datasets: [{
                  label: 'Price',
                  data: prices,
                  backgroundColor: '#8b5cf6'
                }]
              },
              options: {
                responsive: true,
                plugins: { legend: { display: false }, title: { display: true, text: 'Bundle Prices (Top 10)' } },
                scales: { y: { beginAtZero: true } }
              }
            });
          }
        }, 100);
      };

      useEffect(() => {
        renderCharts();
      }, [showCharts, products, bundles]);

      const verifyToken = async (token) => {
        try {
          const response = await fetch(`${API_URL}/api/auth/me`, {
            headers: { 'Authorization': `Bearer ${token}` }
          });
          if (!response.ok) handleLogout();
        } catch (error) {
          console.error('Token verification failed:', error);
        }
      };

      const handleLogin = async (e) => {
        e.preventDefault();
        setLoginError('');
        setIsLoggingIn(true);

        try {
          const response = await fetch(`${API_URL}/api/auth/login`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              username: loginForm.username,
              password: loginForm.password,
              rememberMe: loginForm.rememberMe
            })
          });

          const data = await response.json();

          if (!response.ok) {
            setLoginError(data.error || 'Login failed');
            return;
          }

          localStorage.setItem('auth_token', data.token);
          localStorage.setItem('auth_user', JSON.stringify(data.user));
          if (data.refreshToken) localStorage.setItem('refresh_token', data.refreshToken);

          setAuthToken(data.token);
          setUser(data.user);
          setIsAuthenticated(true);
          addMessage('system', `âœ… Welcome back, ${data.user.username}! AI features are ready.`);
        } catch (error) {
          setLoginError('Connection failed. Please check your internet connection.');
        } finally {
          setIsLoggingIn(false);
        }
      };

      const handleLogout = async () => {
        try {
          if (authToken) {
            await fetch(`${API_URL}/api/auth/logout`, {
              method: 'POST',
              headers: { 'Authorization': `Bearer ${authToken}` }
            });
          }
        } catch (error) {}

        localStorage.removeItem('auth_token');
        localStorage.removeItem('auth_user');
        localStorage.removeItem('refresh_token');
        setAuthToken(null);
        setUser(null);
        setIsAuthenticated(false);
        setLoginForm({ username: '', password: '', rememberMe: false });
      };

      const refreshAuthToken = async () => {
        const refreshToken = localStorage.getItem('refresh_token');
        if (!refreshToken) return false;

        try {
          const response = await fetch(`${API_URL}/api/auth/refresh`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ refreshToken })
          });

          if (!response.ok) return false;
          const data = await response.json();
          localStorage.setItem('auth_token', data.token);
          setAuthToken(data.token);
          return true;
        } catch (error) {
          return false;
        }
      };

      useEffect(() => {
        const handleKeyDown = (e) => {
          if ((e.metaKey || e.ctrlKey) && e.key === 'k') {
            e.preventDefault();
            searchInputRef.current?.focus();
          }
        };
        document.addEventListener('keydown', handleKeyDown);
        return () => document.removeEventListener('keydown', handleKeyDown);
      }, []);

      const performSearch = (query) => {
        if (!query.trim()) {
          setSearchResults({ products: [], bundles: [] });
          setShowSearchResults(false);
          return;
        }

        const searchTerm = query.toLowerCase();
        const productMatches = products.filter(product => 
          Object.values(product).some(value => String(value).toLowerCase().includes(searchTerm))
        ).slice(0, 50);
        const bundleMatches = bundles.filter(bundle => 
          Object.values(bundle).some(value => String(value).toLowerCase().includes(searchTerm))
        ).slice(0, 50);

        setSearchResults({ products: productMatches, bundles: bundleMatches });
        setShowSearchResults(true);
      };

      useEffect(() => {
        const timer = setTimeout(() => performSearch(searchQuery), 300);
        return () => clearTimeout(timer);
      }, [searchQuery, products, bundles]);

      const clearSearch = () => {
        setSearchQuery('');
        setSearchResults({ products: [], bundles: [] });
        setShowSearchResults(false);
      };

      const runAISanityCheck = async (data, type) => {
        if (!isAuthenticated) { alert('Please login'); return; }
        if (data.length === 0) { alert(`No ${type} to check!`); return; }

        setIsCheckingSanity(true);
        setShowSanityReport(true);
        setSanityReport(null);

        try {
          const sampleData = data.slice(0, 50);
          const columns = Object.keys(data[0] || {});

          const prompt = `Analyze this ${type} data and return a sanity check report.
DATA (${data.length} rows): ${JSON.stringify(sampleData, null, 2)}
COLUMNS: ${columns.join(', ')}

Return ONLY valid JSON:
{"qualityScore": 85, "completeness": 92, "critical": [{"issue": "...", "count": 5, "fix": "..."}], "warnings": [{"issue": "...", "suggestion": "..."}], "suggestions": [{"title": "...", "description": "..."}], "statistics": {"totalRows": ${data.length}, "completeRows": 92, "issuesFound": 8, "fieldsAnalyzed": ${columns.length}}}`;

          const response = await callClaudeAPI(prompt, true);
          let jsonResponse = response.trim().replace(/```json\n?/g, '').replace(/```\n?/g, '').trim();
          const aiReport = JSON.parse(jsonResponse);
          setSanityReport({ ...aiReport, dataType: type, totalRows: data.length });
          addMessage('system', `âœ… Sanity check complete! Quality score: ${aiReport.qualityScore}/100`);
        } catch (error) {
          addMessage('system', `âŒ Sanity check failed: ${error.message}`);
          setSanityReport({ error: error.message });
        } finally {
          setIsCheckingSanity(false);
        }
      };

      const handleFileUpload = (e, type) => {
        const file = e.target.files[0];
        if (!file) return;

        if (file.name.endsWith('.xlsx') || file.name.endsWith('.xls')) {
          const reader = new FileReader();
          reader.onload = (evt) => {
            try {
              const data = new Uint8Array(evt.target.result);
              const workbook = XLSX.read(data, { type: 'array' });
              const firstSheet = workbook.SheetNames[0];
              const sheetData = XLSX.utils.sheet_to_json(workbook.Sheets[firstSheet], { defval: '' });
              
              if (type === 'products') {
                setProducts(sheetData);
                addMessage('system', `âœ… Loaded ${sheetData.length} products from Excel`);
                if (showOnboarding) completeOnboarding();
              } else {
                setBundles(sheetData);
                addMessage('system', `âœ… Loaded ${sheetData.length} bundles from Excel`);
                if (showOnboarding) completeOnboarding();
              }
            } catch (error) {
              addMessage('system', `âŒ Error reading Excel: ${error.message}`);
            }
          };
          reader.readAsArrayBuffer(file);
          return;
        }

        Papa.parse(file, {
          header: true,
          skipEmptyLines: true,
          complete: (results) => {
            if (type === 'products') {
              setProducts(results.data);
              addMessage('system', `âœ… Loaded ${results.data.length} products`);
              if (showOnboarding) completeOnboarding();
            } else {
              setBundles(results.data);
              addMessage('system', `âœ… Loaded ${results.data.length} bundles`);
              if (showOnboarding) completeOnboarding();
            }
          },
          error: (error) => addMessage('system', `âŒ Error: ${error.message}`)
        });
      };

      const exportToExcel = (data, filename, type) => {
        const wb = XLSX.utils.book_new();
        const ws = XLSX.utils.json_to_sheet(data);
        XLSX.utils.book_append_sheet(wb, ws, type);
        XLSX.writeFile(wb, filename);
        addMessage('system', `âœ… Exported to ${filename}`);
      };

      const addMessage = (role, content) => {
        setMessages(prev => [...prev, { role, content, timestamp: Date.now() }]);
      };

      const callClaudeAPI = async (userPrompt, useExtendedThinking = false) => {
        if (!isAuthenticated || !authToken) throw new Error('Please login');

        try {
          let dataContext = '';
          if (products.length > 0) {
            dataContext += `\n\nPRODUCTS (${products.length} total):\nColumns: ${Object.keys(products[0]).join(', ')}\n`;
            dataContext += products.length <= 100 ? JSON.stringify(products, null, 2) : JSON.stringify(products.slice(0, 20), null, 2);
          }
          if (bundles.length > 0) {
            dataContext += `\n\nBUNDLES (${bundles.length} total):\nColumns: ${Object.keys(bundles[0]).join(', ')}\n`;
            dataContext += bundles.length <= 100 ? JSON.stringify(bundles, null, 2) : JSON.stringify(bundles.slice(0, 20), null, 2);
          }

          const currentDate = new Date();
          const dateStr = currentDate.toLocaleDateString('en-GB', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
          
          // Get exact column names from data
          const productColumns = products.length > 0 ? Object.keys(products[0]) : [];
          const bundleColumns = bundles.length > 0 ? Object.keys(bundles[0]) : [];
          
          const systemPrompt = `You are an AI assistant helping manage a product catalog. You have DIRECT ACCESS to the user's data below.

CURRENT DATE: ${dateStr}
CURRENT YEAR: ${currentDate.getFullYear()}

${dataContext}

USER QUESTION: ${userPrompt}

CRITICAL FORMATTING RULES:
1. ALWAYS use markdown tables when listing multiple items (products or bundles)
2. ALWAYS include IDs/SKUs in the first column so the user can find items
3. ALWAYS summarize with totals at the end (e.g., "Total: 5 bundles found")
4. Keep answers concise - NO waffle or unnecessary explanation
5. When asked about dates (e.g., "ending this year", "expiring soon"), use the CURRENT DATE above
6. "This year" means ${currentDate.getFullYear()}, "next year" means ${currentDate.getFullYear() + 1}

âš ï¸ CRITICAL - USE EXACT COLUMN NAMES FROM THE DATA:
${productColumns.length > 0 ? `PRODUCT COLUMNS (use these EXACT names): ${productColumns.join(' | ')}` : 'No products loaded'}
${bundleColumns.length > 0 ? `BUNDLE COLUMNS (use these EXACT names): ${bundleColumns.join(' | ')}` : 'No bundles loaded'}

When creating tables:
- Use the EXACT column names listed above as headers
- Do NOT rename or create new column names
- Include ALL relevant columns from the original data
- If showing bundles, use the bundle column names
- If showing products, use the product column names

EXAMPLE - If bundle columns are "Bundle_ID | Bundle_Name | End_Date | Price | Network"
Your table MUST use those exact headers:
| Bundle_ID | Bundle_Name | End_Date | Price | Network |
|-----------|-------------|----------|-------|---------|
| 4303 | M50 Fibre Broadband | 04/06/2025 | Â£48 | DOCSIS |

**Total: X bundles found**

NOW ANSWER THE USER'S QUESTION USING THE EXACT COLUMN NAMES FROM THEIR DATA:`;

          const response = await fetch(`${API_URL}/api/claude/completion`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              "Authorization": `Bearer ${authToken}`
            },
            body: JSON.stringify({
              messages: [{ role: "user", content: systemPrompt }],
              max_tokens: useExtendedThinking ? 4000 : 2000
            })
          });

          if (response.status === 401) {
            const refreshed = await refreshAuthToken();
            if (!refreshed) { handleLogout(); throw new Error('Session expired'); }
            return callClaudeAPI(userPrompt, useExtendedThinking);
          }

          if (!response.ok) {
            const errorData = await response.json().catch(() => ({}));
            throw new Error(errorData.error || `API failed: ${response.status}`);
          }

          const data = await response.json();
          return data.data.content[0].text;
        } catch (error) {
          throw error;
        }
      };

      const handleSubmit = async (e) => {
        e.preventDefault();
        if (!input.trim() || isLoading) return;
        if (!isAuthenticated) { addMessage('system', 'âš ï¸ Please login'); return; }

        const userMessage = input;
        setInput("");
        addMessage('user', userMessage);
        setIsLoading(true);
        
        // Track query type for follow-up suggestions
        setLastQueryType(detectQueryType(userMessage));

        try {
          const response = await callClaudeAPI(userMessage, false);
          addMessage('assistant', response);
        } catch (error) {
          addMessage('system', `âŒ Error: ${error.message}`);
        } finally {
          setIsLoading(false);
        }
      };

      const downloadCSV = (data, filename) => {
        const csv = Papa.unparse(data);
        const blob = new Blob([csv], { type: 'text/csv' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        a.click();
      };

      const deleteItem = (type, index) => {
        if (confirm(`Delete this ${type}?`)) {
          if (type === 'product') {
            setProducts(products.filter((_, i) => i !== index));
          } else {
            setBundles(bundles.filter((_, i) => i !== index));
          }
          addMessage('system', `âœ… ${type} deleted`);
        }
      };

      const startEdit = (type, index) => {
        if (type === 'product') {
          setEditingItem({ ...products[index], index });
          setEditingType('product');
        } else {
          setEditingItem({ ...bundles[index], index });
          setEditingType('bundle');
        }
      };

      const saveEdit = () => {
        if (editingType === 'product') {
          const newProducts = [...products];
          const { index, ...itemData } = editingItem;
          newProducts[index] = itemData;
          setProducts(newProducts);
        } else {
          const newBundles = [...bundles];
          const { index, ...itemData } = editingItem;
          newBundles[index] = itemData;
          setBundles(newBundles);
        }
        addMessage('system', `âœ… ${editingType} updated`);
        setEditingItem(null);
        setEditingType(null);
      };

      const cancelEdit = () => { setEditingItem(null); setEditingType(null); };

      const initializeNewItem = (type) => {
        const template = type === 'product' 
          ? (products.length > 0 ? Object.keys(products[0]).reduce((acc, key) => ({ ...acc, [key]: '' }), {}) : { name: '', price: '', category: '', sku: '' })
          : (bundles.length > 0 ? Object.keys(bundles[0]).reduce((acc, key) => ({ ...acc, [key]: '' }), {}) : { name: '', products: '', price: '' });
        setNewItem(template);
        setCreateType(type);
        setShowCreateForm(true);
      };

      const saveNewItem = () => {
        if (createType === 'product') {
          setProducts([...products, newItem]);
        } else {
          setBundles([...bundles, newItem]);
        }
        addMessage('system', `âœ… New ${createType} added!`);
        setNewItem({});
        setShowCreateForm(false);
        setActiveTab(createType === 'product' ? 'products' : 'bundles');
      };

      const askAIToCreate = async (type) => {
        if (!isAuthenticated) { alert('Please login'); return; }
        setIsLoading(true);
        setActiveTab('chat');
        
        try {
          const prompt = type === 'product' 
            ? `Create a new product template based on my existing products. Give me a filled-out example. Format as JSON.`
            : `Create a new bundle template based on my existing bundles. Give me a filled-out example. Format as JSON.`;
          addMessage('user', prompt);
          const response = await callClaudeAPI(prompt);
          addMessage('assistant', response);
        } catch (error) {
          addMessage('system', `âŒ Error: ${error.message}`);
        } finally {
          setIsLoading(false);
        }
      };

      // LOGIN SCREEN
      if (!isAuthenticated) {
        return (
          <div className={`min-h-screen flex items-center justify-center p-4 ${darkMode ? 'dark bg-gray-900' : 'bg-gradient-to-br from-purple-600 via-blue-600 to-indigo-700'}`}>
            <div className="bg-white rounded-2xl shadow-2xl p-8 max-w-md w-full">
              <div className="text-center mb-8">
                <div className="text-6xl mb-4">ğŸ¤–</div>
                <h1 className="text-3xl font-bold bg-gradient-to-r from-purple-600 to-blue-600 bg-clip-text text-transparent">AI Product Catalog</h1>
                <p className="text-gray-500 mt-2">Sign in to access AI features</p>
              </div>

              <form onSubmit={handleLogin} className="space-y-4">
                {loginError && <div className="bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-lg text-sm">{loginError}</div>}
                <div>
                  <label className="block text-sm font-semibold text-gray-700 mb-2">Username</label>
                  <input type="text" value={loginForm.username} onChange={(e) => setLoginForm({...loginForm, username: e.target.value})} className="w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500" placeholder="Enter username" required />
                </div>
                <div>
                  <label className="block text-sm font-semibold text-gray-700 mb-2">Password</label>
                  <input type="password" value={loginForm.password} onChange={(e) => setLoginForm({...loginForm, password: e.target.value})} className="w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500" placeholder="Enter password" required />
                </div>
                <div className="flex items-center">
                  <input type="checkbox" id="rememberMe" checked={loginForm.rememberMe} onChange={(e) => setLoginForm({...loginForm, rememberMe: e.target.checked})} className="h-4 w-4 text-purple-600" />
                  <label htmlFor="rememberMe" className="ml-2 text-sm text-gray-600">Remember me</label>
                </div>
                <button type="submit" disabled={isLoggingIn} className="w-full py-3 bg-gradient-to-r from-purple-600 to-blue-600 text-white rounded-lg font-semibold hover:from-purple-700 hover:to-blue-700 disabled:opacity-50">
                  {isLoggingIn ? 'Signing in...' : 'Sign In'}
                </button>
              </form>

              <div className="mt-6 p-4 bg-blue-50 rounded-lg">
                <p className="text-sm text-blue-800 font-medium mb-2">ğŸ” Default Credentials:</p>
                <p className="text-xs text-blue-700">Admin: admin / admin123</p>
                <p className="text-xs text-blue-700">Demo: demo / demo123</p>
              </div>
            </div>
          </div>
        );
      }

      // MAIN APP
      return (
        <div className={`min-h-screen ${darkMode ? 'dark bg-gray-900' : 'bg-gradient-to-br from-purple-50 via-blue-50 to-indigo-100'}`}>
          <div className="container mx-auto px-4 py-6 max-w-7xl">
            
            {/* Header */}
            <div className="bg-white rounded-xl shadow-xl p-6 mb-6 border-t-4 border-purple-500">
              <div className="flex items-center justify-between mb-4">
                <div>
                  <h1 className="text-4xl font-bold bg-gradient-to-r from-purple-600 to-blue-600 bg-clip-text text-transparent mb-2">ğŸ¤– AI Product Catalog Manager</h1>
                  <p className="text-gray-600">AI-powered catalog management â€¢ Create, analyze, and optimize</p>
                </div>
                <div className="text-right flex items-center gap-4">
                  <button onClick={toggleDarkMode} className="p-2 rounded-lg bg-gray-100 hover:bg-gray-200" title="Toggle dark mode">
                    {darkMode ? 'â˜€ï¸' : 'ğŸŒ™'}
                  </button>
                  <div>
                    <div className="flex items-center gap-3 mb-2">
                      <span className="text-sm text-gray-600">ğŸ‘¤ {user?.username}</span>
                      <span className="px-2 py-1 bg-green-100 text-green-800 rounded-full text-xs font-semibold">{user?.role}</span>
                      <button onClick={handleLogout} className="text-sm text-red-600 hover:text-red-800 underline">Logout</button>
                    </div>
                    <div className="text-sm text-gray-500">{products.length} products â€¢ {bundles.length} bundles</div>
                  </div>
                </div>
              </div>
              
              {/* Search Bar */}
              <div className="relative">
                <div className="flex gap-2">
                  <div className="flex-1 relative">
                    <div className="absolute left-4 top-1/2 transform -translate-y-1/2 text-gray-400">ğŸ”</div>
                    <input ref={searchInputRef} type="text" value={searchQuery} onChange={(e) => setSearchQuery(e.target.value)} placeholder="Search products, bundles... (Cmd+K)" className="w-full pl-12 pr-12 py-3 border-2 border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 text-lg" />
                    {searchQuery && <button onClick={clearSearch} className="absolute right-4 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-gray-600 text-xl">âœ•</button>}
                  </div>
                  <button onClick={() => setShowCharts(!showCharts)} className={`px-4 py-2 rounded-lg font-semibold ${showCharts ? 'bg-purple-600 text-white' : 'bg-gray-100 text-gray-700 hover:bg-gray-200'}`}>ğŸ“Š Charts</button>
                  <button onClick={() => setShowCompare(!showCompare)} className={`px-4 py-2 rounded-lg font-semibold ${showCompare ? 'bg-blue-600 text-white' : 'bg-gray-100 text-gray-700 hover:bg-gray-200'}`}>âš–ï¸ Compare {compareItems.length > 0 && `(${compareItems.length})`}</button>
                </div>
                
                {showSearchResults && (searchResults.products.length > 0 || searchResults.bundles.length > 0) && (
                  <div className="absolute top-full left-0 right-0 mt-2 bg-white border-2 border-purple-200 rounded-lg shadow-2xl z-50 max-h-96 overflow-y-auto">
                    <div className="p-4">
                      <div className="flex justify-between items-center mb-3">
                        <div className="font-bold text-lg">Search Results</div>
                        <button onClick={() => setShowSearchResults(false)} className="text-gray-400 hover:text-gray-600">âœ•</button>
                      </div>
                      {searchResults.products.length > 0 && (
                        <div className="mb-4">
                          <div className="font-semibold text-purple-600 mb-2">Products ({searchResults.products.length})</div>
                          {searchResults.products.slice(0, 5).map((product, idx) => (
                            <div key={idx} className="p-2 hover:bg-purple-50 rounded border border-gray-100 mb-1 flex justify-between items-center">
                              <div className="font-medium">{product[Object.keys(product)[0]]}</div>
                              <button onClick={() => addToCompare(product, 'product')} className="text-xs px-2 py-1 bg-purple-100 text-purple-700 rounded hover:bg-purple-200">+ Compare</button>
                            </div>
                          ))}
                        </div>
                      )}
                      {searchResults.bundles.length > 0 && (
                        <div>
                          <div className="font-semibold text-blue-600 mb-2">Bundles ({searchResults.bundles.length})</div>
                          {searchResults.bundles.slice(0, 5).map((bundle, idx) => (
                            <div key={idx} className="p-2 hover:bg-blue-50 rounded border border-gray-100 mb-1 flex justify-between items-center">
                              <div className="font-medium">{bundle[Object.keys(bundle)[0]]}</div>
                              <button onClick={() => addToCompare(bundle, 'bundle')} className="text-xs px-2 py-1 bg-blue-100 text-blue-700 rounded hover:bg-blue-200">+ Compare</button>
                            </div>
                          ))}
                        </div>
                      )}
                    </div>
                  </div>
                )}
              </div>
            </div>

            {/* Charts Panel */}
            {showCharts && (products.length > 0 || bundles.length > 0) && (
              <div className="bg-white rounded-xl shadow-lg p-6 mb-6">
                <div className="flex justify-between items-center mb-4">
                  <h2 className="text-xl font-bold">ğŸ“Š Data Visualizations</h2>
                  <button onClick={() => setShowCharts(false)} className="text-gray-400 hover:text-gray-600">âœ•</button>
                </div>
                <div className="grid md:grid-cols-2 gap-6">
                  {products.length > 0 && (
                    <div className="bg-gray-50 rounded-lg p-4">
                      <canvas ref={chartRef}></canvas>
                    </div>
                  )}
                  {bundles.length > 0 && (
                    <div className="bg-gray-50 rounded-lg p-4">
                      <canvas ref={priceChartRef}></canvas>
                    </div>
                  )}
                </div>
              </div>
            )}

            {/* Compare Panel */}
            {showCompare && (
              <div className="bg-white rounded-xl shadow-lg p-6 mb-6">
                <div className="flex justify-between items-center mb-4">
                  <h2 className="text-xl font-bold">âš–ï¸ Compare Items ({compareItems.length}/4)</h2>
                  <div className="flex gap-2">
                    {compareItems.length > 0 && <button onClick={() => setCompareItems([])} className="text-sm text-red-600 hover:text-red-800">Clear All</button>}
                    <button onClick={() => setShowCompare(false)} className="text-gray-400 hover:text-gray-600">âœ•</button>
                  </div>
                </div>
                
                {compareItems.length === 0 ? (
                  <div className="text-center py-8 text-gray-500">
                    <p className="text-lg mb-2">No items to compare</p>
                    <p className="text-sm">Search for items and click "+ Compare" to add them here</p>
                  </div>
                ) : (
                  <div className="overflow-x-auto">
                    <table className="w-full text-sm">
                      <thead className="bg-gray-100">
                        <tr>
                          <th className="px-4 py-3 text-left font-semibold">Field</th>
                          {compareItems.map((item, idx) => (
                            <th key={idx} className="px-4 py-3 text-left font-semibold">
                              <div className="flex items-center justify-between">
                                <span className={`px-2 py-1 rounded text-xs ${item._type === 'product' ? 'bg-purple-100 text-purple-700' : 'bg-blue-100 text-blue-700'}`}>
                                  {item._type}
                                </span>
                                <button onClick={() => removeFromCompare(idx)} className="text-red-500 hover:text-red-700 ml-2">âœ•</button>
                              </div>
                            </th>
                          ))}
                        </tr>
                      </thead>
                      <tbody>
                        {Object.keys(compareItems[0] || {}).filter(k => k !== '_type').map((key, keyIdx) => (
                          <tr key={keyIdx} className="border-b border-gray-200">
                            <td className="px-4 py-3 font-medium bg-gray-50">{key}</td>
                            {compareItems.map((item, idx) => (
                              <td key={idx} className="px-4 py-3">{String(item[key] || '-').substring(0, 50)}</td>
                            ))}
                          </tr>
                        ))}
                      </tbody>
                    </table>
                  </div>
                )}
              </div>
            )}

            {/* Status Bar */}
            <div className="bg-green-50 border border-green-200 rounded-lg p-3 mb-6 flex items-center justify-between">
              <span className="text-green-800 text-sm font-medium">âœ… AI Enabled - Secure Connection</span>
              <div className="flex items-center gap-4">
                <button onClick={resetOnboarding} className="text-xs text-purple-600 hover:text-purple-800 font-medium">ğŸ“– Show Tutorial</button>
                <span className="text-xs text-green-600">Today: {new Date().toLocaleDateString('en-GB', { weekday: 'short', day: 'numeric', month: 'short', year: 'numeric' })}</span>
              </div>
            </div>

            {/* Onboarding Wizard - Show when no data and onboarding not complete */}
            {showOnboarding && products.length === 0 && bundles.length === 0 && (
              <OnboardingWizard />
            )}

            {/* File Upload */}
            <div className="bg-white rounded-xl shadow-lg p-6 mb-6">
              <div className="flex items-center justify-between mb-4">
                <h2 className="text-xl font-semibold text-gray-800">ğŸ“ Upload Your Data</h2>
                <span className="text-sm text-green-800 bg-green-50 px-3 py-1 rounded-full">ğŸ“Š Excel & CSV</span>
              </div>
              <div className="grid md:grid-cols-2 gap-4">
                <div className="border-2 border-dashed border-purple-300 rounded-lg p-4 hover:border-purple-500 transition bg-gradient-to-br from-purple-50 to-white">
                  <label className="block text-sm font-medium text-gray-700 mb-2">Products {products.length > 0 && <span className="text-green-600">âœ“ {products.length}</span>}</label>
                  <input type="file" accept=".csv,.xlsx,.xls" onChange={(e) => handleFileUpload(e, 'products')} className="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-purple-50 file:text-purple-700 hover:file:bg-purple-100 cursor-pointer" />
                </div>
                <div className="border-2 border-dashed border-blue-300 rounded-lg p-4 hover:border-blue-500 transition bg-gradient-to-br from-blue-50 to-white">
                  <label className="block text-sm font-medium text-gray-700 mb-2">Bundles {bundles.length > 0 && <span className="text-green-600">âœ“ {bundles.length}</span>}</label>
                  <input type="file" accept=".csv,.xlsx,.xls" onChange={(e) => handleFileUpload(e, 'bundles')} className="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100 cursor-pointer" />
                </div>
              </div>
            </div>

            {/* Tabs */}
            <div className="bg-white rounded-xl shadow-lg mb-6 overflow-hidden">
              <div className="flex border-b border-gray-200">
                {['chat', 'products', 'bundles', 'create'].map((tab) => (
                  <button key={tab} onClick={() => setActiveTab(tab)} className={`flex-1 px-6 py-4 font-semibold transition ${activeTab === tab ? 'bg-gradient-to-r from-purple-500 to-blue-500 text-white' : 'text-gray-600 hover:bg-gray-50'}`}>
                    {tab === 'chat' && 'ğŸ’¬ AI Chat'}
                    {tab === 'products' && `ğŸ“¦ Products (${products.length})`}
                    {tab === 'bundles' && `ğŸ Bundles (${bundles.length})`}
                    {tab === 'create' && 'â• Create'}
                  </button>
                ))}
              </div>

              <div className="p-6">
                {/* Chat Tab */}
                {activeTab === 'chat' && (
                  <div>
                    {/* Chat Header with Export */}
                    <div className="flex justify-between items-center mb-4">
                      <h3 className="font-semibold text-gray-700">AI Assistant</h3>
                      <div className="flex gap-2">
                        {messages.length > 0 && (
                          <button onClick={exportChat} className="text-sm px-3 py-1 bg-gray-100 text-gray-700 rounded hover:bg-gray-200">ğŸ“¥ Export Chat</button>
                        )}
                        <button onClick={() => setShowPromptLibrary(!showPromptLibrary)} className={`text-sm px-3 py-1 rounded font-medium ${showPromptLibrary ? 'bg-purple-600 text-white' : 'bg-purple-100 text-purple-700 hover:bg-purple-200'}`}>
                          ğŸ’¡ {showPromptLibrary ? 'Hide' : 'Show'} Prompts
                        </button>
                      </div>
                    </div>
                    
                    {/* Favorite Prompts */}
                    {favoritePrompts.length > 0 && (
                      <div className="mb-4 p-3 bg-yellow-50 rounded-lg">
                        <p className="text-xs font-semibold text-yellow-700 mb-2">â­ Your Favorites</p>
                        <div className="flex flex-wrap gap-2">
                          {favoritePrompts.map((prompt, idx) => (
                            <div key={idx} className="flex items-center gap-1">
                              <button onClick={() => setInput(prompt)} className="px-3 py-1 bg-white text-yellow-800 rounded-full text-xs hover:bg-yellow-100 border border-yellow-300">{prompt.substring(0, 30)}...</button>
                              <button onClick={() => toggleFavoritePrompt(prompt)} className="text-yellow-600 hover:text-yellow-800 text-xs">âœ•</button>
                            </div>
                          ))}
                        </div>
                      </div>
                    )}
                    
                    {/* PROMPT LIBRARY - Always available, collapsible */}
                    {showPromptLibrary && (
                      <div className="mb-4 bg-gradient-to-r from-purple-50 to-blue-50 rounded-lg border border-purple-200 max-h-96 overflow-y-auto">
                        <div className="p-4 space-y-4">
                          <div className="flex justify-between items-center sticky top-0 bg-gradient-to-r from-purple-50 to-blue-50 pb-2">
                            <p className="font-semibold text-purple-800">ğŸ’¡ Prompt Library - Click any to use</p>
                            <button onClick={() => setShowPromptLibrary(false)} className="text-gray-400 hover:text-gray-600">âœ•</button>
                          </div>
                          
                          {/* Getting Started - No Data */}
                          {products.length === 0 && bundles.length === 0 && (
                            <div className="bg-white rounded-lg p-3 border border-gray-200">
                              <p className="text-xs font-semibold text-gray-500 mb-2">ğŸ“ GETTING STARTED</p>
                              <div className="flex flex-wrap gap-2">
                                {getSmartPrompts().gettingStarted.map((q, i) => (
                                  <button key={i} onClick={() => { setInput(q); setShowPromptLibrary(false); }} className="px-3 py-1.5 bg-gray-50 text-gray-700 rounded-full text-xs hover:bg-gray-100 border border-gray-200">{q}</button>
                                ))}
                              </div>
                            </div>
                          )}
                          
                          {/* Column-Specific Prompts */}
                          {bundles.length > 0 && getColumnSpecificPrompts().length > 0 && (
                            <div className="bg-white rounded-lg p-3 border border-purple-200">
                              <p className="text-xs font-semibold text-purple-600 mb-2">âœ¨ SUGGESTED FOR YOUR DATA</p>
                              <div className="flex flex-wrap gap-2">
                                {getColumnSpecificPrompts().map((q, i) => (
                                  <button key={i} onClick={() => { setInput(q); setShowPromptLibrary(false); }} className="px-3 py-1.5 bg-purple-50 text-purple-700 rounded-full text-xs hover:bg-purple-100 border border-purple-200">{q}</button>
                                ))}
                              </div>
                            </div>
                          )}
                          
                          {/* ROLE-BASED SECTIONS */}
                          {(products.length > 0 || bundles.length > 0) && (
                            <>
                              {/* Daily Stand-up */}
                              <div className="bg-white rounded-lg p-3 border border-amber-200">
                                <p className="text-xs font-semibold text-amber-600 mb-2">â˜€ï¸ DAILY STAND-UP</p>
                                <div className="flex flex-wrap gap-2">
                                  {getSmartPrompts().dailyStandUp.slice(0, 8).map((q, i) => (
                                    <button key={i} onClick={() => { setInput(q); setShowPromptLibrary(false); }} className="px-3 py-1.5 bg-amber-50 text-amber-700 rounded-full text-xs hover:bg-amber-100 border border-amber-200">{q}</button>
                                  ))}
                                </div>
                              </div>
                              
                              {/* Product Owner */}
                              <div className="bg-white rounded-lg p-3 border border-rose-200">
                                <p className="text-xs font-semibold text-rose-600 mb-2">ğŸ‘” PRODUCT OWNER</p>
                                <div className="flex flex-wrap gap-2">
                                  {getSmartPrompts().productOwner.slice(0, 10).map((q, i) => (
                                    <button key={i} onClick={() => { setInput(q); setShowPromptLibrary(false); }} className="px-3 py-1.5 bg-rose-50 text-rose-700 rounded-full text-xs hover:bg-rose-100 border border-rose-200">{q}</button>
                                  ))}
                                </div>
                              </div>
                              
                              {/* Business Analyst */}
                              <div className="bg-white rounded-lg p-3 border border-cyan-200">
                                <p className="text-xs font-semibold text-cyan-600 mb-2">ğŸ“Š BUSINESS ANALYST</p>
                                <div className="flex flex-wrap gap-2">
                                  {getSmartPrompts().businessAnalyst.slice(0, 10).map((q, i) => (
                                    <button key={i} onClick={() => { setInput(q); setShowPromptLibrary(false); }} className="px-3 py-1.5 bg-cyan-50 text-cyan-700 rounded-full text-xs hover:bg-cyan-100 border border-cyan-200">{q}</button>
                                  ))}
                                </div>
                              </div>
                              
                              {/* Developer */}
                              <div className="bg-white rounded-lg p-3 border border-slate-200">
                                <p className="text-xs font-semibold text-slate-600 mb-2">ğŸ’» DEVELOPER</p>
                                <div className="flex flex-wrap gap-2">
                                  {getSmartPrompts().developer.slice(0, 10).map((q, i) => (
                                    <button key={i} onClick={() => { setInput(q); setShowPromptLibrary(false); }} className="px-3 py-1.5 bg-slate-50 text-slate-700 rounded-full text-xs hover:bg-slate-100 border border-slate-200">{q}</button>
                                  ))}
                                </div>
                              </div>
                            </>
                          )}
                          
                          {/* LOOKUP SECTIONS */}
                          {bundles.length > 0 && (
                            <>
                              {/* Bundle Lookup */}
                              <div className="bg-white rounded-lg p-3 border border-purple-200">
                                <p className="text-xs font-semibold text-purple-600 mb-2">ğŸ” BUNDLE LOOKUP</p>
                                <div className="flex flex-wrap gap-2">
                                  {getSmartPrompts().bundleLookup.slice(0, 10).map((q, i) => (
                                    <button key={i} onClick={() => { setInput(q); setShowPromptLibrary(false); }} className="px-3 py-1.5 bg-purple-50 text-purple-700 rounded-full text-xs hover:bg-purple-100 border border-purple-200">{q}</button>
                                  ))}
                                </div>
                              </div>
                              
                              {/* Content Lookup */}
                              <div className="bg-white rounded-lg p-3 border border-pink-200">
                                <p className="text-xs font-semibold text-pink-600 mb-2">ğŸ“º CONTENT LOOKUP</p>
                                <div className="flex flex-wrap gap-2">
                                  {getSmartPrompts().productLookup.map((q, i) => (
                                    <button key={i} onClick={() => { setInput(q); setShowPromptLibrary(false); }} className="px-3 py-1.5 bg-pink-50 text-pink-700 rounded-full text-xs hover:bg-pink-100 border border-pink-200">{q}</button>
                                  ))}
                                </div>
                              </div>
                              
                              {/* Configuration */}
                              <div className="bg-white rounded-lg p-3 border border-teal-200">
                                <p className="text-xs font-semibold text-teal-600 mb-2">âš™ï¸ CONFIGURATION</p>
                                <div className="flex flex-wrap gap-2">
                                  {getSmartPrompts().configurationQueries.slice(0, 10).map((q, i) => (
                                    <button key={i} onClick={() => { setInput(q); setShowPromptLibrary(false); }} className="px-3 py-1.5 bg-teal-50 text-teal-700 rounded-full text-xs hover:bg-teal-100 border border-teal-200">{q}</button>
                                  ))}
                                </div>
                              </div>
                              
                              {/* Pricing */}
                              <div className="bg-white rounded-lg p-3 border border-emerald-200">
                                <p className="text-xs font-semibold text-emerald-600 mb-2">ğŸ’° PRICING</p>
                                <div className="flex flex-wrap gap-2">
                                  {getSmartPrompts().pricingQueries.map((q, i) => (
                                    <button key={i} onClick={() => { setInput(q); setShowPromptLibrary(false); }} className="px-3 py-1.5 bg-emerald-50 text-emerald-700 rounded-full text-xs hover:bg-emerald-100 border border-emerald-200">{q}</button>
                                  ))}
                                </div>
                              </div>
                            </>
                          )}
                          
                          {/* Data Quality */}
                          {(products.length > 0 || bundles.length > 0) && (
                            <div className="bg-white rounded-lg p-3 border border-orange-200">
                              <p className="text-xs font-semibold text-orange-600 mb-2">ğŸ” DATA QUALITY</p>
                              <div className="flex flex-wrap gap-2">
                                {getSmartPrompts().dataQuality.map((q, i) => (
                                  <button key={i} onClick={() => { setInput(q); setShowPromptLibrary(false); }} className="px-3 py-1.5 bg-orange-50 text-orange-700 rounded-full text-xs hover:bg-orange-100 border border-orange-200">{q}</button>
                                ))}
                              </div>
                            </div>
                          )}
                          
                          {/* Reports */}
                          {(products.length > 0 || bundles.length > 0) && (
                            <div className="bg-white rounded-lg p-3 border border-indigo-200">
                              <p className="text-xs font-semibold text-indigo-600 mb-2">ğŸ“ˆ REPORTS</p>
                              <div className="flex flex-wrap gap-2">
                                {getSmartPrompts().reporting.map((q, i) => (
                                  <button key={i} onClick={() => { setInput(q); setShowPromptLibrary(false); }} className="px-3 py-1.5 bg-indigo-50 text-indigo-700 rounded-full text-xs hover:bg-indigo-100 border border-indigo-200">{q}</button>
                                ))}
                              </div>
                            </div>
                          )}
                        </div>
                      </div>
                    )}
                    
                    <div className="h-96 overflow-y-auto mb-4 space-y-4 p-4 bg-gray-50 rounded-lg">
                      {messages.length === 0 ? (
                        <div className="text-center text-gray-500 mt-8">
                          <p className="text-lg mb-2">ğŸ‘‹ Ask me anything about your catalog!</p>
                          <p className="text-sm mb-4 text-gray-400">
                            {products.length === 0 && bundles.length === 0 ? "Upload your products or bundles to get started" : `I have access to ${products.length} products and ${bundles.length} bundles`}
                          </p>
                          <button onClick={() => setShowPromptLibrary(true)} className="px-4 py-2 bg-purple-100 text-purple-700 rounded-full font-medium hover:bg-purple-200">
                            ğŸ’¡ Browse Prompt Library
                          </button>
                        </div>
                      ) : (
                        messages.map((msg, idx) => (
                          <div key={idx} className={`flex ${msg.role === 'user' ? 'justify-end' : 'justify-start'}`}>
                            <div className={`max-w-4xl px-4 py-3 rounded-lg shadow-md ${msg.role === 'user' ? 'bg-gradient-to-r from-purple-600 to-blue-600 text-white' : msg.role === 'system' ? 'bg-yellow-50 text-yellow-800 border border-yellow-200' : 'bg-white text-gray-800 border border-gray-200'}`}>
                              {msg.role === 'assistant' ? renderFormattedMessage(msg.content) : <pre className="whitespace-pre-wrap font-sans text-sm">{msg.content}</pre>}
                              {msg.role === 'user' && (
                                <button onClick={() => toggleFavoritePrompt(msg.content)} className="mt-2 text-xs opacity-70 hover:opacity-100" title={favoritePrompts.includes(msg.content) ? 'Remove from favorites' : 'Add to favorites'}>
                                  {favoritePrompts.includes(msg.content) ? 'â­' : 'â˜†'} Favorite
                                </button>
                              )}
                            </div>
                          </div>
                        ))
                      )}
                      {isLoading && (
                        <div className="flex justify-start">
                          <div className="bg-white px-4 py-3 rounded-lg shadow-md border border-gray-200">
                            <div className="flex items-center space-x-2">
                              <div className="w-2 h-2 bg-purple-500 rounded-full animate-bounce"></div>
                              <div className="w-2 h-2 bg-blue-500 rounded-full animate-bounce" style={{animationDelay: '0.1s'}}></div>
                              <div className="w-2 h-2 bg-indigo-500 rounded-full animate-bounce" style={{animationDelay: '0.2s'}}></div>
                            </div>
                          </div>
                        </div>
                      )}
                      <div ref={messagesEndRef} />
                    </div>

                    <form onSubmit={handleSubmit} className="flex gap-2">
                      <input type="text" value={input} onChange={(e) => setInput(e.target.value)} placeholder="Ask me anything about your data..." className="flex-1 px-4 py-3 border-2 border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500" />
                      <button type="submit" disabled={!input.trim() || isLoading} className="px-8 py-3 bg-gradient-to-r from-purple-600 to-blue-600 text-white rounded-lg hover:from-purple-700 hover:to-blue-700 disabled:bg-gray-300 disabled:cursor-not-allowed font-semibold shadow-md">Send</button>
                    </form>
                    
                    {(products.length > 0 || bundles.length > 0) && messages.length > 0 && (
                      <div className="mt-3 space-y-2">
                        {/* Follow-up suggestions based on last query */}
                        {lastQueryType && getFollowUpPrompts().length > 0 && (
                          <div className="flex flex-wrap gap-2 items-center">
                            <span className="text-xs text-purple-600 font-semibold">ğŸ’¡ Follow-up:</span>
                            {getFollowUpPrompts().map((q, i) => (
                              <button key={i} onClick={() => setInput(q)} className="px-3 py-1 bg-purple-50 text-purple-700 rounded-full text-xs hover:bg-purple-100 border border-purple-200">{q}</button>
                            ))}
                          </div>
                        )}
                        
                        {/* Quick actions */}
                        <div className="flex flex-wrap gap-2 items-center">
                          <span className="text-xs text-gray-400">Quick:</span>
                          {bundles.length > 0 && (
                            <>
                              <button onClick={() => setInput("Which bundles end this year?")} className="px-3 py-1 bg-gray-50 text-gray-600 rounded-full text-xs hover:bg-gray-100 border border-gray-200">Ending 2025</button>
                              <button onClick={() => setInput("Show all bundles in a table")} className="px-3 py-1 bg-gray-50 text-gray-600 rounded-full text-xs hover:bg-gray-100 border border-gray-200">All bundles</button>
                              <button onClick={() => setInput("Show bundles with Netflix")} className="px-3 py-1 bg-gray-50 text-gray-600 rounded-full text-xs hover:bg-gray-100 border border-gray-200">Netflix bundles</button>
                            </>
                          )}
                          {products.length > 0 && (
                            <button onClick={() => setInput("Products not in any bundle")} className="px-3 py-1 bg-gray-50 text-gray-600 rounded-full text-xs hover:bg-gray-100 border border-gray-200">Unused products</button>
                          )}
                          <button onClick={() => setInput("Check for data errors")} className="px-3 py-1 bg-gray-50 text-gray-600 rounded-full text-xs hover:bg-gray-100 border border-gray-200">Check errors</button>
                          <button onClick={() => setInput("Give me a summary")} className="px-3 py-1 bg-gray-50 text-gray-600 rounded-full text-xs hover:bg-gray-100 border border-gray-200">Summary</button>
                        </div>
                      </div>
                    )}
                  </div>
                )}

                {/* Products Tab */}
                {activeTab === 'products' && (
                  <div>
                    <div className="flex justify-between items-center mb-4">
                      <h3 className="text-xl font-semibold">Your Products</h3>
                      <div className="flex gap-2">
                        {selectedItems.products.length > 0 && (
                          <>
                            <button onClick={() => deleteSelectedItems('products')} className="px-4 py-2 bg-red-600 text-white rounded-lg text-sm font-semibold">ğŸ—‘ï¸ Delete ({selectedItems.products.length})</button>
                            <button onClick={() => deselectAllItems('products')} className="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg text-sm font-semibold">Deselect</button>
                          </>
                        )}
                        {products.length > 0 && (
                          <>
                            <button onClick={() => selectAllItems('products')} className="px-4 py-2 bg-gray-100 text-gray-700 rounded-lg text-sm font-semibold">Select All</button>
                            <button onClick={() => runAISanityCheck(products, 'products')} disabled={isCheckingSanity} className="px-4 py-2 bg-gradient-to-r from-indigo-600 to-purple-600 text-white rounded-lg text-sm font-semibold disabled:opacity-50">
                              {isCheckingSanity ? 'ğŸ” Checking...' : 'ğŸ§  AI Check'}
                            </button>
                          </>
                        )}
                        <button onClick={() => initializeNewItem('product')} className="px-4 py-2 bg-purple-600 text-white rounded-lg text-sm font-semibold">â• Add</button>
                        {products.length > 0 && (
                          <>
                            <button onClick={() => downloadCSV(products, 'products.csv')} className="px-4 py-2 bg-blue-600 text-white rounded-lg text-sm font-semibold">ğŸ’¾ CSV</button>
                            <button onClick={() => exportToExcel(products, 'products.xlsx', 'Products')} className="px-4 py-2 bg-green-600 text-white rounded-lg text-sm font-semibold">ğŸ“Š Excel</button>
                          </>
                        )}
                      </div>
                    </div>
                    
                    {products.length === 0 ? (
                      <div className="text-center py-12 text-gray-500">
                        <p className="text-lg">No products loaded yet.</p>
                        <p className="text-sm mt-2">Upload a CSV/Excel file or create one.</p>
                      </div>
                    ) : (
                      <div className="overflow-x-auto">
                        <table className="w-full text-sm">
                          <thead className="bg-purple-100 border-b-2 border-purple-300">
                            <tr>
                              <th className="px-4 py-3 text-left"><input type="checkbox" checked={selectedItems.products.length === products.length} onChange={() => selectedItems.products.length === products.length ? deselectAllItems('products') : selectAllItems('products')} /></th>
                              {Object.keys(products[0]).map((key, i) => (
                                <th key={i} className="px-4 py-3 text-left font-semibold text-gray-700">{key}</th>
                              ))}
                              <th className="px-4 py-3 text-left font-semibold text-gray-700">Actions</th>
                            </tr>
                          </thead>
                          <tbody>
                            {products.map((product, idx) => (
                              <tr key={idx} className={`border-b border-gray-200 hover:bg-purple-50 ${selectedItems.products.includes(idx) ? 'bg-purple-100' : ''}`}>
                                <td className="px-4 py-3"><input type="checkbox" checked={selectedItems.products.includes(idx)} onChange={() => toggleSelectItem('products', idx)} /></td>
                                {Object.values(product).map((val, i) => (
                                  <td key={i} className="px-4 py-3">{String(val).substring(0, 50)}</td>
                                ))}
                                <td className="px-4 py-3">
                                  <button onClick={() => addToCompare(product, 'product')} className="text-purple-600 hover:text-purple-800 text-xs font-semibold mr-2">Compare</button>
                                  <button onClick={() => startEdit('product', idx)} className="text-blue-600 hover:text-blue-800 text-xs font-semibold mr-2">Edit</button>
                                  <button onClick={() => deleteItem('product', idx)} className="text-red-600 hover:text-red-800 text-xs font-semibold">Delete</button>
                                </td>
                              </tr>
                            ))}
                          </tbody>
                        </table>
                      </div>
                    )}
                  </div>
                )}

                {/* Bundles Tab */}
                {activeTab === 'bundles' && (
                  <div>
                    <div className="flex justify-between items-center mb-4">
                      <h3 className="text-xl font-semibold">Your Bundles</h3>
                      <div className="flex gap-2">
                        {selectedItems.bundles.length > 0 && (
                          <>
                            <button onClick={() => deleteSelectedItems('bundles')} className="px-4 py-2 bg-red-600 text-white rounded-lg text-sm font-semibold">ğŸ—‘ï¸ Delete ({selectedItems.bundles.length})</button>
                            <button onClick={() => deselectAllItems('bundles')} className="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg text-sm font-semibold">Deselect</button>
                          </>
                        )}
                        {bundles.length > 0 && (
                          <>
                            <button onClick={() => selectAllItems('bundles')} className="px-4 py-2 bg-gray-100 text-gray-700 rounded-lg text-sm font-semibold">Select All</button>
                            <button onClick={() => runAISanityCheck(bundles, 'bundles')} disabled={isCheckingSanity} className="px-4 py-2 bg-gradient-to-r from-indigo-600 to-purple-600 text-white rounded-lg text-sm font-semibold disabled:opacity-50">
                              {isCheckingSanity ? 'ğŸ” Checking...' : 'ğŸ§  AI Check'}
                            </button>
                          </>
                        )}
                        <button onClick={() => initializeNewItem('bundle')} className="px-4 py-2 bg-blue-600 text-white rounded-lg text-sm font-semibold">â• Add</button>
                        {bundles.length > 0 && (
                          <>
                            <button onClick={() => downloadCSV(bundles, 'bundles.csv')} className="px-4 py-2 bg-blue-600 text-white rounded-lg text-sm font-semibold">ğŸ’¾ CSV</button>
                            <button onClick={() => exportToExcel(bundles, 'bundles.xlsx', 'Bundles')} className="px-4 py-2 bg-green-600 text-white rounded-lg text-sm font-semibold">ğŸ“Š Excel</button>
                          </>
                        )}
                      </div>
                    </div>
                    
                    {bundles.length === 0 ? (
                      <div className="text-center py-12 text-gray-500">
                        <p className="text-lg">No bundles loaded yet.</p>
                        <p className="text-sm mt-2">Upload a CSV/Excel file or create one.</p>
                      </div>
                    ) : (
                      <div className="overflow-x-auto">
                        <table className="w-full text-sm">
                          <thead className="bg-blue-100 border-b-2 border-blue-300">
                            <tr>
                              <th className="px-4 py-3 text-left"><input type="checkbox" checked={selectedItems.bundles.length === bundles.length} onChange={() => selectedItems.bundles.length === bundles.length ? deselectAllItems('bundles') : selectAllItems('bundles')} /></th>
                              {Object.keys(bundles[0]).map((key, i) => (
                                <th key={i} className="px-4 py-3 text-left font-semibold text-gray-700">{key}</th>
                              ))}
                              <th className="px-4 py-3 text-left font-semibold text-gray-700">Actions</th>
                            </tr>
                          </thead>
                          <tbody>
                            {bundles.map((bundle, idx) => (
                              <tr key={idx} className={`border-b border-gray-200 hover:bg-blue-50 ${selectedItems.bundles.includes(idx) ? 'bg-blue-100' : ''}`}>
                                <td className="px-4 py-3"><input type="checkbox" checked={selectedItems.bundles.includes(idx)} onChange={() => toggleSelectItem('bundles', idx)} /></td>
                                {Object.values(bundle).map((val, i) => (
                                  <td key={i} className="px-4 py-3">{String(val).substring(0, 50)}</td>
                                ))}
                                <td className="px-4 py-3">
                                  <button onClick={() => addToCompare(bundle, 'bundle')} className="text-blue-600 hover:text-blue-800 text-xs font-semibold mr-2">Compare</button>
                                  <button onClick={() => startEdit('bundle', idx)} className="text-blue-600 hover:text-blue-800 text-xs font-semibold mr-2">Edit</button>
                                  <button onClick={() => deleteItem('bundle', idx)} className="text-red-600 hover:text-red-800 text-xs font-semibold">Delete</button>
                                </td>
                              </tr>
                            ))}
                          </tbody>
                        </table>
                      </div>
                    )}
                  </div>
                )}

                {/* Create Tab */}
                {activeTab === 'create' && (
                  <div className="max-w-3xl mx-auto">
                    <h3 className="text-2xl font-bold text-center mb-6">AI-Powered Creation Studio</h3>
                    
                    <div className="grid md:grid-cols-2 gap-4 mb-6">
                      <button onClick={() => initializeNewItem('product')} className="p-8 bg-white rounded-xl border-2 border-purple-300 hover:border-purple-500 hover:shadow-xl transition">
                        <div className="text-5xl mb-4">ğŸ“¦</div>
                        <h4 className="font-bold text-xl mb-2">Create Product</h4>
                        <p className="text-sm text-gray-600">Add a new product</p>
                      </button>
                      <button onClick={() => initializeNewItem('bundle')} className="p-8 bg-white rounded-xl border-2 border-blue-300 hover:border-blue-500 hover:shadow-xl transition">
                        <div className="text-5xl mb-4">ğŸ</div>
                        <h4 className="font-bold text-xl mb-2">Create Bundle</h4>
                        <p className="text-sm text-gray-600">Build a new bundle</p>
                      </button>
                    </div>

                    <div className="bg-white rounded-lg p-6 border border-purple-200">
                      <h4 className="font-bold mb-3 text-purple-900">ğŸ¤– Or Ask AI to Create</h4>
                      <div className="space-y-3">
                        <button onClick={() => askAIToCreate('product')} className="w-full px-6 py-4 bg-gradient-to-r from-purple-600 to-purple-700 text-white rounded-lg font-semibold text-left">âœ¨ Generate Product Suggestion</button>
                        <button onClick={() => askAIToCreate('bundle')} className="w-full px-6 py-4 bg-gradient-to-r from-blue-600 to-blue-700 text-white rounded-lg font-semibold text-left">âœ¨ Generate Bundle Suggestion</button>
                      </div>
                    </div>
                  </div>
                )}
              </div>
            </div>

            {/* Edit Modal */}
            {editingItem && (
              <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
                <div className="bg-white rounded-xl p-6 max-w-2xl w-full max-h-[80vh] overflow-y-auto">
                  <h3 className="text-2xl font-bold mb-4">Edit {editingType}</h3>
                  <div className="space-y-3">
                    {Object.entries(editingItem).filter(([key]) => key !== 'index').map(([key, value]) => (
                      <div key={key}>
                        <label className="block text-sm font-semibold text-gray-700 mb-1">{key}</label>
                        <input type="text" value={value} onChange={(e) => setEditingItem({...editingItem, [key]: e.target.value})} className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500" />
                      </div>
                    ))}
                  </div>
                  <div className="flex gap-3 mt-6">
                    <button onClick={saveEdit} className="flex-1 px-4 py-3 bg-green-600 text-white rounded-lg font-semibold">Save</button>
                    <button onClick={cancelEdit} className="flex-1 px-4 py-3 bg-gray-300 text-gray-700 rounded-lg font-semibold">Cancel</button>
                  </div>
                </div>
              </div>
            )}

            {/* Create Modal */}
            {showCreateForm && (
              <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
                <div className="bg-white rounded-xl p-6 max-w-2xl w-full max-h-[80vh] overflow-y-auto">
                  <h3 className="text-2xl font-bold mb-4">Create New {createType}</h3>
                  <div className="space-y-3">
                    {Object.keys(newItem).map((key) => (
                      <div key={key}>
                        <label className="block text-sm font-semibold text-gray-700 mb-1">{key}</label>
                        <input type="text" value={newItem[key]} onChange={(e) => setNewItem({...newItem, [key]: e.target.value})} className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500" placeholder={`Enter ${key}`} />
                      </div>
                    ))}
                  </div>
                  <div className="flex gap-3 mt-6">
                    <button onClick={saveNewItem} className="flex-1 px-4 py-3 bg-green-600 text-white rounded-lg font-semibold">Create</button>
                    <button onClick={() => setShowCreateForm(false)} className="flex-1 px-4 py-3 bg-gray-300 text-gray-700 rounded-lg font-semibold">Cancel</button>
                  </div>
                </div>
              </div>
            )}

            {/* Sanity Report Modal */}
            {showSanityReport && (
              <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
                <div className="bg-white rounded-xl p-6 max-w-3xl w-full max-h-[80vh] overflow-y-auto">
                  <div className="flex justify-between items-center mb-4">
                    <h3 className="text-2xl font-bold">ğŸ§  AI Sanity Check Report</h3>
                    <button onClick={() => setShowSanityReport(false)} className="text-gray-400 hover:text-gray-600 text-2xl">âœ•</button>
                  </div>
                  
                  {isCheckingSanity && (
                    <div className="text-center py-12">
                      <div className="text-4xl animate-spin mb-4">ğŸ”</div>
                      <p className="text-lg">Analyzing your data...</p>
                    </div>
                  )}
                  
                  {sanityReport && !isCheckingSanity && (
                    <div>
                      {sanityReport.error ? (
                        <div className="bg-red-50 border border-red-200 rounded-lg p-4"><p className="text-red-700">Error: {sanityReport.error}</p></div>
                      ) : (
                        <>
                          <div className="grid grid-cols-2 gap-4 mb-6">
                            <div className="bg-purple-50 rounded-lg p-4 text-center">
                              <div className="text-4xl font-bold text-purple-600">{sanityReport.qualityScore}/100</div>
                              <div className="text-sm text-gray-600">Quality Score</div>
                            </div>
                            <div className="bg-green-50 rounded-lg p-4 text-center">
                              <div className="text-4xl font-bold text-green-600">{sanityReport.completeness}%</div>
                              <div className="text-sm text-gray-600">Completeness</div>
                            </div>
                          </div>
                          
                          {sanityReport.critical?.length > 0 && (
                            <div className="mb-4">
                              <h4 className="font-bold text-red-700 mb-2">ğŸ”´ Critical Issues</h4>
                              {sanityReport.critical.map((issue, idx) => (
                                <div key={idx} className="bg-red-50 border border-red-200 rounded p-3 mb-2">
                                  <p className="font-medium">{issue.issue}</p>
                                  <p className="text-sm text-gray-600">{issue.fix}</p>
                                </div>
                              ))}
                            </div>
                          )}
                          
                          {sanityReport.warnings?.length > 0 && (
                            <div className="mb-4">
                              <h4 className="font-bold text-yellow-700 mb-2">ğŸŸ¡ Warnings</h4>
                              {sanityReport.warnings.map((warning, idx) => (
                                <div key={idx} className="bg-yellow-50 border border-yellow-200 rounded p-3 mb-2">
                                  <p className="font-medium">{warning.issue}</p>
                                  <p className="text-sm text-gray-600">{warning.suggestion}</p>
                                </div>
                              ))}
                            </div>
                          )}
                          
                          {sanityReport.suggestions?.length > 0 && (
                            <div>
                              <h4 className="font-bold text-blue-700 mb-2">ğŸ’¡ Suggestions</h4>
                              {sanityReport.suggestions.map((suggestion, idx) => (
                                <div key={idx} className="bg-blue-50 border border-blue-200 rounded p-3 mb-2">
                                  <p className="font-medium">{suggestion.title}</p>
                                  <p className="text-sm text-gray-600">{suggestion.description}</p>
                                </div>
                              ))}
                            </div>
                          )}
                        </>
                      )}
                    </div>
                  )}
                </div>
              </div>
            )}

          </div>
        </div>
      );
    }

    ReactDOM.render(<App />, document.getElementById('root'));
  </script>
</body>
</html>
