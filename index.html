<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AI Product Catalog Assistant</title>
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useRef, useEffect } = React;

    function App() {
      const [products, setProducts] = useState(null);
      const [bundles, setBundles] = useState(null);
      const [messages, setMessages] = useState([]);
      const [input, setInput] = useState("");
      const [isLoading, setIsLoading] = useState(false);
      const [apiKey, setApiKey] = useState("");
      const [showApiKeyInput, setShowApiKeyInput] = useState(true);
      const messagesEndRef = useRef(null);

      const scrollToBottom = () => {
        messagesEndRef.current?.scrollIntoView({ behavior: "smooth" });
      };

      useEffect(() => {
        scrollToBottom();
      }, [messages]);

      // Check if API key is stored
      useEffect(() => {
        const stored = localStorage.getItem('anthropic_api_key');
        if (stored) {
          setApiKey(stored);
          setShowApiKeyInput(false);
        }
      }, []);

      const handleFileUpload = (e, type) => {
        const file = e.target.files[0];
        if (!file) return;

        Papa.parse(file, {
          header: true,
          skipEmptyLines: true,
          complete: (results) => {
            if (type === 'products') {
              setProducts(results.data);
              addMessage('system', `‚úÖ Loaded ${results.data.length} products`);
            } else {
              setBundles(results.data);
              addMessage('system', `‚úÖ Loaded ${results.data.length} bundles`);
            }
          },
          error: (error) => {
            addMessage('system', `‚ùå Error parsing ${type}: ${error.message}`);
          }
        });
      };

      const addMessage = (role, content) => {
        setMessages(prev => [...prev, { role, content }]);
      };

      const saveApiKey = () => {
        if (apiKey.trim()) {
          localStorage.setItem('anthropic_api_key', apiKey.trim());
          setShowApiKeyInput(false);
          addMessage('system', '‚úÖ API Key saved! You can now ask questions.');
        }
      };

      const clearApiKey = () => {
        localStorage.removeItem('anthropic_api_key');
        setApiKey('');
        setShowApiKeyInput(true);
        addMessage('system', 'üîë API Key cleared. Please enter a new one.');
      };

      const handleSubmit = async (e) => {
        e.preventDefault();
        if (!input.trim() || isLoading) return;

        if (!apiKey) {
          addMessage('system', '‚ö†Ô∏è Please enter your Anthropic API key first');
          setShowApiKeyInput(true);
          return;
        }

        if (!products && !bundles) {
          addMessage('system', '‚ö†Ô∏è Please upload at least one CSV file first');
          return;
        }

        const userMessage = input;
        setInput("");
        addMessage('user', userMessage);
        setIsLoading(true);

        try {
          // Build context for Claude
          let context = "You are an AI assistant helping with a product catalog. ";
          
          if (products) {
            context += `\n\nPRODUCTS DATA (${products.length} items):\n`;
            context += `Columns: ${Object.keys(products[0]).join(', ')}\n`;
            context += `Sample (first 5 rows):\n${JSON.stringify(products.slice(0, 5), null, 2)}\n`;
            
            // Only include full data if it's not too large
            if (products.length <= 100) {
              context += `\nFull products data:\n${JSON.stringify(products, null, 2)}\n`;
            } else {
              context += `\nNote: There are ${products.length} total products. Here's a summary:\n`;
              context += `First 50 products:\n${JSON.stringify(products.slice(0, 50), null, 2)}\n`;
            }
          }
          
          if (bundles) {
            context += `\n\nBUNDLES DATA (${bundles.length} items):\n`;
            context += `Columns: ${Object.keys(bundles[0]).join(', ')}\n`;
            context += `Sample (first 5 rows):\n${JSON.stringify(bundles.slice(0, 5), null, 2)}\n`;
            
            if (bundles.length <= 100) {
              context += `\nFull bundles data:\n${JSON.stringify(bundles, null, 2)}\n`;
            }
          }

          context += `\n\nUser question: ${userMessage}\n\n`;
          context += `Please analyze the data and provide a helpful response. `;
          context += `If the user wants to add a product, generate the CSV row format they need. `;
          context += `If they want statistics, calculate them. `;
          context += `If they're searching for something, find it in the data. `;
          context += `Be concise but thorough.`;

          const response = await fetch("https://api.anthropic.com/v1/messages", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              "x-api-key": apiKey,
              "anthropic-version": "2023-06-01"
            },
            body: JSON.stringify({
              model: "claude-sonnet-4-20250514",
              max_tokens: 2000,
              messages: [
                { role: "user", content: context }
              ]
            })
          });

          if (!response.ok) {
            const errorData = await response.json().catch(() => ({}));
            throw new Error(errorData.error?.message || `API request failed: ${response.status}`);
          }

          const data = await response.json();
          const assistantMessage = data.content[0].text;
          addMessage('assistant', assistantMessage);
        } catch (error) {
          console.error("Error:", error);
          if (error.message.includes('401') || error.message.includes('authentication')) {
            addMessage('system', `‚ùå Authentication failed. Please check your API key and try again.`);
            setShowApiKeyInput(true);
          } else {
            addMessage('system', `‚ùå Error: ${error.message}`);
          }
        } finally {
          setIsLoading(false);
        }
      };

      const quickActions = [
        "How many products do we have?",
        "Show me the most expensive items",
        "What categories are available?",
        "Help me add a new product",
        "Find products under $50"
      ];

      return (
        <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100">
          <div className="container mx-auto px-4 py-8 max-w-6xl">
            {/* Header */}
            <div className="bg-white rounded-lg shadow-lg p-6 mb-6">
              <h1 className="text-3xl font-bold text-gray-800 mb-2">
                ü§ñ AI Product Catalog Assistant
              </h1>
              <p className="text-gray-600">
                Upload your product and bundle CSVs, then ask questions or get help managing your catalog
              </p>
            </div>

            {/* API Key Input */}
            {showApiKeyInput && (
              <div className="bg-yellow-50 border-2 border-yellow-200 rounded-lg shadow-lg p-6 mb-6">
                <h2 className="text-xl font-semibold text-gray-800 mb-2">üîë API Key Required</h2>
                <p className="text-sm text-gray-600 mb-4">
                  You need an Anthropic API key to use this tool. Get one at{' '}
                  <a href="https://console.anthropic.com/" target="_blank" className="text-blue-600 hover:underline">
                    console.anthropic.com
                  </a>
                </p>
                <div className="flex gap-2">
                  <input
                    type="password"
                    value={apiKey}
                    onChange={(e) => setApiKey(e.target.value)}
                    placeholder="sk-ant-..."
                    className="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                  />
                  <button
                    onClick={saveApiKey}
                    className="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition"
                  >
                    Save Key
                  </button>
                </div>
                <p className="text-xs text-gray-500 mt-2">
                  Your API key is stored locally in your browser and never sent anywhere except to Anthropic's API.
                </p>
              </div>
            )}

            {!showApiKeyInput && (
              <div className="bg-green-50 border border-green-200 rounded-lg p-4 mb-6 flex items-center justify-between">
                <span className="text-green-800 text-sm">‚úÖ API Key configured</span>
                <button
                  onClick={clearApiKey}
                  className="text-sm text-red-600 hover:text-red-800 underline"
                >
                  Clear & Re-enter
                </button>
              </div>
            )}

            {/* File Upload Section */}
            <div className="bg-white rounded-lg shadow-lg p-6 mb-6">
              <h2 className="text-xl font-semibold text-gray-800 mb-4">üìÅ Upload CSV Files</h2>
              <div className="grid md:grid-cols-2 gap-4">
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-2">
                    Products CSV
                    {products && <span className="text-green-600 ml-2">‚úì {products.length} loaded</span>}
                  </label>
                  <input
                    type="file"
                    accept=".csv"
                    onChange={(e) => handleFileUpload(e, 'products')}
                    className="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100"
                  />
                </div>
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-2">
                    Bundles CSV (Optional)
                    {bundles && <span className="text-green-600 ml-2">‚úì {bundles.length} loaded</span>}
                  </label>
                  <input
                    type="file"
                    accept=".csv"
                    onChange={(e) => handleFileUpload(e, 'bundles')}
                    className="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-green-50 file:text-green-700 hover:file:bg-green-100"
                  />
                </div>
              </div>
            </div>

            {/* Quick Actions */}
            {(products || bundles) && messages.length === 0 && !showApiKeyInput && (
              <div className="bg-white rounded-lg shadow-lg p-6 mb-6">
                <h3 className="text-lg font-semibold text-gray-800 mb-3">üí° Try asking:</h3>
                <div className="flex flex-wrap gap-2">
                  {quickActions.map((action, idx) => (
                    <button
                      key={idx}
                      onClick={() => setInput(action)}
                      className="px-4 py-2 bg-blue-50 text-blue-700 rounded-full text-sm hover:bg-blue-100 transition"
                    >
                      {action}
                    </button>
                  ))}
                </div>
              </div>
            )}

            {/* Chat Interface */}
            <div className="bg-white rounded-lg shadow-lg overflow-hidden">
              {/* Messages */}
              <div className="h-96 overflow-y-auto p-6 space-y-4">
                {messages.length === 0 ? (
                  <div className="text-center text-gray-500 mt-20">
                    <p className="text-lg">üëã {showApiKeyInput ? 'Enter your API key to get started!' : 'Upload your CSV files and start asking questions!'}</p>
                    <p className="text-sm mt-2">I can help you search, analyze, and manage your product catalog</p>
                  </div>
                ) : (
                  messages.map((msg, idx) => (
                    <div
                      key={idx}
                      className={`flex ${msg.role === 'user' ? 'justify-end' : 'justify-start'}`}
                    >
                      <div
                        className={`max-w-3xl px-4 py-3 rounded-lg ${
                          msg.role === 'user'
                            ? 'bg-blue-600 text-white'
                            : msg.role === 'system'
                            ? 'bg-yellow-50 text-yellow-800 border border-yellow-200'
                            : 'bg-gray-100 text-gray-800'
                        }`}
                      >
                        <pre className="whitespace-pre-wrap font-sans">{msg.content}</pre>
                      </div>
                    </div>
                  ))
                )}
                {isLoading && (
                  <div className="flex justify-start">
                    <div className="bg-gray-100 text-gray-800 px-4 py-3 rounded-lg">
                      <div className="flex items-center space-x-2">
                        <div className="animate-bounce">‚óè</div>
                        <div className="animate-bounce delay-100">‚óè</div>
                        <div className="animate-bounce delay-200">‚óè</div>
                      </div>
                    </div>
                  </div>
                )}
                <div ref={messagesEndRef} />
              </div>

              {/* Input */}
              <form onSubmit={handleSubmit} className="border-t border-gray-200 p-4">
                <div className="flex space-x-2">
                  <input
                    type="text"
                    value={input}
                    onChange={(e) => setInput(e.target.value)}
                    placeholder={!apiKey ? "Enter API key first..." : !products && !bundles ? "Upload CSV files first..." : "Ask anything about your catalog..."}
                    disabled={!apiKey || (!products && !bundles)}
                    className="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 disabled:bg-gray-100"
                  />
                  <button
                    type="submit"
                    disabled={!input.trim() || isLoading || !apiKey || (!products && !bundles)}
                    className="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:bg-gray-300 disabled:cursor-not-allowed transition"
                  >
                    Send
                  </button>
                </div>
              </form>
            </div>

            {/* Footer */}
            <div className="mt-6 text-center text-sm text-gray-600">
              <p>üí° Examples: "Show products by category" ‚Ä¢ "Help me add a new bundle" ‚Ä¢ "Find duplicate items" ‚Ä¢ "Export top 10 products"</p>
            </div>
          </div>
        </div>
      );
    }

    ReactDOM.render(<App />, document.getElementById('root'));
  </script>
</body>
</html>
