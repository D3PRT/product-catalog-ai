<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AI Product Catalog Manager</title>
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script src="https://unpkg.com/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    * { font-family: 'Inter', system-ui, -apple-system, sans-serif; }
    
    /* Custom scrollbar */
    ::-webkit-scrollbar { width: 8px; height: 8px; }
    ::-webkit-scrollbar-track { background: #f1f5f9; border-radius: 4px; }
    ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
    ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
    
    /* Glass effect */
    .glass { background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); }
    
    /* Shadows */
    .shadow-soft { box-shadow: 0 2px 8px -2px rgba(0, 0, 0, 0.05), 0 4px 16px -4px rgba(0, 0, 0, 0.1); }
    .shadow-elevated { box-shadow: 0 4px 12px -2px rgba(0, 0, 0, 0.08), 0 8px 24px -4px rgba(0, 0, 0, 0.12); }
    
    /* Pills */
    .pill { padding: 6px 14px; border-radius: 9999px; font-size: 13px; font-weight: 500; }
    
    /* Smooth transitions */
    button, input, .transition-all { transition: all 0.15s ease; }
    
    /* Button hover lift */
    button:hover:not(:disabled) { transform: translateY(-1px); }
    button:active:not(:disabled) { transform: translateY(0); }
    
    /* Input focus */
    input:focus { box-shadow: 0 0 0 3px rgba(139, 92, 246, 0.1); }
    
    /* Animations */
    @keyframes fadeIn { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }
    .animate-fadeIn { animation: fadeIn 0.3s ease forwards; }
    
    /* Dark mode */
    .dark { background: linear-gradient(135deg, #0f172a 0%, #1e1b4b 100%); color: #e2e8f0; }
    .dark .glass { background: rgba(30, 41, 59, 0.9); }
    .dark .bg-white { background-color: #1e293b !important; }
    .dark .bg-gray-50 { background-color: #0f172a !important; }
    .dark .bg-slate-50 { background-color: #1e293b !important; }
    .dark .bg-slate-100 { background-color: #334155 !important; }
    .dark .bg-gray-100 { background-color: #1e293b !important; }
    .dark .text-gray-900 { color: #f1f5f9 !important; }
    .dark .text-gray-800 { color: #e2e8f0 !important; }
    .dark .text-gray-700 { color: #cbd5e1 !important; }
    .dark .text-gray-600 { color: #94a3b8 !important; }
    .dark .text-gray-500 { color: #64748b !important; }
    .dark .border-gray-200 { border-color: #334155 !important; }
    .dark .border-gray-300 { border-color: #475569 !important; }
    .dark .border-slate-200 { border-color: #334155 !important; }
    .dark .border-slate-100 { border-color: #1e293b !important; }
    .dark input, .dark select { background-color: #1e293b !important; color: #e2e8f0 !important; border-color: #475569 !important; }
    .dark .hover\:bg-gray-50:hover { background-color: #334155 !important; }
    .dark .hover\:bg-slate-50:hover { background-color: #334155 !important; }
    .dark .hover\:bg-slate-100:hover { background-color: #475569 !important; }
    .dark .bg-purple-50, .dark .bg-blue-50, .dark .bg-green-50, .dark .bg-yellow-50, .dark .bg-orange-50, .dark .bg-indigo-50, .dark .bg-red-50, .dark .bg-amber-50 { background-color: rgba(139, 92, 246, 0.15) !important; }
    .dark ::-webkit-scrollbar-track { background: #1e293b; }
    .dark ::-webkit-scrollbar-thumb { background: #475569; }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useRef, useEffect } = React;

    const API_URL = 'https://product-catalog-ai-production.up.railway.app';

    function App() {
      // Auth state
      const [isAuthenticated, setIsAuthenticated] = useState(false);
      const [authToken, setAuthToken] = useState(null);
      const [user, setUser] = useState(null);
      const [loginError, setLoginError] = useState('');
      const [isLoggingIn, setIsLoggingIn] = useState(false);
      const [loginForm, setLoginForm] = useState({ username: '', password: '', rememberMe: false });

      // Data state
      const [products, setProducts] = useState([]);
      const [bundles, setBundles] = useState([]);
      const [messages, setMessages] = useState([]);
      const [input, setInput] = useState("");
      const [isLoading, setIsLoading] = useState(false);
      const [activeTab, setActiveTab] = useState('chat');
      const [editingItem, setEditingItem] = useState(null);
      const [editingType, setEditingType] = useState(null);
      const [createType, setCreateType] = useState('product');
      const [newItem, setNewItem] = useState({});
      const [showCreateForm, setShowCreateForm] = useState(false);
      const [searchQuery, setSearchQuery] = useState('');
      const [searchResults, setSearchResults] = useState({ products: [], bundles: [] });
      const [showSearchResults, setShowSearchResults] = useState(false);
      const [showSanityReport, setShowSanityReport] = useState(false);
      const [sanityReport, setSanityReport] = useState(null);
      const [isCheckingSanity, setIsCheckingSanity] = useState(false);
      
      // SMART DATA DICTIONARY - learns your data structure
      const [dataDictionary, setDataDictionary] = useState(null);
      
      // Analyze data and build a comprehensive dictionary
      const analyzeData = (data, type) => {
        if (!data || data.length === 0) return null;
        
        const columns = Object.keys(data[0]);
        const analysis = {
          type,
          rowCount: data.length,
          columns: {},
          uniqueValues: {},
          dateColumns: [],
          priceColumns: [],
          idColumns: [],
          nameColumns: [],
          categoryColumns: [],
          contentColumns: [],
          patterns: {}
        };
        
        columns.forEach(col => {
          const colLower = col.toLowerCase();
          const values = data.map(row => row[col]).filter(v => v !== null && v !== undefined && v !== '');
          const uniqueVals = [...new Set(values.map(v => String(v).trim()))];
          
          // Analyze column type
          let colType = 'text';
          let isDate = false;
          let isPrice = false;
          let isId = false;
          let isName = false;
          let isCategory = false;
          let isContent = false;
          
          // Check for ID columns
          if (colLower.includes('id') || colLower.includes('sku') || colLower.includes('code') || colLower.includes('ref')) {
            isId = true;
            analysis.idColumns.push(col);
          }
          
          // Check for name columns
          if (colLower.includes('name') || colLower.includes('title') || colLower.includes('bundle') || colLower.includes('product') || colLower.includes('description')) {
            isName = true;
            analysis.nameColumns.push(col);
          }
          
          // Check for date columns
          if (colLower.includes('date') || colLower.includes('start') || colLower.includes('end') || colLower.includes('expir') || colLower.includes('launch') || colLower.includes('created')) {
            isDate = true;
            analysis.dateColumns.push(col);
          }
          
          // Check for price columns
          if (colLower.includes('price') || colLower.includes('cost') || colLower.includes('fee') || colLower.includes('charge') || colLower.includes('Â£') || colLower.includes('revenue')) {
            isPrice = true;
            analysis.priceColumns.push(col);
          }
          
          // Check for category columns
          if (colLower.includes('category') || colLower.includes('type') || colLower.includes('segment') || colLower.includes('group') || colLower.includes('tier') || colLower.includes('class')) {
            isCategory = true;
            analysis.categoryColumns.push(col);
          }
          
          // Check for content/product columns (columns that contain product names)
          if (colLower.includes('content') || colLower.includes('includes') || colLower.includes('products') || colLower.includes('services') || colLower.includes('features') || colLower.includes('apps')) {
            isContent = true;
            analysis.contentColumns.push(col);
          }
          
          // Store column info
          analysis.columns[col] = {
            type: isDate ? 'date' : isPrice ? 'price' : isId ? 'id' : isName ? 'name' : isCategory ? 'category' : 'text',
            uniqueCount: uniqueVals.length,
            sampleValues: uniqueVals.slice(0, 10),
            isEmpty: values.length === 0
          };
          
          // For categorical columns with few unique values, store all of them
          if (uniqueVals.length <= 50 && !isId) {
            analysis.uniqueValues[col] = uniqueVals;
          }
        });
        
        // Detect products/services mentioned across ALL text columns
        const allTextContent = data.flatMap(row => 
          Object.entries(row)
            .filter(([col]) => !analysis.idColumns.includes(col) && !analysis.priceColumns.includes(col))
            .map(([, val]) => String(val).toLowerCase())
        ).join(' ');
        
        // Build a frequency map of potential product/service names
        const productPatterns = {};
        data.forEach(row => {
          Object.values(row).forEach(val => {
            const str = String(val);
            // Look for capitalized words or known patterns
            const words = str.match(/[A-Z][a-zA-Z0-9+]+|[A-Z]{2,}[0-9]*|[a-zA-Z]+[0-9]+/g) || [];
            words.forEach(word => {
              if (word.length >= 2 && word.length <= 30) {
                productPatterns[word] = (productPatterns[word] || 0) + 1;
              }
            });
          });
        });
        
        // Filter to patterns that appear multiple times (likely product names)
        analysis.patterns.products = Object.entries(productPatterns)
          .filter(([name, count]) => count >= 2 && name.length >= 2)
          .sort((a, b) => b[1] - a[1])
          .slice(0, 100)
          .map(([name, count]) => ({ name, count }));
        
        console.log(`ðŸ“Š Data Analysis Complete for ${type}:`, analysis);
        return analysis;
      };
      
      // Build comprehensive data context for AI
      const buildSmartContext = () => {
        if (!dataDictionary) return '';
        
        let context = '\\n\\n=== SMART DATA DICTIONARY ===\\n';
        
        if (dataDictionary.products) {
          const p = dataDictionary.products;
          context += `\\nðŸ“¦ PRODUCTS (${p.rowCount} rows):\\n`;
          context += `Columns: ${Object.keys(p.columns).join(' | ')}\\n`;
          if (p.idColumns.length) context += `â€¢ ID columns: ${p.idColumns.join(', ')}\\n`;
          if (p.nameColumns.length) context += `â€¢ Name columns: ${p.nameColumns.join(', ')}\\n`;
          if (p.priceColumns.length) context += `â€¢ Price columns: ${p.priceColumns.join(', ')}\\n`;
          if (p.dateColumns.length) context += `â€¢ Date columns: ${p.dateColumns.join(', ')}\\n`;
          if (p.categoryColumns.length) context += `â€¢ Category columns: ${p.categoryColumns.join(', ')}\\n`;
          
          // Show unique values for categorical columns
          Object.entries(p.uniqueValues).forEach(([col, vals]) => {
            if (vals.length <= 20) {
              context += `â€¢ ${col} values: ${vals.join(', ')}\\n`;
            }
          });
        }
        
        if (dataDictionary.bundles) {
          const b = dataDictionary.bundles;
          context += `\\nðŸ“¦ BUNDLES (${b.rowCount} rows):\\n`;
          context += `Columns: ${Object.keys(b.columns).join(' | ')}\\n`;
          if (b.idColumns.length) context += `â€¢ ID columns: ${b.idColumns.join(', ')}\\n`;
          if (b.nameColumns.length) context += `â€¢ Name columns: ${b.nameColumns.join(', ')}\\n`;
          if (b.priceColumns.length) context += `â€¢ Price columns: ${b.priceColumns.join(', ')}\\n`;
          if (b.dateColumns.length) context += `â€¢ Date columns: ${b.dateColumns.join(', ')}\\n`;
          if (b.categoryColumns.length) context += `â€¢ Category columns: ${b.categoryColumns.join(', ')}\\n`;
          if (b.contentColumns.length) context += `â€¢ Content/Product columns: ${b.contentColumns.join(', ')}\\n`;
          
          // Show unique values for categorical columns
          Object.entries(b.uniqueValues).forEach(([col, vals]) => {
            if (vals.length <= 20) {
              context += `â€¢ ${col} values: ${vals.join(', ')}\\n`;
            }
          });
          
          // Show detected product patterns
          if (b.patterns.products && b.patterns.products.length > 0) {
            context += `\\nðŸ” DETECTED PRODUCTS/SERVICES IN BUNDLES:\\n`;
            context += b.patterns.products.slice(0, 30).map(p => `${p.name} (${p.count}x)`).join(', ');
            context += '\\n';
          }
        }
        
        return context;
      };
      
      // Dynamic prompt suggestions based on context
      const [lastQueryType, setLastQueryType] = useState(null);
      
      const getSmartPrompts = () => {
        const prompts = {
          gettingStarted: [
            "What file formats can I upload?",
            "Show me an example structure",
            "What can you help me with?",
            "How do I get started?"
          ],
          
          // ROLE-SPECIFIC PROMPTS
          productOwner: [
            "What bundles are launching this quarter?",
            "Which bundles need renewal decisions?",
            "Show bundles expiring in next 30 days",
            "What's our most expensive bundle?",
            "What's our cheapest bundle?",
            "Compare our Fibre offerings",
            "Which bundles have the best value?",
            "Show bundle pricing tier breakdown",
            "What bundles compete with each other?",
            "Which products are in most bundles?",
            "Suggest bundle improvements",
            "What gaps exist in our bundle lineup?"
          ],
          
          businessAnalyst: [
            "Give me a full data summary",
            "Show all bundle configurations",
            "Compare all network types (DOCSIS vs FTTP)",
            "Break down bundles by category",
            "What's the price distribution?",
            "Find any data inconsistencies",
            "Which bundles have incomplete data?",
            "Show bundle to product mapping",
            "List all unique product combinations",
            "What patterns exist in pricing?",
            "Identify duplicate or similar bundles",
            "Create a bundle comparison matrix",
            "Show pricing anomalies",
            "What's the average price per category?"
          ],
          
          developer: [
            "Show me the data structure",
            "What fields are available?",
            "List all unique values for each column",
            "Find bundles with missing IDs",
            "Check for data type issues",
            "Show bundles with special characters",
            "Find formatting inconsistencies",
            "What's the schema of this data?",
            "Show sample bundle configuration",
            "List all bundle IDs",
            "Show all product SKUs",
            "Find null or empty values",
            "Check date format consistency",
            "Validate ID patterns"
          ],
          
          dailyStandUp: [
            "What's changed recently?",
            "Show bundles added this week",
            "What bundles expire today?",
            "What expires this week?",
            "Quick summary of all active bundles",
            "Any pricing changes needed?",
            "What needs immediate attention?",
            "Show bundles by end date (soonest first)",
            "Any data quality issues to fix?",
            "What's our current bundle count?",
            "Show today's bundle status"
          ],
          
          // SPECIFIC LOOKUP QUERIES
          bundleLookup: [
            "Find bundle by ID...",
            "Show me bundle [ID] details",
            "What products are in bundle [ID]?",
            "When does bundle [ID] expire?",
            "What's the price of bundle [ID]?",
            "Compare bundle [ID] with similar bundles",
            "Show all M50 bundles",
            "Show all M125 bundles",
            "Show all M250 bundles",
            "Show all M350 bundles",
            "Show all M500 bundles",
            "Show all Gig1 bundles",
            "Find all Flex bundles",
            "Find all Solus bundles"
          ],
          
          productLookup: [
            "Which bundles contain Netflix?",
            "Which bundles contain Disney+?",
            "Which bundles contain Sky Sports?",
            "Which bundles contain BT Sport?",
            "Which bundles have streaming included?",
            "Find bundles with broadband only",
            "Find bundles with TV included",
            "Find bundles with phone included",
            "What add-ons are available?"
          ],
          
          configurationQueries: [
            "How is bundle [ID] configured?",
            "What's included in the Family pack?",
            "Show all BB + Stream configurations",
            "Show all BB Solus configurations",
            "What's the difference between Flex and non-Flex?",
            "Compare Standard vs Premium tiers",
            "Show network configuration for bundle [ID]",
            "What speed tiers do we offer?",
            "Show all DOCSIS bundles",
            "Show all FTTP bundles",
            "Compare DOCSIS vs FTTP offerings"
          ],
          
          pricingQueries: [
            "Show pricing for all M500 bundles",
            "Compare intro vs standard pricing",
            "Which bundles have promotional pricing?",
            "Show Â£0 intro price bundles",
            "Which bundles are under Â£50?",
            "Which bundles are over Â£70?",
            "Price breakdown by speed tier",
            "Show bundles with best intro deals",
            "Compare pricing across categories"
          ],

          bundleAnalysis: [
            "Which bundles end this year?",
            "Which bundles expire in the next 30 days?",
            "Which bundles expire in the next 3 months?",
            "Show all bundles with Netflix",
            "Show all bundles with Disney+",
            "Which bundles have the most products?",
            "List bundles by price (high to low)",
            "List bundles by price (low to high)",
            "Show bundles cheaper than Â£50",
            "Show bundles more expensive than Â£100",
            "Which bundles are DOCSIS?",
            "Which bundles are FTTP?",
            "Show all BB Solus bundles",
            "Show all BB + Stream bundles",
            "Compare Flex vs non-Flex bundles",
            "Which bundles were added this month?",
            "Show bundles by category",
            "Find duplicate bundles"
          ],
          productAnalysis: [
            "Show all products by category",
            "Which products aren't in any bundle?",
            "List products with missing data",
            "What's the average product price?",
            "Show duplicate products",
            "Which products are most expensive?",
            "Which products are cheapest?",
            "Show products added this month",
            "Find products with no price",
            "List all product categories"
          ],
          crossAnalysis: [
            "Which products appear in the most bundles?",
            "Suggest new bundle combinations",
            "Find pricing inconsistencies",
            "Compare bundle vs individual pricing",
            "Which products should I add to bundles?",
            "Find bundles with similar products",
            "Show product overlap between bundles",
            "Which bundles offer best value?"
          ],
          dataQuality: [
            "Check my data for errors",
            "Find rows with missing fields",
            "Show me any duplicates",
            "Validate all dates are correct",
            "Find inconsistent pricing",
            "Check for empty cells",
            "Validate bundle IDs",
            "Find formatting issues"
          ],
          reporting: [
            "Give me a summary of all bundles",
            "Give me a summary of all products",
            "Create a pricing report",
            "Show me bundles expiring each month",
            "Break down bundles by network type",
            "Break down bundles by category",
            "Show monthly bundle count",
            "Revenue analysis by bundle type"
          ]
        };
        return prompts;
      };

      // Get dynamic follow-up prompts based on last query
      const getFollowUpPrompts = () => {
        if (!lastQueryType) return [];
        
        const followUps = {
          'bundles_ending': [
            "Export these to Excel",
            "Which of these have Netflix?",
            "Sort by price",
            "Show full details for each",
            "Which have the best value?",
            "Compare pricing across these",
            "Who owns these bundles?",
            "What's the renewal plan?"
          ],
          'bundles_netflix': [
            "Which also have Disney+?",
            "Sort by price",
            "Which end this year?",
            "Compare Netflix tiers",
            "Which is cheapest with Netflix?",
            "Show all streaming bundles",
            "What other content is included?"
          ],
          'bundles_price': [
            "Filter by network type",
            "Show only BB + Stream",
            "Which include streaming?",
            "Compare top 5",
            "Show intro vs standard pricing",
            "Find promotional offers",
            "Price per speed tier"
          ],
          'products_category': [
            "Which category has most?",
            "Show products not in bundles",
            "Average price by category",
            "Find gaps in categories",
            "List all categories",
            "Category breakdown chart"
          ],
          'data_quality': [
            "Show the specific errors",
            "How do I fix these?",
            "Export issues list",
            "Which are critical?",
            "Re-validate after fixes",
            "Check IDs specifically",
            "Validate dates only"
          ],
          'bundle_lookup': [
            "Show all products in this bundle",
            "When does this expire?",
            "What's the pricing?",
            "Compare with similar bundles",
            "Show configuration details",
            "What network type is this?",
            "Is there a Flex version?"
          ],
          'configuration': [
            "Compare with other configs",
            "What's the network type?",
            "Show all similar bundles",
            "What products are included?",
            "DOCSIS or FTTP?",
            "Show speed options",
            "List all variants"
          ],
          'pricing': [
            "Show intro vs standard",
            "Which has best value?",
            "Compare across speeds",
            "Show promotional pricing",
            "Price per product included",
            "Export pricing table"
          ],
          'daily': [
            "What needs action today?",
            "Show expiring bundles",
            "Any data issues?",
            "Quick summary",
            "What changed this week?",
            "Upcoming renewals"
          ],
          'general': [
            "Tell me more",
            "Export this table",
            "Show in different format",
            "Compare with others",
            "Summarize findings",
            "What else should I know?"
          ]
        };
        
        return followUps[lastQueryType] || followUps['general'];
      };

      // Detect query type for follow-up suggestions
      const detectQueryType = (query) => {
        const q = query.toLowerCase();
        if (q.includes('end') && (q.includes('year') || q.includes('month') || q.includes('expire'))) return 'bundles_ending';
        if (q.includes('netflix') || q.includes('disney') || q.includes('streaming')) return 'bundles_netflix';
        if (q.includes('price') || q.includes('cheap') || q.includes('expensive') || q.includes('cost')) return 'pricing';
        if (q.includes('category') || q.includes('categories')) return 'products_category';
        if (q.includes('error') || q.includes('quality') || q.includes('missing') || q.includes('duplicate') || q.includes('validate')) return 'data_quality';
        if (q.includes('config') || q.includes('docsis') || q.includes('fttp') || q.includes('network')) return 'configuration';
        if (q.includes('show me bundle') || q.includes('find bundle') || q.includes('bundle id') || q.match(/\b(m50|m125|m250|m350|m500|gig)/)) return 'bundle_lookup';
        if (q.includes('today') || q.includes('this week') || q.includes('stand') || q.includes('quick') || q.includes('summary')) return 'daily';
        return 'general';
      };

      // Get column-specific prompts based on actual data
      const getColumnSpecificPrompts = () => {
        const prompts = [];
        
        if (bundles.length > 0) {
          const cols = Object.keys(bundles[0]);
          
          // Date columns
          cols.forEach(col => {
            if (col.toLowerCase().includes('date') || col.toLowerCase().includes('end') || col.toLowerCase().includes('expir')) {
              prompts.push(`Show bundles by ${col}`);
              prompts.push(`Which bundles have ${col} this year?`);
              prompts.push(`Sort bundles by ${col}`);
            }
          });
          
          // Price columns
          cols.forEach(col => {
            if (col.toLowerCase().includes('price') || col.toLowerCase().includes('cost')) {
              prompts.push(`Show bundles sorted by ${col}`);
              prompts.push(`Average ${col} across all bundles`);
              prompts.push(`Find bundles with ${col} under Â£50`);
            }
          });
          
          // Category/Type columns
          cols.forEach(col => {
            if (col.toLowerCase().includes('type') || col.toLowerCase().includes('category') || col.toLowerCase().includes('network')) {
              prompts.push(`Break down bundles by ${col}`);
              prompts.push(`Show unique values in ${col}`);
              prompts.push(`Count bundles per ${col}`);
            }
          });
          
          // Name columns - look for specific products
          const sampleValues = bundles.slice(0, 20).map(b => Object.values(b).join(' ')).join(' ').toLowerCase();
          if (sampleValues.includes('netflix')) prompts.push('Show all bundles with Netflix');
          if (sampleValues.includes('disney')) prompts.push('Show all bundles with Disney+');
          if (sampleValues.includes('spotify')) prompts.push('Show all bundles with Spotify');
          if (sampleValues.includes('flex')) prompts.push('Compare Flex vs non-Flex bundles');
          if (sampleValues.includes('fibre')) prompts.push('Show all Fibre bundles');
          if (sampleValues.includes('gig')) prompts.push('Show all Gig speed bundles');
        }
        
        return [...new Set(prompts)].slice(0, 10); // Unique prompts, max 10
      };

      // NEW FEATURES
      const [darkMode, setDarkMode] = useState(false);
      const [favoritePrompts, setFavoritePrompts] = useState([]);
      const [showCompare, setShowCompare] = useState(false);
      const [compareItems, setCompareItems] = useState([]);
      const [selectedItems, setSelectedItems] = useState({ products: [], bundles: [] });
      const [showCharts, setShowCharts] = useState(false);
      const [showOnboarding, setShowOnboarding] = useState(true);
      const [onboardingStep, setOnboardingStep] = useState(1);
      const [showPromptLibrary, setShowPromptLibrary] = useState(false);
      const [showImpactAnalysis, setShowImpactAnalysis] = useState(false);
      
      // Bundle Price Calculator state
      const [showPriceCalculator, setShowPriceCalculator] = useState(false);
      const [selectedBundle, setSelectedBundle] = useState(null);
      const [calculatorAddons, setCalculatorAddons] = useState([]);
      
      // Add-on Impact Viewer state
      const [showAddonViewer, setShowAddonViewer] = useState(false);
      const [selectedProductCode, setSelectedProductCode] = useState('');
      const [impactSearchTerm, setImpactSearchTerm] = useState('');
      const [impactResults, setImpactResults] = useState(null);
      const [isAnalyzing, setIsAnalyzing] = useState(false);
      
      const messagesEndRef = useRef(null);
      const searchInputRef = useRef(null);
      const chartRef = useRef(null);
      const priceChartRef = useRef(null);

      // Parse and render markdown tables
      const parseMarkdownTable = (tableText) => {
        const lines = tableText.trim().split('\n').filter(line => line.trim());
        if (lines.length < 2) return null;
        
        const parseRow = (row) => {
          return row.split('|').map(cell => cell.trim()).filter(cell => cell && !cell.match(/^[-:]+$/));
        };
        
        const headers = parseRow(lines[0]);
        if (headers.length === 0) return null;
        
        // Skip separator line
        const dataStartIndex = lines[1].includes('---') ? 2 : 1;
        const rows = lines.slice(dataStartIndex).map(parseRow).filter(row => row.length > 0);
        
        return { headers, rows };
      };

      const exportTableToCSV = (tableData, filename = 'table-export.csv') => {
        if (!tableData) return;
        const csvContent = [
          tableData.headers.join(','),
          ...tableData.rows.map(row => row.map(cell => `"${cell}"`).join(','))
        ].join('\n');
        
        const blob = new Blob([csvContent], { type: 'text/csv' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        a.click();
        addMessage('system', `âœ… Table exported to ${filename}`);
      };

      const exportTableToExcel = (tableData, filename = 'table-export.xlsx') => {
        if (!tableData) return;
        const wsData = [tableData.headers, ...tableData.rows];
        const ws = XLSX.utils.aoa_to_sheet(wsData);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, 'Data');
        XLSX.writeFile(wb, filename);
        addMessage('system', `âœ… Table exported to ${filename}`);
      };

      const renderFormattedMessage = (content) => {
        // Split content into parts (tables and text)
        const parts = [];
        let currentText = '';
        const lines = content.split('\n');
        let tableLines = [];
        let inTable = false;

        lines.forEach((line, idx) => {
          const isTableLine = line.trim().startsWith('|') && line.trim().endsWith('|');
          
          if (isTableLine) {
            if (!inTable && currentText.trim()) {
              parts.push({ type: 'text', content: currentText });
              currentText = '';
            }
            inTable = true;
            tableLines.push(line);
          } else {
            if (inTable && tableLines.length > 0) {
              parts.push({ type: 'table', content: tableLines.join('\n') });
              tableLines = [];
              inTable = false;
            }
            currentText += line + '\n';
          }
        });

        // Handle remaining content
        if (tableLines.length > 0) {
          parts.push({ type: 'table', content: tableLines.join('\n') });
        }
        if (currentText.trim()) {
          parts.push({ type: 'text', content: currentText });
        }

        return (
          <div className="space-y-4">
            {parts.map((part, idx) => {
              if (part.type === 'table') {
                const tableData = parseMarkdownTable(part.content);
                if (!tableData) return <pre key={idx} className="whitespace-pre-wrap font-sans text-sm">{part.content}</pre>;
                
                return (
                  <div key={idx} className="border border-gray-200 rounded-lg overflow-hidden">
                    <div className="bg-gray-50 px-3 py-2 flex justify-between items-center border-b border-gray-200">
                      <span className="text-xs font-semibold text-gray-500">{tableData.rows.length} rows</span>
                      <div className="flex gap-2">
                        <button 
                          onClick={() => exportTableToCSV(tableData)} 
                          className="text-xs px-2 py-1 bg-blue-100 text-blue-700 rounded hover:bg-blue-200 font-medium"
                        >
                          ðŸ“¥ CSV
                        </button>
                        <button 
                          onClick={() => exportTableToExcel(tableData)} 
                          className="text-xs px-2 py-1 bg-green-100 text-green-700 rounded hover:bg-green-200 font-medium"
                        >
                          ðŸ“Š Excel
                        </button>
                      </div>
                    </div>
                    <div className="overflow-x-auto">
                      <table className="w-full text-sm">
                        <thead className="bg-purple-50">
                          <tr>
                            {tableData.headers.map((header, hIdx) => (
                              <th key={hIdx} className="px-3 py-2 text-left font-semibold text-purple-900 border-b border-purple-200 whitespace-nowrap">
                                {header}
                              </th>
                            ))}
                          </tr>
                        </thead>
                        <tbody>
                          {tableData.rows.map((row, rIdx) => (
                            <tr key={rIdx} className={`${rIdx % 2 === 0 ? 'bg-white' : 'bg-gray-50'} hover:bg-purple-50`}>
                              {row.map((cell, cIdx) => (
                                <td key={cIdx} className="px-3 py-2 border-b border-gray-100 whitespace-nowrap">
                                  {cell}
                                </td>
                              ))}
                            </tr>
                          ))}
                        </tbody>
                      </table>
                    </div>
                  </div>
                );
              } else {
                // Render text with basic markdown formatting
                const formattedText = part.content
                  .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
                  .replace(/\*(.+?)\*/g, '<em>$1</em>')
                  .replace(/`(.+?)`/g, '<code class="bg-gray-100 px-1 rounded text-purple-700">$1</code>');
                
                return (
                  <div 
                    key={idx} 
                    className="text-sm whitespace-pre-wrap" 
                    dangerouslySetInnerHTML={{ __html: formattedText }}
                  />
                );
              }
            })}
          </div>
        );
      };

      const scrollToBottom = () => {
        messagesEndRef.current?.scrollIntoView({ behavior: "smooth" });
      };

      useEffect(() => {
        scrollToBottom();
      }, [messages]);

      // Load saved preferences
      useEffect(() => {
        const storedToken = localStorage.getItem('auth_token');
        const storedUser = localStorage.getItem('auth_user');
        const storedDarkMode = localStorage.getItem('dark_mode');
        const storedFavorites = localStorage.getItem('favorite_prompts');
        
        if (storedToken && storedUser) {
          setAuthToken(storedToken);
          setUser(JSON.parse(storedUser));
          setIsAuthenticated(true);
          verifyToken(storedToken);
        }
        
        if (storedDarkMode === 'true') setDarkMode(true);
        if (storedFavorites) setFavoritePrompts(JSON.parse(storedFavorites));
        
        // Check if onboarding completed
        const onboardingComplete = localStorage.getItem('onboarding_complete');
        if (onboardingComplete === 'true') setShowOnboarding(false);
      }, []);

      // Toggle dark mode
      const toggleDarkMode = () => {
        const newMode = !darkMode;
        setDarkMode(newMode);
        localStorage.setItem('dark_mode', newMode.toString());
      };

      // Complete onboarding
      const completeOnboarding = () => {
        setShowOnboarding(false);
        localStorage.setItem('onboarding_complete', 'true');
      };

      const resetOnboarding = () => {
        setShowOnboarding(true);
        setOnboardingStep(1);
        localStorage.removeItem('onboarding_complete');
      };

      // Impact Analysis Function
      const runImpactAnalysis = (searchTerm) => {
        if (!searchTerm.trim() || bundles.length === 0) return;
        
        setIsAnalyzing(true);
        const term = searchTerm.toLowerCase();
        
        // Find all bundles containing this term
        const affectedBundles = bundles.filter(bundle => 
          Object.values(bundle).some(value => 
            String(value).toLowerCase().includes(term)
          )
        );
        
        console.log(`Impact Analysis: Searched "${term}" in ${bundles.length} bundles, found ${affectedBundles.length} matches`);
        
        // Get bundle columns for analysis
        const bundleCols = Object.keys(bundles[0] || {});
        const priceCol = bundleCols.find(c => c.toLowerCase().includes('price')) || null;
        const nameCol = bundleCols.find(c => c.toLowerCase().includes('name') || c.toLowerCase().includes('bundle')) || bundleCols[0];
        const idCol = bundleCols.find(c => c.toLowerCase().includes('id') || c.toLowerCase().includes('sku')) || bundleCols[0];
        const endDateCol = bundleCols.find(c => c.toLowerCase().includes('end') || c.toLowerCase().includes('expir') || c.toLowerCase().includes('date')) || null;
        const categoryCol = bundleCols.find(c => c.toLowerCase().includes('category') || c.toLowerCase().includes('type')) || null;
        
        // Calculate statistics
        const totalBundles = bundles.length;
        const affectedCount = affectedBundles.length;
        const affectedPercentage = ((affectedCount / totalBundles) * 100).toFixed(1);
        
        // Price impact
        let totalRevenueAtRisk = 0;
        if (priceCol) {
          affectedBundles.forEach(bundle => {
            const priceStr = String(bundle[priceCol] || '0');
            const price = parseFloat(priceStr.replace(/[^0-9.-]/g, '')) || 0;
            totalRevenueAtRisk += price;
          });
        }
        
        // Category breakdown
        const categoryBreakdown = {};
        if (categoryCol) {
          affectedBundles.forEach(bundle => {
            const cat = bundle[categoryCol] || 'Unknown';
            categoryBreakdown[cat] = (categoryBreakdown[cat] || 0) + 1;
          });
        }
        
        // Find bundles expiring soon
        const now = new Date();
        const expiringIn30Days = [];
        const expiringIn90Days = [];
        if (endDateCol) {
          affectedBundles.forEach(bundle => {
            const dateStr = bundle[endDateCol];
            if (dateStr) {
              const parts = String(dateStr).split(/[\/\-]/);
              let endDate;
              if (parts.length === 3) {
                // Try DD/MM/YYYY or YYYY-MM-DD
                if (parts[0].length === 4) {
                  endDate = new Date(parts[0], parts[1] - 1, parts[2]);
                } else {
                  endDate = new Date(parts[2], parts[1] - 1, parts[0]);
                }
              }
              if (endDate && !isNaN(endDate)) {
                const daysUntil = Math.ceil((endDate - now) / (1000 * 60 * 60 * 24));
                if (daysUntil <= 30 && daysUntil > 0) {
                  expiringIn30Days.push({ ...bundle, daysUntil });
                } else if (daysUntil <= 90 && daysUntil > 0) {
                  expiringIn90Days.push({ ...bundle, daysUntil });
                }
              }
            }
          });
        }
        
        // Find similar bundles WITHOUT this term (alternatives)
        const alternatives = bundles.filter(bundle => 
          !Object.values(bundle).some(value => 
            String(value).toLowerCase().includes(term)
          )
        ).slice(0, 10);
        
        // Find other common products/terms in affected bundles
        const commonTerms = {};
        affectedBundles.forEach(bundle => {
          Object.values(bundle).forEach(value => {
            const str = String(value).toLowerCase();
            ['netflix', 'disney', 'spotify', 'sky', 'bt sport', 'prime', 'apple', 'hbo', 'paramount', 'fibre', 'broadband', 'tv', 'phone', 'flex', 'stream'].forEach(product => {
              if (str.includes(product) && product !== term) {
                commonTerms[product] = (commonTerms[product] || 0) + 1;
              }
            });
          });
        });
        
        setImpactResults({
          searchTerm,
          affectedBundles,
          affectedCount,
          totalBundles,
          affectedPercentage,
          totalRevenueAtRisk,
          categoryBreakdown,
          expiringIn30Days,
          expiringIn90Days,
          alternatives,
          commonTerms: Object.entries(commonTerms).sort((a, b) => b[1] - a[1]).slice(0, 5),
          columns: { nameCol, idCol, priceCol, endDateCol, categoryCol }
        });
        
        setIsAnalyzing(false);
      };

      // Quick impact suggestions based on data
      // ========== BUNDLE PRICE CALCULATOR ==========
      const getBundlePriceBreakdown = (bundle) => {
        if (!bundle) return null;
        
        const parsePrice = (val) => {
          if (!val && val !== 0) return null;
          const num = parseFloat(String(val).replace(/[^0-9.-]/g, ''));
          return isNaN(num) ? null : num;
        };
        
        const breakdown = {
          bundleId: bundle.ID,
          bundleName: bundle.Name,
          description: bundle.Description,
          contractMonths: bundle.Contract_months || 24,
          
          // Pricing tiers
          discountedPrice1: parsePrice(bundle.Discounted_Monthly_Price_1),
          discountedLength1: parsePrice(bundle.Discounted_Length_1),
          discountedPrice2: parsePrice(bundle.Discounted_Monthly_Price_2),
          discountedLength2: parsePrice(bundle.Discounted_Length_2),
          ongoingPrice: parsePrice(bundle.On_going_Monthly_Price),
          setupCost: parsePrice(bundle.Setup_Cost),
          setupCostNow: parsePrice(bundle.Setup_Cost_Now),
          
          // Network & speed
          networkType: bundle.BB_Network_Type,
          speed: bundle.BB_Speed_Mbs,
          
          // Included products
          includedProducts: [],
          includedAddons: [],
          additionalCodes: [],
          excludedAddons: [],
          
          // Tier info
          tier: bundle.Tier,
          isStream: bundle.Is_Stream === 'TRUE' || bundle.Is_Stream === true,
          isStudent: bundle.Is_Student === 'TRUE' || bundle.Is_Student === true,
        };
        
        // Parse product codes
        const extractCodes = (str) => {
          if (!str) return [];
          return String(str).match(/[PDA]\d+/g) || [];
        };
        
        breakdown.includedProducts = extractCodes(bundle.Bundles_RGU);
        breakdown.includedAddons = extractCodes(bundle.Included_Addon);
        breakdown.additionalCodes = extractCodes(bundle.Additional_bundle_codes);
        breakdown.excludedAddons = extractCodes(bundle.Excluded_Addon);
        
        // Calculate 24-month total cost
        let total24Month = 0;
        if (breakdown.discountedPrice1 !== null && breakdown.discountedLength1) {
          total24Month += breakdown.discountedPrice1 * breakdown.discountedLength1;
        }
        if (breakdown.discountedPrice2 !== null && breakdown.discountedLength2) {
          total24Month += breakdown.discountedPrice2 * breakdown.discountedLength2;
        }
        const remainingMonths = 24 - (breakdown.discountedLength1 || 0) - (breakdown.discountedLength2 || 0);
        if (remainingMonths > 0 && breakdown.ongoingPrice !== null) {
          total24Month += breakdown.ongoingPrice * remainingMonths;
        }
        if (breakdown.setupCostNow) {
          total24Month += breakdown.setupCostNow;
        }
        breakdown.total24Month = total24Month;
        breakdown.avgMonthly24 = total24Month / 24;
        
        // Lookup product details
        breakdown.productDetails = breakdown.includedProducts.map(code => {
          const product = products.find(p => p.Code === code);
          return product ? { code, name: product.Name, type: product.Type, category: product.Category } : { code, name: 'Unknown', type: '-', category: '-' };
        });
        
        breakdown.addonDetails = breakdown.includedAddons.map(code => {
          const product = products.find(p => p.Code === code);
          return product ? { code, name: product.Name, type: product.Type, category: product.Category } : { code, name: 'Unknown', type: '-', category: '-' };
        });
        
        return breakdown;
      };
      
      // Get available add-ons that can be added to a bundle
      const getAvailableAddons = () => {
        return products.filter(p => p.Type === 'AddOn').map(p => ({
          code: p.Code,
          name: p.Name,
          category: p.Category,
          price: parseFloat(String(p.Discounted_Monthly_Price || 0).replace(/[^0-9.-]/g, '')) || 0
        }));
      };
      
      // Calculate price delta when adding/removing an addon
      const calculateAddonDelta = (addonCode, isAdding) => {
        const addon = products.find(p => p.Code === addonCode);
        if (!addon) return 0;
        const price = parseFloat(String(addon.Discounted_Monthly_Price || 0).replace(/[^0-9.-]/g, '')) || 0;
        return isAdding ? price : -price;
      };
      
      // ========== ADD-ON IMPACT VIEWER ==========
      const getProductImpact = (productCode) => {
        if (!productCode || bundles.length === 0) return null;
        
        const code = productCode.toUpperCase().trim();
        
        // Find the product
        const product = products.find(p => p.Code === code);
        
        // Find all bundles that reference this product
        const affectedBundles = bundles.filter(bundle => {
          const allCodes = [
            bundle.Bundles_RGU,
            bundle.Additional_bundle_codes,
            bundle.Included_Addon,
            bundle.Excluded_Addon
          ].filter(Boolean).join(' ');
          return allCodes.includes(code);
        });
        
        // Categorize how it's used in each bundle
        const usage = {
          asCore: [],      // In Bundles_RGU
          asAddon: [],     // In Included_Addon
          asAdditional: [], // In Additional_bundle_codes
          asExcluded: []   // In Excluded_Addon
        };
        
        affectedBundles.forEach(bundle => {
          if (String(bundle.Bundles_RGU || '').includes(code)) {
            usage.asCore.push(bundle);
          }
          if (String(bundle.Included_Addon || '').includes(code)) {
            usage.asAddon.push(bundle);
          }
          if (String(bundle.Additional_bundle_codes || '').includes(code)) {
            usage.asAdditional.push(bundle);
          }
          if (String(bundle.Excluded_Addon || '').includes(code)) {
            usage.asExcluded.push(bundle);
          }
        });
        
        // Find related products (products often bundled with this one)
        const relatedProducts = {};
        affectedBundles.forEach(bundle => {
          const allCodes = String(bundle.Bundles_RGU || '').match(/[PDA]\d+/g) || [];
          allCodes.forEach(c => {
            if (c !== code) {
              relatedProducts[c] = (relatedProducts[c] || 0) + 1;
            }
          });
        });
        
        // Get required products for this product
        const requiredProducts = product?.Required_Product ? 
          String(product.Required_Product).match(/[PDA]\d+/g) || [] : [];
        
        // Calculate revenue impact
        let totalRevenue = 0;
        affectedBundles.forEach(bundle => {
          const price = parseFloat(String(bundle.On_going_Monthly_Price || 0).replace(/[^0-9.-]/g, '')) || 0;
          totalRevenue += price;
        });
        
        return {
          productCode: code,
          productName: product?.Name || 'Unknown Product',
          productType: product?.Type || 'Unknown',
          productCategory: product?.Category || 'Unknown',
          totalBundlesAffected: affectedBundles.length,
          percentOfCatalog: ((affectedBundles.length / bundles.length) * 100).toFixed(1),
          usage,
          relatedProducts: Object.entries(relatedProducts)
            .sort((a, b) => b[1] - a[1])
            .slice(0, 10)
            .map(([c, count]) => {
              const p = products.find(pr => pr.Code === c);
              return { code: c, name: p?.Name || 'Unknown', count };
            }),
          requiredProducts: requiredProducts.map(c => {
            const p = products.find(pr => pr.Code === c);
            return { code: c, name: p?.Name || 'Unknown' };
          }),
          totalMonthlyRevenue: totalRevenue,
          affectedBundles
        };
      };
      
      // Get all unique product codes for autocomplete
      const getAllProductCodes = () => {
        const codes = new Set();
        products.forEach(p => codes.add(p.Code));
        bundles.forEach(b => {
          [b.Bundles_RGU, b.Additional_bundle_codes, b.Included_Addon, b.Excluded_Addon]
            .filter(Boolean)
            .forEach(str => {
              const matches = String(str).match(/[PDA]\d+/g) || [];
              matches.forEach(c => codes.add(c));
            });
        });
        return Array.from(codes).sort();
      };

      const getImpactSuggestions = () => {
        if (bundles.length === 0) return [];
        
        // Use learned patterns from data dictionary if available
        if (dataDictionary?.bundles?.patterns?.products) {
          // Return the top detected products from the actual data
          return dataDictionary.bundles.patterns.products
            .slice(0, 15)
            .map(p => p.name);
        }
        
        // Fallback: scan all bundle data
        const suggestions = new Set();
        const allData = bundles.map(b => Object.values(b).join(' ').toLowerCase()).join(' ');
        
        // Common products as fallback
        const commonProducts = ['Netflix', 'Disney+', 'Disney', 'Spotify', 'Sky Sports', 'BT Sport', 'Prime Video', 'Apple TV', 'HBO', 'Paramount+', 'NOW TV', 'YouTube Premium', 'Fibre', 'Broadband', 'Phone', 'TV', 'Flex', 'Stream', 'DOCSIS', 'FTTP', 'M50', 'M125', 'M250', 'M350', 'M500', 'Gig1'];
        
        commonProducts.forEach(product => {
          if (allData.includes(product.toLowerCase())) {
            suggestions.add(product);
          }
        });
        
        return Array.from(suggestions).slice(0, 15);
      };

      // Onboarding Wizard Component
      const OnboardingWizard = () => {
        const steps = [
          {
            title: "Welcome to AI Product Catalog Manager! ðŸ‘‹",
            description: "This tool helps you manage, analyze, and get insights from your product and bundle data using AI.",
            icon: "ðŸš€",
            features: [
              "ðŸ“Š Upload and analyze your product/bundle spreadsheets",
              "ðŸ¤– Ask AI questions about your data in plain English",
              "ðŸ“ˆ Visualize data with charts and comparisons",
              "âœ… Check data quality and find errors automatically"
            ]
          },
          {
            title: "Step 1: Upload Your Data ðŸ“",
            description: "Start by uploading your Products and/or Bundles files. We support Excel (.xlsx) and CSV files.",
            icon: "ðŸ“",
            tips: [
              "ðŸ’¡ Products = Individual items (e.g., Netflix, Broadband, TV packages)",
              "ðŸ’¡ Bundles = Combinations of products sold together",
              "ðŸ’¡ Your file should have headers in the first row",
              "ðŸ’¡ Common columns: ID, Name, Price, Category, End Date"
            ],
            action: "upload"
          },
          {
            title: "Step 2: Ask the AI Anything ðŸ’¬",
            description: "Once your data is loaded, you can ask questions in plain English. The AI understands your data!",
            icon: "ðŸ¤–",
            examples: [
              "\"Which bundles expire this year?\"",
              "\"Show all bundles with Netflix\"",
              "\"Find pricing errors in my data\"",
              "\"Compare M500 vs Gig1 bundles\"",
              "\"What products aren't in any bundle?\""
            ]
          },
          {
            title: "Step 3: Explore Features ðŸŽ¯",
            description: "Use the tabs and tools to manage your catalog effectively.",
            icon: "âœ¨",
            features: [
              "ðŸ“Š Charts - Visualize pricing and categories",
              "âš–ï¸ Compare - Side-by-side bundle comparison",
              "ðŸ” Search - Find anything instantly (Cmd+K)",
              "ðŸ§  AI Sanity Check - Automatic data validation",
              "ðŸ“¥ Export - Download tables to Excel/CSV"
            ]
          },
          {
            title: "You're Ready! ðŸŽ‰",
            description: "Start by uploading a file, or try asking the AI a question. Need help? Click any suggested prompt!",
            icon: "ðŸŽ‰",
            quickStart: true
          }
        ];

        const currentStep = steps[onboardingStep - 1];

        return (
          <div className="bg-white rounded-xl shadow-2xl border-2 border-purple-200 overflow-hidden mb-6">
            {/* Progress bar */}
            <div className="bg-gradient-to-r from-purple-500 to-blue-500 p-1">
              <div className="flex justify-between px-4">
                {steps.map((_, idx) => (
                  <div key={idx} className={`w-8 h-8 rounded-full flex items-center justify-center text-sm font-bold transition-all ${idx + 1 <= onboardingStep ? 'bg-white text-purple-600' : 'bg-purple-400 text-white'}`}>
                    {idx + 1 <= onboardingStep ? 'âœ“' : idx + 1}
                  </div>
                ))}
              </div>
            </div>
            
            <div className="p-8">
              {/* Header */}
              <div className="text-center mb-6">
                <div className="text-6xl mb-4">{currentStep.icon}</div>
                <h2 className="text-2xl font-bold text-gray-800 mb-2">{currentStep.title}</h2>
                <p className="text-gray-600">{currentStep.description}</p>
              </div>

              {/* Content based on step */}
              {currentStep.features && (
                <div className="bg-purple-50 rounded-lg p-4 mb-6">
                  <div className="grid md:grid-cols-2 gap-3">
                    {currentStep.features.map((feature, idx) => (
                      <div key={idx} className="flex items-center gap-2 text-gray-700">
                        <span>{feature}</span>
                      </div>
                    ))}
                  </div>
                </div>
              )}

              {currentStep.tips && (
                <div className="bg-blue-50 rounded-lg p-4 mb-6">
                  <p className="font-semibold text-blue-800 mb-2">ðŸ’¡ Tips:</p>
                  <ul className="space-y-2">
                    {currentStep.tips.map((tip, idx) => (
                      <li key={idx} className="text-blue-700 text-sm">{tip}</li>
                    ))}
                  </ul>
                </div>
              )}

              {currentStep.examples && (
                <div className="bg-green-50 rounded-lg p-4 mb-6">
                  <p className="font-semibold text-green-800 mb-2">ðŸ’¬ Try asking:</p>
                  <div className="flex flex-wrap gap-2">
                    {currentStep.examples.map((example, idx) => (
                      <span key={idx} className="px-3 py-1 bg-white text-green-700 rounded-full text-sm border border-green-200">{example}</span>
                    ))}
                  </div>
                </div>
              )}

              {currentStep.action === 'upload' && (
                <div className="bg-amber-50 rounded-lg p-4 mb-6 border-2 border-dashed border-amber-300">
                  <p className="text-center text-amber-800 font-medium">
                    ðŸ‘† Use the "Upload Your Data" section above to add your files
                  </p>
                </div>
              )}

              {currentStep.quickStart && (
                <div className="grid md:grid-cols-3 gap-4 mb-6">
                  <button onClick={() => { completeOnboarding(); document.querySelector('input[type="file"]')?.click(); }} className="p-4 bg-purple-100 rounded-lg hover:bg-purple-200 transition text-center">
                    <div className="text-3xl mb-2">ðŸ“</div>
                    <div className="font-semibold text-purple-800">Upload Data</div>
                    <div className="text-xs text-purple-600">Start with your files</div>
                  </button>
                  <button onClick={() => { completeOnboarding(); setInput("What can you help me with?"); }} className="p-4 bg-blue-100 rounded-lg hover:bg-blue-200 transition text-center">
                    <div className="text-3xl mb-2">ðŸ¤–</div>
                    <div className="font-semibold text-blue-800">Ask AI</div>
                    <div className="text-xs text-blue-600">Get help from AI</div>
                  </button>
                  <button onClick={completeOnboarding} className="p-4 bg-green-100 rounded-lg hover:bg-green-200 transition text-center">
                    <div className="text-3xl mb-2">ðŸŽ¯</div>
                    <div className="font-semibold text-green-800">Explore</div>
                    <div className="text-xs text-green-600">Look around first</div>
                  </button>
                </div>
              )}

              {/* Navigation */}
              <div className="flex justify-between items-center pt-4 border-t border-gray-200">
                <button 
                  onClick={() => setOnboardingStep(Math.max(1, onboardingStep - 1))}
                  className={`px-4 py-2 rounded-lg font-medium ${onboardingStep === 1 ? 'text-gray-400 cursor-not-allowed' : 'text-purple-600 hover:bg-purple-50'}`}
                  disabled={onboardingStep === 1}
                >
                  â† Back
                </button>
                
                <div className="flex gap-2">
                  <button onClick={completeOnboarding} className="px-4 py-2 text-gray-500 hover:text-gray-700 text-sm">
                    Skip tutorial
                  </button>
                  
                  {onboardingStep < steps.length ? (
                    <button 
                      onClick={() => setOnboardingStep(onboardingStep + 1)}
                      className="px-6 py-2 bg-gradient-to-r from-purple-600 to-blue-600 text-white rounded-lg font-semibold hover:from-purple-700 hover:to-blue-700"
                    >
                      Next â†’
                    </button>
                  ) : (
                    <button 
                      onClick={completeOnboarding}
                      className="px-6 py-2 bg-gradient-to-r from-green-600 to-emerald-600 text-white rounded-lg font-semibold hover:from-green-700 hover:to-emerald-700"
                    >
                      Get Started! ðŸš€
                    </button>
                  )}
                </div>
              </div>
            </div>
          </div>
        );
      };

      // Favorite prompts
      const toggleFavoritePrompt = (prompt) => {
        let updated;
        if (favoritePrompts.includes(prompt)) {
          updated = favoritePrompts.filter(p => p !== prompt);
        } else {
          updated = [...favoritePrompts, prompt];
        }
        setFavoritePrompts(updated);
        localStorage.setItem('favorite_prompts', JSON.stringify(updated));
      };

      // Export chat
      const exportChat = () => {
        const chatText = messages.map(m => {
          const role = m.role === 'user' ? 'You' : m.role === 'assistant' ? 'AI' : 'System';
          return `[${role}]\n${m.content}\n`;
        }).join('\n---\n\n');
        
        const blob = new Blob([`AI Product Catalog - Chat Export\nExported: ${new Date().toLocaleString()}\n\n${'='.repeat(50)}\n\n${chatText}`], { type: 'text/plain' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `chat-export-${Date.now()}.txt`;
        a.click();
        addMessage('system', 'âœ… Chat exported successfully!');
      };

      // Compare bundles
      const addToCompare = (item, type) => {
        if (compareItems.length >= 4) {
          alert('Maximum 4 items to compare');
          return;
        }
        if (compareItems.find(i => i.id === item.id || JSON.stringify(i) === JSON.stringify(item))) {
          return;
        }
        setCompareItems([...compareItems, { ...item, _type: type }]);
      };

      const removeFromCompare = (index) => {
        setCompareItems(compareItems.filter((_, i) => i !== index));
      };

      // Bulk selection
      const toggleSelectItem = (type, index) => {
        const current = selectedItems[type];
        if (current.includes(index)) {
          setSelectedItems({ ...selectedItems, [type]: current.filter(i => i !== index) });
        } else {
          setSelectedItems({ ...selectedItems, [type]: [...current, index] });
        }
      };

      const selectAllItems = (type) => {
        const items = type === 'products' ? products : bundles;
        setSelectedItems({ ...selectedItems, [type]: items.map((_, i) => i) });
      };

      const deselectAllItems = (type) => {
        setSelectedItems({ ...selectedItems, [type]: [] });
      };

      const deleteSelectedItems = (type) => {
        if (!confirm(`Delete ${selectedItems[type].length} selected ${type}?`)) return;
        
        if (type === 'products') {
          setProducts(products.filter((_, i) => !selectedItems.products.includes(i)));
        } else {
          setBundles(bundles.filter((_, i) => !selectedItems.bundles.includes(i)));
        }
        setSelectedItems({ ...selectedItems, [type]: [] });
        addMessage('system', `âœ… Deleted ${selectedItems[type].length} ${type}`);
      };

      // Charts
      const renderCharts = () => {
        if (!showCharts) return;
        
        setTimeout(() => {
          // Category distribution chart
          if (chartRef.current && products.length > 0) {
            const ctx = chartRef.current.getContext('2d');
            const categoryField = Object.keys(products[0]).find(k => k.toLowerCase().includes('category')) || Object.keys(products[0])[1];
            const categories = {};
            products.forEach(p => {
              const cat = p[categoryField] || 'Unknown';
              categories[cat] = (categories[cat] || 0) + 1;
            });
            
            if (window.categoryChart) window.categoryChart.destroy();
            window.categoryChart = new Chart(ctx, {
              type: 'doughnut',
              data: {
                labels: Object.keys(categories),
                datasets: [{
                  data: Object.values(categories),
                  backgroundColor: ['#8b5cf6', '#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#ec4899', '#6366f1', '#14b8a6']
                }]
              },
              options: {
                responsive: true,
                plugins: { legend: { position: 'bottom' }, title: { display: true, text: 'Products by Category' } }
              }
            });
          }
          
          // Price distribution chart
          if (priceChartRef.current && bundles.length > 0) {
            const ctx = priceChartRef.current.getContext('2d');
            const priceField = Object.keys(bundles[0]).find(k => k.toLowerCase().includes('price')) || Object.keys(bundles[0])[2];
            const bundleNames = bundles.slice(0, 10).map(b => b[Object.keys(b)[0]] || 'Bundle');
            const prices = bundles.slice(0, 10).map(b => parseFloat(String(b[priceField]).replace(/[^0-9.-]/g, '')) || 0);
            
            if (window.priceChart) window.priceChart.destroy();
            window.priceChart = new Chart(ctx, {
              type: 'bar',
              data: {
                labels: bundleNames.map(n => String(n).substring(0, 15)),
                datasets: [{
                  label: 'Price',
                  data: prices,
                  backgroundColor: '#8b5cf6'
                }]
              },
              options: {
                responsive: true,
                plugins: { legend: { display: false }, title: { display: true, text: 'Bundle Prices (Top 10)' } },
                scales: { y: { beginAtZero: true } }
              }
            });
          }
        }, 100);
      };

      useEffect(() => {
        renderCharts();
      }, [showCharts, products, bundles]);

      const verifyToken = async (token) => {
        try {
          const response = await fetch(`${API_URL}/api/auth/me`, {
            headers: { 'Authorization': `Bearer ${token}` }
          });
          if (!response.ok) handleLogout();
        } catch (error) {
          console.error('Token verification failed:', error);
        }
      };

      const handleLogin = async (e) => {
        e.preventDefault();
        setLoginError('');
        setIsLoggingIn(true);

        try {
          const response = await fetch(`${API_URL}/api/auth/login`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              username: loginForm.username,
              password: loginForm.password,
              rememberMe: loginForm.rememberMe
            })
          });

          const data = await response.json();

          if (!response.ok) {
            setLoginError(data.error || 'Login failed');
            return;
          }

          localStorage.setItem('auth_token', data.token);
          localStorage.setItem('auth_user', JSON.stringify(data.user));
          if (data.refreshToken) localStorage.setItem('refresh_token', data.refreshToken);

          setAuthToken(data.token);
          setUser(data.user);
          setIsAuthenticated(true);
          addMessage('system', `âœ… Welcome back, ${data.user.username}! AI features are ready.`);
        } catch (error) {
          setLoginError('Connection failed. Please check your internet connection.');
        } finally {
          setIsLoggingIn(false);
        }
      };

      const handleLogout = async () => {
        try {
          if (authToken) {
            await fetch(`${API_URL}/api/auth/logout`, {
              method: 'POST',
              headers: { 'Authorization': `Bearer ${authToken}` }
            });
          }
        } catch (error) {}

        localStorage.removeItem('auth_token');
        localStorage.removeItem('auth_user');
        localStorage.removeItem('refresh_token');
        setAuthToken(null);
        setUser(null);
        setIsAuthenticated(false);
        setLoginForm({ username: '', password: '', rememberMe: false });
      };

      const refreshAuthToken = async () => {
        const refreshToken = localStorage.getItem('refresh_token');
        if (!refreshToken) return false;

        try {
          const response = await fetch(`${API_URL}/api/auth/refresh`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ refreshToken })
          });

          if (!response.ok) return false;
          const data = await response.json();
          localStorage.setItem('auth_token', data.token);
          setAuthToken(data.token);
          return true;
        } catch (error) {
          return false;
        }
      };

      useEffect(() => {
        const handleKeyDown = (e) => {
          if ((e.metaKey || e.ctrlKey) && e.key === 'k') {
            e.preventDefault();
            searchInputRef.current?.focus();
          }
        };
        document.addEventListener('keydown', handleKeyDown);
        return () => document.removeEventListener('keydown', handleKeyDown);
      }, []);

      const performSearch = (query) => {
        if (!query.trim()) {
          setSearchResults({ products: [], bundles: [] });
          setShowSearchResults(false);
          return;
        }

        const searchTerm = query.toLowerCase();
        const productMatches = products.filter(product => 
          Object.values(product).some(value => String(value).toLowerCase().includes(searchTerm))
        ).slice(0, 50);
        const bundleMatches = bundles.filter(bundle => 
          Object.values(bundle).some(value => String(value).toLowerCase().includes(searchTerm))
        ).slice(0, 50);

        setSearchResults({ products: productMatches, bundles: bundleMatches });
        setShowSearchResults(true);
      };

      useEffect(() => {
        const timer = setTimeout(() => performSearch(searchQuery), 300);
        return () => clearTimeout(timer);
      }, [searchQuery, products, bundles]);

      const clearSearch = () => {
        setSearchQuery('');
        setSearchResults({ products: [], bundles: [] });
        setShowSearchResults(false);
      };

      const runAISanityCheck = async (data, type) => {
        if (!isAuthenticated) { alert('Please login'); return; }
        if (data.length === 0) { alert(`No ${type} to check!`); return; }

        setIsCheckingSanity(true);
        setShowSanityReport(true);
        setSanityReport(null);

        try {
          const sampleData = data.slice(0, 50);
          const columns = Object.keys(data[0] || {});

          const prompt = `Analyze this ${type} data and return a sanity check report.
DATA (${data.length} rows): ${JSON.stringify(sampleData, null, 2)}
COLUMNS: ${columns.join(', ')}

Return ONLY valid JSON:
{"qualityScore": 85, "completeness": 92, "critical": [{"issue": "...", "count": 5, "fix": "..."}], "warnings": [{"issue": "...", "suggestion": "..."}], "suggestions": [{"title": "...", "description": "..."}], "statistics": {"totalRows": ${data.length}, "completeRows": 92, "issuesFound": 8, "fieldsAnalyzed": ${columns.length}}}`;

          const response = await callClaudeAPI(prompt, true);
          let jsonResponse = response.trim().replace(/```json\n?/g, '').replace(/```\n?/g, '').trim();
          const aiReport = JSON.parse(jsonResponse);
          setSanityReport({ ...aiReport, dataType: type, totalRows: data.length });
          addMessage('system', `âœ… Sanity check complete! Quality score: ${aiReport.qualityScore}/100`);
        } catch (error) {
          addMessage('system', `âŒ Sanity check failed: ${error.message}`);
          setSanityReport({ error: error.message });
        } finally {
          setIsCheckingSanity(false);
        }
      };

      const handleFileUpload = (e, type) => {
        const file = e.target.files[0];
        if (!file) return;

        if (file.name.endsWith('.xlsx') || file.name.endsWith('.xls')) {
          const reader = new FileReader();
          reader.onload = (evt) => {
            try {
              const data = new Uint8Array(evt.target.result);
              const workbook = XLSX.read(data, { type: 'array' });
              const firstSheet = workbook.SheetNames[0];
              const sheetData = XLSX.utils.sheet_to_json(workbook.Sheets[firstSheet], { defval: '' });
              
              // Analyze the data and update dictionary
              const analysis = analyzeData(sheetData, type);
              setDataDictionary(prev => ({ ...prev, [type]: analysis }));
              
              if (type === 'products') {
                setProducts(sheetData);
                const cols = Object.keys(sheetData[0] || {}).join(', ');
                addMessage('system', `âœ… Loaded ${sheetData.length} products from Excel\nðŸ“Š Columns detected: ${cols}\nðŸ§  Data analyzed and indexed for smart queries`);
                if (showOnboarding) completeOnboarding();
              } else {
                setBundles(sheetData);
                const cols = Object.keys(sheetData[0] || {}).join(', ');
                const detectedProducts = analysis?.patterns?.products?.slice(0, 10).map(p => p.name).join(', ') || 'None detected';
                addMessage('system', `âœ… Loaded ${sheetData.length} bundles from Excel\nðŸ“Š Columns: ${cols}\nðŸ” Products/services detected: ${detectedProducts}\nðŸ§  Data analyzed and indexed for smart queries`);
                if (showOnboarding) completeOnboarding();
              }
            } catch (error) {
              addMessage('system', `âŒ Error reading Excel: ${error.message}`);
            }
          };
          reader.readAsArrayBuffer(file);
          return;
        }

        Papa.parse(file, {
          header: true,
          skipEmptyLines: true,
          complete: (results) => {
            // Analyze the data and update dictionary
            const analysis = analyzeData(results.data, type);
            setDataDictionary(prev => ({ ...prev, [type]: analysis }));
            
            if (type === 'products') {
              setProducts(results.data);
              const cols = Object.keys(results.data[0] || {}).join(', ');
              addMessage('system', `âœ… Loaded ${results.data.length} products\nðŸ“Š Columns: ${cols}\nðŸ§  Data analyzed and indexed`);
              if (showOnboarding) completeOnboarding();
            } else {
              setBundles(results.data);
              const cols = Object.keys(results.data[0] || {}).join(', ');
              const detectedProducts = analysis?.patterns?.products?.slice(0, 10).map(p => p.name).join(', ') || 'None detected';
              addMessage('system', `âœ… Loaded ${results.data.length} bundles\nðŸ“Š Columns: ${cols}\nðŸ” Products detected: ${detectedProducts}\nðŸ§  Data analyzed and indexed`);
              if (showOnboarding) completeOnboarding();
            }
          },
          error: (error) => addMessage('system', `âŒ Error: ${error.message}`)
        });
      };

      const exportToExcel = (data, filename, type) => {
        const wb = XLSX.utils.book_new();
        const ws = XLSX.utils.json_to_sheet(data);
        XLSX.utils.book_append_sheet(wb, ws, type);
        XLSX.writeFile(wb, filename);
        addMessage('system', `âœ… Exported to ${filename}`);
      };

      const addMessage = (role, content) => {
        setMessages(prev => [...prev, { role, content, timestamp: Date.now() }]);
      };

      // SMART QUERY ENGINE - Analyzes data in JavaScript for 100% accuracy
      const analyzeQuery = (query) => {
        const q = query.toLowerCase();
        const results = { type: null, data: null, summary: null };
        const now = new Date();
        const currentYear = now.getFullYear();
        
        // Helper: Search all columns of a row for a term
        const rowContains = (row, term) => {
          const t = term.toLowerCase();
          return Object.values(row).some(val => String(val).toLowerCase().includes(t));
        };
        
        // Helper: Parse date from various formats
        const parseDate = (dateStr) => {
          if (!dateStr) return null;
          const str = String(dateStr).trim();
          
          // Try DD/MM/YYYY
          let match = str.match(/^(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{4})$/);
          if (match) {
            const [, day, month, year] = match;
            return new Date(parseInt(year), parseInt(month) - 1, parseInt(day));
          }
          
          // Try YYYY-MM-DD
          match = str.match(/^(\d{4})[\/\-](\d{1,2})[\/\-](\d{1,2})$/);
          if (match) {
            const [, year, month, day] = match;
            return new Date(parseInt(year), parseInt(month) - 1, parseInt(day));
          }
          
          // Try parsing directly
          const d = new Date(str);
          return isNaN(d.getTime()) ? null : d;
        };
        
        // Helper: Parse price
        const parsePrice = (priceStr) => {
          if (!priceStr) return 0;
          const cleaned = String(priceStr).replace(/[^0-9.-]/g, '');
          return parseFloat(cleaned) || 0;
        };
        
        // Helper: Get column by type
        const getCol = (data, ...keywords) => {
          if (!data || data.length === 0) return null;
          const cols = Object.keys(data[0]);
          for (const kw of keywords) {
            const found = cols.find(c => c.toLowerCase().includes(kw.toLowerCase()));
            if (found) return found;
          }
          return null;
        };
        
        // Detect date column
        const dateCol = getCol(bundles, 'end', 'expir', 'date') || getCol(bundles, 'start', 'launch');
        const nameCol = getCol(bundles, 'name', 'bundle', 'title') || (bundles[0] ? Object.keys(bundles[0])[1] : null);
        const idCol = getCol(bundles, 'id', 'sku', 'code') || (bundles[0] ? Object.keys(bundles[0])[0] : null);
        const priceCol = getCol(bundles, 'price', 'cost', 'fee');
        
        // PATTERN: "how many" / "count" questions
        if (q.includes('how many') || q.includes('count') || q.includes('total number')) {
          
          // Count bundles containing a term
          const containsMatch = q.match(/(?:contain|with|have|include|featuring)\s+['"]?([^'"?]+?)['"]?(?:\s|$|\?)/i);
          if (containsMatch) {
            const term = containsMatch[1].trim();
            const matching = bundles.filter(b => rowContains(b, term));
            results.type = 'count';
            results.data = matching;
            results.summary = `Found ${matching.length} bundles containing "${term}" (searched all ${bundles.length} bundles)`;
            return results;
          }
          
          // Count expiring
          if (q.includes('expir') || q.includes('ending')) {
            let days = 30;
            if (q.includes('this month')) days = 30;
            if (q.includes('this year') || q.includes(String(currentYear))) days = 365;
            if (q.includes('next 30')) days = 30;
            if (q.includes('next 60')) days = 60;
            if (q.includes('next 90')) days = 90;
            if (q.includes('next 7') || q.includes('this week')) days = 7;
            
            const cutoff = new Date(now.getTime() + days * 24 * 60 * 60 * 1000);
            const expiring = bundles.filter(b => {
              if (!dateCol) return false;
              const d = parseDate(b[dateCol]);
              return d && d >= now && d <= cutoff;
            });
            results.type = 'expiring';
            results.data = expiring;
            results.summary = `Found ${expiring.length} bundles expiring in the next ${days} days`;
            return results;
          }
        }
        
        // PATTERN: "list" / "show" / "what" bundles
        if (q.includes('list') || q.includes('show me') || q.includes('what bundles') || q.includes('which bundles')) {
          
          // With a specific term
          const withMatch = q.match(/(?:with|contain|include|have|featuring)\s+['"]?([^'"?]+?)['"]?(?:\s|$|\?)/i);
          if (withMatch) {
            const term = withMatch[1].trim();
            const matching = bundles.filter(b => rowContains(b, term));
            results.type = 'list';
            results.data = matching;
            results.summary = `${matching.length} bundles contain "${term}"`;
            return results;
          }
          
          // Expiring
          if (q.includes('expir') || q.includes('ending')) {
            let days = 30;
            if (q.includes('this year')) {
              const endOfYear = new Date(currentYear, 11, 31);
              const expiring = bundles.filter(b => {
                if (!dateCol) return false;
                const d = parseDate(b[dateCol]);
                return d && d >= now && d <= endOfYear;
              });
              results.type = 'list';
              results.data = expiring;
              results.summary = `${expiring.length} bundles expiring before end of ${currentYear}`;
              return results;
            }
            
            if (q.includes('30')) days = 30;
            if (q.includes('60')) days = 60;
            if (q.includes('90')) days = 90;
            if (q.includes('7') || q.includes('week')) days = 7;
            
            const cutoff = new Date(now.getTime() + days * 24 * 60 * 60 * 1000);
            const expiring = bundles.filter(b => {
              if (!dateCol) return false;
              const d = parseDate(b[dateCol]);
              return d && d >= now && d <= cutoff;
            });
            results.type = 'list';
            results.data = expiring;
            results.summary = `${expiring.length} bundles expiring in next ${days} days`;
            return results;
          }
        }
        
        // PATTERN: Price questions
        if (q.includes('expensive') || q.includes('cheapest') || q.includes('price')) {
          if (priceCol) {
            const withPrices = bundles.map(b => ({ ...b, _price: parsePrice(b[priceCol]) })).filter(b => b._price > 0);
            
            if (q.includes('most expensive') || q.includes('highest price')) {
              const sorted = withPrices.sort((a, b) => b._price - a._price).slice(0, 10);
              results.type = 'list';
              results.data = sorted;
              results.summary = `Top 10 most expensive bundles`;
              return results;
            }
            
            if (q.includes('cheapest') || q.includes('lowest price')) {
              const sorted = withPrices.sort((a, b) => a._price - b._price).slice(0, 10);
              results.type = 'list';
              results.data = sorted;
              results.summary = `Top 10 cheapest bundles`;
              return results;
            }
          }
        }
        
        // PATTERN: Search for specific product/term
        const searchTerms = ['netflix', 'disney', 'spotify', 'sky', 'bt sport', 'amazon', 'prime', 'apple', 'hbo', 'fibre', 'broadband'];
        for (const term of searchTerms) {
          if (q.includes(term)) {
            const matching = bundles.filter(b => rowContains(b, term));
            if (matching.length > 0) {
              results.type = 'search';
              results.data = matching;
              results.summary = `${matching.length} bundles contain "${term}"`;
              return results;
            }
          }
        }
        
        // No pattern matched - return null for Claude to handle
        return null;
      };

      const callClaudeAPI = async (userPrompt, useExtendedThinking = false) => {
        if (!isAuthenticated || !authToken) throw new Error('Please login');

        try {
          // FIRST: Try to answer with JavaScript analysis (100% accurate)
          const preAnalysis = analyzeQuery(userPrompt);
          
          let dataContext = '';
          let preComputedAnswer = '';
          
          if (preAnalysis && preAnalysis.data) {
            // We have pre-computed results - send these to Claude for formatting
            const cols = bundles.length > 0 ? Object.keys(bundles[0]) : [];
            preComputedAnswer = `
=== PRE-COMPUTED RESULTS (100% ACCURATE - USE THESE) ===
Query Type: ${preAnalysis.type}
Summary: ${preAnalysis.summary}
Total Matches: ${preAnalysis.data.length}
Data Columns: ${cols.join(', ')}

MATCHING DATA:
${JSON.stringify(preAnalysis.data.slice(0, 100), null, 2)}
${preAnalysis.data.length > 100 ? `\n... and ${preAnalysis.data.length - 100} more matches` : ''}

IMPORTANT: The above results are PRE-COMPUTED and 100% ACCURATE. 
Your job is to FORMAT these results nicely as a markdown table.
Use the exact column names: ${cols.join(' | ')}
End with: **Total: ${preAnalysis.data.length} bundles found**
`;
          } else {
            // No pre-computation - send full data
            if (products.length > 0) {
              dataContext += `\n\n=== PRODUCTS DATA (${products.length} total rows) ===\n`;
              dataContext += `Columns: ${Object.keys(products[0]).join(', ')}\n`;
              dataContext += JSON.stringify(products.slice(0, 300), null, 2);
              if (products.length > 300) dataContext += `\n... and ${products.length - 300} more rows`;
            }
            if (bundles.length > 0) {
              dataContext += `\n\n=== BUNDLES DATA (${bundles.length} total rows) ===\n`;
              dataContext += `Columns: ${Object.keys(bundles[0]).join(', ')}\n`;
              dataContext += JSON.stringify(bundles.slice(0, 300), null, 2);
              if (bundles.length > 300) dataContext += `\n... and ${bundles.length - 300} more rows`;
            }
          }
          
          // Build smart context from data dictionary
          const smartContext = buildSmartContext();

          const currentDate = new Date();
          const dateStr = currentDate.toLocaleDateString('en-GB', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
          
          const productColumns = products.length > 0 ? Object.keys(products[0]) : [];
          const bundleColumns = bundles.length > 0 ? Object.keys(bundles[0]) : [];
          
          const systemPrompt = preAnalysis ? 
            `You are formatting pre-computed data analysis results. The data has already been accurately analyzed.

${preComputedAnswer}

Format the results as a clean markdown table using the exact column names provided.
Keep your response concise - just the table and the total count.
Do NOT re-analyze or question the results - they are accurate.` 
            :
            `You are an expert data analyst. IMPORTANT: Search EVERY row carefully.

CURRENT DATE: ${dateStr} | YEAR: ${currentDate.getFullYear()}

${smartContext}

${dataContext}

USER QUESTION: ${userPrompt}

RULES:
1. Search EVERY row in the data - don't sample
2. Check ALL columns for matches (case-insensitive)
3. Format results as markdown tables with exact column names
4. Always end with "**Total: X found**"
5. If uncertain, say so - don't guess

COLUMNS: ${bundleColumns.join(' | ')}`;

          const response = await fetch(`${API_URL}/api/claude/completion`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              "Authorization": `Bearer ${authToken}`
            },
            body: JSON.stringify({
              messages: [{ role: "user", content: systemPrompt }],
              max_tokens: useExtendedThinking ? 4000 : 2000
            })
          });

          if (response.status === 401) {
            const refreshed = await refreshAuthToken();
            if (!refreshed) { handleLogout(); throw new Error('Session expired'); }
            return callClaudeAPI(userPrompt, useExtendedThinking);
          }

          if (!response.ok) {
            const errorData = await response.json().catch(() => ({}));
            throw new Error(errorData.error || `API failed: ${response.status}`);
          }

          const data = await response.json();
          return data.data.content[0].text;
        } catch (error) {
          throw error;
        }
      };

      // FAST LOCAL QUERY - Answers simple questions instantly without API call
      const tryLocalAnswer = (query) => {
        const q = query.toLowerCase();
        const cols = bundles.length > 0 ? Object.keys(bundles[0]) : [];
        const idCol = cols.find(c => c.toLowerCase().includes('id') || c.toLowerCase().includes('sku')) || cols[0];
        const nameCol = cols.find(c => c.toLowerCase().includes('name') || c.toLowerCase().includes('bundle') || c.toLowerCase().includes('title')) || cols[1] || cols[0];
        const priceCol = cols.find(c => c.toLowerCase().includes('price') || c.toLowerCase().includes('cost'));
        const dateCol = cols.find(c => c.toLowerCase().includes('end') || c.toLowerCase().includes('expir') || c.toLowerCase().includes('date'));
        
        // Helper functions
        const rowContains = (row, term) => Object.values(row).some(v => String(v).toLowerCase().includes(term.toLowerCase()));
        
        const parseDate = (str) => {
          if (!str) return null;
          const s = String(str).trim();
          let m = s.match(/^(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{4})$/);
          if (m) return new Date(parseInt(m[3]), parseInt(m[2])-1, parseInt(m[1]));
          m = s.match(/^(\d{4})[\/\-](\d{1,2})[\/\-](\d{1,2})$/);
          if (m) return new Date(parseInt(m[1]), parseInt(m[2])-1, parseInt(m[3]));
          const d = new Date(s);
          return isNaN(d.getTime()) ? null : d;
        };
        
        const parsePrice = (p) => parseFloat(String(p || '0').replace(/[^0-9.-]/g, '')) || 0;
        
        const formatTable = (data, columns) => {
          if (data.length === 0) return 'No results found.';
          const showCols = columns || cols.slice(0, 6);
          let table = '| ' + showCols.join(' | ') + ' |\n';
          table += '| ' + showCols.map(() => '---').join(' | ') + ' |\n';
          data.slice(0, 50).forEach(row => {
            table += '| ' + showCols.map(c => String(row[c] || '').substring(0, 40)).join(' | ') + ' |\n';
          });
          if (data.length > 50) table += `\n*... and ${data.length - 50} more rows*\n`;
          return table;
        };
        
        const now = new Date();
        const currentYear = now.getFullYear();
        
        // Pattern: How many bundles total
        if ((q.includes('how many bundles') || q.includes('total bundles') || q.includes('count of bundles')) && !q.includes('contain') && !q.includes('with') && !q.includes('expir')) {
          return `**Total: ${bundles.length} bundles** in the catalog.`;
        }
        
        // Pattern: How many products total  
        if ((q.includes('how many products') || q.includes('total products')) && !q.includes('contain')) {
          return `**Total: ${products.length} products** in the catalog.`;
        }
        
        // Pattern: How many contain X
        const containMatch = q.match(/how many (?:bundles? )?(?:contain|with|have|include|featuring)\s+['"]?([^'"?]+?)['"]?(?:\s|$|\?)/i);
        if (containMatch) {
          const term = containMatch[1].trim();
          const matching = bundles.filter(b => rowContains(b, term));
          return `**${matching.length} bundles** contain "${term}" (searched all ${bundles.length} bundles).\n\n${matching.length > 0 ? formatTable(matching) + '\n\n' : ''}**Total: ${matching.length} bundles found**`;
        }
        
        // Pattern: List/show bundles with X
        const listMatch = q.match(/(?:list|show|what|which)\s+(?:all\s+)?bundles?\s+(?:that\s+)?(?:contain|with|have|include|featuring)\s+['"]?([^'"?]+?)['"]?/i);
        if (listMatch) {
          const term = listMatch[1].trim();
          const matching = bundles.filter(b => rowContains(b, term));
          return `Found **${matching.length} bundles** containing "${term}":\n\n${formatTable(matching)}\n\n**Total: ${matching.length} bundles found**`;
        }
        
        // Pattern: Bundles expiring this year / in 2025 / soon
        if (q.includes('expir') || q.includes('ending')) {
          let days = 30;
          let label = 'in the next 30 days';
          
          if (q.includes('this year') || q.includes(String(currentYear))) {
            const endOfYear = new Date(currentYear, 11, 31);
            const expiring = bundles.filter(b => {
              if (!dateCol) return false;
              const d = parseDate(b[dateCol]);
              return d && d >= now && d <= endOfYear;
            }).sort((a, b) => {
              const da = parseDate(a[dateCol]) || new Date(9999, 0);
              const db = parseDate(b[dateCol]) || new Date(9999, 0);
              return da - db;
            });
            return `Found **${expiring.length} bundles** expiring before end of ${currentYear}:\n\n${formatTable(expiring)}\n\n**Total: ${expiring.length} bundles expiring this year**`;
          }
          
          if (q.includes('next 7') || q.includes('this week')) { days = 7; label = 'in the next 7 days'; }
          if (q.includes('next 30') || q.includes('this month')) { days = 30; label = 'in the next 30 days'; }
          if (q.includes('next 60')) { days = 60; label = 'in the next 60 days'; }
          if (q.includes('next 90')) { days = 90; label = 'in the next 90 days'; }
          if (q.includes('soon')) { days = 30; label = 'soon (next 30 days)'; }
          
          const cutoff = new Date(now.getTime() + days * 24 * 60 * 60 * 1000);
          const expiring = bundles.filter(b => {
            if (!dateCol) return false;
            const d = parseDate(b[dateCol]);
            return d && d >= now && d <= cutoff;
          }).sort((a, b) => {
            const da = parseDate(a[dateCol]) || new Date(9999, 0);
            const db = parseDate(b[dateCol]) || new Date(9999, 0);
            return da - db;
          });
          
          return `Found **${expiring.length} bundles** expiring ${label}:\n\n${formatTable(expiring)}\n\n**Total: ${expiring.length} bundles found**`;
        }
        
        // Pattern: Most expensive / cheapest
        if (priceCol && (q.includes('expensive') || q.includes('cheapest') || q.includes('highest price') || q.includes('lowest price'))) {
          const withPrices = bundles.map(b => ({ ...b, _parsed_price: parsePrice(b[priceCol]) })).filter(b => b._parsed_price > 0);
          
          if (q.includes('most expensive') || q.includes('highest price')) {
            const sorted = withPrices.sort((a, b) => b._parsed_price - a._parsed_price).slice(0, 10);
            return `**Top 10 most expensive bundles:**\n\n${formatTable(sorted)}\n\n**Highest price: Â£${sorted[0]?._parsed_price || 'N/A'}**`;
          }
          
          if (q.includes('cheapest') || q.includes('lowest price')) {
            const sorted = withPrices.sort((a, b) => a._parsed_price - b._parsed_price).slice(0, 10);
            return `**Top 10 cheapest bundles:**\n\n${formatTable(sorted)}\n\n**Lowest price: Â£${sorted[0]?._parsed_price || 'N/A'}**`;
          }
        }
        
        // Pattern: Search for common terms (Netflix, Disney, Fibre, etc)
        const commonTerms = ['netflix', 'disney', 'spotify', 'sky', 'bt sport', 'prime', 'amazon', 'apple', 'hbo', 'fibre', 'fttp', 'docsis', 'broadband'];
        for (const term of commonTerms) {
          if (q.includes(term) && (q.includes('bundle') || q.includes('how many') || q.includes('list') || q.includes('show') || q.includes('which') || q.includes('what'))) {
            const matching = bundles.filter(b => rowContains(b, term));
            if (matching.length > 0 || q.includes('how many')) {
              return `Found **${matching.length} bundles** containing "${term}":\n\n${formatTable(matching)}\n\n**Total: ${matching.length} bundles found**`;
            }
          }
        }
        
        // Not a pattern we can answer locally
        return null;
      };

      const handleSubmit = async (e) => {
        e.preventDefault();
        if (!input.trim() || isLoading) return;
        if (!isAuthenticated) { addMessage('system', 'âš ï¸ Please login'); return; }

        const userMessage = input;
        setInput("");
        addMessage('user', userMessage);
        setIsLoading(true);
        
        // Track query type for follow-up suggestions
        setLastQueryType(detectQueryType(userMessage));

        try {
          // FIRST: Try to answer locally (instant & 100% accurate)
          const localAnswer = tryLocalAnswer(userMessage);
          if (localAnswer) {
            addMessage('assistant', 'âš¡ ' + localAnswer + '\n\n*âœ“ Computed locally - 100% accurate*');
            setIsLoading(false);
            return;
          }
          
          // Otherwise, call Claude API
          const response = await callClaudeAPI(userMessage, false);
          addMessage('assistant', response);
        } catch (error) {
          addMessage('system', `âŒ Error: ${error.message}`);
        } finally {
          setIsLoading(false);
        }
      };

      const downloadCSV = (data, filename) => {
        const csv = Papa.unparse(data);
        const blob = new Blob([csv], { type: 'text/csv' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        a.click();
      };

      const deleteItem = (type, index) => {
        if (confirm(`Delete this ${type}?`)) {
          if (type === 'product') {
            setProducts(products.filter((_, i) => i !== index));
          } else {
            setBundles(bundles.filter((_, i) => i !== index));
          }
          addMessage('system', `âœ… ${type} deleted`);
        }
      };

      const startEdit = (type, index) => {
        if (type === 'product') {
          setEditingItem({ ...products[index], index });
          setEditingType('product');
        } else {
          setEditingItem({ ...bundles[index], index });
          setEditingType('bundle');
        }
      };

      const saveEdit = () => {
        if (editingType === 'product') {
          const newProducts = [...products];
          const { index, ...itemData } = editingItem;
          newProducts[index] = itemData;
          setProducts(newProducts);
        } else {
          const newBundles = [...bundles];
          const { index, ...itemData } = editingItem;
          newBundles[index] = itemData;
          setBundles(newBundles);
        }
        addMessage('system', `âœ… ${editingType} updated`);
        setEditingItem(null);
        setEditingType(null);
      };

      const cancelEdit = () => { setEditingItem(null); setEditingType(null); };

      const initializeNewItem = (type) => {
        const template = type === 'product' 
          ? (products.length > 0 ? Object.keys(products[0]).reduce((acc, key) => ({ ...acc, [key]: '' }), {}) : { name: '', price: '', category: '', sku: '' })
          : (bundles.length > 0 ? Object.keys(bundles[0]).reduce((acc, key) => ({ ...acc, [key]: '' }), {}) : { name: '', products: '', price: '' });
        setNewItem(template);
        setCreateType(type);
        setShowCreateForm(true);
      };

      const saveNewItem = () => {
        if (createType === 'product') {
          setProducts([...products, newItem]);
        } else {
          setBundles([...bundles, newItem]);
        }
        addMessage('system', `âœ… New ${createType} added!`);
        setNewItem({});
        setShowCreateForm(false);
        setActiveTab(createType === 'product' ? 'products' : 'bundles');
      };

      const askAIToCreate = async (type) => {
        if (!isAuthenticated) { alert('Please login'); return; }
        setIsLoading(true);
        setActiveTab('chat');
        
        try {
          const prompt = type === 'product' 
            ? `Create a new product template based on my existing products. Give me a filled-out example. Format as JSON.`
            : `Create a new bundle template based on my existing bundles. Give me a filled-out example. Format as JSON.`;
          addMessage('user', prompt);
          const response = await callClaudeAPI(prompt);
          addMessage('assistant', response);
        } catch (error) {
          addMessage('system', `âŒ Error: ${error.message}`);
        } finally {
          setIsLoading(false);
        }
      };

      // LOGIN SCREEN
      if (!isAuthenticated) {
        return (
          <div className={`min-h-screen flex items-center justify-center p-4 ${darkMode ? 'dark' : 'bg-gradient-to-br from-slate-50 via-indigo-50 to-purple-50'}`}>
            <div className="absolute inset-0 overflow-hidden pointer-events-none">
              <div className="absolute -top-40 -right-40 w-80 h-80 bg-purple-200 rounded-full mix-blend-multiply filter blur-3xl opacity-30 animate-pulse-soft"></div>
              <div className="absolute -bottom-40 -left-40 w-80 h-80 bg-indigo-200 rounded-full mix-blend-multiply filter blur-3xl opacity-30 animate-pulse-soft" style={{animationDelay: '1s'}}></div>
            </div>
            
            <div className="relative bg-white rounded-2xl shadow-elevated p-8 max-w-md w-full border border-slate-100">
              <div className="text-center mb-8">
                <div className="inline-flex items-center justify-center w-16 h-16 bg-gradient-to-br from-indigo-500 to-purple-600 rounded-2xl mb-4 shadow-lg">
                  <span className="text-3xl">ðŸ“Š</span>
                </div>
                <h1 className="text-2xl font-bold text-gray-900 mb-1">Product Catalog AI</h1>
                <p className="text-gray-500 text-sm">Sign in to your workspace</p>
              </div>

              <form onSubmit={handleLogin} className="space-y-5">
                {loginError && (
                  <div className="flex items-center gap-2 bg-red-50 border border-red-100 text-red-600 px-4 py-3 rounded-xl text-sm">
                    <svg className="w-5 h-5 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20"><path fillRule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clipRule="evenodd"/></svg>
                    {loginError}
                  </div>
                )}
                
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1.5">Username</label>
                  <input 
                    type="text" 
                    value={loginForm.username} 
                    onChange={(e) => setLoginForm({...loginForm, username: e.target.value})} 
                    className="w-full px-4 py-3 bg-slate-50 border border-slate-200 rounded-xl text-gray-900 placeholder-gray-400 focus:border-indigo-500 focus:bg-white" 
                    placeholder="Enter your username" 
                    required 
                  />
                </div>
                
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1.5">Password</label>
                  <input 
                    type="password" 
                    value={loginForm.password} 
                    onChange={(e) => setLoginForm({...loginForm, password: e.target.value})} 
                    className="w-full px-4 py-3 bg-slate-50 border border-slate-200 rounded-xl text-gray-900 placeholder-gray-400 focus:border-indigo-500 focus:bg-white" 
                    placeholder="Enter your password" 
                    required 
                  />
                </div>
                
                <div className="flex items-center justify-between">
                  <label className="flex items-center gap-2 cursor-pointer">
                    <input 
                      type="checkbox" 
                      checked={loginForm.rememberMe} 
                      onChange={(e) => setLoginForm({...loginForm, rememberMe: e.target.checked})} 
                      className="w-4 h-4 text-indigo-600 border-slate-300 rounded focus:ring-indigo-500" 
                    />
                    <span className="text-sm text-gray-600">Remember me</span>
                  </label>
                </div>
                
                <button 
                  type="submit" 
                  disabled={isLoggingIn} 
                  className="w-full py-3 btn-primary text-white rounded-xl font-semibold disabled:opacity-50 disabled:cursor-not-allowed disabled:transform-none"
                >
                  {isLoggingIn ? (
                    <span className="flex items-center justify-center gap-2">
                      <svg className="animate-spin h-5 w-5" viewBox="0 0 24 24"><circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4" fill="none"/><path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"/></svg>
                      Signing in...
                    </span>
                  ) : 'Sign In'}
                </button>
              </form>

              <div className="mt-6 pt-6 border-t border-slate-100">
                <p className="text-xs text-gray-500 text-center mb-3">Demo credentials</p>
                <div className="flex gap-2 justify-center">
                  <button onClick={() => setLoginForm({username: 'admin', password: 'admin123', rememberMe: false})} className="px-3 py-1.5 bg-slate-100 hover:bg-slate-200 rounded-lg text-xs font-medium text-gray-600">admin / admin123</button>
                  <button onClick={() => setLoginForm({username: 'demo', password: 'demo123', rememberMe: false})} className="px-3 py-1.5 bg-slate-100 hover:bg-slate-200 rounded-lg text-xs font-medium text-gray-600">demo / demo123</button>
                </div>
              </div>
            </div>
          </div>
        );
      }

      // MAIN APP
      return (
        <div className={`min-h-screen ${darkMode ? 'dark' : 'bg-gradient-to-br from-slate-50 via-gray-50 to-slate-100'}`}>
          {/* Top Navigation Bar */}
          <nav className="sticky top-0 z-50 glass border-b border-slate-200/50">
            <div className="max-w-7xl mx-auto px-4 sm:px-6">
              <div className="flex items-center justify-between h-16">
                {/* Logo & Title */}
                <div className="flex items-center gap-3">
                  <div className="w-10 h-10 bg-gradient-to-br from-indigo-500 to-purple-600 rounded-xl flex items-center justify-center shadow-lg shadow-indigo-200">
                    <span className="text-xl">ðŸ“Š</span>
                  </div>
                  <div className="hidden sm:block">
                    <h1 className="text-lg font-bold text-gray-900">Product Catalog</h1>
                    <p className="text-xs text-gray-500 -mt-0.5">AI-Powered Management</p>
                  </div>
                </div>
                
                {/* Center Search */}
                <div className="flex-1 max-w-xl mx-4">
                  <div className="relative">
                    <svg className="absolute left-3 top-1/2 -translate-y-1/2 w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/></svg>
                    <input 
                      ref={searchInputRef} 
                      type="text" 
                      value={searchQuery} 
                      onChange={(e) => setSearchQuery(e.target.value)} 
                      placeholder="Search products, bundles... âŒ˜K" 
                      className="w-full pl-10 pr-4 py-2.5 bg-slate-100 border-0 rounded-xl text-sm text-gray-900 placeholder-gray-500 focus:bg-white focus:ring-2 focus:ring-indigo-500" 
                    />
                    {searchQuery && (
                      <button onClick={clearSearch} className="absolute right-3 top-1/2 -translate-y-1/2 text-gray-400 hover:text-gray-600">
                        <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M6 18L18 6M6 6l12 12"/></svg>
                      </button>
                    )}
                  </div>
                </div>
                
                {/* Right Actions */}
                <div className="flex items-center gap-2">
                  <button onClick={toggleDarkMode} className="p-2 rounded-xl hover:bg-slate-100 text-gray-500" title="Toggle theme">
                    {darkMode ? <svg className="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path fillRule="evenodd" d="M10 2a1 1 0 011 1v1a1 1 0 11-2 0V3a1 1 0 011-1zm4 8a4 4 0 11-8 0 4 4 0 018 0zm-.464 4.95l.707.707a1 1 0 001.414-1.414l-.707-.707a1 1 0 00-1.414 1.414zm2.12-10.607a1 1 0 010 1.414l-.706.707a1 1 0 11-1.414-1.414l.707-.707a1 1 0 011.414 0zM17 11a1 1 0 100-2h-1a1 1 0 100 2h1zm-7 4a1 1 0 011 1v1a1 1 0 11-2 0v-1a1 1 0 011-1zM5.05 6.464A1 1 0 106.465 5.05l-.708-.707a1 1 0 00-1.414 1.414l.707.707zm1.414 8.486l-.707.707a1 1 0 01-1.414-1.414l.707-.707a1 1 0 011.414 1.414zM4 11a1 1 0 100-2H3a1 1 0 000 2h1z" clipRule="evenodd"/></svg> : <svg className="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001 0 1010.586 10.586z"/></svg>}
                  </button>
                  
                  <div className="hidden sm:flex items-center gap-2 px-3 py-1.5 bg-slate-100 rounded-xl">
                    <div className="w-8 h-8 bg-gradient-to-br from-indigo-500 to-purple-500 rounded-lg flex items-center justify-center text-white text-sm font-semibold">
                      {user?.username?.charAt(0).toUpperCase()}
                    </div>
                    <div className="text-sm">
                      <p className="font-medium text-gray-900">{user?.username}</p>
                      <p className="text-xs text-gray-500">{user?.role}</p>
                    </div>
                  </div>
                  
                  <button onClick={handleLogout} className="p-2 rounded-xl hover:bg-red-50 text-gray-400 hover:text-red-500" title="Logout">
                    <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"/></svg>
                  </button>
                </div>
              </div>
            </div>
          </nav>
          
          {/* Search Results Dropdown */}
          {showSearchResults && (searchResults.products.length > 0 || searchResults.bundles.length > 0) && (
            <div className="fixed top-20 left-1/2 -translate-x-1/2 w-full max-w-xl bg-white rounded-2xl shadow-elevated border border-slate-200 z-50 max-h-96 overflow-y-auto animate-fadeIn">
              <div className="p-4">
                <div className="flex justify-between items-center mb-3">
                  <span className="text-sm font-semibold text-gray-900">Search Results</span>
                  <button onClick={() => setShowSearchResults(false)} className="text-gray-400 hover:text-gray-600">
                    <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M6 18L18 6M6 6l12 12"/></svg>
                  </button>
                </div>
                {searchResults.products.length > 0 && (
                  <div className="mb-4">
                    <p className="text-xs font-semibold text-indigo-600 mb-2">Products ({searchResults.products.length})</p>
                    {searchResults.products.slice(0, 5).map((product, idx) => (
                      <div key={idx} className="p-2.5 hover:bg-slate-50 rounded-xl flex justify-between items-center cursor-pointer">
                        <span className="text-sm text-gray-700">{product[Object.keys(product)[0]]}</span>
                        <button onClick={() => addToCompare(product, 'product')} className="pill bg-indigo-50 text-indigo-600 hover:bg-indigo-100 text-xs">+ Compare</button>
                      </div>
                    ))}
                  </div>
                )}
                {searchResults.bundles.length > 0 && (
                  <div>
                    <p className="text-xs font-semibold text-purple-600 mb-2">Bundles ({searchResults.bundles.length})</p>
                    {searchResults.bundles.slice(0, 5).map((bundle, idx) => (
                      <div key={idx} className="p-2.5 hover:bg-slate-50 rounded-xl flex justify-between items-center cursor-pointer">
                        <span className="text-sm text-gray-700">{bundle[Object.keys(bundle)[0]]}</span>
                        <button onClick={() => addToCompare(bundle, 'bundle')} className="pill bg-purple-50 text-purple-600 hover:bg-purple-100 text-xs">+ Compare</button>
                      </div>
                    ))}
                  </div>
                )}
              </div>
            </div>
          )}
          
          <div className="max-w-7xl mx-auto px-4 sm:px-6 py-6">
            {/* Quick Stats Bar */}
            <div className="flex items-center justify-between mb-6">
              <div className="flex items-center gap-4">
                <div className="flex items-center gap-2 px-3 py-1.5 bg-white rounded-xl shadow-soft border border-slate-100">
                  <span className="w-2 h-2 bg-emerald-500 rounded-full animate-pulse"></span>
                  <span className="text-sm text-gray-600">Connected</span>
                </div>
                <div className="flex items-center gap-3 text-sm text-gray-500">
                  <span className="flex items-center gap-1.5"><span className="text-indigo-600 font-semibold">{products.length}</span> products</span>
                  <span className="text-gray-300">â€¢</span>
                  <span className="flex items-center gap-1.5"><span className="text-purple-600 font-semibold">{bundles.length}</span> bundles</span>
                </div>
              </div>
              
              <div className="flex items-center gap-2">
                <button onClick={() => setShowCharts(!showCharts)} className={`pill ${showCharts ? 'bg-indigo-600 text-white' : 'bg-white text-gray-600 border border-slate-200 hover:border-indigo-300'}`}>
                  <span className="flex items-center gap-1.5"><svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/></svg> Charts</span>
                </button>
                <button onClick={() => setShowCompare(!showCompare)} className={`pill ${showCompare ? 'bg-purple-600 text-white' : 'bg-white text-gray-600 border border-slate-200 hover:border-purple-300'}`}>
                  <span className="flex items-center gap-1.5"><svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/></svg> Compare {compareItems.length > 0 && `(${compareItems.length})`}</span>
                </button>
                <button onClick={() => setShowPriceCalculator(!showPriceCalculator)} className={`pill ${showPriceCalculator ? 'bg-emerald-600 text-white' : 'bg-white text-gray-600 border border-slate-200 hover:border-emerald-300'}`}>
                  <span className="flex items-center gap-1.5"><svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z"/></svg> ðŸ§® Price Calc</span>
                </button>
                <button onClick={() => setShowAddonViewer(!showAddonViewer)} className={`pill ${showAddonViewer ? 'bg-amber-600 text-white' : 'bg-white text-gray-600 border border-slate-200 hover:border-amber-300'}`}>
                  <span className="flex items-center gap-1.5"><svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1"/></svg> ðŸ”— Add-on Lookup</span>
                </button>
                <button onClick={() => setShowImpactAnalysis(!showImpactAnalysis)} className={`pill ${showImpactAnalysis ? 'bg-rose-600 text-white' : 'bg-white text-gray-600 border border-slate-200 hover:border-rose-300'}`}>
                  <span className="flex items-center gap-1.5"><svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M13 10V3L4 14h7v7l9-11h-7z"/></svg> Impact</span>
                </button>
                {dataDictionary && (
                  <button onClick={() => {
                    const dict = dataDictionary;
                    let info = 'ðŸ§  DATA DICTIONARY - What I learned from your data:\n\n';
                    if (dict.products) {
                      info += `ðŸ“¦ PRODUCTS (${dict.products.rowCount} rows)\n`;
                      info += `Columns: ${Object.keys(dict.products.columns).join(', ')}\n`;
                      if (dict.products.idColumns.length) info += `â€¢ ID columns: ${dict.products.idColumns.join(', ')}\n`;
                      if (dict.products.nameColumns.length) info += `â€¢ Name columns: ${dict.products.nameColumns.join(', ')}\n`;
                      if (dict.products.priceColumns.length) info += `â€¢ Price columns: ${dict.products.priceColumns.join(', ')}\n`;
                      if (dict.products.dateColumns.length) info += `â€¢ Date columns: ${dict.products.dateColumns.join(', ')}\n`;
                      info += '\n';
                    }
                    if (dict.bundles) {
                      info += `ðŸ“¦ BUNDLES (${dict.bundles.rowCount} rows)\n`;
                      info += `Columns: ${Object.keys(dict.bundles.columns).join(', ')}\n`;
                      if (dict.bundles.idColumns.length) info += `â€¢ ID columns: ${dict.bundles.idColumns.join(', ')}\n`;
                      if (dict.bundles.nameColumns.length) info += `â€¢ Name columns: ${dict.bundles.nameColumns.join(', ')}\n`;
                      if (dict.bundles.priceColumns.length) info += `â€¢ Price columns: ${dict.bundles.priceColumns.join(', ')}\n`;
                      if (dict.bundles.dateColumns.length) info += `â€¢ Date columns: ${dict.bundles.dateColumns.join(', ')}\n`;
                      if (dict.bundles.contentColumns.length) info += `â€¢ Content columns: ${dict.bundles.contentColumns.join(', ')}\n`;
                      if (dict.bundles.patterns?.products?.length) {
                        info += `\nðŸ” DETECTED PRODUCTS/SERVICES:\n`;
                        info += dict.bundles.patterns.products.slice(0, 20).map(p => `${p.name} (${p.count}x)`).join(', ');
                      }
                    }
                    addMessage('system', info);
                  }} className="pill bg-emerald-50 text-emerald-600 border border-emerald-200 hover:border-emerald-300">
                    <span className="flex items-center gap-1.5"><svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"/></svg> ðŸ§  Dictionary</span>
                  </button>
                )}
                <button onClick={resetOnboarding} className="pill bg-white text-gray-600 border border-slate-200 hover:border-slate-300">
                  <span className="flex items-center gap-1.5"><svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg> Help</span>
                </button>
              </div>
            </div>

            {/* Charts Panel */}
            {showCharts && (products.length > 0 || bundles.length > 0) && (
              <div className="bg-white rounded-xl shadow-lg p-6 mb-6">
                <div className="flex justify-between items-center mb-4">
                  <h2 className="text-xl font-bold">ðŸ“Š Data Visualizations</h2>
                  <button onClick={() => setShowCharts(false)} className="text-gray-400 hover:text-gray-600">âœ•</button>
                </div>
                <div className="grid md:grid-cols-2 gap-6">
                  {products.length > 0 && (
                    <div className="bg-gray-50 rounded-lg p-4">
                      <canvas ref={chartRef}></canvas>
                    </div>
                  )}
                  {bundles.length > 0 && (
                    <div className="bg-gray-50 rounded-lg p-4">
                      <canvas ref={priceChartRef}></canvas>
                    </div>
                  )}
                </div>
              </div>
            )}

            {/* Compare Panel */}
            {showCompare && (
              <div className="bg-white rounded-xl shadow-lg p-6 mb-6">
                <div className="flex justify-between items-center mb-4">
                  <h2 className="text-xl font-bold">âš–ï¸ Compare Items ({compareItems.length}/4)</h2>
                  <div className="flex gap-2">
                    {compareItems.length > 0 && <button onClick={() => setCompareItems([])} className="text-sm text-red-600 hover:text-red-800">Clear All</button>}
                    <button onClick={() => setShowCompare(false)} className="text-gray-400 hover:text-gray-600">âœ•</button>
                  </div>
                </div>
                
                {compareItems.length === 0 ? (
                  <div className="text-center py-8 text-gray-500">
                    <p className="text-lg mb-2">No items to compare</p>
                    <p className="text-sm">Search for items and click "+ Compare" to add them here</p>
                  </div>
                ) : (
                  <div className="overflow-x-auto">
                    <table className="w-full text-sm">
                      <thead className="bg-gray-100">
                        <tr>
                          <th className="px-4 py-3 text-left font-semibold">Field</th>
                          {compareItems.map((item, idx) => (
                            <th key={idx} className="px-4 py-3 text-left font-semibold">
                              <div className="flex items-center justify-between">
                                <span className={`px-2 py-1 rounded text-xs ${item._type === 'product' ? 'bg-purple-100 text-purple-700' : 'bg-blue-100 text-blue-700'}`}>
                                  {item._type}
                                </span>
                                <button onClick={() => removeFromCompare(idx)} className="text-red-500 hover:text-red-700 ml-2">âœ•</button>
                              </div>
                            </th>
                          ))}
                        </tr>
                      </thead>
                      <tbody>
                        {Object.keys(compareItems[0] || {}).filter(k => k !== '_type').map((key, keyIdx) => (
                          <tr key={keyIdx} className="border-b border-gray-200">
                            <td className="px-4 py-3 font-medium bg-gray-50">{key}</td>
                            {compareItems.map((item, idx) => (
                              <td key={idx} className="px-4 py-3">{String(item[key] || '-').substring(0, 50)}</td>
                            ))}
                          </tr>
                        ))}
                      </tbody>
                    </table>
                  </div>
                )}
              </div>
            )}

            {/* Bundle Price Calculator Panel */}
            {showPriceCalculator && (
              <div className="bg-white rounded-xl shadow-lg p-6 mb-6 border-2 border-emerald-200">
                <div className="flex justify-between items-center mb-4">
                  <div>
                    <h2 className="text-xl font-bold text-emerald-800">ðŸ§® Bundle Price Calculator</h2>
                    <p className="text-sm text-gray-600">See full price breakdown and simulate add-on changes</p>
                  </div>
                  <button onClick={() => setShowPriceCalculator(false)} className="text-gray-400 hover:text-gray-600">âœ•</button>
                </div>
                
                {bundles.length === 0 ? (
                  <div className="text-center py-8 text-gray-500">
                    <p className="text-lg mb-2">ðŸ“ No bundles loaded</p>
                    <p className="text-sm">Upload your bundles data to use the Price Calculator</p>
                  </div>
                ) : (
                  <div className="space-y-4">
                    {/* Bundle Selector */}
                    <div>
                      <label className="block text-sm font-medium text-gray-700 mb-2">Select a Bundle</label>
                      <select 
                        onChange={(e) => {
                          const bundle = bundles.find(b => String(b.ID) === e.target.value);
                          setSelectedBundle(bundle);
                          setCalculatorAddons([]);
                        }}
                        className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500"
                      >
                        <option value="">-- Choose a bundle --</option>
                        {bundles.slice(0, 200).map((b, idx) => (
                          <option key={idx} value={b.ID}>{b.ID} - {b.Name}</option>
                        ))}
                      </select>
                    </div>
                    
                    {/* Price Breakdown */}
                    {selectedBundle && (() => {
                      const breakdown = getBundlePriceBreakdown(selectedBundle);
                      if (!breakdown) return null;
                      
                      return (
                        <div className="space-y-4">
                          {/* Bundle Header */}
                          <div className="bg-emerald-50 rounded-lg p-4 border border-emerald-200">
                            <h3 className="font-bold text-lg text-emerald-900">{breakdown.bundleName}</h3>
                            <p className="text-sm text-gray-600">{breakdown.description}</p>
                            <div className="flex gap-4 mt-2 text-sm">
                              <span className="px-2 py-1 bg-emerald-100 rounded">{breakdown.networkType}</span>
                              {breakdown.speed && <span className="px-2 py-1 bg-blue-100 rounded">{breakdown.speed} Mbps</span>}
                              <span className="px-2 py-1 bg-purple-100 rounded">{breakdown.contractMonths} months</span>
                              {breakdown.tier && <span className="px-2 py-1 bg-amber-100 rounded">Tier: {breakdown.tier}</span>}
                            </div>
                          </div>
                          
                          {/* Price Breakdown Grid */}
                          <div className="grid md:grid-cols-2 gap-4">
                            {/* Monthly Pricing */}
                            <div className="bg-white border border-gray-200 rounded-lg p-4">
                              <h4 className="font-semibold text-gray-800 mb-3">ðŸ’° Monthly Pricing</h4>
                              <div className="space-y-2 text-sm">
                                {breakdown.discountedPrice1 !== null && (
                                  <div className="flex justify-between">
                                    <span className="text-gray-600">Months 1-{breakdown.discountedLength1}:</span>
                                    <span className="font-bold text-emerald-600">Â£{breakdown.discountedPrice1?.toFixed(2)}/mo</span>
                                  </div>
                                )}
                                {breakdown.discountedPrice2 !== null && (
                                  <div className="flex justify-between">
                                    <span className="text-gray-600">Months {(breakdown.discountedLength1 || 0) + 1}-{(breakdown.discountedLength1 || 0) + (breakdown.discountedLength2 || 0)}:</span>
                                    <span className="font-bold text-amber-600">Â£{breakdown.discountedPrice2?.toFixed(2)}/mo</span>
                                  </div>
                                )}
                                {breakdown.ongoingPrice !== null && (
                                  <div className="flex justify-between">
                                    <span className="text-gray-600">Ongoing price:</span>
                                    <span className="font-bold text-gray-800">Â£{breakdown.ongoingPrice?.toFixed(2)}/mo</span>
                                  </div>
                                )}
                                <hr className="my-2" />
                                {breakdown.setupCostNow !== null && breakdown.setupCostNow > 0 && (
                                  <div className="flex justify-between">
                                    <span className="text-gray-600">Setup cost:</span>
                                    <span className="font-bold text-red-600">Â£{breakdown.setupCostNow?.toFixed(2)}</span>
                                  </div>
                                )}
                              </div>
                            </div>
                            
                            {/* 24-Month Summary */}
                            <div className="bg-gradient-to-br from-emerald-500 to-teal-600 text-white rounded-lg p-4">
                              <h4 className="font-semibold mb-3">ðŸ“Š 24-Month Total</h4>
                              <div className="text-3xl font-bold mb-2">Â£{breakdown.total24Month?.toFixed(2)}</div>
                              <div className="text-sm opacity-90">Average: Â£{breakdown.avgMonthly24?.toFixed(2)}/month</div>
                            </div>
                          </div>
                          
                          {/* Included Products */}
                          <div className="bg-white border border-gray-200 rounded-lg p-4">
                            <h4 className="font-semibold text-gray-800 mb-3">ðŸ“¦ Included Products (Bundles_RGU)</h4>
                            <div className="flex flex-wrap gap-2">
                              {breakdown.productDetails.map((p, i) => (
                                <span key={i} className="px-3 py-1 bg-blue-50 text-blue-800 rounded-full text-sm border border-blue-200">
                                  <span className="font-mono text-xs">{p.code}</span> - {p.name}
                                </span>
                              ))}
                            </div>
                          </div>
                          
                          {/* Included Add-ons */}
                          {breakdown.addonDetails.length > 0 && (
                            <div className="bg-white border border-gray-200 rounded-lg p-4">
                              <h4 className="font-semibold text-gray-800 mb-3">ðŸŽ Included Add-ons</h4>
                              <div className="flex flex-wrap gap-2">
                                {breakdown.addonDetails.map((p, i) => (
                                  <span key={i} className="px-3 py-1 bg-purple-50 text-purple-800 rounded-full text-sm border border-purple-200">
                                    <span className="font-mono text-xs">{p.code}</span> - {p.name}
                                  </span>
                                ))}
                              </div>
                            </div>
                          )}
                          
                          {/* Additional Codes */}
                          {breakdown.additionalCodes.length > 0 && (
                            <div className="bg-white border border-gray-200 rounded-lg p-4">
                              <h4 className="font-semibold text-gray-800 mb-3">âž• Additional Bundle Codes</h4>
                              <div className="flex flex-wrap gap-2">
                                {breakdown.additionalCodes.map((code, i) => {
                                  const p = products.find(pr => pr.Code === code);
                                  return (
                                    <span key={i} className="px-3 py-1 bg-gray-50 text-gray-800 rounded-full text-sm border border-gray-200">
                                      <span className="font-mono text-xs">{code}</span> {p ? `- ${p.Name}` : ''}
                                    </span>
                                  );
                                })}
                              </div>
                            </div>
                          )}
                          
                          {/* Excluded Add-ons */}
                          {breakdown.excludedAddons.length > 0 && (
                            <div className="bg-white border border-red-200 rounded-lg p-4">
                              <h4 className="font-semibold text-red-800 mb-3">ðŸš« Excluded Add-ons</h4>
                              <div className="flex flex-wrap gap-2">
                                {breakdown.excludedAddons.map((code, i) => {
                                  const p = products.find(pr => pr.Code === code);
                                  return (
                                    <span key={i} className="px-3 py-1 bg-red-50 text-red-800 rounded-full text-sm border border-red-200">
                                      <span className="font-mono text-xs">{code}</span> {p ? `- ${p.Name}` : ''}
                                    </span>
                                  );
                                })}
                              </div>
                            </div>
                          )}
                          
                          {/* Quick Actions */}
                          <div className="flex gap-2 mt-4">
                            <button 
                              onClick={() => {
                                setInput(`Tell me everything about bundle ${breakdown.bundleId} "${breakdown.bundleName}"`);
                                setActiveTab('chat');
                              }}
                              className="px-4 py-2 bg-emerald-600 text-white rounded-lg hover:bg-emerald-700 text-sm"
                            >
                              ðŸ¤– Ask AI About This Bundle
                            </button>
                            <button 
                              onClick={() => {
                                setSelectedProductCode(breakdown.includedProducts[0] || '');
                                setShowAddonViewer(true);
                              }}
                              className="px-4 py-2 bg-amber-600 text-white rounded-lg hover:bg-amber-700 text-sm"
                            >
                              ðŸ”— View Product Dependencies
                            </button>
                          </div>
                        </div>
                      );
                    })()}
                  </div>
                )}
              </div>
            )}

            {/* Add-on Impact Viewer Panel */}
            {showAddonViewer && (
              <div className="bg-white rounded-xl shadow-lg p-6 mb-6 border-2 border-amber-200">
                <div className="flex justify-between items-center mb-4">
                  <div>
                    <h2 className="text-xl font-bold text-amber-800">ðŸ”— Add-on / Product Impact Viewer</h2>
                    <p className="text-sm text-gray-600">See where any product code is used across the catalogue</p>
                  </div>
                  <button onClick={() => setShowAddonViewer(false)} className="text-gray-400 hover:text-gray-600">âœ•</button>
                </div>
                
                {bundles.length === 0 || products.length === 0 ? (
                  <div className="text-center py-8 text-gray-500">
                    <p className="text-lg mb-2">ðŸ“ No data loaded</p>
                    <p className="text-sm">Upload products and bundles to use the Impact Viewer</p>
                  </div>
                ) : (
                  <div className="space-y-4">
                    {/* Product Code Search */}
                    <div className="flex gap-2">
                      <input
                        type="text"
                        value={selectedProductCode}
                        onChange={(e) => setSelectedProductCode(e.target.value.toUpperCase())}
                        placeholder="Enter product code (e.g., P106879, A135733)"
                        className="flex-1 px-4 py-2 border border-amber-300 rounded-lg focus:ring-2 focus:ring-amber-500 focus:border-amber-500 font-mono"
                      />
                      <button 
                        onClick={() => setSelectedProductCode(selectedProductCode)}
                        className="px-6 py-2 bg-amber-600 text-white rounded-lg hover:bg-amber-700"
                      >
                        ðŸ” Search
                      </button>
                    </div>
                    
                    {/* Quick Suggestions */}
                    <div className="flex flex-wrap gap-2">
                      <span className="text-sm text-gray-500">Quick lookup:</span>
                      {products.slice(0, 12).map((p, i) => (
                        <button
                          key={i}
                          onClick={() => setSelectedProductCode(p.Code)}
                          className="px-2 py-1 bg-amber-50 text-amber-700 rounded text-xs hover:bg-amber-100 border border-amber-200"
                        >
                          {p.Code}
                        </button>
                      ))}
                    </div>
                    
                    {/* Impact Results */}
                    {selectedProductCode && (() => {
                      const impact = getProductImpact(selectedProductCode);
                      if (!impact) return <p className="text-gray-500">Product not found</p>;
                      
                      return (
                        <div className="space-y-4 mt-4">
                          {/* Product Header */}
                          <div className="bg-amber-50 rounded-lg p-4 border border-amber-200">
                            <div className="flex items-center gap-3">
                              <span className="text-2xl font-mono font-bold text-amber-800">{impact.productCode}</span>
                              <span className="text-lg text-gray-700">{impact.productName}</span>
                            </div>
                            <div className="flex gap-2 mt-2">
                              <span className="px-2 py-1 bg-amber-100 rounded text-sm">{impact.productType}</span>
                              <span className="px-2 py-1 bg-blue-100 rounded text-sm">{impact.productCategory}</span>
                            </div>
                          </div>
                          
                          {/* Impact Summary Cards */}
                          <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                            <div className="bg-red-50 rounded-lg p-4 text-center border border-red-200">
                              <div className="text-3xl font-bold text-red-600">{impact.totalBundlesAffected}</div>
                              <div className="text-sm text-gray-600">Bundles Use This</div>
                            </div>
                            <div className="bg-orange-50 rounded-lg p-4 text-center border border-orange-200">
                              <div className="text-3xl font-bold text-orange-600">{impact.percentOfCatalog}%</div>
                              <div className="text-sm text-gray-600">Of Catalogue</div>
                            </div>
                            <div className="bg-blue-50 rounded-lg p-4 text-center border border-blue-200">
                              <div className="text-3xl font-bold text-blue-600">{impact.usage.asCore.length}</div>
                              <div className="text-sm text-gray-600">As Core Product</div>
                            </div>
                            <div className="bg-purple-50 rounded-lg p-4 text-center border border-purple-200">
                              <div className="text-3xl font-bold text-purple-600">{impact.usage.asAddon.length}</div>
                              <div className="text-sm text-gray-600">As Add-on</div>
                            </div>
                          </div>
                          
                          {/* Usage Breakdown */}
                          <div className="grid md:grid-cols-2 gap-4">
                            {/* As Core */}
                            {impact.usage.asCore.length > 0 && (
                              <div className="bg-white border border-gray-200 rounded-lg p-4">
                                <h4 className="font-semibold text-blue-800 mb-2">ðŸ“¦ In Bundles_RGU ({impact.usage.asCore.length})</h4>
                                <div className="max-h-40 overflow-y-auto space-y-1">
                                  {impact.usage.asCore.slice(0, 20).map((b, i) => (
                                    <div key={i} className="text-sm p-2 bg-blue-50 rounded">
                                      <span className="font-mono text-blue-600">{b.ID}</span> - {b.Name}
                                    </div>
                                  ))}
                                  {impact.usage.asCore.length > 20 && (
                                    <p className="text-sm text-gray-500">...and {impact.usage.asCore.length - 20} more</p>
                                  )}
                                </div>
                              </div>
                            )}
                            
                            {/* As Add-on */}
                            {impact.usage.asAddon.length > 0 && (
                              <div className="bg-white border border-gray-200 rounded-lg p-4">
                                <h4 className="font-semibold text-purple-800 mb-2">ðŸŽ In Included_Addon ({impact.usage.asAddon.length})</h4>
                                <div className="max-h-40 overflow-y-auto space-y-1">
                                  {impact.usage.asAddon.slice(0, 20).map((b, i) => (
                                    <div key={i} className="text-sm p-2 bg-purple-50 rounded">
                                      <span className="font-mono text-purple-600">{b.ID}</span> - {b.Name}
                                    </div>
                                  ))}
                                  {impact.usage.asAddon.length > 20 && (
                                    <p className="text-sm text-gray-500">...and {impact.usage.asAddon.length - 20} more</p>
                                  )}
                                </div>
                              </div>
                            )}
                            
                            {/* As Excluded */}
                            {impact.usage.asExcluded.length > 0 && (
                              <div className="bg-white border border-red-200 rounded-lg p-4">
                                <h4 className="font-semibold text-red-800 mb-2">ðŸš« In Excluded_Addon ({impact.usage.asExcluded.length})</h4>
                                <div className="max-h-40 overflow-y-auto space-y-1">
                                  {impact.usage.asExcluded.slice(0, 20).map((b, i) => (
                                    <div key={i} className="text-sm p-2 bg-red-50 rounded">
                                      <span className="font-mono text-red-600">{b.ID}</span> - {b.Name}
                                    </div>
                                  ))}
                                </div>
                              </div>
                            )}
                          </div>
                          
                          {/* Related Products */}
                          {impact.relatedProducts.length > 0 && (
                            <div className="bg-white border border-gray-200 rounded-lg p-4">
                              <h4 className="font-semibold text-gray-800 mb-3">ðŸ”— Often Bundled With</h4>
                              <div className="flex flex-wrap gap-2">
                                {impact.relatedProducts.map((p, i) => (
                                  <button
                                    key={i}
                                    onClick={() => setSelectedProductCode(p.code)}
                                    className="px-3 py-1 bg-gray-50 hover:bg-gray-100 text-gray-800 rounded-full text-sm border border-gray-200"
                                  >
                                    <span className="font-mono text-xs">{p.code}</span> - {p.name} ({p.count}x)
                                  </button>
                                ))}
                              </div>
                            </div>
                          )}
                          
                          {/* Required Products */}
                          {impact.requiredProducts.length > 0 && (
                            <div className="bg-white border border-amber-200 rounded-lg p-4">
                              <h4 className="font-semibold text-amber-800 mb-3">âš ï¸ Required Products</h4>
                              <div className="flex flex-wrap gap-2">
                                {impact.requiredProducts.map((p, i) => (
                                  <button
                                    key={i}
                                    onClick={() => setSelectedProductCode(p.code)}
                                    className="px-3 py-1 bg-amber-50 hover:bg-amber-100 text-amber-800 rounded-full text-sm border border-amber-200"
                                  >
                                    <span className="font-mono text-xs">{p.code}</span> - {p.name}
                                  </button>
                                ))}
                              </div>
                            </div>
                          )}
                          
                          {/* Actions */}
                          <div className="flex gap-2">
                            <button 
                              onClick={() => {
                                setInput(`What bundles use product ${impact.productCode} "${impact.productName}" and what would happen if we removed it?`);
                                setActiveTab('chat');
                              }}
                              className="px-4 py-2 bg-amber-600 text-white rounded-lg hover:bg-amber-700 text-sm"
                            >
                              ðŸ¤– Ask AI About This Product
                            </button>
                            <button 
                              onClick={() => {
                                const csv = impact.affectedBundles.map(b => `${b.ID},${b.Name},${b.On_going_Monthly_Price}`).join('\n');
                                const blob = new Blob([`ID,Name,Price\n${csv}`], { type: 'text/csv' });
                                const url = URL.createObjectURL(blob);
                                const a = document.createElement('a');
                                a.href = url;
                                a.download = `bundles_using_${impact.productCode}.csv`;
                                a.click();
                              }}
                              className="px-4 py-2 bg-emerald-600 text-white rounded-lg hover:bg-emerald-700 text-sm"
                            >
                              ðŸ“¥ Export Affected Bundles
                            </button>
                          </div>
                        </div>
                      );
                    })()}
                  </div>
                )}
              </div>
            )}

            {/* Impact Analysis Panel */}
            {showImpactAnalysis && (
              <div className="bg-white rounded-xl shadow-lg p-6 mb-6 border-2 border-red-200">
                <div className="flex justify-between items-center mb-4">
                  <div>
                    <h2 className="text-xl font-bold text-red-800">ðŸ’¥ Impact Analysis</h2>
                    <p className="text-sm text-gray-600">What happens if we remove a product or change a bundle?</p>
                  </div>
                  <button onClick={() => setShowImpactAnalysis(false)} className="text-gray-400 hover:text-gray-600">âœ•</button>
                </div>
                
                {bundles.length === 0 ? (
                  <div className="text-center py-8 text-gray-500">
                    <p className="text-lg mb-2">ðŸ“ No bundles loaded</p>
                    <p className="text-sm">Upload your bundles data to use Impact Analysis</p>
                  </div>
                ) : (
                  <>
                    {/* Search Input */}
                    <div className="mb-4">
                      <div className="flex gap-2">
                        <input
                          type="text"
                          value={impactSearchTerm}
                          onChange={(e) => setImpactSearchTerm(e.target.value)}
                          onKeyDown={(e) => e.key === 'Enter' && runImpactAnalysis(impactSearchTerm)}
                          placeholder="Enter product name (e.g., Netflix, Disney+, M500, FTTP...)"
                          className="flex-1 px-4 py-3 border-2 border-red-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500 text-lg"
                        />
                        <button
                          onClick={() => runImpactAnalysis(impactSearchTerm)}
                          disabled={!impactSearchTerm.trim() || isAnalyzing}
                          className="px-6 py-3 bg-red-600 text-white rounded-lg font-semibold hover:bg-red-700 disabled:bg-gray-300 disabled:cursor-not-allowed"
                        >
                          {isAnalyzing ? 'ðŸ” Analyzing...' : 'ðŸ” Analyze Impact'}
                        </button>
                      </div>
                    </div>
                    
                    {/* Quick Suggestions */}
                    <div className="mb-4">
                      <p className="text-xs font-semibold text-gray-500 mb-2">Quick analyze:</p>
                      <div className="flex flex-wrap gap-2">
                        {getImpactSuggestions().map((suggestion, idx) => (
                          <button
                            key={idx}
                            onClick={() => { setImpactSearchTerm(suggestion); runImpactAnalysis(suggestion); }}
                            className="px-3 py-1.5 bg-red-50 text-red-700 rounded-full text-sm hover:bg-red-100 border border-red-200"
                          >
                            {suggestion}
                          </button>
                        ))}
                      </div>
                    </div>
                    
                    {/* Results */}
                    {impactResults && (
                      <div className="space-y-4 mt-6">
                        {/* Debug/confirmation info */}
                        <div className="text-xs text-gray-500 bg-slate-100 px-3 py-2 rounded-lg flex items-center gap-2">
                          <span className="w-2 h-2 bg-green-500 rounded-full"></span>
                          Scanned all <strong>{bundles.length}</strong> bundles â€¢ Found <strong>{impactResults.affectedCount}</strong> containing "<strong>{impactResults.searchTerm}</strong>"
                        </div>
                        
                        {/* Summary Cards */}
                        <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                          <div className="bg-red-50 rounded-lg p-4 text-center border border-red-200">
                            <div className="text-3xl font-bold text-red-600">{impactResults.affectedCount}</div>
                            <div className="text-sm text-gray-600">Bundles Affected</div>
                          </div>
                          <div className="bg-orange-50 rounded-lg p-4 text-center border border-orange-200">
                            <div className="text-3xl font-bold text-orange-600">{impactResults.affectedPercentage}%</div>
                            <div className="text-sm text-gray-600">Of Total Catalog</div>
                          </div>
                          <div className="bg-yellow-50 rounded-lg p-4 text-center border border-yellow-200">
                            <div className="text-3xl font-bold text-yellow-600">{impactResults.expiringIn30Days.length}</div>
                            <div className="text-sm text-gray-600">Expiring in 30 Days</div>
                          </div>
                          <div className="bg-purple-50 rounded-lg p-4 text-center border border-purple-200">
                            <div className="text-3xl font-bold text-purple-600">
                              {impactResults.totalRevenueAtRisk > 0 ? `Â£${impactResults.totalRevenueAtRisk.toFixed(0)}` : 'N/A'}
                            </div>
                            <div className="text-sm text-gray-600">Combined Price</div>
                          </div>
                        </div>
                        
                        {/* Alert Banner */}
                        {impactResults.affectedCount > 0 && (
                          <div className={`p-4 rounded-lg border-2 ${impactResults.affectedPercentage > 50 ? 'bg-red-100 border-red-400' : impactResults.affectedPercentage > 25 ? 'bg-orange-100 border-orange-400' : 'bg-yellow-100 border-yellow-400'}`}>
                            <p className="font-semibold">
                              {impactResults.affectedPercentage > 50 
                                ? `ðŸš¨ HIGH IMPACT: Removing "${impactResults.searchTerm}" affects more than half your bundles!`
                                : impactResults.affectedPercentage > 25 
                                ? `âš ï¸ MEDIUM IMPACT: Removing "${impactResults.searchTerm}" affects a significant portion of bundles.`
                                : `â„¹ï¸ LOW IMPACT: Removing "${impactResults.searchTerm}" affects a small number of bundles.`
                              }
                            </p>
                          </div>
                        )}
                        
                        {/* Category Breakdown */}
                        {Object.keys(impactResults.categoryBreakdown).length > 0 && (
                          <div className="bg-gray-50 rounded-lg p-4">
                            <h4 className="font-semibold mb-3">ðŸ“‚ Affected by Category</h4>
                            <div className="flex flex-wrap gap-2">
                              {Object.entries(impactResults.categoryBreakdown).map(([cat, count], idx) => (
                                <span key={idx} className="px-3 py-1 bg-white rounded-full text-sm border border-gray-200">
                                  {cat}: <strong>{count}</strong>
                                </span>
                              ))}
                            </div>
                          </div>
                        )}
                        
                        {/* Commonly Bundled With */}
                        {impactResults.commonTerms.length > 0 && (
                          <div className="bg-blue-50 rounded-lg p-4">
                            <h4 className="font-semibold mb-3 text-blue-800">ðŸ”— Often Bundled With "{impactResults.searchTerm}"</h4>
                            <div className="flex flex-wrap gap-2">
                              {impactResults.commonTerms.map(([term, count], idx) => (
                                <button 
                                  key={idx} 
                                  onClick={() => { setImpactSearchTerm(term); runImpactAnalysis(term); }}
                                  className="px-3 py-1 bg-white rounded-full text-sm border border-blue-200 hover:bg-blue-100"
                                >
                                  {term}: <strong>{count} bundles</strong>
                                </button>
                              ))}
                            </div>
                          </div>
                        )}
                        
                        {/* Expiring Soon Warning */}
                        {impactResults.expiringIn30Days.length > 0 && (
                          <div className="bg-red-50 rounded-lg p-4 border border-red-200">
                            <h4 className="font-semibold mb-3 text-red-800">ðŸš¨ Expiring Within 30 Days ({impactResults.expiringIn30Days.length})</h4>
                            <div className="overflow-x-auto">
                              <table className="w-full text-sm">
                                <thead className="bg-red-100">
                                  <tr>
                                    <th className="px-3 py-2 text-left">ID</th>
                                    <th className="px-3 py-2 text-left">Name</th>
                                    <th className="px-3 py-2 text-left">Days Left</th>
                                    {impactResults.columns.priceCol && <th className="px-3 py-2 text-left">Price</th>}
                                  </tr>
                                </thead>
                                <tbody>
                                  {impactResults.expiringIn30Days.slice(0, 5).map((bundle, idx) => (
                                    <tr key={idx} className="border-b border-red-100">
                                      <td className="px-3 py-2 font-mono text-xs">{bundle[impactResults.columns.idCol]}</td>
                                      <td className="px-3 py-2">{String(bundle[impactResults.columns.nameCol]).substring(0, 40)}</td>
                                      <td className="px-3 py-2"><span className="px-2 py-1 bg-red-200 text-red-800 rounded text-xs font-bold">{bundle.daysUntil} days</span></td>
                                      {impactResults.columns.priceCol && <td className="px-3 py-2">{bundle[impactResults.columns.priceCol]}</td>}
                                    </tr>
                                  ))}
                                </tbody>
                              </table>
                            </div>
                          </div>
                        )}
                        
                        {/* All Affected Bundles */}
                        <div className="bg-white rounded-lg border border-gray-200">
                          <div className="p-4 border-b border-gray-200 flex justify-between items-center">
                            <h4 className="font-semibold">ðŸ“‹ All Affected Bundles ({impactResults.affectedCount})</h4>
                            <button 
                              onClick={() => exportToExcel(impactResults.affectedBundles, `impact-${impactResults.searchTerm}-${Date.now()}.xlsx`, 'Affected Bundles')}
                              className="text-sm px-3 py-1 bg-green-100 text-green-700 rounded hover:bg-green-200 font-medium"
                            >
                              ðŸ“Š Export to Excel
                            </button>
                          </div>
                          <div className="overflow-x-auto max-h-64">
                            <table className="w-full text-sm">
                              <thead className="bg-gray-50 sticky top-0">
                                <tr>
                                  {Object.keys(impactResults.affectedBundles[0] || {}).filter(k => k !== 'daysUntil').slice(0, 6).map((col, idx) => (
                                    <th key={idx} className="px-3 py-2 text-left font-semibold text-gray-700">{col}</th>
                                  ))}
                                </tr>
                              </thead>
                              <tbody>
                                {impactResults.affectedBundles.slice(0, 20).map((bundle, idx) => (
                                  <tr key={idx} className="border-b border-gray-100 hover:bg-gray-50">
                                    {Object.entries(bundle).filter(([k]) => k !== 'daysUntil').slice(0, 6).map(([key, val], cIdx) => (
                                      <td key={cIdx} className="px-3 py-2">{String(val).substring(0, 30)}</td>
                                    ))}
                                  </tr>
                                ))}
                              </tbody>
                            </table>
                            {impactResults.affectedBundles.length > 20 && (
                              <div className="p-2 text-center text-gray-500 text-sm bg-gray-50">
                                ... and {impactResults.affectedBundles.length - 20} more bundles. Export to see all.
                              </div>
                            )}
                          </div>
                        </div>
                        
                        {/* Alternatives */}
                        {impactResults.alternatives.length > 0 && (
                          <div className="bg-green-50 rounded-lg p-4 border border-green-200">
                            <h4 className="font-semibold mb-3 text-green-800">âœ… Bundles WITHOUT "{impactResults.searchTerm}" (Potential Alternatives)</h4>
                            <p className="text-sm text-green-700 mb-3">These bundles don't include {impactResults.searchTerm} - could be alternatives or upsell targets:</p>
                            <div className="overflow-x-auto">
                              <table className="w-full text-sm">
                                <thead className="bg-green-100">
                                  <tr>
                                    <th className="px-3 py-2 text-left">ID</th>
                                    <th className="px-3 py-2 text-left">Name</th>
                                    {impactResults.columns.priceCol && <th className="px-3 py-2 text-left">Price</th>}
                                    {impactResults.columns.categoryCol && <th className="px-3 py-2 text-left">Category</th>}
                                  </tr>
                                </thead>
                                <tbody>
                                  {impactResults.alternatives.slice(0, 5).map((bundle, idx) => (
                                    <tr key={idx} className="border-b border-green-100">
                                      <td className="px-3 py-2 font-mono text-xs">{bundle[impactResults.columns.idCol]}</td>
                                      <td className="px-3 py-2">{String(bundle[impactResults.columns.nameCol]).substring(0, 40)}</td>
                                      {impactResults.columns.priceCol && <td className="px-3 py-2">{bundle[impactResults.columns.priceCol]}</td>}
                                      {impactResults.columns.categoryCol && <td className="px-3 py-2">{bundle[impactResults.columns.categoryCol]}</td>}
                                    </tr>
                                  ))}
                                </tbody>
                              </table>
                            </div>
                          </div>
                        )}
                        
                        {/* AI Analysis Button */}
                        <div className="bg-purple-50 rounded-lg p-4 border border-purple-200">
                          <h4 className="font-semibold mb-2 text-purple-800">ðŸ¤– Want deeper analysis?</h4>
                          <div className="flex flex-wrap gap-2">
                            <button 
                              onClick={() => { setShowImpactAnalysis(false); setActiveTab('chat'); setInput(`Analyze the impact of removing ${impactResults.searchTerm} from our bundles. What are the risks and what alternatives can we offer customers?`); }}
                              className="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 text-sm font-medium"
                            >
                              Ask AI for Recommendations
                            </button>
                            <button 
                              onClick={() => { setShowImpactAnalysis(false); setActiveTab('chat'); setInput(`Create a migration plan for customers currently on bundles with ${impactResults.searchTerm}. What similar bundles can we move them to?`); }}
                              className="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 text-sm font-medium"
                            >
                              Create Migration Plan
                            </button>
                          </div>
                        </div>
                      </div>
                    )}
                  </>
                )}
              </div>
            )}

            {/* Onboarding Wizard - Show when no data and onboarding not complete */}
            {showOnboarding && products.length === 0 && bundles.length === 0 && (
              <OnboardingWizard />
            )}
            
            {/* File Upload - Compact Design */}
            <div className="bg-white rounded-2xl shadow-soft border border-slate-100 p-5 mb-6">
              <div className="flex items-center justify-between mb-4">
                <div className="flex items-center gap-3">
                  <div className="w-10 h-10 bg-gradient-to-br from-emerald-400 to-teal-500 rounded-xl flex items-center justify-center">
                    <svg className="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"/></svg>
                  </div>
                  <div>
                    <h2 className="font-semibold text-gray-900">Upload Data</h2>
                    <p className="text-xs text-gray-500">Excel (.xlsx) or CSV files</p>
                  </div>
                </div>
              </div>
              
              <div className="grid md:grid-cols-2 gap-4">
                <label className="group cursor-pointer">
                  <div className="border-2 border-dashed border-slate-200 rounded-xl p-4 hover:border-indigo-400 hover:bg-indigo-50/50 transition-all">
                    <div className="flex items-center gap-3">
                      <div className="w-12 h-12 bg-indigo-100 rounded-xl flex items-center justify-center group-hover:bg-indigo-200 transition-colors">
                        <svg className="w-6 h-6 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"/></svg>
                      </div>
                      <div className="flex-1">
                        <p className="font-medium text-gray-900">Products</p>
                        <p className="text-xs text-gray-500">{products.length > 0 ? `âœ“ ${products.length} loaded` : 'No file selected'}</p>
                      </div>
                      {products.length > 0 && <span className="w-6 h-6 bg-emerald-100 rounded-full flex items-center justify-center"><svg className="w-4 h-4 text-emerald-600" fill="currentColor" viewBox="0 0 20 20"><path fillRule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clipRule="evenodd"/></svg></span>}
                    </div>
                    <input type="file" accept=".csv,.xlsx,.xls" onChange={(e) => handleFileUpload(e, 'products')} className="hidden" />
                  </div>
                </label>
                
                <label className="group cursor-pointer">
                  <div className="border-2 border-dashed border-slate-200 rounded-xl p-4 hover:border-purple-400 hover:bg-purple-50/50 transition-all">
                    <div className="flex items-center gap-3">
                      <div className="w-12 h-12 bg-purple-100 rounded-xl flex items-center justify-center group-hover:bg-purple-200 transition-colors">
                        <svg className="w-6 h-6 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"/></svg>
                      </div>
                      <div className="flex-1">
                        <p className="font-medium text-gray-900">Bundles</p>
                        <p className="text-xs text-gray-500">{bundles.length > 0 ? `âœ“ ${bundles.length} loaded` : 'No file selected'}</p>
                      </div>
                      {bundles.length > 0 && <span className="w-6 h-6 bg-emerald-100 rounded-full flex items-center justify-center"><svg className="w-4 h-4 text-emerald-600" fill="currentColor" viewBox="0 0 20 20"><path fillRule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clipRule="evenodd"/></svg></span>}
                    </div>
                    <input type="file" accept=".csv,.xlsx,.xls" onChange={(e) => handleFileUpload(e, 'bundles')} className="hidden" />
                  </div>
                </label>
              </div>
            </div>

            {/* Tabs */}
            <div className="bg-white rounded-2xl shadow-soft border border-slate-100 overflow-hidden">
              <div className="flex border-b border-slate-100">
                {[
                  { id: 'chat', label: 'AI Chat', icon: <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/></svg> },
                  { id: 'products', label: `Products`, count: products.length, icon: <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"/></svg> },
                  { id: 'bundles', label: `Bundles`, count: bundles.length, icon: <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"/></svg> },
                  { id: 'create', label: 'Create', icon: <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M12 4v16m8-8H4"/></svg> }
                ].map((tab) => (
                  <button 
                    key={tab.id} 
                    onClick={() => setActiveTab(tab.id)} 
                    className={`flex-1 flex items-center justify-center gap-2 px-6 py-4 text-sm font-medium transition-all relative ${
                      activeTab === tab.id 
                        ? 'text-indigo-600' 
                        : 'text-gray-500 hover:text-gray-700 hover:bg-slate-50'
                    }`}
                  >
                    {tab.icon}
                    <span>{tab.label}</span>
                    {tab.count !== undefined && (
                      <span className={`px-2 py-0.5 rounded-full text-xs font-semibold ${activeTab === tab.id ? 'bg-indigo-100 text-indigo-600' : 'bg-slate-100 text-gray-500'}`}>
                        {tab.count}
                      </span>
                    )}
                    {activeTab === tab.id && (
                      <span className="absolute bottom-0 left-0 right-0 h-0.5 bg-indigo-600"></span>
                    )}
                  </button>
                ))}
              </div>

              <div className="p-6">
                {/* Chat Tab */}
                {activeTab === 'chat' && (
                  <div>
                    {/* Chat Header */}
                    <div className="flex justify-between items-center mb-4">
                      <div className="flex items-center gap-2">
                        <div className="w-8 h-8 bg-gradient-to-br from-indigo-500 to-purple-600 rounded-lg flex items-center justify-center">
                          <svg className="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"/></svg>
                        </div>
                        <div>
                          <h3 className="font-semibold text-gray-900">AI Assistant</h3>
                          <p className="text-xs text-gray-500">Ask anything about your data</p>
                        </div>
                      </div>
                      <div className="flex items-center gap-2">
                        {messages.length > 0 && (
                          <button onClick={exportChat} className="pill bg-slate-100 text-gray-600 hover:bg-slate-200">
                            <span className="flex items-center gap-1.5"><svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/></svg> Export</span>
                          </button>
                        )}
                        <button onClick={() => setShowPromptLibrary(!showPromptLibrary)} className={`pill ${showPromptLibrary ? 'bg-indigo-600 text-white' : 'bg-indigo-50 text-indigo-600 hover:bg-indigo-100'}`}>
                          <span className="flex items-center gap-1.5"><svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"/></svg> Prompts</span>
                        </button>
                      </div>
                    </div>
                    
                    {/* Favorite Prompts */}
                    {favoritePrompts.length > 0 && (
                      <div className="mb-4 p-3 bg-amber-50 rounded-xl border border-amber-100">
                        <p className="text-xs font-semibold text-amber-700 mb-2 flex items-center gap-1"><svg className="w-4 h-4" fill="currentColor" viewBox="0 0 20 20"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"/></svg> Favorites</p>
                        <div className="flex flex-wrap gap-2">
                          {favoritePrompts.map((prompt, idx) => (
                            <div key={idx} className="flex items-center gap-1 bg-white rounded-lg border border-amber-200 overflow-hidden">
                              <button onClick={() => setInput(prompt)} className="px-3 py-1.5 text-xs text-amber-800 hover:bg-amber-100">{prompt.substring(0, 30)}...</button>
                              <button onClick={() => toggleFavoritePrompt(prompt)} className="px-2 py-1.5 text-amber-400 hover:text-amber-600 hover:bg-amber-100">Ã—</button>
                            </div>
                          ))}
                        </div>
                      </div>
                    )}
                    
                    {/* PROMPT LIBRARY - Always available, collapsible */}
                    {showPromptLibrary && (
                      <div className="mb-4 bg-gradient-to-r from-purple-50 to-blue-50 rounded-lg border border-purple-200 max-h-96 overflow-y-auto">
                        <div className="p-4 space-y-4">
                          <div className="flex justify-between items-center sticky top-0 bg-gradient-to-r from-purple-50 to-blue-50 pb-2">
                            <p className="font-semibold text-purple-800">ðŸ’¡ Prompt Library - Click any to use</p>
                            <button onClick={() => setShowPromptLibrary(false)} className="text-gray-400 hover:text-gray-600">âœ•</button>
                          </div>
                          
                          {/* Getting Started - No Data */}
                          {products.length === 0 && bundles.length === 0 && (
                            <div className="bg-white rounded-lg p-3 border border-gray-200">
                              <p className="text-xs font-semibold text-gray-500 mb-2">ðŸ“ GETTING STARTED</p>
                              <div className="flex flex-wrap gap-2">
                                {getSmartPrompts().gettingStarted.map((q, i) => (
                                  <button key={i} onClick={() => { setInput(q); setShowPromptLibrary(false); }} className="px-3 py-1.5 bg-gray-50 text-gray-700 rounded-full text-xs hover:bg-gray-100 border border-gray-200">{q}</button>
                                ))}
                              </div>
                            </div>
                          )}
                          
                          {/* Column-Specific Prompts */}
                          {bundles.length > 0 && getColumnSpecificPrompts().length > 0 && (
                            <div className="bg-white rounded-lg p-3 border border-purple-200">
                              <p className="text-xs font-semibold text-purple-600 mb-2">âœ¨ SUGGESTED FOR YOUR DATA</p>
                              <div className="flex flex-wrap gap-2">
                                {getColumnSpecificPrompts().map((q, i) => (
                                  <button key={i} onClick={() => { setInput(q); setShowPromptLibrary(false); }} className="px-3 py-1.5 bg-purple-50 text-purple-700 rounded-full text-xs hover:bg-purple-100 border border-purple-200">{q}</button>
                                ))}
                              </div>
                            </div>
                          )}
                          
                          {/* ROLE-BASED SECTIONS */}
                          {(products.length > 0 || bundles.length > 0) && (
                            <>
                              {/* Daily Stand-up */}
                              <div className="bg-white rounded-lg p-3 border border-amber-200">
                                <p className="text-xs font-semibold text-amber-600 mb-2">â˜€ï¸ DAILY STAND-UP</p>
                                <div className="flex flex-wrap gap-2">
                                  {getSmartPrompts().dailyStandUp.slice(0, 8).map((q, i) => (
                                    <button key={i} onClick={() => { setInput(q); setShowPromptLibrary(false); }} className="px-3 py-1.5 bg-amber-50 text-amber-700 rounded-full text-xs hover:bg-amber-100 border border-amber-200">{q}</button>
                                  ))}
                                </div>
                              </div>
                              
                              {/* Product Owner */}
                              <div className="bg-white rounded-lg p-3 border border-rose-200">
                                <p className="text-xs font-semibold text-rose-600 mb-2">ðŸ‘” PRODUCT OWNER</p>
                                <div className="flex flex-wrap gap-2">
                                  {getSmartPrompts().productOwner.slice(0, 10).map((q, i) => (
                                    <button key={i} onClick={() => { setInput(q); setShowPromptLibrary(false); }} className="px-3 py-1.5 bg-rose-50 text-rose-700 rounded-full text-xs hover:bg-rose-100 border border-rose-200">{q}</button>
                                  ))}
                                </div>
                              </div>
                              
                              {/* Business Analyst */}
                              <div className="bg-white rounded-lg p-3 border border-cyan-200">
                                <p className="text-xs font-semibold text-cyan-600 mb-2">ðŸ“Š BUSINESS ANALYST</p>
                                <div className="flex flex-wrap gap-2">
                                  {getSmartPrompts().businessAnalyst.slice(0, 10).map((q, i) => (
                                    <button key={i} onClick={() => { setInput(q); setShowPromptLibrary(false); }} className="px-3 py-1.5 bg-cyan-50 text-cyan-700 rounded-full text-xs hover:bg-cyan-100 border border-cyan-200">{q}</button>
                                  ))}
                                </div>
                              </div>
                              
                              {/* Developer */}
                              <div className="bg-white rounded-lg p-3 border border-slate-200">
                                <p className="text-xs font-semibold text-slate-600 mb-2">ðŸ’» DEVELOPER</p>
                                <div className="flex flex-wrap gap-2">
                                  {getSmartPrompts().developer.slice(0, 10).map((q, i) => (
                                    <button key={i} onClick={() => { setInput(q); setShowPromptLibrary(false); }} className="px-3 py-1.5 bg-slate-50 text-slate-700 rounded-full text-xs hover:bg-slate-100 border border-slate-200">{q}</button>
                                  ))}
                                </div>
                              </div>
                            </>
                          )}
                          
                          {/* LOOKUP SECTIONS */}
                          {bundles.length > 0 && (
                            <>
                              {/* Bundle Lookup */}
                              <div className="bg-white rounded-lg p-3 border border-purple-200">
                                <p className="text-xs font-semibold text-purple-600 mb-2">ðŸ”Ž BUNDLE LOOKUP</p>
                                <div className="flex flex-wrap gap-2">
                                  {getSmartPrompts().bundleLookup.slice(0, 10).map((q, i) => (
                                    <button key={i} onClick={() => { setInput(q); setShowPromptLibrary(false); }} className="px-3 py-1.5 bg-purple-50 text-purple-700 rounded-full text-xs hover:bg-purple-100 border border-purple-200">{q}</button>
                                  ))}
                                </div>
                              </div>
                              
                              {/* Content Lookup */}
                              <div className="bg-white rounded-lg p-3 border border-pink-200">
                                <p className="text-xs font-semibold text-pink-600 mb-2">ðŸ“º CONTENT LOOKUP</p>
                                <div className="flex flex-wrap gap-2">
                                  {getSmartPrompts().productLookup.map((q, i) => (
                                    <button key={i} onClick={() => { setInput(q); setShowPromptLibrary(false); }} className="px-3 py-1.5 bg-pink-50 text-pink-700 rounded-full text-xs hover:bg-pink-100 border border-pink-200">{q}</button>
                                  ))}
                                </div>
                              </div>
                              
                              {/* Configuration */}
                              <div className="bg-white rounded-lg p-3 border border-teal-200">
                                <p className="text-xs font-semibold text-teal-600 mb-2">âš™ï¸ CONFIGURATION</p>
                                <div className="flex flex-wrap gap-2">
                                  {getSmartPrompts().configurationQueries.slice(0, 10).map((q, i) => (
                                    <button key={i} onClick={() => { setInput(q); setShowPromptLibrary(false); }} className="px-3 py-1.5 bg-teal-50 text-teal-700 rounded-full text-xs hover:bg-teal-100 border border-teal-200">{q}</button>
                                  ))}
                                </div>
                              </div>
                              
                              {/* Pricing */}
                              <div className="bg-white rounded-lg p-3 border border-emerald-200">
                                <p className="text-xs font-semibold text-emerald-600 mb-2">ðŸ’° PRICING</p>
                                <div className="flex flex-wrap gap-2">
                                  {getSmartPrompts().pricingQueries.map((q, i) => (
                                    <button key={i} onClick={() => { setInput(q); setShowPromptLibrary(false); }} className="px-3 py-1.5 bg-emerald-50 text-emerald-700 rounded-full text-xs hover:bg-emerald-100 border border-emerald-200">{q}</button>
                                  ))}
                                </div>
                              </div>
                            </>
                          )}
                          
                          {/* Data Quality */}
                          {(products.length > 0 || bundles.length > 0) && (
                            <div className="bg-white rounded-lg p-3 border border-orange-200">
                              <p className="text-xs font-semibold text-orange-600 mb-2">ðŸ” DATA QUALITY</p>
                              <div className="flex flex-wrap gap-2">
                                {getSmartPrompts().dataQuality.map((q, i) => (
                                  <button key={i} onClick={() => { setInput(q); setShowPromptLibrary(false); }} className="px-3 py-1.5 bg-orange-50 text-orange-700 rounded-full text-xs hover:bg-orange-100 border border-orange-200">{q}</button>
                                ))}
                              </div>
                            </div>
                          )}
                          
                          {/* Reports */}
                          {(products.length > 0 || bundles.length > 0) && (
                            <div className="bg-white rounded-lg p-3 border border-indigo-200">
                              <p className="text-xs font-semibold text-indigo-600 mb-2">ðŸ“ˆ REPORTS</p>
                              <div className="flex flex-wrap gap-2">
                                {getSmartPrompts().reporting.map((q, i) => (
                                  <button key={i} onClick={() => { setInput(q); setShowPromptLibrary(false); }} className="px-3 py-1.5 bg-indigo-50 text-indigo-700 rounded-full text-xs hover:bg-indigo-100 border border-indigo-200">{q}</button>
                                ))}
                              </div>
                            </div>
                          )}
                        </div>
                      </div>
                    )}
                    
                    <div className="h-96 overflow-y-auto mb-4 space-y-4 p-4 bg-slate-50 rounded-xl">
                      {messages.length === 0 ? (
                        <div className="text-center text-gray-500 mt-8">
                          <div className="w-16 h-16 bg-gradient-to-br from-indigo-100 to-purple-100 rounded-2xl flex items-center justify-center mx-auto mb-4">
                            <svg className="w-8 h-8 text-indigo-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/></svg>
                          </div>
                          <p className="text-lg font-medium text-gray-700 mb-1">Start a conversation</p>
                          <p className="text-sm text-gray-500 mb-4">
                            {products.length === 0 && bundles.length === 0 ? "Upload your data to get started" : `Ready to analyze ${products.length} products and ${bundles.length} bundles`}
                          </p>
                          <button onClick={() => setShowPromptLibrary(true)} className="pill bg-indigo-50 text-indigo-600 hover:bg-indigo-100">
                            <span className="flex items-center gap-1.5"><svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"/></svg> Browse Prompt Library</span>
                          </button>
                        </div>
                      ) : (
                        messages.map((msg, idx) => (
                          <div key={idx} className={`flex ${msg.role === 'user' ? 'justify-end' : 'justify-start'} animate-fadeIn`}>
                            <div className={`max-w-4xl px-4 py-3 rounded-2xl ${
                              msg.role === 'user' 
                                ? 'bg-gradient-to-r from-indigo-600 to-purple-600 text-white' 
                                : msg.role === 'system' 
                                ? 'bg-amber-50 text-amber-800 border border-amber-200' 
                                : 'bg-white text-gray-800 shadow-soft border border-slate-100'
                            }`}>
                              {msg.role === 'assistant' ? renderFormattedMessage(msg.content) : <pre className="whitespace-pre-wrap font-sans text-sm">{msg.content}</pre>}
                              {msg.role === 'user' && (
                                <button onClick={() => toggleFavoritePrompt(msg.content)} className="mt-2 text-xs opacity-70 hover:opacity-100 flex items-center gap-1" title={favoritePrompts.includes(msg.content) ? 'Remove from favorites' : 'Add to favorites'}>
                                  <svg className="w-3 h-3" fill={favoritePrompts.includes(msg.content) ? 'currentColor' : 'none'} stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z"/></svg>
                                  {favoritePrompts.includes(msg.content) ? 'Saved' : 'Save'}
                                </button>
                              )}
                            </div>
                          </div>
                        ))
                      )}
                      {isLoading && (
                        <div className="flex justify-start animate-fadeIn">
                          <div className="bg-white px-4 py-3 rounded-2xl shadow-soft border border-slate-100">
                            <div className="flex items-center gap-1">
                              <span className="w-2 h-2 bg-indigo-500 rounded-full animate-bounce" style={{animationDelay: '0ms'}}></span>
                              <span className="w-2 h-2 bg-indigo-400 rounded-full animate-bounce" style={{animationDelay: '150ms'}}></span>
                              <span className="w-2 h-2 bg-indigo-300 rounded-full animate-bounce" style={{animationDelay: '300ms'}}></span>
                            </div>
                          </div>
                        </div>
                      )}
                      <div ref={messagesEndRef} />
                    </div>

                    <form onSubmit={handleSubmit} className="flex gap-3">
                      <div className="flex-1 relative">
                        <input 
                          type="text" 
                          value={input} 
                          onChange={(e) => setInput(e.target.value)} 
                          placeholder="Ask anything about your data..." 
                          className="w-full px-4 py-3.5 bg-slate-50 border border-slate-200 rounded-xl text-gray-900 placeholder-gray-400 focus:bg-white focus:border-indigo-500" 
                        />
                      </div>
                      <button
                        type="submit"
                        disabled={!input.trim() || isLoading}
                        className="px-6 py-3.5 btn-primary text-white rounded-xl font-semibold disabled:opacity-50 disabled:cursor-not-allowed disabled:transform-none flex items-center gap-2"
                      >
                        {isLoading ? (
                          <svg className="animate-spin h-5 w-5" viewBox="0 0 24 24"><circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4" fill="none"/><path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"/></svg>
                        ) : (
                          <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"/></svg>
                        )}
                        <span className="hidden sm:inline">{isLoading ? 'Thinking...' : 'Send'}</span>
                      </button>
                    </form>
                    
                    {(products.length > 0 || bundles.length > 0) && messages.length > 0 && (
                      <div className="mt-3 space-y-2">
                        {/* Follow-up suggestions based on last query */}
                        {lastQueryType && getFollowUpPrompts().length > 0 && (
                          <div className="flex flex-wrap gap-2 items-center">
                            <span className="text-xs text-purple-600 font-semibold">ðŸ’¡ Follow-up:</span>
                            {getFollowUpPrompts().map((q, i) => (
                              <button key={i} onClick={() => setInput(q)} className="px-3 py-1 bg-purple-50 text-purple-700 rounded-full text-xs hover:bg-purple-100 border border-purple-200">{q}</button>
                            ))}
                          </div>
                        )}
                        
                        {/* Quick actions */}
                        <div className="flex flex-wrap gap-2 items-center">
                          <span className="text-xs text-gray-400">Quick:</span>
                          {bundles.length > 0 && (
                            <>
                              <button onClick={() => setInput("Which bundles end this year?")} className="px-3 py-1 bg-gray-50 text-gray-600 rounded-full text-xs hover:bg-gray-100 border border-gray-200">Ending 2025</button>
                              <button onClick={() => setInput("Show all bundles in a table")} className="px-3 py-1 bg-gray-50 text-gray-600 rounded-full text-xs hover:bg-gray-100 border border-gray-200">All bundles</button>
                              <button onClick={() => setInput("Show bundles with Netflix")} className="px-3 py-1 bg-gray-50 text-gray-600 rounded-full text-xs hover:bg-gray-100 border border-gray-200">Netflix bundles</button>
                            </>
                          )}
                          {products.length > 0 && (
                            <button onClick={() => setInput("Products not in any bundle")} className="px-3 py-1 bg-gray-50 text-gray-600 rounded-full text-xs hover:bg-gray-100 border border-gray-200">Unused products</button>
                          )}
                          <button onClick={() => setInput("Check for data errors")} className="px-3 py-1 bg-gray-50 text-gray-600 rounded-full text-xs hover:bg-gray-100 border border-gray-200">Check errors</button>
                          <button onClick={() => setInput("Give me a summary")} className="px-3 py-1 bg-gray-50 text-gray-600 rounded-full text-xs hover:bg-gray-100 border border-gray-200">Summary</button>
                        </div>
                      </div>
                    )}
                  </div>
                )}

                {/* Products Tab */}
                {activeTab === 'products' && (
                  <div>
                    <div className="flex justify-between items-center mb-4">
                      <h3 className="text-xl font-semibold">Your Products</h3>
                      <div className="flex gap-2">
                        {selectedItems.products.length > 0 && (
                          <>
                            <button onClick={() => deleteSelectedItems('products')} className="px-4 py-2 bg-red-600 text-white rounded-lg text-sm font-semibold">ðŸ—‘ï¸ Delete ({selectedItems.products.length})</button>
                            <button onClick={() => deselectAllItems('products')} className="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg text-sm font-semibold">Deselect</button>
                          </>
                        )}
                        {products.length > 0 && (
                          <>
                            <button onClick={() => selectAllItems('products')} className="px-4 py-2 bg-gray-100 text-gray-700 rounded-lg text-sm font-semibold">Select All</button>
                            <button onClick={() => runAISanityCheck(products, 'products')} disabled={isCheckingSanity} className="px-4 py-2 bg-gradient-to-r from-indigo-600 to-purple-600 text-white rounded-lg text-sm font-semibold disabled:opacity-50">
                              {isCheckingSanity ? 'ðŸ” Checking...' : 'ðŸ§  AI Check'}
                            </button>
                          </>
                        )}
                        <button onClick={() => initializeNewItem('product')} className="px-4 py-2 bg-purple-600 text-white rounded-lg text-sm font-semibold">âž• Add</button>
                        {products.length > 0 && (
                          <>
                            <button onClick={() => downloadCSV(products, 'products.csv')} className="px-4 py-2 bg-blue-600 text-white rounded-lg text-sm font-semibold">ðŸ’¾ CSV</button>
                            <button onClick={() => exportToExcel(products, 'products.xlsx', 'Products')} className="px-4 py-2 bg-green-600 text-white rounded-lg text-sm font-semibold">ðŸ“Š Excel</button>
                          </>
                        )}
                      </div>
                    </div>
                    
                    {products.length === 0 ? (
                      <div className="text-center py-12 text-gray-500">
                        <p className="text-lg">No products loaded yet.</p>
                        <p className="text-sm mt-2">Upload a CSV/Excel file or create one.</p>
                      </div>
                    ) : (
                      <div className="overflow-x-auto">
                        <table className="w-full text-sm">
                          <thead className="bg-purple-100 border-b-2 border-purple-300">
                            <tr>
                              <th className="px-4 py-3 text-left"><input type="checkbox" checked={selectedItems.products.length === products.length} onChange={() => selectedItems.products.length === products.length ? deselectAllItems('products') : selectAllItems('products')} /></th>
                              {Object.keys(products[0]).map((key, i) => (
                                <th key={i} className="px-4 py-3 text-left font-semibold text-gray-700">{key}</th>
                              ))}
                              <th className="px-4 py-3 text-left font-semibold text-gray-700">Actions</th>
                            </tr>
                          </thead>
                          <tbody>
                            {products.map((product, idx) => (
                              <tr key={idx} className={`border-b border-gray-200 hover:bg-purple-50 ${selectedItems.products.includes(idx) ? 'bg-purple-100' : ''}`}>
                                <td className="px-4 py-3"><input type="checkbox" checked={selectedItems.products.includes(idx)} onChange={() => toggleSelectItem('products', idx)} /></td>
                                {Object.values(product).map((val, i) => (
                                  <td key={i} className="px-4 py-3">{String(val).substring(0, 50)}</td>
                                ))}
                                <td className="px-4 py-3">
                                  <button onClick={() => addToCompare(product, 'product')} className="text-purple-600 hover:text-purple-800 text-xs font-semibold mr-2">Compare</button>
                                  <button onClick={() => startEdit('product', idx)} className="text-blue-600 hover:text-blue-800 text-xs font-semibold mr-2">Edit</button>
                                  <button onClick={() => deleteItem('product', idx)} className="text-red-600 hover:text-red-800 text-xs font-semibold">Delete</button>
                                </td>
                              </tr>
                            ))}
                          </tbody>
                        </table>
                      </div>
                    )}
                  </div>
                )}

                {/* Bundles Tab */}
                {activeTab === 'bundles' && (
                  <div>
                    <div className="flex justify-between items-center mb-4">
                      <h3 className="text-xl font-semibold">Your Bundles</h3>
                      <div className="flex gap-2">
                        {selectedItems.bundles.length > 0 && (
                          <>
                            <button onClick={() => deleteSelectedItems('bundles')} className="px-4 py-2 bg-red-600 text-white rounded-lg text-sm font-semibold">ðŸ—‘ï¸ Delete ({selectedItems.bundles.length})</button>
                            <button onClick={() => deselectAllItems('bundles')} className="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg text-sm font-semibold">Deselect</button>
                          </>
                        )}
                        {bundles.length > 0 && (
                          <>
                            <button onClick={() => selectAllItems('bundles')} className="px-4 py-2 bg-gray-100 text-gray-700 rounded-lg text-sm font-semibold">Select All</button>
                            <button onClick={() => runAISanityCheck(bundles, 'bundles')} disabled={isCheckingSanity} className="px-4 py-2 bg-gradient-to-r from-indigo-600 to-purple-600 text-white rounded-lg text-sm font-semibold disabled:opacity-50">
                              {isCheckingSanity ? 'ðŸ” Checking...' : 'ðŸ§  AI Check'}
                            </button>
                          </>
                        )}
                        <button onClick={() => initializeNewItem('bundle')} className="px-4 py-2 bg-blue-600 text-white rounded-lg text-sm font-semibold">âž• Add</button>
                        {bundles.length > 0 && (
                          <>
                            <button onClick={() => downloadCSV(bundles, 'bundles.csv')} className="px-4 py-2 bg-blue-600 text-white rounded-lg text-sm font-semibold">ðŸ’¾ CSV</button>
                            <button onClick={() => exportToExcel(bundles, 'bundles.xlsx', 'Bundles')} className="px-4 py-2 bg-green-600 text-white rounded-lg text-sm font-semibold">ðŸ“Š Excel</button>
                          </>
                        )}
                      </div>
                    </div>
                    
                    {bundles.length === 0 ? (
                      <div className="text-center py-12 text-gray-500">
                        <p className="text-lg">No bundles loaded yet.</p>
                        <p className="text-sm mt-2">Upload a CSV/Excel file or create one.</p>
                      </div>
                    ) : (
                      <div className="overflow-x-auto">
                        <table className="w-full text-sm">
                          <thead className="bg-blue-100 border-b-2 border-blue-300">
                            <tr>
                              <th className="px-4 py-3 text-left"><input type="checkbox" checked={selectedItems.bundles.length === bundles.length} onChange={() => selectedItems.bundles.length === bundles.length ? deselectAllItems('bundles') : selectAllItems('bundles')} /></th>
                              {Object.keys(bundles[0]).map((key, i) => (
                                <th key={i} className="px-4 py-3 text-left font-semibold text-gray-700">{key}</th>
                              ))}
                              <th className="px-4 py-3 text-left font-semibold text-gray-700">Actions</th>
                            </tr>
                          </thead>
                          <tbody>
                            {bundles.map((bundle, idx) => (
                              <tr key={idx} className={`border-b border-gray-200 hover:bg-blue-50 ${selectedItems.bundles.includes(idx) ? 'bg-blue-100' : ''}`}>
                                <td className="px-4 py-3"><input type="checkbox" checked={selectedItems.bundles.includes(idx)} onChange={() => toggleSelectItem('bundles', idx)} /></td>
                                {Object.values(bundle).map((val, i) => (
                                  <td key={i} className="px-4 py-3">{String(val).substring(0, 50)}</td>
                                ))}
                                <td className="px-4 py-3">
                                  <button onClick={() => addToCompare(bundle, 'bundle')} className="text-blue-600 hover:text-blue-800 text-xs font-semibold mr-2">Compare</button>
                                  <button onClick={() => startEdit('bundle', idx)} className="text-blue-600 hover:text-blue-800 text-xs font-semibold mr-2">Edit</button>
                                  <button onClick={() => deleteItem('bundle', idx)} className="text-red-600 hover:text-red-800 text-xs font-semibold">Delete</button>
                                </td>
                              </tr>
                            ))}
                          </tbody>
                        </table>
                      </div>
                    )}
                  </div>
                )}

                {/* Create Tab */}
                {activeTab === 'create' && (
                  <div className="max-w-3xl mx-auto">
                    <h3 className="text-2xl font-bold text-center mb-6">AI-Powered Creation Studio</h3>
                    
                    <div className="grid md:grid-cols-2 gap-4 mb-6">
                      <button onClick={() => initializeNewItem('product')} className="p-8 bg-white rounded-xl border-2 border-purple-300 hover:border-purple-500 hover:shadow-xl transition">
                        <div className="text-5xl mb-4">ðŸ“¦</div>
                        <h4 className="font-bold text-xl mb-2">Create Product</h4>
                        <p className="text-sm text-gray-600">Add a new product</p>
                      </button>
                      <button onClick={() => initializeNewItem('bundle')} className="p-8 bg-white rounded-xl border-2 border-blue-300 hover:border-blue-500 hover:shadow-xl transition">
                        <div className="text-5xl mb-4">ðŸŽ</div>
                        <h4 className="font-bold text-xl mb-2">Create Bundle</h4>
                        <p className="text-sm text-gray-600">Build a new bundle</p>
                      </button>
                    </div>

                    <div className="bg-white rounded-lg p-6 border border-purple-200">
                      <h4 className="font-bold mb-3 text-purple-900">ðŸ¤– Or Ask AI to Create</h4>
                      <div className="space-y-3">
                        <button onClick={() => askAIToCreate('product')} className="w-full px-6 py-4 bg-gradient-to-r from-purple-600 to-purple-700 text-white rounded-lg font-semibold text-left">âœ¨ Generate Product Suggestion</button>
                        <button onClick={() => askAIToCreate('bundle')} className="w-full px-6 py-4 bg-gradient-to-r from-blue-600 to-blue-700 text-white rounded-lg font-semibold text-left">âœ¨ Generate Bundle Suggestion</button>
                      </div>
                    </div>
                  </div>
                )}
              </div>
            </div>

            {/* Edit Modal */}
            {editingItem && (
              <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
                <div className="bg-white rounded-xl p-6 max-w-2xl w-full max-h-[80vh] overflow-y-auto">
                  <h3 className="text-2xl font-bold mb-4">Edit {editingType}</h3>
                  <div className="space-y-3">
                    {Object.entries(editingItem).filter(([key]) => key !== 'index').map(([key, value]) => (
                      <div key={key}>
                        <label className="block text-sm font-semibold text-gray-700 mb-1">{key}</label>
                        <input type="text" value={value} onChange={(e) => setEditingItem({...editingItem, [key]: e.target.value})} className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500" />
                      </div>
                    ))}
                  </div>
                  <div className="flex gap-3 mt-6">
                    <button onClick={saveEdit} className="flex-1 px-4 py-3 bg-green-600 text-white rounded-lg font-semibold">Save</button>
                    <button onClick={cancelEdit} className="flex-1 px-4 py-3 bg-gray-300 text-gray-700 rounded-lg font-semibold">Cancel</button>
                  </div>
                </div>
              </div>
            )}

            {/* Create Modal */}
            {showCreateForm && (
              <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
                <div className="bg-white rounded-xl p-6 max-w-2xl w-full max-h-[80vh] overflow-y-auto">
                  <h3 className="text-2xl font-bold mb-4">Create New {createType}</h3>
                  <div className="space-y-3">
                    {Object.keys(newItem).map((key) => (
                      <div key={key}>
                        <label className="block text-sm font-semibold text-gray-700 mb-1">{key}</label>
                        <input type="text" value={newItem[key]} onChange={(e) => setNewItem({...newItem, [key]: e.target.value})} className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500" placeholder={`Enter ${key}`} />
                      </div>
                    ))}
                  </div>
                  <div className="flex gap-3 mt-6">
                    <button onClick={saveNewItem} className="flex-1 px-4 py-3 bg-green-600 text-white rounded-lg font-semibold">Create</button>
                    <button onClick={() => setShowCreateForm(false)} className="flex-1 px-4 py-3 bg-gray-300 text-gray-700 rounded-lg font-semibold">Cancel</button>
                  </div>
                </div>
              </div>
            )}

            {/* Sanity Report Modal */}
            {showSanityReport && (
              <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
                <div className="bg-white rounded-xl p-6 max-w-3xl w-full max-h-[80vh] overflow-y-auto">
                  <div className="flex justify-between items-center mb-4">
                    <h3 className="text-2xl font-bold">ðŸ§  AI Sanity Check Report</h3>
                    <button onClick={() => setShowSanityReport(false)} className="text-gray-400 hover:text-gray-600 text-2xl">âœ•</button>
                  </div>
                  
                  {isCheckingSanity && (
                    <div className="text-center py-12">
                      <div className="text-4xl animate-spin mb-4">ðŸ”</div>
                      <p className="text-lg">Analyzing your data...</p>
                    </div>
                  )}
                  
                  {sanityReport && !isCheckingSanity && (
                    <div>
                      {sanityReport.error ? (
                        <div className="bg-red-50 border border-red-200 rounded-lg p-4"><p className="text-red-700">Error: {sanityReport.error}</p></div>
                      ) : (
                        <>
                          <div className="grid grid-cols-2 gap-4 mb-6">
                            <div className="bg-purple-50 rounded-lg p-4 text-center">
                              <div className="text-4xl font-bold text-purple-600">{sanityReport.qualityScore}/100</div>
                              <div className="text-sm text-gray-600">Quality Score</div>
                            </div>
                            <div className="bg-green-50 rounded-lg p-4 text-center">
                              <div className="text-4xl font-bold text-green-600">{sanityReport.completeness}%</div>
                              <div className="text-sm text-gray-600">Completeness</div>
                            </div>
                          </div>
                          
                          {sanityReport.critical?.length > 0 && (
                            <div className="mb-4">
                              <h4 className="font-bold text-red-700 mb-2">ðŸ”´ Critical Issues</h4>
                              {sanityReport.critical.map((issue, idx) => (
                                <div key={idx} className="bg-red-50 border border-red-200 rounded p-3 mb-2">
                                  <p className="font-medium">{issue.issue}</p>
                                  <p className="text-sm text-gray-600">{issue.fix}</p>
                                </div>
                              ))}
                            </div>
                          )}
                          
                          {sanityReport.warnings?.length > 0 && (
                            <div className="mb-4">
                              <h4 className="font-bold text-yellow-700 mb-2">ðŸŸ¡ Warnings</h4>
                              {sanityReport.warnings.map((warning, idx) => (
                                <div key={idx} className="bg-yellow-50 border border-yellow-200 rounded p-3 mb-2">
                                  <p className="font-medium">{warning.issue}</p>
                                  <p className="text-sm text-gray-600">{warning.suggestion}</p>
                                </div>
                              ))}
                            </div>
                          )}
                          
                          {sanityReport.suggestions?.length > 0 && (
                            <div>
                              <h4 className="font-bold text-blue-700 mb-2">ðŸ’¡ Suggestions</h4>
                              {sanityReport.suggestions.map((suggestion, idx) => (
                                <div key={idx} className="bg-blue-50 border border-blue-200 rounded p-3 mb-2">
                                  <p className="font-medium">{suggestion.title}</p>
                                  <p className="text-sm text-gray-600">{suggestion.description}</p>
                                </div>
                              ))}
                            </div>
                          )}
                        </>
                      )}
                    </div>
                  )}
                </div>
              </div>
            )}
          </div>
        </div>
      );
    }

    ReactDOM.render(<App />, document.getElementById('root'));
  </script>
</body>
</html>
