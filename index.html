<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AI Product Catalog Manager</title>
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script src="https://unpkg.com/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useRef, useEffect } = React;

    // Backend API URL - Your Railway deployment
    const API_URL = 'https://product-catalog-ai-production.up.railway.app';

    function App() {
      // Authentication state
      const [isAuthenticated, setIsAuthenticated] = useState(false);
      const [authToken, setAuthToken] = useState(null);
      const [user, setUser] = useState(null);
      const [loginError, setLoginError] = useState('');
      const [isLoggingIn, setIsLoggingIn] = useState(false);
      const [loginForm, setLoginForm] = useState({ username: '', password: '', rememberMe: false });

      const [products, setProducts] = useState([]);
      const [bundles, setBundles] = useState([]);
      const [messages, setMessages] = useState([]);
      const [input, setInput] = useState("");
      const [isLoading, setIsLoading] = useState(false);
      const [activeTab, setActiveTab] = useState('chat');
      const [editingItem, setEditingItem] = useState(null);
      const [editingType, setEditingType] = useState(null);
      const [createType, setCreateType] = useState('product');
      const [newItem, setNewItem] = useState({});
      const [showCreateForm, setShowCreateForm] = useState(false);
      const [searchQuery, setSearchQuery] = useState('');
      const [searchResults, setSearchResults] = useState({ products: [], bundles: [] });
      const [showSearchResults, setShowSearchResults] = useState(false);
      const [showSanityReport, setShowSanityReport] = useState(false);
      const [sanityReport, setSanityReport] = useState(null);
      const [isCheckingSanity, setIsCheckingSanity] = useState(false);
      const messagesEndRef = useRef(null);
      const searchInputRef = useRef(null);

      const scrollToBottom = () => {
        messagesEndRef.current?.scrollIntoView({ behavior: "smooth" });
      };

      useEffect(() => {
        scrollToBottom();
      }, [messages]);

      // Check for existing session on load
      useEffect(() => {
        const storedToken = localStorage.getItem('auth_token');
        const storedUser = localStorage.getItem('auth_user');
        
        if (storedToken && storedUser) {
          setAuthToken(storedToken);
          setUser(JSON.parse(storedUser));
          setIsAuthenticated(true);
          verifyToken(storedToken);
        }
      }, []);

      // Verify token is still valid
      const verifyToken = async (token) => {
        try {
          const response = await fetch(`${API_URL}/api/auth/me`, {
            headers: {
              'Authorization': `Bearer ${token}`
            }
          });
          
          if (!response.ok) {
            handleLogout();
          }
        } catch (error) {
          console.error('Token verification failed:', error);
        }
      };

      // Login handler
      const handleLogin = async (e) => {
        e.preventDefault();
        setLoginError('');
        setIsLoggingIn(true);

        try {
          const response = await fetch(`${API_URL}/api/auth/login`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({
              username: loginForm.username,
              password: loginForm.password,
              rememberMe: loginForm.rememberMe
            })
          });

          const data = await response.json();

          if (!response.ok) {
            setLoginError(data.error || 'Login failed');
            return;
          }

          // Store auth data
          localStorage.setItem('auth_token', data.token);
          localStorage.setItem('auth_user', JSON.stringify(data.user));
          
          if (data.refreshToken) {
            localStorage.setItem('refresh_token', data.refreshToken);
          }

          setAuthToken(data.token);
          setUser(data.user);
          setIsAuthenticated(true);
          addMessage('system', `‚úÖ Welcome back, ${data.user.username}! AI features are ready.`);

        } catch (error) {
          setLoginError('Connection failed. Please check your internet connection.');
          console.error('Login error:', error);
        } finally {
          setIsLoggingIn(false);
        }
      };

      // Logout handler
      const handleLogout = async () => {
        try {
          if (authToken) {
            await fetch(`${API_URL}/api/auth/logout`, {
              method: 'POST',
              headers: {
                'Authorization': `Bearer ${authToken}`
              }
            });
          }
        } catch (error) {
          console.error('Logout error:', error);
        }

        localStorage.removeItem('auth_token');
        localStorage.removeItem('auth_user');
        localStorage.removeItem('refresh_token');
        
        setAuthToken(null);
        setUser(null);
        setIsAuthenticated(false);
        setLoginForm({ username: '', password: '', rememberMe: false });
      };

      // Refresh token if needed
      const refreshAuthToken = async () => {
        const refreshToken = localStorage.getItem('refresh_token');
        if (!refreshToken) return false;

        try {
          const response = await fetch(`${API_URL}/api/auth/refresh`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({ refreshToken })
          });

          if (!response.ok) return false;

          const data = await response.json();
          localStorage.setItem('auth_token', data.token);
          setAuthToken(data.token);
          return true;
        } catch (error) {
          return false;
        }
      };

      // Keyboard shortcut for search
      useEffect(() => {
        const handleKeyDown = (e) => {
          if ((e.metaKey || e.ctrlKey) && e.key === 'k') {
            e.preventDefault();
            searchInputRef.current?.focus();
          }
        };
        
        document.addEventListener('keydown', handleKeyDown);
        return () => document.removeEventListener('keydown', handleKeyDown);
      }, []);

      // Perform fuzzy search
      const performSearch = (query) => {
        if (!query.trim()) {
          setSearchResults({ products: [], bundles: [] });
          setShowSearchResults(false);
          return;
        }

        const searchTerm = query.toLowerCase();
        
        const productMatches = products.filter(product => {
          return Object.values(product).some(value => 
            String(value).toLowerCase().includes(searchTerm)
          );
        }).slice(0, 50);

        const bundleMatches = bundles.filter(bundle => {
          return Object.values(bundle).some(value => 
            String(value).toLowerCase().includes(searchTerm)
          );
        }).slice(0, 50);

        setSearchResults({ products: productMatches, bundles: bundleMatches });
        setShowSearchResults(true);
      };

      useEffect(() => {
        const timer = setTimeout(() => {
          performSearch(searchQuery);
        }, 300);
        return () => clearTimeout(timer);
      }, [searchQuery, products, bundles]);

      const clearSearch = () => {
        setSearchQuery('');
        setSearchResults({ products: [], bundles: [] });
        setShowSearchResults(false);
      };

      // AI Sanity Checker
      const runAISanityCheck = async (data, type) => {
        if (!isAuthenticated) {
          alert('Please login to use AI Sanity Check');
          return;
        }

        if (data.length === 0) {
          alert(`No ${type} to check!`);
          return;
        }

        setIsCheckingSanity(true);
        setShowSanityReport(true);
        setSanityReport(null);

        try {
          const sampleData = data.slice(0, 50);
          const columns = Object.keys(data[0] || {});

          const prompt = `You are a data quality expert. Analyze this ${type} catalog data and provide a sanity check report.

DATA SAMPLE (${data.length} total rows, showing first ${sampleData.length}):
${JSON.stringify(sampleData, null, 2)}

COLUMNS: ${columns.join(', ')}

Return ONLY valid JSON:
{
  "qualityScore": 85,
  "completeness": 92,
  "critical": [{"issue": "...", "count": 5, "fix": "..."}],
  "warnings": [{"issue": "...", "suggestion": "..."}],
  "suggestions": [{"title": "...", "description": "..."}],
  "statistics": {"totalRows": ${data.length}, "completeRows": 92, "issuesFound": 8, "fieldsAnalyzed": ${columns.length}}
}`;

          const response = await callClaudeAPI(prompt, true);
          
          let jsonResponse = response.trim();
          jsonResponse = jsonResponse.replace(/```json\n?/g, '').replace(/```\n?/g, '').trim();
          
          const aiReport = JSON.parse(jsonResponse);
          setSanityReport({ ...aiReport, dataType: type, totalRows: data.length });
          addMessage('system', `‚úÖ Sanity check complete! Quality score: ${aiReport.qualityScore}/100`);
          
        } catch (error) {
          console.error('Sanity check error:', error);
          addMessage('system', `‚ùå Sanity check failed: ${error.message}`);
          setSanityReport({ error: error.message });
        } finally {
          setIsCheckingSanity(false);
        }
      };

      const handleFileUpload = (e, type) => {
        const file = e.target.files[0];
        if (!file) return;

        if (file.name.endsWith('.xlsx') || file.name.endsWith('.xls')) {
          const reader = new FileReader();
          reader.onload = (evt) => {
            try {
              const data = new Uint8Array(evt.target.result);
              const workbook = XLSX.read(data, { type: 'array' });
              const firstSheet = workbook.SheetNames[0];
              const sheetData = XLSX.utils.sheet_to_json(workbook.Sheets[firstSheet], { defval: '' });
              
              if (type === 'products') {
                setProducts(sheetData);
                addMessage('system', `‚úÖ Loaded ${sheetData.length} products from Excel`);
              } else {
                setBundles(sheetData);
                addMessage('system', `‚úÖ Loaded ${sheetData.length} bundles from Excel`);
              }
            } catch (error) {
              addMessage('system', `‚ùå Error reading Excel: ${error.message}`);
            }
          };
          reader.readAsArrayBuffer(file);
          return;
        }

        Papa.parse(file, {
          header: true,
          skipEmptyLines: true,
          complete: (results) => {
            if (type === 'products') {
              setProducts(results.data);
              addMessage('system', `‚úÖ Loaded ${results.data.length} products`);
            } else {
              setBundles(results.data);
              addMessage('system', `‚úÖ Loaded ${results.data.length} bundles`);
            }
          },
          error: (error) => {
            addMessage('system', `‚ùå Error parsing ${type}: ${error.message}`);
          }
        });
      };

      const exportToExcel = (data, filename, type) => {
        const wb = XLSX.utils.book_new();
        const ws = XLSX.utils.json_to_sheet(data);
        XLSX.utils.book_append_sheet(wb, ws, type === 'products' ? 'Products' : 'Bundles');
        XLSX.writeFile(wb, filename);
        addMessage('system', `‚úÖ Exported to ${filename}`);
      };

      const addMessage = (role, content) => {
        setMessages(prev => [...prev, { role, content, timestamp: Date.now() }]);
      };

      // Call Claude API through secure backend
      const callClaudeAPI = async (userPrompt, useExtendedThinking = false) => {
        if (!isAuthenticated || !authToken) {
          throw new Error('Please login to use AI features');
        }

        try {
          let dataContext = '';
          
          if (products.length > 0) {
            dataContext += `\n\nPRODUCTS (${products.length} total):\n`;
            dataContext += `Columns: ${Object.keys(products[0]).join(', ')}\n\n`;
            
            if (products.length <= 100) {
              dataContext += `Complete products data:\n${JSON.stringify(products, null, 2)}\n`;
            } else {
              dataContext += `Sample products (first 20):\n${JSON.stringify(products.slice(0, 20), null, 2)}\n`;
            }
          }
          
          if (bundles.length > 0) {
            dataContext += `\n\nBUNDLES (${bundles.length} total):\n`;
            dataContext += `Columns: ${Object.keys(bundles[0]).join(', ')}\n\n`;
            
            if (bundles.length <= 100) {
              dataContext += `Complete bundles data:\n${JSON.stringify(bundles, null, 2)}\n`;
            } else {
              dataContext += `Sample bundles (first 20):\n${JSON.stringify(bundles.slice(0, 20), null, 2)}\n`;
            }
          }

          const systemPrompt = `You are an AI assistant helping manage a product catalog. You have DIRECT ACCESS to the user's data below.

${dataContext}

USER QUESTION: ${userPrompt}

INSTRUCTIONS:
- You HAVE the data above - analyze it directly
- Answer questions about products, bundles, pricing, relationships, etc.
- If asked to create new items, generate realistic examples
- Be specific and reference actual data`;

          // Call secure backend instead of direct API
          const response = await fetch(`${API_URL}/api/claude/completion`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              "Authorization": `Bearer ${authToken}`
            },
            body: JSON.stringify({
              messages: [{ role: "user", content: systemPrompt }],
              max_tokens: useExtendedThinking ? 4000 : 2000
            })
          });

          if (response.status === 401) {
            const refreshed = await refreshAuthToken();
            if (!refreshed) {
              handleLogout();
              throw new Error('Session expired. Please login again.');
            }
            return callClaudeAPI(userPrompt, useExtendedThinking);
          }

          if (!response.ok) {
            const errorData = await response.json().catch(() => ({}));
            throw new Error(errorData.error || `API failed: ${response.status}`);
          }

          const data = await response.json();
          return data.data.content[0].text;
        } catch (error) {
          throw error;
        }
      };

      const handleSubmit = async (e) => {
        e.preventDefault();
        if (!input.trim() || isLoading) return;

        if (!isAuthenticated) {
          addMessage('system', '‚ö†Ô∏è Please login to use AI features');
          return;
        }

        const userMessage = input;
        setInput("");
        addMessage('user', userMessage);
        setIsLoading(true);

        try {
          const response = await callClaudeAPI(userMessage, false);
          addMessage('assistant', response);
        } catch (error) {
          console.error("Error:", error);
          addMessage('system', `‚ùå Error: ${error.message}`);
        } finally {
          setIsLoading(false);
        }
      };

      const downloadCSV = (data, filename) => {
        const csv = Papa.unparse(data);
        const blob = new Blob([csv], { type: 'text/csv' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        a.click();
      };

      const deleteItem = (type, index) => {
        if (confirm(`Delete this ${type}?`)) {
          if (type === 'product') {
            const newProducts = [...products];
            newProducts.splice(index, 1);
            setProducts(newProducts);
            addMessage('system', `‚úÖ Product deleted`);
          } else {
            const newBundles = [...bundles];
            newBundles.splice(index, 1);
            setBundles(newBundles);
            addMessage('system', `‚úÖ Bundle deleted`);
          }
        }
      };

      const startEdit = (type, index) => {
        if (type === 'product') {
          setEditingItem({ ...products[index], index });
          setEditingType('product');
        } else {
          setEditingItem({ ...bundles[index], index });
          setEditingType('bundle');
        }
      };

      const saveEdit = () => {
        if (editingType === 'product') {
          const newProducts = [...products];
          const { index, ...itemData } = editingItem;
          newProducts[index] = itemData;
          setProducts(newProducts);
          addMessage('system', `‚úÖ Product updated`);
        } else {
          const newBundles = [...bundles];
          const { index, ...itemData } = editingItem;
          newBundles[index] = itemData;
          setBundles(newBundles);
          addMessage('system', `‚úÖ Bundle updated`);
        }
        setEditingItem(null);
        setEditingType(null);
      };

      const cancelEdit = () => {
        setEditingItem(null);
        setEditingType(null);
      };

      const initializeNewItem = (type) => {
        const template = type === 'product' 
          ? (products.length > 0 ? Object.keys(products[0]).reduce((acc, key) => ({ ...acc, [key]: '' }), {}) : { name: '', price: '', category: '', sku: '' })
          : (bundles.length > 0 ? Object.keys(bundles[0]).reduce((acc, key) => ({ ...acc, [key]: '' }), {}) : { name: '', products: '', price: '' });
        setNewItem(template);
        setCreateType(type);
        setShowCreateForm(true);
      };

      const saveNewItem = () => {
        if (createType === 'product') {
          setProducts([...products, newItem]);
          addMessage('system', `‚úÖ New product added!`);
        } else {
          setBundles([...bundles, newItem]);
          addMessage('system', `‚úÖ New bundle added!`);
        }
        setNewItem({});
        setShowCreateForm(false);
        setActiveTab(createType === 'product' ? 'products' : 'bundles');
      };

      const askAIToCreate = async (type) => {
        if (!isAuthenticated) {
          alert('Please login first');
          return;
        }

        setIsLoading(true);
        setActiveTab('chat');
        
        try {
          const prompt = type === 'product' 
            ? `Create a new product template based on my existing products. Give me a filled-out example with realistic values. Format it as JSON.`
            : `Create a new bundle template based on my existing bundles and products. Give me a filled-out example. Format it as JSON.`;
          
          addMessage('user', prompt);
          const response = await callClaudeAPI(prompt);
          addMessage('assistant', response + '\n\nüí° Copy the JSON and paste it into the create form!');
        } catch (error) {
          addMessage('system', `‚ùå Error: ${error.message}`);
        } finally {
          setIsLoading(false);
        }
      };

      // LOGIN SCREEN
      if (!isAuthenticated) {
        return (
          <div className="min-h-screen bg-gradient-to-br from-purple-600 via-blue-600 to-indigo-700 flex items-center justify-center p-4">
            <div className="bg-white rounded-2xl shadow-2xl p-8 max-w-md w-full">
              <div className="text-center mb-8">
                <div className="text-6xl mb-4">ü§ñ</div>
                <h1 className="text-3xl font-bold bg-gradient-to-r from-purple-600 to-blue-600 bg-clip-text text-transparent">
                  AI Product Catalog
                </h1>
                <p className="text-gray-500 mt-2">Sign in to access AI features</p>
              </div>

              <form onSubmit={handleLogin} className="space-y-4">
                {loginError && (
                  <div className="bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-lg text-sm">
                    {loginError}
                  </div>
                )}

                <div>
                  <label className="block text-sm font-semibold text-gray-700 mb-2">Username</label>
                  <input
                    type="text"
                    value={loginForm.username}
                    onChange={(e) => setLoginForm({...loginForm, username: e.target.value})}
                    className="w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                    placeholder="Enter username"
                    required
                  />
                </div>

                <div>
                  <label className="block text-sm font-semibold text-gray-700 mb-2">Password</label>
                  <input
                    type="password"
                    value={loginForm.password}
                    onChange={(e) => setLoginForm({...loginForm, password: e.target.value})}
                    className="w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                    placeholder="Enter password"
                    required
                  />
                </div>

                <div className="flex items-center">
                  <input
                    type="checkbox"
                    id="rememberMe"
                    checked={loginForm.rememberMe}
                    onChange={(e) => setLoginForm({...loginForm, rememberMe: e.target.checked})}
                    className="h-4 w-4 text-purple-600 focus:ring-purple-500 border-gray-300 rounded"
                  />
                  <label htmlFor="rememberMe" className="ml-2 text-sm text-gray-600">Remember me</label>
                </div>

                <button
                  type="submit"
                  disabled={isLoggingIn}
                  className="w-full py-3 bg-gradient-to-r from-purple-600 to-blue-600 text-white rounded-lg font-semibold hover:from-purple-700 hover:to-blue-700 transition disabled:opacity-50 disabled:cursor-not-allowed"
                >
                  {isLoggingIn ? 'Signing in...' : 'Sign In'}
                </button>
              </form>

              <div className="mt-6 p-4 bg-blue-50 rounded-lg">
                <p className="text-sm text-blue-800 font-medium mb-2">üîê Default Credentials:</p>
                <p className="text-xs text-blue-700">Admin: admin / admin123</p>
                <p className="text-xs text-blue-700">Demo: demo / demo123</p>
              </div>

              <div className="mt-4 text-center">
                <p className="text-xs text-gray-400">Secure authentication powered by JWT</p>
              </div>
            </div>
          </div>
        );
      }

      // MAIN APP (after login)
      return (
        <div className="min-h-screen bg-gradient-to-br from-purple-50 via-blue-50 to-indigo-100">
          <div className="container mx-auto px-4 py-6 max-w-7xl">
            
            {/* Header */}
            <div className="bg-white rounded-xl shadow-xl p-6 mb-6 border-t-4 border-purple-500">
              <div className="flex items-center justify-between mb-4">
                <div>
                  <h1 className="text-4xl font-bold bg-gradient-to-r from-purple-600 to-blue-600 bg-clip-text text-transparent mb-2">
                    ü§ñ AI Product Catalog Manager
                  </h1>
                  <p className="text-gray-600">AI-powered catalog management ‚Ä¢ Create, analyze, and optimize</p>
                </div>
                <div className="text-right">
                  <div className="flex items-center gap-3 mb-2">
                    <span className="text-sm text-gray-600">üë§ {user?.username}</span>
                    <span className="px-2 py-1 bg-green-100 text-green-800 rounded-full text-xs font-semibold">{user?.role}</span>
                    <button onClick={handleLogout} className="text-sm text-red-600 hover:text-red-800 underline">Logout</button>
                  </div>
                  <div className="text-sm text-gray-500">{products.length} products ‚Ä¢ {bundles.length} bundles</div>
                </div>
              </div>
              
              {/* Search Bar */}
              <div className="relative">
                <div className="flex gap-2">
                  <div className="flex-1 relative">
                    <div className="absolute left-4 top-1/2 transform -translate-y-1/2 text-gray-400">üîç</div>
                    <input
                      ref={searchInputRef}
                      type="text"
                      value={searchQuery}
                      onChange={(e) => setSearchQuery(e.target.value)}
                      placeholder="Search products, bundles, SKUs... (Cmd+K)"
                      className="w-full pl-12 pr-12 py-3 border-2 border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent text-lg"
                    />
                    {searchQuery && (
                      <button onClick={clearSearch} className="absolute right-4 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-gray-600 text-xl">‚úï</button>
                    )}
                  </div>
                </div>
                
                {/* Search Results */}
                {showSearchResults && (searchResults.products.length > 0 || searchResults.bundles.length > 0) && (
                  <div className="absolute top-full left-0 right-0 mt-2 bg-white border-2 border-purple-200 rounded-lg shadow-2xl z-50 max-h-96 overflow-y-auto">
                    <div className="p-4">
                      <div className="flex justify-between items-center mb-3">
                        <div className="font-bold text-lg">Search Results</div>
                        <button onClick={() => setShowSearchResults(false)} className="text-gray-400 hover:text-gray-600">‚úï</button>
                      </div>
                      
                      {searchResults.products.length > 0 && (
                        <div className="mb-4">
                          <div className="font-semibold text-purple-600 mb-2">Products ({searchResults.products.length})</div>
                          {searchResults.products.slice(0, 5).map((product, idx) => (
                            <div key={idx} className="p-2 hover:bg-purple-50 rounded border border-gray-100 mb-1">
                              <div className="font-medium">{product.name || product.Name || Object.values(product)[0]}</div>
                            </div>
                          ))}
                        </div>
                      )}
                      
                      {searchResults.bundles.length > 0 && (
                        <div>
                          <div className="font-semibold text-blue-600 mb-2">Bundles ({searchResults.bundles.length})</div>
                          {searchResults.bundles.slice(0, 5).map((bundle, idx) => (
                            <div key={idx} className="p-2 hover:bg-blue-50 rounded border border-gray-100 mb-1">
                              <div className="font-medium">{bundle.name || bundle.Name || Object.values(bundle)[0]}</div>
                            </div>
                          ))}
                        </div>
                      )}
                    </div>
                  </div>
                )}
              </div>
            </div>

            {/* Status Bar */}
            <div className="bg-green-50 border border-green-200 rounded-lg p-3 mb-6 flex items-center justify-between">
              <span className="text-green-800 text-sm font-medium">‚úÖ AI Enabled - Secure Connection</span>
              <span className="text-xs text-green-600">Backend: Railway</span>
            </div>

            {/* File Upload */}
            <div className="bg-white rounded-xl shadow-lg p-6 mb-6">
              <div className="flex items-center justify-between mb-4">
                <h2 className="text-xl font-semibold text-gray-800">üìÅ Upload Your Data</h2>
                <div className="flex items-center gap-2 bg-green-50 border border-green-200 rounded-lg px-4 py-2">
                  <span className="text-2xl">üìä</span>
                  <span className="text-sm font-semibold text-green-800">Excel & CSV Supported!</span>
                </div>
              </div>

              <div className="grid md:grid-cols-2 gap-4">
                <div className="border-2 border-dashed border-purple-300 rounded-lg p-4 hover:border-purple-500 transition bg-gradient-to-br from-purple-50 to-white">
                  <label className="block text-sm font-medium text-gray-700 mb-2">
                    Products {products.length > 0 && <span className="text-green-600">‚úì {products.length} loaded</span>}
                  </label>
                  <input
                    type="file"
                    accept=".csv,.xlsx,.xls"
                    onChange={(e) => handleFileUpload(e, 'products')}
                    className="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-purple-50 file:text-purple-700 hover:file:bg-purple-100 cursor-pointer"
                  />
                </div>
                <div className="border-2 border-dashed border-blue-300 rounded-lg p-4 hover:border-blue-500 transition bg-gradient-to-br from-blue-50 to-white">
                  <label className="block text-sm font-medium text-gray-700 mb-2">
                    Bundles {bundles.length > 0 && <span className="text-green-600">‚úì {bundles.length} loaded</span>}
                  </label>
                  <input
                    type="file"
                    accept=".csv,.xlsx,.xls"
                    onChange={(e) => handleFileUpload(e, 'bundles')}
                    className="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100 cursor-pointer"
                  />
                </div>
              </div>
            </div>

            {/* Tabs */}
            <div className="bg-white rounded-xl shadow-lg mb-6 overflow-hidden">
              <div className="flex border-b border-gray-200">
                {['chat', 'products', 'bundles', 'create'].map((tab) => (
                  <button
                    key={tab}
                    onClick={() => setActiveTab(tab)}
                    className={`flex-1 px-6 py-4 font-semibold transition ${
                      activeTab === tab
                        ? 'bg-gradient-to-r from-purple-500 to-blue-500 text-white'
                        : 'text-gray-600 hover:bg-gray-50'
                    }`}
                  >
                    {tab === 'chat' && 'üí¨ AI Chat'}
                    {tab === 'products' && `üì¶ Products (${products.length})`}
                    {tab === 'bundles' && `üéÅ Bundles (${bundles.length})`}
                    {tab === 'create' && '‚ûï Create New'}
                  </button>
                ))}
              </div>

              <div className="p-6">
                {/* Chat Tab */}
                {activeTab === 'chat' && (
                  <div>
                    <div className="h-96 overflow-y-auto mb-4 space-y-4 p-4 bg-gray-50 rounded-lg">
                      {messages.length === 0 ? (
                        <div className="text-center text-gray-500 mt-20">
                          <p className="text-lg mb-2">üëã Ask me anything!</p>
                          <p className="text-sm mb-4 text-gray-400">Upload files and I'll help you analyze them</p>
                          <div className="flex flex-wrap gap-2 justify-center max-w-2xl mx-auto">
                            {["üìä What's in my data?", "üîç Check for errors", "üí∞ Analyze pricing"].map((q, i) => (
                              <button
                                key={i}
                                onClick={() => setInput(q)}
                                className="px-4 py-2 bg-white text-purple-700 rounded-full text-sm hover:bg-purple-50 shadow-sm border border-purple-200"
                              >
                                {q}
                              </button>
                            ))}
                          </div>
                        </div>
                      ) : (
                        messages.map((msg, idx) => (
                          <div key={idx} className={`flex ${msg.role === 'user' ? 'justify-end' : 'justify-start'}`}>
                            <div className={`max-w-3xl px-4 py-3 rounded-lg shadow-md ${
                              msg.role === 'user'
                                ? 'bg-gradient-to-r from-purple-600 to-blue-600 text-white'
                                : msg.role === 'system'
                                ? 'bg-yellow-50 text-yellow-800 border border-yellow-200'
                                : 'bg-white text-gray-800 border border-gray-200'
                            }`}>
                              <pre className="whitespace-pre-wrap font-sans text-sm">{msg.content}</pre>
                            </div>
                          </div>
                        ))
                      )}
                      {isLoading && (
                        <div className="flex justify-start">
                          <div className="bg-white px-4 py-3 rounded-lg shadow-md border border-gray-200">
                            <div className="flex items-center space-x-2">
                              <div className="w-2 h-2 bg-purple-500 rounded-full animate-bounce"></div>
                              <div className="w-2 h-2 bg-blue-500 rounded-full animate-bounce" style={{animationDelay: '0.1s'}}></div>
                              <div className="w-2 h-2 bg-indigo-500 rounded-full animate-bounce" style={{animationDelay: '0.2s'}}></div>
                            </div>
                          </div>
                        </div>
                      )}
                      <div ref={messagesEndRef} />
                    </div>

                    <form onSubmit={handleSubmit} className="flex gap-2">
                      <input
                        type="text"
                        value={input}
                        onChange={(e) => setInput(e.target.value)}
                        placeholder="Ask me anything about your data..."
                        className="flex-1 px-4 py-3 border-2 border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500"
                      />
                      <button
                        type="submit"
                        disabled={!input.trim() || isLoading}
                        className="px-8 py-3 bg-gradient-to-r from-purple-600 to-blue-600 text-white rounded-lg hover:from-purple-700 hover:to-blue-700 disabled:bg-gray-300 disabled:cursor-not-allowed font-semibold shadow-md"
                      >
                        Send
                      </button>
                    </form>
                  </div>
                )}

                {/* Products Tab */}
                {activeTab === 'products' && (
                  <div>
                    <div className="flex justify-between items-center mb-4">
                      <h3 className="text-xl font-semibold">Your Products</h3>
                      <div className="flex gap-2">
                        {products.length > 0 && (
                          <button
                            onClick={() => runAISanityCheck(products, 'products')}
                            disabled={isCheckingSanity}
                            className="px-4 py-2 bg-gradient-to-r from-indigo-600 to-purple-600 text-white rounded-lg text-sm font-semibold disabled:opacity-50"
                          >
                            {isCheckingSanity ? 'üîç Checking...' : 'üß† AI Sanity Check'}
                          </button>
                        )}
                        <button onClick={() => initializeNewItem('product')} className="px-4 py-2 bg-purple-600 text-white rounded-lg text-sm font-semibold">‚ûï Add</button>
                        {products.length > 0 && (
                          <>
                            <button onClick={() => downloadCSV(products, 'products.csv')} className="px-4 py-2 bg-blue-600 text-white rounded-lg text-sm font-semibold">üíæ CSV</button>
                            <button onClick={() => exportToExcel(products, 'products.xlsx', 'products')} className="px-4 py-2 bg-green-600 text-white rounded-lg text-sm font-semibold">üìä Excel</button>
                          </>
                        )}
                      </div>
                    </div>
                    
                    {products.length === 0 ? (
                      <div className="text-center py-12 text-gray-500">
                        <p className="text-lg">No products loaded yet.</p>
                        <p className="text-sm mt-2">Upload a CSV/Excel file or create one.</p>
                      </div>
                    ) : (
                      <div className="overflow-x-auto">
                        <table className="w-full text-sm">
                          <thead className="bg-purple-100 border-b-2 border-purple-300">
                            <tr>
                              {Object.keys(products[0]).map((key, i) => (
                                <th key={i} className="px-4 py-3 text-left font-semibold text-gray-700">{key}</th>
                              ))}
                              <th className="px-4 py-3 text-left font-semibold text-gray-700">Actions</th>
                            </tr>
                          </thead>
                          <tbody>
                            {products.map((product, idx) => (
                              <tr key={idx} className="border-b border-gray-200 hover:bg-purple-50">
                                {Object.values(product).map((val, i) => (
                                  <td key={i} className="px-4 py-3">{String(val).substring(0, 50)}</td>
                                ))}
                                <td className="px-4 py-3">
                                  <button onClick={() => startEdit('product', idx)} className="text-blue-600 hover:text-blue-800 text-xs font-semibold mr-2">Edit</button>
                                  <button onClick={() => deleteItem('product', idx)} className="text-red-600 hover:text-red-800 text-xs font-semibold">Delete</button>
                                </td>
                              </tr>
                            ))}
                          </tbody>
                        </table>
                      </div>
                    )}
                  </div>
                )}

                {/* Bundles Tab */}
                {activeTab === 'bundles' && (
                  <div>
                    <div className="flex justify-between items-center mb-4">
                      <h3 className="text-xl font-semibold">Your Bundles</h3>
                      <div className="flex gap-2">
                        {bundles.length > 0 && (
                          <button
                            onClick={() => runAISanityCheck(bundles, 'bundles')}
                            disabled={isCheckingSanity}
                            className="px-4 py-2 bg-gradient-to-r from-indigo-600 to-purple-600 text-white rounded-lg text-sm font-semibold disabled:opacity-50"
                          >
                            {isCheckingSanity ? 'üîç Checking...' : 'üß† AI Sanity Check'}
                          </button>
                        )}
                        <button onClick={() => initializeNewItem('bundle')} className="px-4 py-2 bg-blue-600 text-white rounded-lg text-sm font-semibold">‚ûï Add</button>
                        {bundles.length > 0 && (
                          <>
                            <button onClick={() => downloadCSV(bundles, 'bundles.csv')} className="px-4 py-2 bg-blue-600 text-white rounded-lg text-sm font-semibold">üíæ CSV</button>
                            <button onClick={() => exportToExcel(bundles, 'bundles.xlsx', 'bundles')} className="px-4 py-2 bg-green-600 text-white rounded-lg text-sm font-semibold">üìä Excel</button>
                          </>
                        )}
                      </div>
                    </div>
                    
                    {bundles.length === 0 ? (
                      <div className="text-center py-12 text-gray-500">
                        <p className="text-lg">No bundles loaded yet.</p>
                        <p className="text-sm mt-2">Upload a CSV/Excel file or create one.</p>
                      </div>
                    ) : (
                      <div className="overflow-x-auto">
                        <table className="w-full text-sm">
                          <thead className="bg-blue-100 border-b-2 border-blue-300">
                            <tr>
                              {Object.keys(bundles[0]).map((key, i) => (
                                <th key={i} className="px-4 py-3 text-left font-semibold text-gray-700">{key}</th>
                              ))}
                              <th className="px-4 py-3 text-left font-semibold text-gray-700">Actions</th>
                            </tr>
                          </thead>
                          <tbody>
                            {bundles.map((bundle, idx) => (
                              <tr key={idx} className="border-b border-gray-200 hover:bg-blue-50">
                                {Object.values(bundle).map((val, i) => (
                                  <td key={i} className="px-4 py-3">{String(val).substring(0, 50)}</td>
                                ))}
                                <td className="px-4 py-3">
                                  <button onClick={() => startEdit('bundle', idx)} className="text-blue-600 hover:text-blue-800 text-xs font-semibold mr-2">Edit</button>
                                  <button onClick={() => deleteItem('bundle', idx)} className="text-red-600 hover:text-red-800 text-xs font-semibold">Delete</button>
                                </td>
                              </tr>
                            ))}
                          </tbody>
                        </table>
                      </div>
                    )}
                  </div>
                )}

                {/* Create Tab */}
                {activeTab === 'create' && (
                  <div className="max-w-3xl mx-auto">
                    <h3 className="text-2xl font-bold text-center mb-6">AI-Powered Creation Studio</h3>
                    
                    <div className="grid md:grid-cols-2 gap-4 mb-6">
                      <button onClick={() => initializeNewItem('product')} className="p-8 bg-white rounded-xl border-2 border-purple-300 hover:border-purple-500 hover:shadow-xl transition">
                        <div className="text-5xl mb-4">üì¶</div>
                        <h4 className="font-bold text-xl mb-2">Create Product</h4>
                        <p className="text-sm text-gray-600">Add a new product</p>
                      </button>
                      
                      <button onClick={() => initializeNewItem('bundle')} className="p-8 bg-white rounded-xl border-2 border-blue-300 hover:border-blue-500 hover:shadow-xl transition">
                        <div className="text-5xl mb-4">üéÅ</div>
                        <h4 className="font-bold text-xl mb-2">Create Bundle</h4>
                        <p className="text-sm text-gray-600">Build a new bundle</p>
                      </button>
                    </div>

                    <div className="bg-white rounded-lg p-6 border border-purple-200">
                      <h4 className="font-bold mb-3 text-purple-900">ü§ñ Or Ask AI to Create</h4>
                      <div className="space-y-3">
                        <button onClick={() => askAIToCreate('product')} className="w-full px-6 py-4 bg-gradient-to-r from-purple-600 to-purple-700 text-white rounded-lg font-semibold text-left">
                          ‚ú® Generate Product Suggestion
                        </button>
                        <button onClick={() => askAIToCreate('bundle')} className="w-full px-6 py-4 bg-gradient-to-r from-blue-600 to-blue-700 text-white rounded-lg font-semibold text-left">
                          ‚ú® Generate Bundle Suggestion
                        </button>
                      </div>
                    </div>
                  </div>
                )}
              </div>
            </div>

            {/* Edit Modal */}
            {editingItem && (
              <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
                <div className="bg-white rounded-xl p-6 max-w-2xl w-full max-h-[80vh] overflow-y-auto">
                  <h3 className="text-2xl font-bold mb-4">Edit {editingType}</h3>
                  <div className="space-y-3">
                    {Object.entries(editingItem).filter(([key]) => key !== 'index').map(([key, value]) => (
                      <div key={key}>
                        <label className="block text-sm font-semibold text-gray-700 mb-1">{key}</label>
                        <input
                          type="text"
                          value={value}
                          onChange={(e) => setEditingItem({...editingItem, [key]: e.target.value})}
                          className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500"
                        />
                      </div>
                    ))}
                  </div>
                  <div className="flex gap-3 mt-6">
                    <button onClick={saveEdit} className="flex-1 px-4 py-3 bg-green-600 text-white rounded-lg font-semibold">Save</button>
                    <button onClick={cancelEdit} className="flex-1 px-4 py-3 bg-gray-300 text-gray-700 rounded-lg font-semibold">Cancel</button>
                  </div>
                </div>
              </div>
            )}

            {/* Create Modal */}
            {showCreateForm && (
              <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
                <div className="bg-white rounded-xl p-6 max-w-2xl w-full max-h-[80vh] overflow-y-auto">
                  <h3 className="text-2xl font-bold mb-4">Create New {createType}</h3>
                  <div className="space-y-3">
                    {Object.keys(newItem).map((key) => (
                      <div key={key}>
                        <label className="block text-sm font-semibold text-gray-700 mb-1">{key}</label>
                        <input
                          type="text"
                          value={newItem[key]}
                          onChange={(e) => setNewItem({...newItem, [key]: e.target.value})}
                          className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500"
                          placeholder={`Enter ${key}`}
                        />
                      </div>
                    ))}
                  </div>
                  <div className="flex gap-3 mt-6">
                    <button onClick={saveNewItem} className="flex-1 px-4 py-3 bg-green-600 text-white rounded-lg font-semibold">Create</button>
                    <button onClick={() => setShowCreateForm(false)} className="flex-1 px-4 py-3 bg-gray-300 text-gray-700 rounded-lg font-semibold">Cancel</button>
                  </div>
                </div>
              </div>
            )}

            {/* Sanity Report Modal */}
            {showSanityReport && (
              <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
                <div className="bg-white rounded-xl p-6 max-w-3xl w-full max-h-[80vh] overflow-y-auto">
                  <div className="flex justify-between items-center mb-4">
                    <h3 className="text-2xl font-bold">üß† AI Sanity Check Report</h3>
                    <button onClick={() => setShowSanityReport(false)} className="text-gray-400 hover:text-gray-600 text-2xl">‚úï</button>
                  </div>
                  
                  {isCheckingSanity && (
                    <div className="text-center py-12">
                      <div className="text-4xl animate-spin mb-4">üîç</div>
                      <p className="text-lg">Analyzing your data...</p>
                    </div>
                  )}
                  
                  {sanityReport && !isCheckingSanity && (
                    <div>
                      {sanityReport.error ? (
                        <div className="bg-red-50 border border-red-200 rounded-lg p-4">
                          <p className="text-red-700">Error: {sanityReport.error}</p>
                        </div>
                      ) : (
                        <>
                          <div className="grid grid-cols-2 gap-4 mb-6">
                            <div className="bg-purple-50 rounded-lg p-4 text-center">
                              <div className="text-4xl font-bold text-purple-600">{sanityReport.qualityScore}/100</div>
                              <div className="text-sm text-gray-600">Quality Score</div>
                            </div>
                            <div className="bg-green-50 rounded-lg p-4 text-center">
                              <div className="text-4xl font-bold text-green-600">{sanityReport.completeness}%</div>
                              <div className="text-sm text-gray-600">Completeness</div>
                            </div>
                          </div>
                          
                          {sanityReport.critical?.length > 0 && (
                            <div className="mb-4">
                              <h4 className="font-bold text-red-700 mb-2">üî¥ Critical Issues</h4>
                              {sanityReport.critical.map((issue, idx) => (
                                <div key={idx} className="bg-red-50 border border-red-200 rounded p-3 mb-2">
                                  <p className="font-medium">{issue.issue}</p>
                                  <p className="text-sm text-gray-600">{issue.fix}</p>
                                </div>
                              ))}
                            </div>
                          )}
                          
                          {sanityReport.warnings?.length > 0 && (
                            <div className="mb-4">
                              <h4 className="font-bold text-yellow-700 mb-2">üü° Warnings</h4>
                              {sanityReport.warnings.map((warning, idx) => (
                                <div key={idx} className="bg-yellow-50 border border-yellow-200 rounded p-3 mb-2">
                                  <p className="font-medium">{warning.issue}</p>
                                  <p className="text-sm text-gray-600">{warning.suggestion}</p>
                                </div>
                              ))}
                            </div>
                          )}
                          
                          {sanityReport.suggestions?.length > 0 && (
                            <div>
                              <h4 className="font-bold text-blue-700 mb-2">üí° Suggestions</h4>
                              {sanityReport.suggestions.map((suggestion, idx) => (
                                <div key={idx} className="bg-blue-50 border border-blue-200 rounded p-3 mb-2">
                                  <p className="font-medium">{suggestion.title}</p>
                                  <p className="text-sm text-gray-600">{suggestion.description}</p>
                                </div>
                              ))}
                            </div>
                          )}
                        </>
                      )}
                    </div>
                  )}
                </div>
              </div>
            )}

          </div>
        </div>
      );
    }

    ReactDOM.render(<App />, document.getElementById('root'));
  </script>
</body>
</html>
