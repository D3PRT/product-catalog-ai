<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AI Product Catalog Manager</title>
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/lucide@latest"></script>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useRef, useEffect } = React;

    function App() {
      const [products, setProducts] = useState([]);
      const [bundles, setBundles] = useState([]);
      const [messages, setMessages] = useState([]);
      const [input, setInput] = useState("");
      const [isLoading, setIsLoading] = useState(false);
      const [apiKey, setApiKey] = useState("");
      const [showApiKeyInput, setShowApiKeyInput] = useState(true);
      const [activeTab, setActiveTab] = useState('chat'); // chat, products, bundles, create
      const [editingItem, setEditingItem] = useState(null);
      const [createType, setCreateType] = useState('product');
      const messagesEndRef = useRef(null);

      const scrollToBottom = () => {
        messagesEndRef.current?.scrollIntoView({ behavior: "smooth" });
      };

      useEffect(() => {
        scrollToBottom();
      }, [messages]);

      useEffect(() => {
        const stored = localStorage.getItem('anthropic_api_key');
        if (stored) {
          setApiKey(stored);
          setShowApiKeyInput(false);
        }
      }, []);

      const handleFileUpload = (e, type) => {
        const file = e.target.files[0];
        if (!file) return;

        Papa.parse(file, {
          header: true,
          skipEmptyLines: true,
          complete: (results) => {
            if (type === 'products') {
              setProducts(results.data);
              addMessage('system', `‚úÖ Loaded ${results.data.length} products`);
            } else {
              setBundles(results.data);
              addMessage('system', `‚úÖ Loaded ${results.data.length} bundles`);
            }
          },
          error: (error) => {
            addMessage('system', `‚ùå Error parsing ${type}: ${error.message}`);
          }
        });
      };

      const addMessage = (role, content) => {
        setMessages(prev => [...prev, { role, content, timestamp: Date.now() }]);
      };

      const saveApiKey = () => {
        if (apiKey.trim()) {
          localStorage.setItem('anthropic_api_key', apiKey.trim());
          setShowApiKeyInput(false);
          addMessage('system', '‚úÖ API Key saved! Now I can help you with AI-powered analysis and creation.');
        }
      };

      const clearApiKey = () => {
        localStorage.removeItem('anthropic_api_key');
        setApiKey('');
        setShowApiKeyInput(true);
      };

      const callClaudeAPI = async (userPrompt) => {
        try {
          // Prepare data summary and full data
          let dataContext = '';
          
          if (products.length > 0) {
            dataContext += `\n\nPRODUCTS (${products.length} total):\n`;
            dataContext += `Columns: ${Object.keys(products[0]).join(', ')}\n\n`;
            
            // Include full data for small datasets, sample for large
            if (products.length <= 100) {
              dataContext += `Complete products data:\n${JSON.stringify(products, null, 2)}\n`;
            } else {
              dataContext += `Sample products (first 20):\n${JSON.stringify(products.slice(0, 20), null, 2)}\n`;
              dataContext += `\nNote: ${products.length} total products available. These are the first 20 as examples.\n`;
            }
          }
          
          if (bundles.length > 0) {
            dataContext += `\n\nBUNDLES (${bundles.length} total):\n`;
            dataContext += `Columns: ${Object.keys(bundles[0]).join(', ')}\n\n`;
            
            if (bundles.length <= 100) {
              dataContext += `Complete bundles data:\n${JSON.stringify(bundles, null, 2)}\n`;
            } else {
              dataContext += `Sample bundles (first 20):\n${JSON.stringify(bundles.slice(0, 20), null, 2)}\n`;
              dataContext += `\nNote: ${bundles.length} total bundles available. These are the first 20 as examples.\n`;
            }
          }

          const context = `You are an AI assistant helping manage a product catalog. You have DIRECT ACCESS to the user's data below. Analyze it and answer their questions directly.

${dataContext}

USER QUESTION: ${userPrompt}

INSTRUCTIONS:
- You HAVE the data above - analyze it directly
- Answer questions about products, bundles, pricing, relationships, etc.
- If asked to create new items, generate realistic examples based on the existing data structure
- Be specific and reference actual data from above
- Don't ask the user to provide data - you already have it above`;

          // Call Netlify function instead of direct API
          const response = await fetch("/.netlify/functions/claude-proxy", {
            method: "POST",
            headers: {
              "Content-Type": "application/json"
            },
            body: JSON.stringify({
              apiKey: apiKey,
              messages: [{ role: "user", content: context }],
              max_tokens: 2000
            })
          });

          if (!response.ok) {
            const errorData = await response.json().catch(() => ({}));
            throw new Error(errorData.error || `API failed: ${response.status}`);
          }

          const data = await response.json();
          return data.content[0].text;
        } catch (error) {
          throw error;
        }
      };

      const handleSubmit = async (e) => {
        e.preventDefault();
        if (!input.trim() || isLoading) return;

        if (!apiKey) {
          addMessage('system', '‚ö†Ô∏è Please enter your Anthropic API key first');
          setShowApiKeyInput(true);
          return;
        }

        const userMessage = input;
        setInput("");
        addMessage('user', userMessage);
        setIsLoading(true);

        try {
          const response = await callClaudeAPI(userMessage);
          addMessage('assistant', response);
        } catch (error) {
          console.error("Error:", error);
          addMessage('system', `‚ùå Error: ${error.message}`);
          if (error.message.includes('401') || error.message.includes('authentication')) {
            setShowApiKeyInput(true);
          }
        } finally {
          setIsLoading(false);
        }
      };

      const downloadCSV = (data, filename) => {
        const csv = Papa.unparse(data);
        const blob = new Blob([csv], { type: 'text/csv' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        a.click();
      };

      const handleCreateItem = async () => {
        if (!apiKey) {
          alert('Please add your API key first');
          setShowApiKeyInput(true);
          return;
        }

        setIsLoading(true);
        try {
          const prompt = createType === 'product' 
            ? `Help me create a new product. Based on my existing products, suggest a template with all the fields I need. Format it as a JSON object.`
            : `Help me create a new bundle. Based on my existing bundles and products, suggest a template with all the fields I need. Format it as a JSON object.`;
          
          const response = await callClaudeAPI(prompt);
          addMessage('assistant', `Here's a template for creating a new ${createType}:\n\n${response}\n\nFill this out and I can help you add it to your catalog!`);
          setActiveTab('chat');
        } catch (error) {
          addMessage('system', `‚ùå Error: ${error.message}`);
        } finally {
          setIsLoading(false);
        }
      };

      const deleteItem = (type, index) => {
        if (confirm(`Delete this ${type}?`)) {
          if (type === 'product') {
            const newProducts = [...products];
            newProducts.splice(index, 1);
            setProducts(newProducts);
            addMessage('system', `‚úÖ Product deleted`);
          } else {
            const newBundles = [...bundles];
            newBundles.splice(index, 1);
            setBundles(newBundles);
            addMessage('system', `‚úÖ Bundle deleted`);
          }
        }
      };

      return (
        <div className="min-h-screen bg-gradient-to-br from-purple-50 via-blue-50 to-indigo-100">
          <div className="container mx-auto px-4 py-6 max-w-7xl">
            
            {/* Header */}
            <div className="bg-white rounded-xl shadow-xl p-6 mb-6 border-t-4 border-purple-500">
              <div className="flex items-center justify-between">
                <div>
                  <h1 className="text-4xl font-bold bg-gradient-to-r from-purple-600 to-blue-600 bg-clip-text text-transparent mb-2">
                    ü§ñ AI Product Catalog Manager
                  </h1>
                  <p className="text-gray-600">
                    AI-powered catalog management ‚Ä¢ Create, analyze, and optimize your products & bundles
                  </p>
                </div>
                <div className="text-right">
                  <div className="text-sm text-gray-500">
                    {products.length} products ‚Ä¢ {bundles.length} bundles
                  </div>
                </div>
              </div>
            </div>

            {/* API Key Section */}
            {showApiKeyInput && (
              <div className="bg-gradient-to-r from-yellow-50 to-orange-50 border-2 border-yellow-300 rounded-xl shadow-lg p-6 mb-6">
                <h2 className="text-xl font-semibold text-gray-800 mb-2 flex items-center">
                  üîë API Key Required for AI Features
                </h2>
                <p className="text-sm text-gray-600 mb-4">
                  Get your free API key at{' '}
                  <a href="https://console.anthropic.com/" target="_blank" className="text-blue-600 hover:underline font-semibold">
                    console.anthropic.com
                  </a>
                </p>
                <div className="flex gap-2">
                  <input
                    type="password"
                    value={apiKey}
                    onChange={(e) => setApiKey(e.target.value)}
                    placeholder="sk-ant-..."
                    className="flex-1 px-4 py-3 border-2 border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                  />
                  <button
                    onClick={saveApiKey}
                    className="px-8 py-3 bg-gradient-to-r from-purple-600 to-blue-600 text-white rounded-lg hover:from-purple-700 hover:to-blue-700 transition font-semibold shadow-md"
                  >
                    Save Key
                  </button>
                </div>
              </div>
            )}

            {!showApiKeyInput && (
              <div className="bg-green-50 border border-green-200 rounded-lg p-3 mb-6 flex items-center justify-between">
                <span className="text-green-800 text-sm font-medium">‚úÖ AI Enabled</span>
                <button
                  onClick={clearApiKey}
                  className="text-sm text-red-600 hover:text-red-800 underline"
                >
                  Clear Key
                </button>
              </div>
            )}

            {/* File Upload */}
            <div className="bg-white rounded-xl shadow-lg p-6 mb-6">
              <h2 className="text-xl font-semibold text-gray-800 mb-4">üìÅ Upload Your Data</h2>
              <div className="grid md:grid-cols-2 gap-4">
                <div className="border-2 border-dashed border-purple-300 rounded-lg p-4 hover:border-purple-500 transition">
                  <label className="block text-sm font-medium text-gray-700 mb-2">
                    Products CSV {products.length > 0 && <span className="text-green-600">‚úì {products.length} loaded</span>}
                  </label>
                  <input
                    type="file"
                    accept=".csv"
                    onChange={(e) => handleFileUpload(e, 'products')}
                    className="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-purple-50 file:text-purple-700 hover:file:bg-purple-100 cursor-pointer"
                  />
                </div>
                <div className="border-2 border-dashed border-blue-300 rounded-lg p-4 hover:border-blue-500 transition">
                  <label className="block text-sm font-medium text-gray-700 mb-2">
                    Bundles CSV {bundles.length > 0 && <span className="text-green-600">‚úì {bundles.length} loaded</span>}
                  </label>
                  <input
                    type="file"
                    accept=".csv"
                    onChange={(e) => handleFileUpload(e, 'bundles')}
                    className="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100 cursor-pointer"
                  />
                </div>
              </div>
            </div>

            {/* Tabs */}
            <div className="bg-white rounded-xl shadow-lg mb-6 overflow-hidden">
              <div className="flex border-b border-gray-200">
                <button
                  onClick={() => setActiveTab('chat')}
                  className={`flex-1 px-6 py-4 font-semibold transition ${
                    activeTab === 'chat'
                      ? 'bg-gradient-to-r from-purple-500 to-blue-500 text-white'
                      : 'text-gray-600 hover:bg-gray-50'
                  }`}
                >
                  üí¨ AI Chat
                </button>
                <button
                  onClick={() => setActiveTab('products')}
                  className={`flex-1 px-6 py-4 font-semibold transition ${
                    activeTab === 'products'
                      ? 'bg-gradient-to-r from-purple-500 to-blue-500 text-white'
                      : 'text-gray-600 hover:bg-gray-50'
                  }`}
                >
                  üì¶ Products ({products.length})
                </button>
                <button
                  onClick={() => setActiveTab('bundles')}
                  className={`flex-1 px-6 py-4 font-semibold transition ${
                    activeTab === 'bundles'
                      ? 'bg-gradient-to-r from-purple-500 to-blue-500 text-white'
                      : 'text-gray-600 hover:bg-gray-50'
                  }`}
                >
                  üéÅ Bundles ({bundles.length})
                </button>
                <button
                  onClick={() => setActiveTab('create')}
                  className={`flex-1 px-6 py-4 font-semibold transition ${
                    activeTab === 'create'
                      ? 'bg-gradient-to-r from-purple-500 to-blue-500 text-white'
                      : 'text-gray-600 hover:bg-gray-50'
                  }`}
                >
                  ‚ûï Create New
                </button>
              </div>

              {/* Tab Content */}
              <div className="p-6">
                
                {/* Chat Tab */}
                {activeTab === 'chat' && (
                  <div>
                    <div className="h-96 overflow-y-auto mb-4 space-y-4 p-4 bg-gray-50 rounded-lg">
                      {messages.length === 0 ? (
                        <div className="text-center text-gray-500 mt-20">
                          <p className="text-lg mb-4">üëã Ask me anything!</p>
                          <div className="flex flex-wrap gap-2 justify-center max-w-2xl mx-auto">
                            {[
                              "What bundles contain which products?",
                              "Help me create a new premium bundle",
                              "Analyze my pricing strategy",
                              "Find my best-selling products",
                              "Suggest product optimizations"
                            ].map((q, i) => (
                              <button
                                key={i}
                                onClick={() => setInput(q)}
                                className="px-4 py-2 bg-white text-purple-700 rounded-full text-sm hover:bg-purple-50 transition shadow-sm border border-purple-200"
                              >
                                {q}
                              </button>
                            ))}
                          </div>
                        </div>
                      ) : (
                        messages.map((msg, idx) => (
                          <div
                            key={idx}
                            className={`flex ${msg.role === 'user' ? 'justify-end' : 'justify-start'}`}
                          >
                            <div
                              className={`max-w-3xl px-4 py-3 rounded-lg shadow-md ${
                                msg.role === 'user'
                                  ? 'bg-gradient-to-r from-purple-600 to-blue-600 text-white'
                                  : msg.role === 'system'
                                  ? 'bg-yellow-50 text-yellow-800 border border-yellow-200'
                                  : 'bg-white text-gray-800 border border-gray-200'
                              }`}
                            >
                              <pre className="whitespace-pre-wrap font-sans text-sm">{msg.content}</pre>
                            </div>
                          </div>
                        ))
                      )}
                      {isLoading && (
                        <div className="flex justify-start">
                          <div className="bg-white text-gray-800 px-4 py-3 rounded-lg shadow-md border border-gray-200">
                            <div className="flex items-center space-x-2">
                              <div className="w-2 h-2 bg-purple-500 rounded-full animate-bounce"></div>
                              <div className="w-2 h-2 bg-blue-500 rounded-full animate-bounce" style={{animationDelay: '0.1s'}}></div>
                              <div className="w-2 h-2 bg-indigo-500 rounded-full animate-bounce" style={{animationDelay: '0.2s'}}></div>
                            </div>
                          </div>
                        </div>
                      )}
                      <div ref={messagesEndRef} />
                    </div>

                    <form onSubmit={handleSubmit} className="flex gap-2">
                      <input
                        type="text"
                        value={input}
                        onChange={(e) => setInput(e.target.value)}
                        placeholder="Ask anything... e.g., 'Help me create a new product' or 'What bundles contain X?'"
                        disabled={!apiKey}
                        className="flex-1 px-4 py-3 border-2 border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent disabled:bg-gray-100"
                      />
                      <button
                        type="submit"
                        disabled={!input.trim() || isLoading || !apiKey}
                        className="px-8 py-3 bg-gradient-to-r from-purple-600 to-blue-600 text-white rounded-lg hover:from-purple-700 hover:to-blue-700 disabled:bg-gray-300 disabled:cursor-not-allowed transition font-semibold shadow-md"
                      >
                        Send
                      </button>
                    </form>
                  </div>
                )}

                {/* Products Tab */}
                {activeTab === 'products' && (
                  <div>
                    <div className="flex justify-between items-center mb-4">
                      <h3 className="text-xl font-semibold">Your Products</h3>
                      {products.length > 0 && (
                        <button
                          onClick={() => downloadCSV(products, 'products.csv')}
                          className="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition text-sm font-semibold"
                        >
                          üíæ Download CSV
                        </button>
                      )}
                    </div>
                    
                    {products.length === 0 ? (
                      <div className="text-center py-12 text-gray-500">
                        <p className="text-lg">No products loaded yet.</p>
                        <p className="text-sm mt-2">Upload a products.csv file to get started.</p>
                      </div>
                    ) : (
                      <div className="overflow-x-auto">
                        <table className="w-full text-sm">
                          <thead className="bg-gray-100 border-b-2 border-gray-300">
                            <tr>
                              {Object.keys(products[0]).map((key, i) => (
                                <th key={i} className="px-4 py-3 text-left font-semibold text-gray-700">
                                  {key}
                                </th>
                              ))}
                              <th className="px-4 py-3 text-left font-semibold text-gray-700">Actions</th>
                            </tr>
                          </thead>
                          <tbody>
                            {products.slice(0, 50).map((product, idx) => (
                              <tr key={idx} className="border-b border-gray-200 hover:bg-gray-50">
                                {Object.values(product).map((val, i) => (
                                  <td key={i} className="px-4 py-3">{val}</td>
                                ))}
                                <td className="px-4 py-3">
                                  <button
                                    onClick={() => deleteItem('product', idx)}
                                    className="text-red-600 hover:text-red-800 text-xs font-semibold"
                                  >
                                    Delete
                                  </button>
                                </td>
                              </tr>
                            ))}
                          </tbody>
                        </table>
                        {products.length > 50 && (
                          <p className="text-center py-4 text-gray-500 text-sm">
                            Showing first 50 of {products.length} products
                          </p>
                        )}
                      </div>
                    )}
                  </div>
                )}

                {/* Bundles Tab */}
                {activeTab === 'bundles' && (
                  <div>
                    <div className="flex justify-between items-center mb-4">
                      <h3 className="text-xl font-semibold">Your Bundles</h3>
                      {bundles.length > 0 && (
                        <button
                          onClick={() => downloadCSV(bundles, 'bundles.csv')}
                          className="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition text-sm font-semibold"
                        >
                          üíæ Download CSV
                        </button>
                      )}
                    </div>
                    
                    {bundles.length === 0 ? (
                      <div className="text-center py-12 text-gray-500">
                        <p className="text-lg">No bundles loaded yet.</p>
                        <p className="text-sm mt-2">Upload a bundles.csv file to get started.</p>
                      </div>
                    ) : (
                      <div className="overflow-x-auto">
                        <table className="w-full text-sm">
                          <thead className="bg-gray-100 border-b-2 border-gray-300">
                            <tr>
                              {Object.keys(bundles[0]).map((key, i) => (
                                <th key={i} className="px-4 py-3 text-left font-semibold text-gray-700">
                                  {key}
                                </th>
                              ))}
                              <th className="px-4 py-3 text-left font-semibold text-gray-700">Actions</th>
                            </tr>
                          </thead>
                          <tbody>
                            {bundles.slice(0, 50).map((bundle, idx) => (
                              <tr key={idx} className="border-b border-gray-200 hover:bg-gray-50">
                                {Object.values(bundle).map((val, i) => (
                                  <td key={i} className="px-4 py-3">{val}</td>
                                ))}
                                <td className="px-4 py-3">
                                  <button
                                    onClick={() => deleteItem('bundle', idx)}
                                    className="text-red-600 hover:text-red-800 text-xs font-semibold"
                                  >
                                    Delete
                                  </button>
                                </td>
                              </tr>
                            ))}
                          </tbody>
                        </table>
                        {bundles.length > 50 && (
                          <p className="text-center py-4 text-gray-500 text-sm">
                            Showing first 50 of {bundles.length} bundles
                          </p>
                        )}
                      </div>
                    )}
                  </div>
                )}

                {/* Create Tab */}
                {activeTab === 'create' && (
                  <div className="max-w-2xl mx-auto">
                    <h3 className="text-2xl font-bold text-center mb-6">Create New Item</h3>
                    
                    <div className="bg-gradient-to-r from-purple-50 to-blue-50 rounded-lg p-6 mb-6 border border-purple-200">
                      <p className="text-gray-700 mb-4">
                        Let AI help you create a new {createType}! It will analyze your existing data and suggest the perfect template.
                      </p>
                      
                      <div className="flex gap-4 mb-6">
                        <button
                          onClick={() => setCreateType('product')}
                          className={`flex-1 px-6 py-3 rounded-lg font-semibold transition ${
                            createType === 'product'
                              ? 'bg-gradient-to-r from-purple-600 to-blue-600 text-white shadow-lg'
                              : 'bg-white text-gray-700 border-2 border-gray-300 hover:border-purple-400'
                          }`}
                        >
                          üì¶ Product
                        </button>
                        <button
                          onClick={() => setCreateType('bundle')}
                          className={`flex-1 px-6 py-3 rounded-lg font-semibold transition ${
                            createType === 'bundle'
                              ? 'bg-gradient-to-r from-purple-600 to-blue-600 text-white shadow-lg'
                              : 'bg-white text-gray-700 border-2 border-gray-300 hover:border-purple-400'
                          }`}
                        >
                          üéÅ Bundle
                        </button>
                      </div>

                      <button
                        onClick={handleCreateItem}
                        disabled={!apiKey || isLoading}
                        className="w-full px-6 py-4 bg-gradient-to-r from-purple-600 to-blue-600 text-white rounded-lg hover:from-purple-700 hover:to-blue-700 disabled:bg-gray-300 disabled:cursor-not-allowed transition font-bold text-lg shadow-lg"
                      >
                        {isLoading ? 'ü§ñ AI is creating a template...' : `‚ú® Generate ${createType.charAt(0).toUpperCase() + createType.slice(1)} Template with AI`}
                      </button>
                    </div>

                    <div className="bg-blue-50 border border-blue-200 rounded-lg p-4">
                      <p className="text-sm text-blue-800">
                        üí° <strong>Tip:</strong> After AI generates a template, you can ask it to modify or refine the {createType} in the chat!
                      </p>
                    </div>
                  </div>
                )}

              </div>
            </div>

          </div>
        </div>
      );
    }

    ReactDOM.render(<App />, document.getElementById('root'));
  </script>
</body>
</html>
