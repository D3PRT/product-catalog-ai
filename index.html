<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Product Catalog Assistant</title>
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useRef, useEffect } = React;

    function App() {
      const [products, setProducts] = useState(null);
      const [bundles, setBundles] = useState(null);
      const [messages, setMessages] = useState([]);
      const [input, setInput] = useState("");
      const [isLoading, setIsLoading] = useState(false);
      const messagesEndRef = useRef(null);

      const scrollToBottom = () => {
        messagesEndRef.current?.scrollIntoView({ behavior: "smooth" });
      };

      useEffect(() => {
        scrollToBottom();
      }, [messages]);

      const handleFileUpload = (e, type) => {
        const file = e.target.files[0];
        if (!file) return;

        Papa.parse(file, {
          header: true,
          skipEmptyLines: true,
          complete: (results) => {
            if (type === 'products') {
              setProducts(results.data);
              addMessage('system', `‚úÖ Loaded ${results.data.length} products`);
            } else {
              setBundles(results.data);
              addMessage('system', `‚úÖ Loaded ${results.data.length} bundles`);
            }
          },
          error: (error) => {
            addMessage('system', `‚ùå Error parsing ${type}: ${error.message}`);
          }
        });
      };

      const addMessage = (role, content) => {
        setMessages(prev => [...prev, { role, content }]);
      };

      const analyzeQuery = (query) => {
        const lowerQuery = query.toLowerCase();
        
        // Check if any data is loaded
        if (!products && !bundles) {
          return "Please upload at least one CSV file (products or bundles) to get started.";
        }
        
        // Count questions
        if (lowerQuery.includes('how many') || lowerQuery.includes('count')) {
          if (products) {
            return `You have ${products.length} products${bundles ? ` and ${bundles.length} bundles` : ''}.`;
          }
          if (bundles) {
            return `You have ${bundles.length} bundles.`;
          }
          return "No data loaded yet.";
        }

        // Show columns/fields
        if (lowerQuery.includes('column') || lowerQuery.includes('field') || lowerQuery.includes('what data')) {
          let response = '';
          if (products) {
            response += `Product columns: ${Object.keys(products[0]).join(', ')}\n\n`;
          }
          if (bundles) {
            response += `Bundle columns: ${Object.keys(bundles[0]).join(', ')}`;
          }
          return response || "Please upload a CSV file first.";
        }

        // Categories
        if (lowerQuery.includes('categor')) {
          const data = products || bundles;
          if (data) {
            const categoryField = Object.keys(data[0]).find(key => 
              key.toLowerCase().includes('category') || key.toLowerCase().includes('type')
            );
            if (categoryField) {
              const categories = [...new Set(data.map(p => p[categoryField]).filter(Boolean))];
              return `Categories found (${categories.length}):\n${categories.join(', ')}`;
            }
            return "No category field found in your data.";
          }
          return "Please upload a CSV file first.";
        }

        // Price-related queries
        if (lowerQuery.includes('price') || lowerQuery.includes('expensive') || lowerQuery.includes('cheap') || lowerQuery.includes('cost')) {
          const data = products || bundles;
          if (data) {
            const priceField = Object.keys(data[0]).find(key => 
              key.toLowerCase().includes('price') || key.toLowerCase().includes('cost')
            );
            
            if (priceField) {
              const dataWithPrice = data.filter(p => p[priceField] && !isNaN(parseFloat(p[priceField])));
              const prices = dataWithPrice.map(p => parseFloat(p[priceField]));
              
              if (prices.length > 0) {
                const sorted = [...dataWithPrice].sort((a, b) => parseFloat(b[priceField]) - parseFloat(a[priceField]));
                const nameField = Object.keys(data[0]).find(k => k.toLowerCase().includes('name') || k.toLowerCase().includes('title')) || Object.keys(data[0])[0];
                
                let response = `Price Statistics:\n`;
                response += `‚Ä¢ Average: $${(prices.reduce((a, b) => a + b, 0) / prices.length).toFixed(2)}\n`;
                response += `‚Ä¢ Highest: $${Math.max(...prices).toFixed(2)}\n`;
                response += `‚Ä¢ Lowest: $${Math.min(...prices).toFixed(2)}\n\n`;
                
                if (lowerQuery.includes('expensive') || lowerQuery.includes('highest') || lowerQuery.includes('most')) {
                  response += `Top 5 Most Expensive:\n`;
                  sorted.slice(0, 5).forEach((p, i) => {
                    response += `${i + 1}. ${p[nameField]} - $${parseFloat(p[priceField]).toFixed(2)}\n`;
                  });
                } else if (lowerQuery.includes('cheap') || lowerQuery.includes('lowest') || lowerQuery.includes('under')) {
                  const match = lowerQuery.match(/under\s+\$?(\d+)/);
                  if (match) {
                    const limit = parseInt(match[1]);
                    const underLimit = sorted.filter(p => parseFloat(p[priceField]) < limit);
                    response += `\nProducts under $${limit} (${underLimit.length} found):\n`;
                    underLimit.slice(0, 10).forEach((p, i) => {
                      response += `${i + 1}. ${p[nameField]} - $${parseFloat(p[priceField]).toFixed(2)}\n`;
                    });
                  } else {
                    response += `\nTop 5 Cheapest:\n`;
                    sorted.slice(-5).reverse().forEach((p, i) => {
                      response += `${i + 1}. ${p[nameField]} - $${parseFloat(p[priceField]).toFixed(2)}\n`;
                    });
                  }
                }
                
                return response;
              }
            }
            return "No price field found in your data.";
          }
          return "Please upload a CSV file first.";
        }

        // Search for specific products
        if (lowerQuery.includes('find') || lowerQuery.includes('search') || lowerQuery.includes('show me')) {
          const data = products || bundles;
          if (data) {
            const searchTerms = query.toLowerCase().replace(/find|search|show me|for/g, '').trim().split(/\s+/);
            const nameField = Object.keys(data[0]).find(k => k.toLowerCase().includes('name') || k.toLowerCase().includes('title')) || Object.keys(data[0])[0];
            
            const matches = data.filter(p => {
              const searchText = Object.values(p).join(' ').toLowerCase();
              return searchTerms.some(term => searchText.includes(term));
            });

            if (matches.length > 0) {
              let response = `Found ${matches.length} matching items:\n\n`;
              matches.slice(0, 10).forEach((p, i) => {
                response += `${i + 1}. ${p[nameField]}\n`;
                Object.entries(p).slice(0, 3).forEach(([key, val]) => {
                  if (val) response += `   ${key}: ${val}\n`;
                });
                response += '\n';
              });
              if (matches.length > 10) {
                response += `... and ${matches.length - 10} more`;
              }
              return response;
            }
            return "No matching items found.";
          }
          return "Please upload a CSV file first.";
        }

        // Add new product
        if (lowerQuery.includes('add') && (lowerQuery.includes('product') || lowerQuery.includes('item') || lowerQuery.includes('bundle'))) {
          const data = products || bundles;
          if (data) {
            const columns = Object.keys(data[0]);
            const dataType = products ? 'product' : 'bundle';
            return `To add a new ${dataType}, you need these columns:\n\n${columns.map((col, i) => `${i + 1}. ${col}`).join('\n')}\n\nExample CSV row:\n${columns.join(',')}\n"Example Product","Category","$99.99",...`;
          }
          return "Please upload a CSV file first to see the required format.";
        }

        // Duplicates
        if (lowerQuery.includes('duplicate')) {
          const data = products || bundles;
          if (data) {
            const nameField = Object.keys(data[0]).find(k => k.toLowerCase().includes('name') || k.toLowerCase().includes('title')) || Object.keys(data[0])[0];
            const names = data.map(p => p[nameField]);
            const duplicates = names.filter((name, index) => names.indexOf(name) !== index && name);
            
            if (duplicates.length > 0) {
              return `Found ${duplicates.length} duplicate entries:\n${[...new Set(duplicates)].join('\n')}`;
            }
            return "No duplicates found!";
          }
          return "Please upload a CSV file first.";
        }

        // Show all data
        if (lowerQuery.includes('show all') || lowerQuery.includes('list all')) {
          const data = products || bundles;
          if (data) {
            const nameField = Object.keys(data[0]).find(k => k.toLowerCase().includes('name') || k.toLowerCase().includes('title')) || Object.keys(data[0])[0];
            const dataType = products ? 'Products' : 'Bundles';
            let response = `All ${dataType} (${data.length} total):\n\n`;
            data.slice(0, 20).forEach((p, i) => {
              response += `${i + 1}. ${p[nameField]}\n`;
            });
            if (data.length > 20) {
              response += `\n... and ${data.length - 20} more (showing first 20)`;
            }
            return response;
          }
          return "Please upload a CSV file first.";
        }

        // Default response with suggestions
        return `I can help you with:\n\n‚Ä¢ "How many products do we have?"\n‚Ä¢ "What categories are available?"\n‚Ä¢ "Show me the most expensive items"\n‚Ä¢ "Find products under $50"\n‚Ä¢ "Search for [product name]"\n‚Ä¢ "Help me add a new product"\n‚Ä¢ "Find duplicate entries"\n‚Ä¢ "Show all products"\n\nWhat would you like to know?`;
      };

      const handleSubmit = async (e) => {
        e.preventDefault();
        if (!input.trim() || isLoading) return;

        if (!products && !bundles) {
          addMessage('system', '‚ö†Ô∏è Please upload at least one CSV file first');
          return;
        }

        const userMessage = input;
        setInput("");
        addMessage('user', userMessage);
        setIsLoading(true);

        // Simulate thinking time
        setTimeout(() => {
          const response = analyzeQuery(userMessage);
          addMessage('assistant', response);
          setIsLoading(false);
        }, 500);
      };

      const quickActions = [
        "How many products do we have?",
        "Show me the most expensive items",
        "What categories are available?",
        "Help me add a new product",
        "Find products under $50"
      ];

      return (
        <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100">
          <div className="container mx-auto px-4 py-8 max-w-6xl">
            {/* Header */}
            <div className="bg-white rounded-lg shadow-lg p-6 mb-6">
              <h1 className="text-3xl font-bold text-gray-800 mb-2">
                üìä Product Catalog Assistant
              </h1>
              <p className="text-gray-600">
                Upload your product and bundle CSVs, then ask questions or get insights about your catalog
              </p>
              <p className="text-sm text-green-600 mt-2">
                ‚ú® No API needed - works entirely in your browser!
              </p>
            </div>

            {/* File Upload Section */}
            <div className="bg-white rounded-lg shadow-lg p-6 mb-6">
              <h2 className="text-xl font-semibold text-gray-800 mb-4">üìÅ Upload CSV Files</h2>
              <div className="grid md:grid-cols-2 gap-4">
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-2">
                    Products CSV
                    {products && <span className="text-green-600 ml-2">‚úì {products.length} loaded</span>}
                  </label>
                  <input
                    type="file"
                    accept=".csv"
                    onChange={(e) => handleFileUpload(e, 'products')}
                    className="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100"
                  />
                </div>
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-2">
                    Bundles CSV (Optional)
                    {bundles && <span className="text-green-600 ml-2">‚úì {bundles.length} loaded</span>}
                  </label>
                  <input
                    type="file"
                    accept=".csv"
                    onChange={(e) => handleFileUpload(e, 'bundles')}
                    className="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-green-50 file:text-green-700 hover:file:bg-green-100"
                  />
                </div>
              </div>
            </div>

            {/* Quick Actions */}
            {(products || bundles) && messages.length === 0 && (
              <div className="bg-white rounded-lg shadow-lg p-6 mb-6">
                <h3 className="text-lg font-semibold text-gray-800 mb-3">üí° Try asking:</h3>
                <div className="flex flex-wrap gap-2">
                  {quickActions.map((action, idx) => (
                    <button
                      key={idx}
                      onClick={() => setInput(action)}
                      className="px-4 py-2 bg-blue-50 text-blue-700 rounded-full text-sm hover:bg-blue-100 transition"
                    >
                      {action}
                    </button>
                  ))}
                </div>
              </div>
            )}

            {/* Chat Interface */}
            <div className="bg-white rounded-lg shadow-lg overflow-hidden">
              {/* Messages */}
              <div className="h-96 overflow-y-auto p-6 space-y-4">
                {messages.length === 0 ? (
                  <div className="text-center text-gray-500 mt-20">
                    <p className="text-lg">üëã Upload your CSV files and start asking questions!</p>
                    <p className="text-sm mt-2">I can help you search, analyze, and understand your product catalog</p>
                  </div>
                ) : (
                  messages.map((msg, idx) => (
                    <div
                      key={idx}
                      className={`flex ${msg.role === 'user' ? 'justify-end' : 'justify-start'}`}
                    >
                      <div
                        className={`max-w-3xl px-4 py-3 rounded-lg ${
                          msg.role === 'user'
                            ? 'bg-blue-600 text-white'
                            : msg.role === 'system'
                            ? 'bg-yellow-50 text-yellow-800 border border-yellow-200'
                            : 'bg-gray-100 text-gray-800'
                        }`}
                      >
                        <pre className="whitespace-pre-wrap font-sans">{msg.content}</pre>
                      </div>
                    </div>
                  ))
                )}
                {isLoading && (
                  <div className="flex justify-start">
                    <div className="bg-gray-100 text-gray-800 px-4 py-3 rounded-lg">
                      <div className="flex items-center space-x-2">
                        <div className="animate-bounce">‚óè</div>
                        <div className="animate-bounce delay-100">‚óè</div>
                        <div className="animate-bounce delay-200">‚óè</div>
                      </div>
                    </div>
                  </div>
                )}
                <div ref={messagesEndRef} />
              </div>

              {/* Input */}
              <form onSubmit={handleSubmit} className="border-t border-gray-200 p-4">
                <div className="flex space-x-2">
                  <input
                    type="text"
                    value={input}
                    onChange={(e) => setInput(e.target.value)}
                    placeholder="Ask anything about your catalog..."
                    disabled={!products && !bundles}
                    className="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 disabled:bg-gray-100"
                  />
                  <button
                    type="submit"
                    disabled={!input.trim() || isLoading || (!products && !bundles)}
                    className="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:bg-gray-300 disabled:cursor-not-allowed transition"
                  >
                    Send
                  </button>
                </div>
              </form>
            </div>

            {/* Footer */}
            <div className="mt-6 text-center text-sm text-gray-600">
              <p>üí° Examples: "Show products by category" ‚Ä¢ "Find duplicate items" ‚Ä¢ "What's the average price?" ‚Ä¢ "List all products"</p>
            </div>
          </div>
        </div>
      );
    }

    ReactDOM.render(<App />, document.getElementById('root'));
  </script>
</body>
</html>
