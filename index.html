<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AI Product Catalog Manager</title>
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/lucide@latest"></script>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useRef, useEffect } = React;

    function App() {
      const [products, setProducts] = useState([]);
      const [bundles, setBundles] = useState([]);
      const [messages, setMessages] = useState([]);
      const [input, setInput] = useState("");
      const [isLoading, setIsLoading] = useState(false);
      const [apiKey, setApiKey] = useState("");
      const [showApiKeyInput, setShowApiKeyInput] = useState(true);
      const [activeTab, setActiveTab] = useState('chat'); // chat, products, bundles, create
      const [editingItem, setEditingItem] = useState(null);
      const [editingType, setEditingType] = useState(null); // 'product' or 'bundle'
      const [createType, setCreateType] = useState('product');
      const [newItem, setNewItem] = useState({});
      const [showCreateForm, setShowCreateForm] = useState(false);
      const [showExcelWizard, setShowExcelWizard] = useState(false);
      const [excelFile, setExcelFile] = useState(null);
      const [excelSheets, setExcelSheets] = useState([]);
      const [selectedSheet, setSelectedSheet] = useState(null);
      const [excelData, setExcelData] = useState(null);
      const [dataIssues, setDataIssues] = useState([]);
      const [columnMappings, setColumnMappings] = useState({});
      const [wizardStep, setWizardStep] = useState(1);
      const messagesEndRef = useRef(null);

      const scrollToBottom = () => {
        messagesEndRef.current?.scrollIntoView({ behavior: "smooth" });
      };

      useEffect(() => {
        scrollToBottom();
      }, [messages]);

      useEffect(() => {
        const stored = localStorage.getItem('anthropic_api_key');
        if (stored) {
          setApiKey(stored);
          setShowApiKeyInput(false);
        }
      }, []);

      const handleFileUpload = (e, type) => {
        const file = e.target.files[0];
        if (!file) return;

        // Check if it's an Excel file
        if (file.name.endsWith('.xlsx') || file.name.endsWith('.xls')) {
          setExcelFile(file);
          setShowExcelWizard(true);
          setWizardStep(1);
          processExcelFile(file);
          return;
        }

        // Handle CSV as before
        Papa.parse(file, {
          header: true,
          skipEmptyLines: true,
          complete: (results) => {
            if (type === 'products') {
              setProducts(results.data);
              addMessage('system', `‚úÖ Loaded ${results.data.length} products`);
            } else {
              setBundles(results.data);
              addMessage('system', `‚úÖ Loaded ${results.data.length} bundles`);
            }
          },
          error: (error) => {
            addMessage('system', `‚ùå Error parsing ${type}: ${error.message}`);
          }
        });
      };

      const processExcelFile = (file) => {
        const reader = new FileReader();
        reader.onload = (e) => {
          try {
            const data = new Uint8Array(e.target.result);
            const workbook = XLSX.read(data, { type: 'array' });
            
            // Get all sheet names
            const sheets = workbook.SheetNames.map(name => ({
              name,
              data: XLSX.utils.sheet_to_json(workbook.Sheets[name], { defval: '' })
            }));
            
            setExcelSheets(sheets);
            
            // Auto-select first sheet if only one
            if (sheets.length === 1) {
              handleSheetSelect(sheets[0], 'products');
            }
          } catch (error) {
            addMessage('system', `‚ùå Error reading Excel file: ${error.message}`);
          }
        };
        reader.readAsArrayBuffer(file);
      };

      const handleSheetSelect = (sheet, targetType) => {
        setSelectedSheet(sheet);
        setExcelData(sheet.data);
        analyzeDataQuality(sheet.data);
        suggestColumnMappings(sheet.data, targetType);
        setWizardStep(2);
      };

      const analyzeDataQuality = (data) => {
        const issues = [];
        
        if (data.length === 0) {
          issues.push({ type: 'error', message: 'Sheet is empty' });
          setDataIssues(issues);
          return;
        }

        const columns = Object.keys(data[0]);
        
        // Check for empty columns
        columns.forEach(col => {
          const emptyCount = data.filter(row => !row[col] || row[col] === '').length;
          if (emptyCount > 0) {
            issues.push({
              type: 'warning',
              message: `Column "${col}" has ${emptyCount} empty cells`,
              fix: () => fillEmptyWithDefault(col)
            });
          }
        });

        // Check for duplicate rows
        const seen = new Set();
        const duplicates = data.filter(row => {
          const key = JSON.stringify(row);
          if (seen.has(key)) return true;
          seen.add(key);
          return false;
        });
        
        if (duplicates.length > 0) {
          issues.push({
            type: 'warning',
            message: `Found ${duplicates.length} duplicate rows`,
            fix: () => removeDuplicates()
          });
        }

        // Check for inconsistent price formatting
        const priceColumns = columns.filter(col => 
          col.toLowerCase().includes('price') || col.toLowerCase().includes('cost')
        );
        
        priceColumns.forEach(col => {
          const hasInconsistentFormat = data.some(row => {
            const val = String(row[col]);
            return val.includes('$') || val.includes('¬£') || val.includes('‚Ç¨');
          });
          
          if (hasInconsistentFormat) {
            issues.push({
              type: 'info',
              message: `Column "${col}" has currency symbols (will be cleaned)`,
              fix: () => cleanPriceFormat(col)
            });
          }
        });

        setDataIssues(issues);
      };

      const suggestColumnMappings = (data, targetType) => {
        if (data.length === 0) return;

        const sourceColumns = Object.keys(data[0]);
        const mappings = {};

        // Smart column detection
        const detectColumn = (patterns) => {
          return sourceColumns.find(col => 
            patterns.some(pattern => col.toLowerCase().includes(pattern))
          );
        };

        mappings.name = detectColumn(['name', 'title', 'product', 'item']);
        mappings.price = detectColumn(['price', 'cost', 'amount']);
        mappings.sku = detectColumn(['sku', 'code', 'id']);
        mappings.category = detectColumn(['category', 'type', 'group']);
        mappings.description = detectColumn(['description', 'desc', 'details']);

        setColumnMappings(mappings);
      };

      const fillEmptyWithDefault = (column) => {
        const updated = excelData.map(row => ({
          ...row,
          [column]: row[column] || 'N/A'
        }));
        setExcelData(updated);
        analyzeDataQuality(updated);
      };

      const removeDuplicates = () => {
        const unique = [];
        const seen = new Set();
        
        excelData.forEach(row => {
          const key = JSON.stringify(row);
          if (!seen.has(key)) {
            seen.add(key);
            unique.push(row);
          }
        });
        
        setExcelData(unique);
        analyzeDataQuality(unique);
        addMessage('system', `‚úÖ Removed ${excelData.length - unique.length} duplicate rows`);
      };

      const cleanPriceFormat = (column) => {
        const updated = excelData.map(row => ({
          ...row,
          [column]: String(row[column]).replace(/[$¬£‚Ç¨,]/g, '').trim()
        }));
        setExcelData(updated);
        analyzeDataQuality(updated);
        addMessage('system', `‚úÖ Cleaned price format in "${column}"`);
      };

      const applyMappingsAndImport = (targetType) => {
        const mapped = excelData.map(row => {
          const newRow = {};
          Object.entries(columnMappings).forEach(([target, source]) => {
            if (source) {
              newRow[target] = row[source];
            }
          });
          return newRow;
        });

        if (targetType === 'products') {
          setProducts(mapped);
          addMessage('system', `‚úÖ Imported ${mapped.length} products from Excel`);
        } else {
          setBundles(mapped);
          addMessage('system', `‚úÖ Imported ${mapped.length} bundles from Excel`);
        }

        setShowExcelWizard(false);
        setWizardStep(1);
      };

      const exportToExcel = (data, filename, type) => {
        // Create workbook
        const wb = XLSX.utils.book_new();
        
        // Add main data sheet
        const ws = XLSX.utils.json_to_sheet(data);
        XLSX.utils.book_append_sheet(wb, ws, type === 'products' ? 'Products' : 'Bundles');
        
        // Add summary sheet
        const summary = [
          { Metric: 'Total Items', Value: data.length },
          { Metric: 'Columns', Value: Object.keys(data[0] || {}).length },
          { Metric: 'Export Date', Value: new Date().toISOString() }
        ];
        const wsSummary = XLSX.utils.json_to_sheet(summary);
        XLSX.utils.book_append_sheet(wb, wsSummary, 'Summary');
        
        // Write file
        XLSX.writeFile(wb, filename);
        addMessage('system', `‚úÖ Exported to ${filename}`);
      };

      const addMessage = (role, content) => {
        setMessages(prev => [...prev, { role, content, timestamp: Date.now() }]);
      };

      const saveApiKey = () => {
        if (apiKey.trim()) {
          localStorage.setItem('anthropic_api_key', apiKey.trim());
          setShowApiKeyInput(false);
          addMessage('system', '‚úÖ API Key saved! Now I can help you with AI-powered analysis and creation.');
        }
      };

      const clearApiKey = () => {
        localStorage.removeItem('anthropic_api_key');
        setApiKey('');
        setShowApiKeyInput(true);
      };

      const callClaudeAPI = async (userPrompt, useExtendedThinking = false) => {
        try {
          // Prepare data summary and full data
          let dataContext = '';
          
          if (products.length > 0) {
            dataContext += `\n\nPRODUCTS (${products.length} total):\n`;
            dataContext += `Columns: ${Object.keys(products[0]).join(', ')}\n\n`;
            
            // Include full data for small datasets, sample for large
            if (products.length <= 100) {
              dataContext += `Complete products data:\n${JSON.stringify(products, null, 2)}\n`;
            } else {
              dataContext += `Sample products (first 20):\n${JSON.stringify(products.slice(0, 20), null, 2)}\n`;
              dataContext += `\nNote: ${products.length} total products available. These are the first 20 as examples.\n`;
            }
          }
          
          if (bundles.length > 0) {
            dataContext += `\n\nBUNDLES (${bundles.length} total):\n`;
            dataContext += `Columns: ${Object.keys(bundles[0]).join(', ')}\n\n`;
            
            if (bundles.length <= 100) {
              dataContext += `Complete bundles data:\n${JSON.stringify(bundles, null, 2)}\n`;
            } else {
              dataContext += `Sample bundles (first 20):\n${JSON.stringify(bundles.slice(0, 20), null, 2)}\n`;
              dataContext += `\nNote: ${bundles.length} total bundles available. These are the first 20 as examples.\n`;
            }
          }

          const systemPrompt = useExtendedThinking ? 
            `You are an expert AI assistant with advanced analytical capabilities. You have DIRECT ACCESS to the user's product catalog data.

REASONING APPROACH:
When faced with complex questions:
1. Break down the problem into steps
2. Analyze the data systematically
3. Show your reasoning process
4. Provide clear, actionable insights
5. Suggest follow-up actions if relevant

For difficult questions:
- Take time to think through the problem
- Consider multiple angles
- Cross-reference products and bundles
- Calculate statistics and relationships
- Provide evidence-based recommendations

${dataContext}

USER QUESTION: ${userPrompt}

TASK: Use advanced reasoning to answer this question thoroughly. Show your thought process and provide detailed analysis.` 
            : 
            `You are an AI assistant helping manage a product catalog. You have DIRECT ACCESS to the user's data below. Analyze it and answer their questions directly.

${dataContext}

USER QUESTION: ${userPrompt}

INSTRUCTIONS:
- You HAVE the data above - analyze it directly
- Answer questions about products, bundles, pricing, relationships, etc.
- If asked to create new items, generate realistic examples based on the existing data structure
- Be specific and reference actual data from above
- Don't ask the user to provide data - you already have it above`;

          // Call Netlify function instead of direct API
          const response = await fetch("/.netlify/functions/claude-proxy", {
            method: "POST",
            headers: {
              "Content-Type": "application/json"
            },
            body: JSON.stringify({
              apiKey: apiKey,
              messages: [{ role: "user", content: systemPrompt }],
              max_tokens: useExtendedThinking ? 4000 : 2000
            })
          });

          if (!response.ok) {
            const errorData = await response.json().catch(() => ({}));
            throw new Error(errorData.error || `API failed: ${response.status}`);
          }

          const data = await response.json();
          return data.content[0].text;
        } catch (error) {
          throw error;
        }
      };

      const handleSubmit = async (e) => {
        e.preventDefault();
        if (!input.trim() || isLoading) return;

        if (!apiKey) {
          addMessage('system', '‚ö†Ô∏è Please enter your Anthropic API key first');
          setShowApiKeyInput(true);
          return;
        }

        const userMessage = input;
        setInput("");
        addMessage('user', userMessage);
        setIsLoading(true);

        try {
          // Detect if this is a complex question that needs extended thinking
          const complexKeywords = [
            'analyze', 'strategy', 'optimize', 'recommend', 'compare',
            'why', 'how should', 'what if', 'best way', 'improve',
            'insights', 'trends', 'patterns', 'evaluate', 'assess',
            'pros and cons', 'advantages', 'disadvantages', 'trade-off',
            'complex', 'difficult', 'challenging', 'detailed analysis'
          ];
          
          const isComplex = complexKeywords.some(keyword => 
            userMessage.toLowerCase().includes(keyword)
          );

          if (isComplex) {
            addMessage('system', 'üß† Using extended thinking for this complex question...');
          }

          const response = await callClaudeAPI(userMessage, isComplex);
          addMessage('assistant', response);
        } catch (error) {
          console.error("Error:", error);
          addMessage('system', `‚ùå Error: ${error.message}`);
          if (error.message.includes('401') || error.message.includes('authentication')) {
            setShowApiKeyInput(true);
          }
        } finally {
          setIsLoading(false);
        }
      };

      const downloadCSV = (data, filename) => {
        const csv = Papa.unparse(data);
        const blob = new Blob([csv], { type: 'text/csv' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        a.click();
      };

      const handleCreateItem = async () => {
        if (!apiKey) {
          alert('Please add your API key first');
          setShowApiKeyInput(true);
          return;
        }

        setIsLoading(true);
        try {
          const prompt = createType === 'product' 
            ? `Help me create a new product. Based on my existing products, suggest a template with all the fields I need. Format it as a JSON object.`
            : `Help me create a new bundle. Based on my existing bundles and products, suggest a template with all the fields I need. Format it as a JSON object.`;
          
          const response = await callClaudeAPI(prompt);
          addMessage('assistant', `Here's a template for creating a new ${createType}:\n\n${response}\n\nFill this out and I can help you add it to your catalog!`);
          setActiveTab('chat');
        } catch (error) {
          addMessage('system', `‚ùå Error: ${error.message}`);
        } finally {
          setIsLoading(false);
        }
      };

      const deleteItem = (type, index) => {
        if (confirm(`Delete this ${type}?`)) {
          if (type === 'product') {
            const newProducts = [...products];
            newProducts.splice(index, 1);
            setProducts(newProducts);
            addMessage('system', `‚úÖ Product deleted`);
          } else {
            const newBundles = [...bundles];
            newBundles.splice(index, 1);
            setBundles(newBundles);
            addMessage('system', `‚úÖ Bundle deleted`);
          }
        }
      };

      const startEdit = (type, index) => {
        if (type === 'product') {
          setEditingItem({ ...products[index], index });
          setEditingType('product');
        } else {
          setEditingItem({ ...bundles[index], index });
          setEditingType('bundle');
        }
      };

      const saveEdit = () => {
        if (editingType === 'product') {
          const newProducts = [...products];
          const { index, ...itemData } = editingItem;
          newProducts[index] = itemData;
          setProducts(newProducts);
          addMessage('system', `‚úÖ Product updated`);
        } else {
          const newBundles = [...bundles];
          const { index, ...itemData } = editingItem;
          newBundles[index] = itemData;
          setBundles(newBundles);
          addMessage('system', `‚úÖ Bundle updated`);
        }
        setEditingItem(null);
        setEditingType(null);
      };

      const cancelEdit = () => {
        setEditingItem(null);
        setEditingType(null);
      };

      const initializeNewItem = (type) => {
        const template = type === 'product' 
          ? (products.length > 0 ? Object.keys(products[0]).reduce((acc, key) => ({ ...acc, [key]: '' }), {}) : {})
          : (bundles.length > 0 ? Object.keys(bundles[0]).reduce((acc, key) => ({ ...acc, [key]: '' }), {}) : {});
        setNewItem(template);
        setCreateType(type);
        setShowCreateForm(true);
      };

      const saveNewItem = () => {
        if (createType === 'product') {
          setProducts([...products, newItem]);
          addMessage('system', `‚úÖ New product added!`);
        } else {
          setBundles([...bundles, newItem]);
          addMessage('system', `‚úÖ New bundle added!`);
        }
        setNewItem({});
        setShowCreateForm(false);
        setActiveTab(createType === 'product' ? 'products' : 'bundles');
      };

      const askAIToCreate = async (type) => {
        if (!apiKey) {
          alert('Please add your API key first');
          setShowApiKeyInput(true);
          return;
        }

        setIsLoading(true);
        setActiveTab('chat');
        
        try {
          const prompt = type === 'product' 
            ? `Create a new product template based on my existing products. Give me a filled-out example with realistic values that matches my data structure. Format it as JSON with the exact column names I use.`
            : `Create a new bundle template based on my existing bundles and products. Give me a filled-out example with realistic values. Include which products should be in this bundle. Format it as JSON with the exact column names I use.`;
          
          addMessage('user', prompt);
          const response = await callClaudeAPI(prompt);
          addMessage('assistant', response + '\n\nüí° Copy the JSON and paste it into the create form, or I can help you refine it!');
        } catch (error) {
          addMessage('system', `‚ùå Error: ${error.message}`);
        } finally {
          setIsLoading(false);
        }
      };

      return (
        <div className="min-h-screen bg-gradient-to-br from-purple-50 via-blue-50 to-indigo-100">
          <div className="container mx-auto px-4 py-6 max-w-7xl">
            
            {/* Header */}
            <div className="bg-white rounded-xl shadow-xl p-6 mb-6 border-t-4 border-purple-500">
              <div className="flex items-center justify-between">
                <div>
                  <h1 className="text-4xl font-bold bg-gradient-to-r from-purple-600 to-blue-600 bg-clip-text text-transparent mb-2">
                    ü§ñ AI Product Catalog Manager
                  </h1>
                  <p className="text-gray-600">
                    AI-powered catalog management ‚Ä¢ Create, analyze, and optimize your products & bundles
                  </p>
                </div>
                <div className="text-right">
                  <div className="text-sm text-gray-500">
                    {products.length} products ‚Ä¢ {bundles.length} bundles
                  </div>
                </div>
              </div>
            </div>

            {/* API Key Section */}
            {showApiKeyInput && (
              <div className="bg-gradient-to-r from-yellow-50 to-orange-50 border-2 border-yellow-300 rounded-xl shadow-lg p-6 mb-6">
                <h2 className="text-xl font-semibold text-gray-800 mb-2 flex items-center">
                  üîë API Key Required for AI Features
                </h2>
                <p className="text-sm text-gray-600 mb-4">
                  Get your free API key at{' '}
                  <a href="https://console.anthropic.com/" target="_blank" className="text-blue-600 hover:underline font-semibold">
                    console.anthropic.com
                  </a>
                </p>
                <div className="flex gap-2">
                  <input
                    type="password"
                    value={apiKey}
                    onChange={(e) => setApiKey(e.target.value)}
                    placeholder="sk-ant-..."
                    className="flex-1 px-4 py-3 border-2 border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                  />
                  <button
                    onClick={saveApiKey}
                    className="px-8 py-3 bg-gradient-to-r from-purple-600 to-blue-600 text-white rounded-lg hover:from-purple-700 hover:to-blue-700 transition font-semibold shadow-md"
                  >
                    Save Key
                  </button>
                </div>
              </div>
            )}

            {!showApiKeyInput && (
              <div className="bg-green-50 border border-green-200 rounded-lg p-3 mb-6 flex items-center justify-between">
                <span className="text-green-800 text-sm font-medium">‚úÖ AI Enabled</span>
                <button
                  onClick={clearApiKey}
                  className="text-sm text-red-600 hover:text-red-800 underline"
                >
                  Clear Key
                </button>
              </div>
            )}

            {/* File Upload */}
            <div className="bg-white rounded-xl shadow-lg p-6 mb-6">
              <h2 className="text-xl font-semibold text-gray-800 mb-4">üìÅ Upload Your Data</h2>
              <div className="grid md:grid-cols-2 gap-4">
                <div className="border-2 border-dashed border-purple-300 rounded-lg p-4 hover:border-purple-500 transition">
                  <label className="block text-sm font-medium text-gray-700 mb-2">
                    Products CSV/Excel {products.length > 0 && <span className="text-green-600">‚úì {products.length} loaded</span>}
                  </label>
                  <input
                    type="file"
                    accept=".csv,.xlsx,.xls"
                    onChange={(e) => handleFileUpload(e, 'products')}
                    className="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-purple-50 file:text-purple-700 hover:file:bg-purple-100 cursor-pointer"
                  />
                  <p className="text-xs text-gray-500 mt-2">‚ú® Supports CSV, XLSX, and XLS files</p>
                </div>
                <div className="border-2 border-dashed border-blue-300 rounded-lg p-4 hover:border-blue-500 transition">
                  <label className="block text-sm font-medium text-gray-700 mb-2">
                    Bundles CSV/Excel {bundles.length > 0 && <span className="text-green-600">‚úì {bundles.length} loaded</span>}
                  </label>
                  <input
                    type="file"
                    accept=".csv,.xlsx,.xls"
                    onChange={(e) => handleFileUpload(e, 'bundles')}
                    className="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100 cursor-pointer"
                  />
                  <p className="text-xs text-gray-500 mt-2">‚ú® Supports CSV, XLSX, and XLS files</p>
                </div>
              </div>
            </div>

            {/* Tabs */}
            <div className="bg-white rounded-xl shadow-lg mb-6 overflow-hidden">
              <div className="flex border-b border-gray-200">
                <button
                  onClick={() => setActiveTab('chat')}
                  className={`flex-1 px-6 py-4 font-semibold transition ${
                    activeTab === 'chat'
                      ? 'bg-gradient-to-r from-purple-500 to-blue-500 text-white'
                      : 'text-gray-600 hover:bg-gray-50'
                  }`}
                >
                  üí¨ AI Chat
                </button>
                <button
                  onClick={() => setActiveTab('products')}
                  className={`flex-1 px-6 py-4 font-semibold transition ${
                    activeTab === 'products'
                      ? 'bg-gradient-to-r from-purple-500 to-blue-500 text-white'
                      : 'text-gray-600 hover:bg-gray-50'
                  }`}
                >
                  üì¶ Products ({products.length})
                </button>
                <button
                  onClick={() => setActiveTab('bundles')}
                  className={`flex-1 px-6 py-4 font-semibold transition ${
                    activeTab === 'bundles'
                      ? 'bg-gradient-to-r from-purple-500 to-blue-500 text-white'
                      : 'text-gray-600 hover:bg-gray-50'
                  }`}
                >
                  üéÅ Bundles ({bundles.length})
                </button>
                <button
                  onClick={() => setActiveTab('create')}
                  className={`flex-1 px-6 py-4 font-semibold transition ${
                    activeTab === 'create'
                      ? 'bg-gradient-to-r from-purple-500 to-blue-500 text-white'
                      : 'text-gray-600 hover:bg-gray-50'
                  }`}
                >
                  ‚ûï Create New
                </button>
              </div>

              {/* Tab Content */}
              <div className="p-6">
                
                {/* Chat Tab */}
                {activeTab === 'chat' && (
                  <div>
                    <div className="h-96 overflow-y-auto mb-4 space-y-4 p-4 bg-gray-50 rounded-lg">
                      {messages.length === 0 ? (
                        <div className="text-center text-gray-500 mt-20">
                          <p className="text-lg mb-4">üëã Ask me anything!</p>
                          <div className="flex flex-wrap gap-2 justify-center max-w-2xl mx-auto">
                            {[
                              "What bundles contain which products?",
                              "Analyze my pricing strategy and suggest improvements",
                              "Which products should I bundle together?",
                              "How can I optimize my catalog for better margins?",
                              "Compare bundle values vs individual products"
                            ].map((q, i) => (
                              <button
                                key={i}
                                onClick={() => setInput(q)}
                                className="px-4 py-2 bg-white text-purple-700 rounded-full text-sm hover:bg-purple-50 transition shadow-sm border border-purple-200"
                              >
                                {q}
                              </button>
                            ))}
                          </div>
                        </div>
                      ) : (
                        messages.map((msg, idx) => (
                          <div
                            key={idx}
                            className={`flex ${msg.role === 'user' ? 'justify-end' : 'justify-start'}`}
                          >
                            <div
                              className={`max-w-3xl px-4 py-3 rounded-lg shadow-md ${
                                msg.role === 'user'
                                  ? 'bg-gradient-to-r from-purple-600 to-blue-600 text-white'
                                  : msg.role === 'system'
                                  ? 'bg-yellow-50 text-yellow-800 border border-yellow-200'
                                  : 'bg-white text-gray-800 border border-gray-200'
                              }`}
                            >
                              <pre className="whitespace-pre-wrap font-sans text-sm">{msg.content}</pre>
                            </div>
                          </div>
                        ))
                      )}
                      {isLoading && (
                        <div className="flex justify-start">
                          <div className="bg-white text-gray-800 px-4 py-3 rounded-lg shadow-md border border-gray-200">
                            <div className="flex items-center space-x-2">
                              <div className="w-2 h-2 bg-purple-500 rounded-full animate-bounce"></div>
                              <div className="w-2 h-2 bg-blue-500 rounded-full animate-bounce" style={{animationDelay: '0.1s'}}></div>
                              <div className="w-2 h-2 bg-indigo-500 rounded-full animate-bounce" style={{animationDelay: '0.2s'}}></div>
                            </div>
                          </div>
                        </div>
                      )}
                      <div ref={messagesEndRef} />
                    </div>

                    <form onSubmit={handleSubmit} className="flex gap-2">
                      <input
                        type="text"
                        value={input}
                        onChange={(e) => setInput(e.target.value)}
                        placeholder="Ask anything... e.g., 'Help me create a new product' or 'What bundles contain X?'"
                        disabled={!apiKey}
                        className="flex-1 px-4 py-3 border-2 border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent disabled:bg-gray-100"
                      />
                      <button
                        type="submit"
                        disabled={!input.trim() || isLoading || !apiKey}
                        className="px-8 py-3 bg-gradient-to-r from-purple-600 to-blue-600 text-white rounded-lg hover:from-purple-700 hover:to-blue-700 disabled:bg-gray-300 disabled:cursor-not-allowed transition font-semibold shadow-md"
                      >
                        Send
                      </button>
                    </form>
                  </div>
                )}

                {/* Products Tab */}
                {activeTab === 'products' && (
                  <div>
                    <div className="flex justify-between items-center mb-4">
                      <h3 className="text-xl font-semibold">Your Products</h3>
                      <div className="flex gap-2">
                        <button
                          onClick={() => initializeNewItem('product')}
                          className="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition text-sm font-semibold"
                        >
                          ‚ûï Add Product
                        </button>
                        {products.length > 0 && (
                          <button
                            onClick={() => downloadCSV(products, 'products.csv')}
                            className="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition text-sm font-semibold"
                          >
                            üíæ CSV
                          </button>
                          <button
                            onClick={() => exportToExcel(products, 'products.xlsx', 'products')}
                            className="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition text-sm font-semibold"
                          >
                            üìä Excel
                          </button>
                        )}
                      </div>
                    </div>
                    
                    {products.length === 0 ? (
                      <div className="text-center py-12 text-gray-500">
                        <p className="text-lg">No products loaded yet.</p>
                        <p className="text-sm mt-2">Upload a products.csv file or create one from scratch.</p>
                        <button
                          onClick={() => initializeNewItem('product')}
                          className="mt-4 px-6 py-3 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition font-semibold"
                        >
                          Create Your First Product
                        </button>
                      </div>
                    ) : (
                      <div className="overflow-x-auto">
                        <table className="w-full text-sm">
                          <thead className="bg-purple-100 border-b-2 border-purple-300">
                            <tr>
                              {Object.keys(products[0]).map((key, i) => (
                                <th key={i} className="px-4 py-3 text-left font-semibold text-gray-700">
                                  {key}
                                </th>
                              ))}
                              <th className="px-4 py-3 text-left font-semibold text-gray-700">Actions</th>
                            </tr>
                          </thead>
                          <tbody>
                            {products.map((product, idx) => (
                              <tr key={idx} className="border-b border-gray-200 hover:bg-purple-50">
                                {Object.values(product).map((val, i) => (
                                  <td key={i} className="px-4 py-3">{val}</td>
                                ))}
                                <td className="px-4 py-3">
                                  <div className="flex gap-2">
                                    <button
                                      onClick={() => startEdit('product', idx)}
                                      className="text-blue-600 hover:text-blue-800 text-xs font-semibold"
                                    >
                                      Edit
                                    </button>
                                    <button
                                      onClick={() => deleteItem('product', idx)}
                                      className="text-red-600 hover:text-red-800 text-xs font-semibold"
                                    >
                                      Delete
                                    </button>
                                  </div>
                                </td>
                              </tr>
                            ))}
                          </tbody>
                        </table>
                      </div>
                    )}

                    {/* Edit Modal */}
                    {editingItem && editingType === 'product' && (
                      <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
                        <div className="bg-white rounded-xl p-6 max-w-2xl w-full max-h-[80vh] overflow-y-auto">
                          <h3 className="text-2xl font-bold mb-4">Edit Product</h3>
                          <div className="space-y-3">
                            {Object.entries(editingItem).filter(([key]) => key !== 'index').map(([key, value]) => (
                              <div key={key}>
                                <label className="block text-sm font-semibold text-gray-700 mb-1">{key}</label>
                                <input
                                  type="text"
                                  value={value}
                                  onChange={(e) => setEditingItem({...editingItem, [key]: e.target.value})}
                                  className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                                />
                              </div>
                            ))}
                          </div>
                          <div className="flex gap-3 mt-6">
                            <button
                              onClick={saveEdit}
                              className="flex-1 px-4 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 transition font-semibold"
                            >
                              Save Changes
                            </button>
                            <button
                              onClick={cancelEdit}
                              className="flex-1 px-4 py-3 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400 transition font-semibold"
                            >
                              Cancel
                            </button>
                          </div>
                        </div>
                      </div>
                    )}

                    {/* Create Modal */}
                    {showCreateForm && createType === 'product' && (
                      <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
                        <div className="bg-white rounded-xl p-6 max-w-2xl w-full max-h-[80vh] overflow-y-auto">
                          <h3 className="text-2xl font-bold mb-4">Create New Product</h3>
                          <div className="mb-4">
                            <button
                              onClick={() => askAIToCreate('product')}
                              disabled={!apiKey}
                              className="w-full px-4 py-2 bg-gradient-to-r from-purple-600 to-blue-600 text-white rounded-lg hover:from-purple-700 hover:to-blue-700 transition font-semibold"
                            >
                              ü§ñ Ask AI to Generate Example
                            </button>
                          </div>
                          <div className="space-y-3">
                            {Object.keys(newItem).map((key) => (
                              <div key={key}>
                                <label className="block text-sm font-semibold text-gray-700 mb-1">{key}</label>
                                <input
                                  type="text"
                                  value={newItem[key]}
                                  onChange={(e) => setNewItem({...newItem, [key]: e.target.value})}
                                  className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                                  placeholder={`Enter ${key}`}
                                />
                              </div>
                            ))}
                          </div>
                          <div className="flex gap-3 mt-6">
                            <button
                              onClick={saveNewItem}
                              className="flex-1 px-4 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 transition font-semibold"
                            >
                              Create Product
                            </button>
                            <button
                              onClick={() => setShowCreateForm(false)}
                              className="flex-1 px-4 py-3 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400 transition font-semibold"
                            >
                              Cancel
                            </button>
                          </div>
                        </div>
                      </div>
                    )}
                  </div>
                )}

                {/* Bundles Tab */}
                {activeTab === 'bundles' && (
                  <div>
                    <div className="flex justify-between items-center mb-4">
                      <h3 className="text-xl font-semibold">Your Bundles</h3>
                      <div className="flex gap-2">
                        <button
                          onClick={() => initializeNewItem('bundle')}
                          className="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition text-sm font-semibold"
                        >
                          ‚ûï Add Bundle
                        </button>
                        {bundles.length > 0 && (
                          <>
                            <button
                              onClick={() => downloadCSV(bundles, 'bundles.csv')}
                              className="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition text-sm font-semibold"
                            >
                              üíæ CSV
                            </button>
                            <button
                              onClick={() => exportToExcel(bundles, 'bundles.xlsx', 'bundles')}
                              className="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition text-sm font-semibold"
                            >
                              üìä Excel
                            </button>
                          </>
                        )}
                      </div>
                    </div>
                    
                    {bundles.length === 0 ? (
                      <div className="text-center py-12 text-gray-500">
                        <p className="text-lg">No bundles loaded yet.</p>
                        <p className="text-sm mt-2">Upload a bundles.csv file or create one from scratch.</p>
                        <button
                          onClick={() => initializeNewItem('bundle')}
                          className="mt-4 px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition font-semibold"
                        >
                          Create Your First Bundle
                        </button>
                      </div>
                    ) : (
                      <div className="overflow-x-auto">
                        <table className="w-full text-sm">
                          <thead className="bg-blue-100 border-b-2 border-blue-300">
                            <tr>
                              {Object.keys(bundles[0]).map((key, i) => (
                                <th key={i} className="px-4 py-3 text-left font-semibold text-gray-700">
                                  {key}
                                </th>
                              ))}
                              <th className="px-4 py-3 text-left font-semibold text-gray-700">Actions</th>
                            </tr>
                          </thead>
                          <tbody>
                            {bundles.map((bundle, idx) => (
                              <tr key={idx} className="border-b border-gray-200 hover:bg-blue-50">
                                {Object.values(bundle).map((val, i) => (
                                  <td key={i} className="px-4 py-3">{val}</td>
                                ))}
                                <td className="px-4 py-3">
                                  <div className="flex gap-2">
                                    <button
                                      onClick={() => startEdit('bundle', idx)}
                                      className="text-blue-600 hover:text-blue-800 text-xs font-semibold"
                                    >
                                      Edit
                                    </button>
                                    <button
                                      onClick={() => deleteItem('bundle', idx)}
                                      className="text-red-600 hover:text-red-800 text-xs font-semibold"
                                    >
                                      Delete
                                    </button>
                                  </div>
                                </td>
                              </tr>
                            ))}
                          </tbody>
                        </table>
                      </div>
                    )}

                    {/* Edit Modal */}
                    {editingItem && editingType === 'bundle' && (
                      <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
                        <div className="bg-white rounded-xl p-6 max-w-2xl w-full max-h-[80vh] overflow-y-auto">
                          <h3 className="text-2xl font-bold mb-4">Edit Bundle</h3>
                          <div className="space-y-3">
                            {Object.entries(editingItem).filter(([key]) => key !== 'index').map(([key, value]) => (
                              <div key={key}>
                                <label className="block text-sm font-semibold text-gray-700 mb-1">{key}</label>
                                <input
                                  type="text"
                                  value={value}
                                  onChange={(e) => setEditingItem({...editingItem, [key]: e.target.value})}
                                  className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                />
                              </div>
                            ))}
                          </div>
                          <div className="flex gap-3 mt-6">
                            <button
                              onClick={saveEdit}
                              className="flex-1 px-4 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 transition font-semibold"
                            >
                              Save Changes
                            </button>
                            <button
                              onClick={cancelEdit}
                              className="flex-1 px-4 py-3 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400 transition font-semibold"
                            >
                              Cancel
                            </button>
                          </div>
                        </div>
                      </div>
                    )}

                    {/* Create Modal */}
                    {showCreateForm && createType === 'bundle' && (
                      <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
                        <div className="bg-white rounded-xl p-6 max-w-2xl w-full max-h-[80vh] overflow-y-auto">
                          <h3 className="text-2xl font-bold mb-4">Create New Bundle</h3>
                          <div className="mb-4">
                            <button
                              onClick={() => askAIToCreate('bundle')}
                              disabled={!apiKey}
                              className="w-full px-4 py-2 bg-gradient-to-r from-purple-600 to-blue-600 text-white rounded-lg hover:from-purple-700 hover:to-blue-700 transition font-semibold"
                            >
                              ü§ñ Ask AI to Generate Example
                            </button>
                          </div>
                          <div className="space-y-3">
                            {Object.keys(newItem).map((key) => (
                              <div key={key}>
                                <label className="block text-sm font-semibold text-gray-700 mb-1">{key}</label>
                                <input
                                  type="text"
                                  value={newItem[key]}
                                  onChange={(e) => setNewItem({...newItem, [key]: e.target.value})}
                                  className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                  placeholder={`Enter ${key}`}
                                />
                              </div>
                            ))}
                          </div>
                          <div className="flex gap-3 mt-6">
                            <button
                              onClick={saveNewItem}
                              className="flex-1 px-4 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 transition font-semibold"
                            >
                              Create Bundle
                            </button>
                            <button
                              onClick={() => setShowCreateForm(false)}
                              className="flex-1 px-4 py-3 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400 transition font-semibold"
                            >
                              Cancel
                            </button>
                          </div>
                        </div>
                      </div>
                    )}
                  </div>
                )}

                {/* Create Tab */}
                {activeTab === 'create' && (
                  <div className="max-w-3xl mx-auto">
                    <h3 className="text-2xl font-bold text-center mb-6">AI-Powered Creation Studio</h3>
                    
                    <div className="bg-gradient-to-r from-purple-50 to-blue-50 rounded-lg p-8 mb-6 border-2 border-purple-200">
                      <p className="text-gray-700 mb-6 text-center text-lg">
                        Let AI help you create products and bundles with smart suggestions!
                      </p>
                      
                      <div className="grid md:grid-cols-2 gap-4 mb-6">
                        <button
                          onClick={() => {
                            setCreateType('product');
                            initializeNewItem('product');
                          }}
                          className="p-8 bg-white rounded-xl border-2 border-purple-300 hover:border-purple-500 hover:shadow-xl transition transform hover:scale-105"
                        >
                          <div className="text-5xl mb-4">üì¶</div>
                          <h4 className="font-bold text-xl mb-2">Create Product</h4>
                          <p className="text-sm text-gray-600">Add a new product with AI assistance</p>
                        </button>
                        
                        <button
                          onClick={() => {
                            setCreateType('bundle');
                            initializeNewItem('bundle');
                          }}
                          className="p-8 bg-white rounded-xl border-2 border-blue-300 hover:border-blue-500 hover:shadow-xl transition transform hover:scale-105"
                        >
                          <div className="text-5xl mb-4">üéÅ</div>
                          <h4 className="font-bold text-xl mb-2">Create Bundle</h4>
                          <p className="text-sm text-gray-600">Build a new product bundle</p>
                        </button>
                      </div>

                      <div className="bg-white rounded-lg p-6 mb-4 border border-purple-200">
                        <h4 className="font-bold mb-3 text-purple-900 flex items-center">
                          <span className="text-2xl mr-2">ü§ñ</span>
                          Or Ask AI to Create for You
                        </h4>
                        <div className="space-y-3">
                          <button
                            onClick={async () => {
                              if (!apiKey) {
                                alert('Please add your API key first');
                                setShowApiKeyInput(true);
                                return;
                              }
                              const prompt = "Create a new product for me. Analyze my existing products and suggest a realistic new product that would fit well in my catalog. Include all required fields with appropriate values.";
                              setInput(prompt);
                              setActiveTab('chat');
                              setTimeout(() => {
                                document.querySelector('form').dispatchEvent(new Event('submit', { cancelable: true, bubbles: true }));
                              }, 100);
                            }}
                            disabled={!apiKey}
                            className="w-full px-6 py-4 bg-gradient-to-r from-purple-600 to-purple-700 text-white rounded-lg hover:from-purple-700 hover:to-purple-800 disabled:bg-gray-300 transition font-semibold text-left flex items-center justify-between group"
                          >
                            <span>‚ú® Generate Product Suggestion</span>
                            <span className="text-2xl group-hover:translate-x-1 transition">‚Üí</span>
                          </button>
                          
                          <button
                            onClick={async () => {
                              if (!apiKey) {
                                alert('Please add your API key first');
                                setShowApiKeyInput(true);
                                return;
                              }
                              const prompt = "Create a new bundle for me. Analyze my products and bundles, then suggest a compelling new bundle with products that complement each other. Explain why these products work well together.";
                              setInput(prompt);
                              setActiveTab('chat');
                              setTimeout(() => {
                                document.querySelector('form').dispatchEvent(new Event('submit', { cancelable: true, bubbles: true }));
                              }, 100);
                            }}
                            disabled={!apiKey}
                            className="w-full px-6 py-4 bg-gradient-to-r from-blue-600 to-blue-700 text-white rounded-lg hover:from-blue-700 hover:to-blue-800 disabled:bg-gray-300 transition font-semibold text-left flex items-center justify-between group"
                          >
                            <span>‚ú® Generate Bundle Suggestion</span>
                            <span className="text-2xl group-hover:translate-x-1 transition">‚Üí</span>
                          </button>

                          <button
                            onClick={async () => {
                              if (!apiKey) {
                                alert('Please add your API key first');
                                setShowApiKeyInput(true);
                                return;
                              }
                              const prompt = "Based on my current catalog, recommend 3 new products I should consider adding. Analyze gaps in my offerings, pricing tiers, and categories. Provide specific suggestions with reasoning.";
                              setInput(prompt);
                              setActiveTab('chat');
                              setTimeout(() => {
                                document.querySelector('form').dispatchEvent(new Event('submit', { cancelable: true, bubbles: true }));
                              }, 100);
                            }}
                            disabled={!apiKey}
                            className="w-full px-6 py-4 bg-gradient-to-r from-indigo-600 to-indigo-700 text-white rounded-lg hover:from-indigo-700 hover:to-indigo-800 disabled:bg-gray-300 transition font-semibold text-left flex items-center justify-between group"
                          >
                            <span>üí° Recommend New Products</span>
                            <span className="text-2xl group-hover:translate-x-1 transition">‚Üí</span>
                          </button>
                        </div>
                      </div>
                    </div>

                    <div className="grid md:grid-cols-2 gap-4">
                      <div className="bg-blue-50 border border-blue-200 rounded-lg p-5">
                        <h4 className="font-bold mb-3 text-blue-900">üí° Quick Tips:</h4>
                        <ul className="space-y-2 text-sm text-blue-800">
                          <li>‚Ä¢ AI analyzes your existing catalog structure</li>
                          <li>‚Ä¢ Get smart suggestions based on your data</li>
                          <li>‚Ä¢ AI matches your column names automatically</li>
                          <li>‚Ä¢ Refine suggestions in the chat</li>
                        </ul>
                      </div>

                      <div className="bg-green-50 border border-green-200 rounded-lg p-5">
                        <h4 className="font-bold mb-3 text-green-900">üéØ Best Practices:</h4>
                        <ul className="space-y-2 text-sm text-green-800">
                          <li>‚Ä¢ Upload your CSVs first for better AI suggestions</li>
                          <li>‚Ä¢ Ask AI to explain bundle recommendations</li>
                          <li>‚Ä¢ Request multiple options to choose from</li>
                          <li>‚Ä¢ Let AI analyze pricing and categories</li>
                        </ul>
                      </div>
                    </div>
                  </div>
                )}

              </div>
            </div>

            {/* Excel Wizard Modal */}
            {showExcelWizard && (
              <div className="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 p-4">
                <div className="bg-white rounded-2xl max-w-4xl w-full max-h-[90vh] overflow-y-auto shadow-2xl">
                  
                  {/* Header */}
                  <div className="bg-gradient-to-r from-green-600 to-teal-600 p-6 text-white">
                    <h2 className="text-3xl font-bold flex items-center">
                      <span className="text-4xl mr-3">üìä</span>
                      Excel Import Wizard
                    </h2>
                    <p className="mt-2 text-green-100">Step {wizardStep} of 3</p>
                  </div>

                  <div className="p-6">
                    
                    {/* Step 1: Sheet Selection */}
                    {wizardStep === 1 && excelSheets.length > 0 && (
                      <div>
                        <h3 className="text-2xl font-bold mb-4">Select Sheet to Import</h3>
                        <p className="text-gray-600 mb-6">Choose which sheet contains your data</p>
                        
                        <div className="space-y-3">
                          {excelSheets.map((sheet, idx) => (
                            <div key={idx} className="border-2 border-gray-200 rounded-lg p-4 hover:border-green-500 transition">
                              <div className="flex items-center justify-between">
                                <div>
                                  <h4 className="font-bold text-lg">{sheet.name}</h4>
                                  <p className="text-sm text-gray-500">{sheet.data.length} rows, {Object.keys(sheet.data[0] || {}).length} columns</p>
                                </div>
                                <div className="flex gap-2">
                                  <button
                                    onClick={() => handleSheetSelect(sheet, 'products')}
                                    className="px-6 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition font-semibold"
                                  >
                                    Import as Products
                                  </button>
                                  <button
                                    onClick={() => handleSheetSelect(sheet, 'bundles')}
                                    className="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition font-semibold"
                                  >
                                    Import as Bundles
                                  </button>
                                </div>
                              </div>
                              
                              {/* Preview */}
                              {sheet.data.length > 0 && (
                                <div className="mt-4 overflow-x-auto">
                                  <table className="min-w-full text-xs">
                                    <thead className="bg-gray-100">
                                      <tr>
                                        {Object.keys(sheet.data[0]).slice(0, 5).map((col, i) => (
                                          <th key={i} className="px-3 py-2 text-left font-semibold">{col}</th>
                                        ))}
                                        {Object.keys(sheet.data[0]).length > 5 && (
                                          <th className="px-3 py-2 text-left font-semibold">...</th>
                                        )}
                                      </tr>
                                    </thead>
                                    <tbody>
                                      {sheet.data.slice(0, 3).map((row, i) => (
                                        <tr key={i} className="border-b">
                                          {Object.values(row).slice(0, 5).map((val, j) => (
                                            <td key={j} className="px-3 py-2">{String(val).substring(0, 20)}</td>
                                          ))}
                                        </tr>
                                      ))}
                                    </tbody>
                                  </table>
                                </div>
                              )}
                            </div>
                          ))}
                        </div>
                      </div>
                    )}

                    {/* Step 2: Data Quality Check */}
                    {wizardStep === 2 && (
                      <div>
                        <h3 className="text-2xl font-bold mb-4">Data Quality Report</h3>
                        <p className="text-gray-600 mb-6">Found {dataIssues.length} potential issues</p>

                        {dataIssues.length === 0 ? (
                          <div className="bg-green-50 border-2 border-green-200 rounded-lg p-6 mb-6">
                            <div className="flex items-center">
                              <span className="text-4xl mr-4">‚úÖ</span>
                              <div>
                                <h4 className="font-bold text-green-900 text-lg">Data looks great!</h4>
                                <p className="text-green-700">No issues detected. Ready to import.</p>
                              </div>
                            </div>
                          </div>
                        ) : (
                          <div className="space-y-3 mb-6">
                            {dataIssues.map((issue, idx) => (
                              <div key={idx} className={`border-2 rounded-lg p-4 ${
                                issue.type === 'error' ? 'border-red-200 bg-red-50' :
                                issue.type === 'warning' ? 'border-yellow-200 bg-yellow-50' :
                                'border-blue-200 bg-blue-50'
                              }`}>
                                <div className="flex items-center justify-between">
                                  <div className="flex items-center">
                                    <span className="text-2xl mr-3">
                                      {issue.type === 'error' ? '‚ùå' : issue.type === 'warning' ? '‚ö†Ô∏è' : '‚ÑπÔ∏è'}
                                    </span>
                                    <p className="font-semibold">{issue.message}</p>
                                  </div>
                                  {issue.fix && (
                                    <button
                                      onClick={issue.fix}
                                      className="px-4 py-2 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 transition text-sm font-semibold"
                                    >
                                      Fix Now
                                    </button>
                                  )}
                                </div>
                              </div>
                            ))}
                          </div>
                        )}

                        {/* Data Preview */}
                        <div className="mb-6">
                          <h4 className="font-bold text-lg mb-3">Data Preview ({excelData?.length} rows)</h4>
                          <div className="overflow-x-auto border rounded-lg">
                            <table className="min-w-full text-sm">
                              <thead className="bg-gray-100">
                                <tr>
                                  {Object.keys(excelData?.[0] || {}).map((col, i) => (
                                    <th key={i} className="px-4 py-2 text-left font-semibold">{col}</th>
                                  ))}
                                </tr>
                              </thead>
                              <tbody>
                                {excelData?.slice(0, 5).map((row, i) => (
                                  <tr key={i} className="border-b hover:bg-gray-50">
                                    {Object.values(row).map((val, j) => (
                                      <td key={j} className="px-4 py-2">{String(val)}</td>
                                    ))}
                                  </tr>
                                ))}
                              </tbody>
                            </table>
                          </div>
                        </div>

                        <div className="flex gap-3">
                          <button
                            onClick={() => setWizardStep(3)}
                            className="flex-1 px-6 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 transition font-bold text-lg"
                          >
                            Continue to Column Mapping
                          </button>
                          <button
                            onClick={() => { setShowExcelWizard(false); setWizardStep(1); }}
                            className="px-6 py-3 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400 transition font-semibold"
                          >
                            Cancel
                          </button>
                        </div>
                      </div>
                    )}

                    {/* Step 3: Column Mapping */}
                    {wizardStep === 3 && (
                      <div>
                        <h3 className="text-2xl font-bold mb-4">Column Mapping</h3>
                        <p className="text-gray-600 mb-6">AI has suggested mappings. Adjust if needed.</p>

                        <div className="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6">
                          <p className="text-sm text-blue-900">
                            üí° <strong>Tip:</strong> Leave unmapped if you don't want to import that column
                          </p>
                        </div>

                        <div className="space-y-4 mb-6">
                          {Object.keys(excelData?.[0] || {}).map((sourceCol, idx) => (
                            <div key={idx} className="border-2 border-gray-200 rounded-lg p-4">
                              <div className="flex items-center justify-between">
                                <div className="flex-1">
                                  <label className="block text-sm font-semibold text-gray-700 mb-2">
                                    Source Column: <span className="text-purple-600">{sourceCol}</span>
                                  </label>
                                  <select
                                    value={Object.entries(columnMappings).find(([, val]) => val === sourceCol)?.[0] || ''}
                                    onChange={(e) => {
                                      const newMappings = { ...columnMappings };
                                      // Remove old mapping
                                      Object.keys(newMappings).forEach(key => {
                                        if (newMappings[key] === sourceCol) delete newMappings[key];
                                      });
                                      // Add new mapping
                                      if (e.target.value) {
                                        newMappings[e.target.value] = sourceCol;
                                      }
                                      setColumnMappings(newMappings);
                                    }}
                                    className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500"
                                  >
                                    <option value="">-- Don't import --</option>
                                    <option value="name">Product Name</option>
                                    <option value="sku">SKU/Code</option>
                                    <option value="price">Price</option>
                                    <option value="category">Category</option>
                                    <option value="description">Description</option>
                                    <option value="stock">Stock/Quantity</option>
                                    <option value={sourceCol}>Keep as "{sourceCol}"</option>
                                  </select>
                                </div>
                                <div className="ml-4 text-right">
                                  <p className="text-xs text-gray-500">Sample:</p>
                                  <p className="text-sm font-mono">{String(excelData?.[0]?.[sourceCol]).substring(0, 20)}...</p>
                                </div>
                              </div>
                            </div>
                          ))}
                        </div>

                        <div className="flex gap-3">
                          <button
                            onClick={() => applyMappingsAndImport(selectedSheet.name.toLowerCase().includes('bundle') ? 'bundles' : 'products')}
                            className="flex-1 px-6 py-4 bg-gradient-to-r from-green-600 to-teal-600 text-white rounded-lg hover:from-green-700 hover:to-teal-700 transition font-bold text-lg"
                          >
                            ‚ú® Import Data
                          </button>
                          <button
                            onClick={() => setWizardStep(2)}
                            className="px-6 py-4 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition font-semibold"
                          >
                            Back
                          </button>
                          <button
                            onClick={() => { setShowExcelWizard(false); setWizardStep(1); }}
                            className="px-6 py-4 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400 transition font-semibold"
                          >
                            Cancel
                          </button>
                        </div>
                      </div>
                    )}

                  </div>
                </div>
              </div>
            )}

          </div>
        </div>
      );
    }

    ReactDOM.render(<App />, document.getElementById('root'));
  </script>
</body>
</html>
